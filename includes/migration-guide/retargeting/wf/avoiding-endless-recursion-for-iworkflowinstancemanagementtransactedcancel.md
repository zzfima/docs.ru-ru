### <a name="avoiding-endless-recursion-for-iworkflowinstancemanagementtransactedcancel-and-iworkflowinstancemanagementtransactedterminate"></a><span data-ttu-id="ad8c7-101">Предотвращение бесконечной рекурсии для IWorkflowInstanceManagement.TransactedCancel и IWorkflowInstanceManagement.TransactedTerminate</span><span class="sxs-lookup"><span data-stu-id="ad8c7-101">Avoiding endless recursion for IWorkflowInstanceManagement.TransactedCancel and IWorkflowInstanceManagement.TransactedTerminate</span></span>

|   |   |
|---|---|
|<span data-ttu-id="ad8c7-102">Подробные сведения</span><span class="sxs-lookup"><span data-stu-id="ad8c7-102">Details</span></span>|<span data-ttu-id="ad8c7-103">В некоторых случаях при использовании API <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> или <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> для отмены или завершения экземпляра службы рабочего процесса в экземпляре рабочего процесса могло возникать переполнение стека из-за бесконечной рекурсии, когда среда выполнения <code>Workflow</code> пыталась сохранить экземпляр службы в ходе обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-103">Under some circumstances when using <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> APIs to cancel or terminate a worklow service instance, the workflow instance may encounter a stack overflow due to endless recursion when the <code>Workflow</code> runtime attempts to persist the service instance as part of processing the request.</span></span> <span data-ttu-id="ad8c7-104">Проблема возникает, если экземпляр рабочего процесса находится в состоянии, когда он ожидает завершения некоторых других необработанных запросов WCF к другой службе. Операции <code>TransactedCancel</code> и <code>TransactedTerminate</code> создают рабочие элементы, которые помещаются в очередь для экземпляра службы рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-104">The problem occurs if the workflow instance is in a state where it is waiting for some other outstanding WCF request to another service to complete.The <code>TransactedCancel</code> and <code>TransactedTerminate</code> operations create work items that are queued for the workflow service instance.</span></span> <span data-ttu-id="ad8c7-105">Эти рабочие элементы не выполняются в рамках обработки запроса <code>TransactedCancel/TransactedTerminate</code>.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-105">These work items are not executed as part of the processing of the <code>TransactedCancel/TransactedTerminate</code> request.</span></span> <span data-ttu-id="ad8c7-106">Поскольку экземпляр службы рабочего процесса занят ожиданием завершения другого необработанного запроса WCF, созданный рабочий элемент остается в очереди.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-106">Because the workflow service instance is busy waiting for the other outstanding WCF request to complete, the work item created remains queued.</span></span> <span data-ttu-id="ad8c7-107">Операция <code>TransactedCancel/TransactedTerminate</code> завершается, и управление возвращается клиенту.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-107">The <code>TransactedCancel/TransactedTerminate</code> operation completes and control is returned back to the client.</span></span> <span data-ttu-id="ad8c7-108">Если транзакция, связанная с операцией <code>TransactedCancel/TransactedTerminate</code>, пытается выполнить фиксацию, ей требуется сохранить состояние экземпляра службы рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-108">When the transaction associated with the <code>TransactedCancel/TransactedTerminate</code> operation attempts to commit, it needs to persist the workflow serivce instance state.</span></span> <span data-ttu-id="ad8c7-109">Однако из-за наличия незавершенного запроса <code>WCF</code> для экземпляра среда выполнения рабочего процесса не может сохранить экземпляр службы рабочего процесса, и бесконечный цикл рекурсии приводит к переполнению стека. Поскольку <code>TransactedCancel</code> и <code>TransactedTerminate</code> создают рабочий элемент только в памяти, тот факт, что транзакция существует, не оказывает никакого влияния.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-109">But because there is an outstanding <code>WCF</code> request for the instance, the Workflow runtime cannot persist the workflow service instance, and an endless recursion loop leads to the stack overflow.Because <code>TransactedCancel</code> and <code>TransactedTerminate</code> only create a work item in memory, the fact that a transaction exists doesn't have any effect.</span></span> <span data-ttu-id="ad8c7-110">Откат транзакции не приводит к отмене рабочего элемента. Чтобы устранить эту проблему, начиная с .NET Framework 4.7.2 мы представили <code>AppSetting</code>, который можно добавлять в <code>web.config/app.config</code> службы рабочего процесса, чтобы указать на необходимость пропуска транзакций для <code>TransactedCancel</code> и <code>TransactedTerminate</code>.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-110">A rollback of the transaction does not discard the work item.To address this issue, starting in .NET Framework 4.7.2, we have introduced an <code>AppSetting</code> that can be added to the <code>web.config/app.config</code> of the workflow service that tells it to ignore transactions for <code>TransactedCancel</code> and <code>TransactedTerminate</code>.</span></span> <span data-ttu-id="ad8c7-111">Это обеспечивает фиксацию транзакции без ожидания сохранения экземпляра рабочего процесса. Параметр AppSetting для этой возможности называется <code>microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate</code>.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-111">This allows the transaction to commit without waiting for the workflow instance to persist.The AppSetting for this feature is named <code>microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate</code>.</span></span> <span data-ttu-id="ad8c7-112">Значение <code>true</code> указывает, что транзакцию следует игнорировать, что позволяет избежать переполнения стека.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-112">A value of <code>true</code> indicates that the transaction should be ignored, thus avoiding the stack overflow.</span></span> <span data-ttu-id="ad8c7-113">Значение по умолчанию этого AppSetting — <code>false</code>, поэтому существующие экземпляры службы рабочих процессов не затрагиваются.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-113">The default value of this AppSetting is <code>false</code>, so existing workflow service instances are not affected.</span></span>|
|<span data-ttu-id="ad8c7-114">Предложение</span><span class="sxs-lookup"><span data-stu-id="ad8c7-114">Suggestion</span></span>|<span data-ttu-id="ad8c7-115">При использовании AppFabric или другого клиента <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> и возникновении переполнения стека в экземпляре службы рабочего процесса при попытке отменить или завершить экземпляр рабочего процесса можно добавить следующий код в часть <code>&lt;appSettings&gt;</code> файла web.config/app.config для службы рабочего процесса:</span><span class="sxs-lookup"><span data-stu-id="ad8c7-115">If you are using AppFabric or another <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> client and are encountering a stack overflow in the workflow serivce instance when trying to cancel or terminate a workflow instance, you can add the following to the <code>&lt;appSettings&gt;</code> section of the web.config/app.config file for the workflow service:</span></span><pre><code class="lang-xml">&lt;add key=&quot;microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate&quot; value=&quot;true&quot;/&gt;&#13;&#10;</code></pre><span data-ttu-id="ad8c7-116">Если проблема не возникает, этого делать не нужно.</span><span class="sxs-lookup"><span data-stu-id="ad8c7-116">If you are not encountering the problem, you do not need to do this.</span></span>|
|<span data-ttu-id="ad8c7-117">Область</span><span class="sxs-lookup"><span data-stu-id="ad8c7-117">Scope</span></span>|<span data-ttu-id="ad8c7-118">Пограничный случай</span><span class="sxs-lookup"><span data-stu-id="ad8c7-118">Edge</span></span>|
|<span data-ttu-id="ad8c7-119">Версия</span><span class="sxs-lookup"><span data-stu-id="ad8c7-119">Version</span></span>|<span data-ttu-id="ad8c7-120">4.7.2</span><span class="sxs-lookup"><span data-stu-id="ad8c7-120">4.7.2</span></span>|
|<span data-ttu-id="ad8c7-121">Тип</span><span class="sxs-lookup"><span data-stu-id="ad8c7-121">Type</span></span>|<span data-ttu-id="ad8c7-122">Изменение целевой платформы</span><span class="sxs-lookup"><span data-stu-id="ad8c7-122">Retargeting</span></span>|

