---
title: Создание отказоустойчивых служб, готовых для облака. адаптация к временным сбоям в облаке
description: Модернизировать существующих приложений .NET с помощью Azure Cloud and Windows Containers | Создание отказоустойчивых служб, готовых для облака. адаптация к временным сбоям в облаке
ms.date: 04/30/2018
ms.openlocfilehash: e6fae8140b55cb0308dca9f4b77e961501b41f8f
ms.sourcegitcommit: 22be09204266253d45ece46f51cc6f080f2b3fd6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2019
ms.locfileid: "73739391"
---
# <a name="build-resilient-services-ready-for-the-cloud-embrace-transient-failures-in-the-cloud"></a><span data-ttu-id="fe8a1-105">Создание отказоустойчивых служб, готовых к работе в облаке: принятие временных сбоев в облаке</span><span class="sxs-lookup"><span data-stu-id="fe8a1-105">Build resilient services ready for the cloud: Embrace transient failures in the cloud</span></span>

<span data-ttu-id="fe8a1-106">Устойчивость — это возможность восстановления после сбоев и продолжение работы.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-106">Resiliency is the ability to recover from failures and continue to function.</span></span> <span data-ttu-id="fe8a1-107">Устойчивость не сводится к предотвращению сбоев, но принимает тот факт, что произойдет сбой, и затем отреагировать на них таким образом, чтобы избежать простоя или потери данных.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-107">Resiliency is not about avoiding failures, but accepting the fact that failures will occur, and then responding to them in a way that avoids downtime or data loss.</span></span> <span data-ttu-id="fe8a1-108">Цель устойчивости — вернуть приложение в полностью функционирующее состояние после сбоя.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-108">The goal of resiliency is to return the application to a fully functioning state after a failure.</span></span>

<span data-ttu-id="fe8a1-109">Приложение готово к работе в облаке, когда, как минимум, оно реализует программную модель устойчивости, а не модель на основе оборудования.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-109">Your application is ready for the cloud when, at a minimum, it implements a software-based model of resiliency, rather than a hardware-based model.</span></span> <span data-ttu-id="fe8a1-110">Облачное приложение должно принять в себя частичные сбои, которые, безусловно, будут выполняться.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-110">Your cloud application must embrace the partial failures that will certainly occur.</span></span> <span data-ttu-id="fe8a1-111">Создайте или частично выполните рефакторинг приложения, чтобы добиться устойчивости с ожидаемыми частичными сбоями.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-111">Design or partially refactor your application to achieve resiliency with expected partial failures.</span></span> <span data-ttu-id="fe8a1-112">Она должна быть разработана для работы с частичными сбоями, такими как временные сбои сети, узлы или сбои виртуальных машин в облаке.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-112">It should be designed to cope with partial failures, like transient network outages and nodes, or VMs crashing in the cloud.</span></span> <span data-ttu-id="fe8a1-113">Даже контейнеры, перемещаемые в другой узел в кластере Orchestrator, могут вызвать периодические кратковременные сбои в приложении.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-113">Even containers being moved to a different node within an orchestrator cluster can cause intermittent short failures within the application.</span></span>

## <a name="handling-partial-failure"></a><span data-ttu-id="fe8a1-114">Обработка частичного сбоя</span><span class="sxs-lookup"><span data-stu-id="fe8a1-114">Handling partial failure</span></span>

<span data-ttu-id="fe8a1-115">В облачном приложении существует риск частичного сбоя.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-115">In a cloud-based application, there's an ever-present risk of partial failure.</span></span> <span data-ttu-id="fe8a1-116">Например, один экземпляр веб-сайта или контейнер может завершиться ошибкой или в течение короткого времени может быть недоступен или не отвечает.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-116">For instance, a single website instance or a container might fail, or it might be unavailable or unresponsive for a short time.</span></span> <span data-ttu-id="fe8a1-117">Или может произойти сбой одной виртуальной машины или сервера.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-117">Or, a single VM or server might crash.</span></span>

<span data-ttu-id="fe8a1-118">Поскольку клиенты и службы являются отдельными процессами, служба не может своевременно отвечать на запросы клиента.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-118">Because clients and services are separate processes, a service might not be able to respond in a timely manner to a client's request.</span></span> <span data-ttu-id="fe8a1-119">Служба может быть перегружена и медленнее реагировать на запросы, или она может быть недоступна в течение короткого промежутка времени из-за проблем с сетью.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-119">The service might be overloaded and respond slowly to requests, or it might not be accessible for a short time because of network issues.</span></span>

<span data-ttu-id="fe8a1-120">Например, рассмотрим монолитное приложение .NET, которое обращается к базе данных в базе данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-120">For example, consider a monolithic .NET application that accesses a database in Azure SQL Database.</span></span> <span data-ttu-id="fe8a1-121">Если база данных SQL Azure или любая другая служба стороннего производителя не отвечает на короткое время (база данных SQL Azure может быть перемещена на другой узел или сервер, не отвечают на несколько секунд), то при попытке пользователя выполнить какое-либо действие приложение может завершиться сбоем и попытаться в то же время исключение.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-121">If the Azure SQL database or any other third-party service is unresponsive for a brief time (an Azure SQL database might be moved to a different node or server, and be unresponsive for a few seconds), when the user tries to do any action, the application might crash and show an exception at the same moment.</span></span>

<span data-ttu-id="fe8a1-122">Подобный сценарий может возникать в приложении, использующем службы HTTP.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-122">A similar scenario might occur in an app that consumes HTTP services.</span></span> <span data-ttu-id="fe8a1-123">Сеть или сама служба могут быть недоступны в облаке во время короткого временного сбоя.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-123">The network or the service itself might not be available in the cloud during a short, transient failure.</span></span>

<span data-ttu-id="fe8a1-124">Устойчивое приложение, как показано на рисунке 4-9, должно реализовать такие приемы, как "повторные попытки с экспоненциальной задержкой", чтобы дать приложению возможность управлять временными сбоями в ресурсах.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-124">A resilient application like the one shown in Figure 4-9 should implement techniques like "retries with exponential backoff" to give the application an opportunity to handle transient failures in resources.</span></span> <span data-ttu-id="fe8a1-125">В приложениях также следует использовать "автоматическое разбиение".</span><span class="sxs-lookup"><span data-stu-id="fe8a1-125">You also should use "circuit breakers" in your applications.</span></span> <span data-ttu-id="fe8a1-126">Автоматическое выключение прекращает попытки приложения получить доступ к ресурсу, когда на самом деле происходит долгосрочный сбой.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-126">A circuit breaker stops an application from trying to access a resource when it's actually a long-term failure.</span></span> <span data-ttu-id="fe8a1-127">С помощью автоматического выключения приложение позволяет избежать заставляющегоия отказа в обслуживании.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-127">By using a circuit breaker, the application avoids provoking a denial of service to itself.</span></span>

![Диаграмма частичных сбоев, обрабатываемых повторными попытками с экспоненциальной задержкой.](./media/build-resilient-services-ready-for-the-cloud-embrace-transient-failures-in-the-cloud/retry-partial-failures.png)

<span data-ttu-id="fe8a1-129">**Рис. 4-9.**</span><span class="sxs-lookup"><span data-stu-id="fe8a1-129">**Figure 4-9.**</span></span> <span data-ttu-id="fe8a1-130">Частичные сбои, обрабатываемые повторами с экспоненциальной задержкой</span><span class="sxs-lookup"><span data-stu-id="fe8a1-130">Partial failures handled by retries with exponential backoff</span></span>

<span data-ttu-id="fe8a1-131">Эти методы можно использовать как в ресурсах HTTP, так и в ресурсах базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-131">You can use these techniques both in HTTP resources and in database resources.</span></span> <span data-ttu-id="fe8a1-132">На рис. 4-9 приложение основано на трехуровневой архитектуре, поэтому эти методы необходимы на уровне служб (HTTP) и на уровне данных (TCP).</span><span class="sxs-lookup"><span data-stu-id="fe8a1-132">In Figure 4-9, the application is based on a 3-tier architecture, so you need these techniques at the services level (HTTP) and at the data tier level (TCP).</span></span> <span data-ttu-id="fe8a1-133">В монолитном приложении, которое использует только один уровень приложения в дополнение к базе данных (без дополнительных служб или микрослужб), обработка временных сбоев на уровне подключения к базе данных может быть достаточной.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-133">In a monolithic application that uses only a single app tier in addition to the database (no additional services or microservices), handling transient failures at the database connection level might be enough.</span></span> <span data-ttu-id="fe8a1-134">В этом сценарии требуется только определенная конфигурация подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-134">In that scenario, just a particular configuration of the database connection is required.</span></span>

<span data-ttu-id="fe8a1-135">При реализации отказоустойчивых соединений, обращающихся к базе данных, в зависимости от используемой версии .NET, она может быть простой (например, [с Entity Framework 6 или более поздней версии](/ef/ef6/fundamentals/connection-resiliency/retry-logic)).</span><span class="sxs-lookup"><span data-stu-id="fe8a1-135">When implementing resilient communications that access the database, depending on the version of .NET you are using, it can be straightforward (for example, [with Entity Framework 6 or later](/ef/ef6/fundamentals/connection-resiliency/retry-logic).</span></span> <span data-ttu-id="fe8a1-136">Это просто вопрос настройки подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-136">It's just a matter of configuring the database connection).</span></span> <span data-ttu-id="fe8a1-137">Также может потребоваться использовать дополнительные библиотеки, такие как [блок приложения для обработки временной ошибки](https://docs.microsoft.com/previous-versions/msp-n-p/hh680934(v=pandp.50)) (для более ранних версий .NET), или даже реализовать собственную библиотеку.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-137">Or, you might need to use additional libraries like the [Transient Fault Handling Application Block](https://docs.microsoft.com/previous-versions/msp-n-p/hh680934(v=pandp.50)) (for earlier versions of .NET), or even implement your own library.</span></span>

<span data-ttu-id="fe8a1-138">При реализации повторных попыток HTTP и отключений следует использовать библиотеку [Polly](https://github.com/App-vNext/Polly) , которая предназначена для .NET Framework 4,0, .NET Framework 4,5 и .NET Standard 1,1, которая включает поддержку .NET Core.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-138">When implementing HTTP retries and circuit breakers, the recommendation for .NET is to use the [Polly](https://github.com/App-vNext/Polly) library, which targets .NET Framework 4.0, .NET Framework 4.5, and .NET Standard 1.1, which includes .NET Core support.</span></span>

<span data-ttu-id="fe8a1-139">Чтобы узнать, как реализовать стратегии по обработке частичных сбоев в облаке, ознакомьтесь со следующими ссылками.</span><span class="sxs-lookup"><span data-stu-id="fe8a1-139">To learn how to implement strategies for handling partial failures in the cloud, see the following references.</span></span>

### <a name="additional-resources"></a><span data-ttu-id="fe8a1-140">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="fe8a1-140">Additional resources</span></span>

- <span data-ttu-id="fe8a1-141">**Реализация отказоустойчивого взаимодействия для выполнения частичного сбоя**</span><span class="sxs-lookup"><span data-stu-id="fe8a1-141">**Implementing resilient communication to handle partial failure**</span></span>

    [https://docs.microsoft.com/dotnet/architecture/microservices/implement-resilient-applications/partial-failure-strategies](../../microservices/implement-resilient-applications/partial-failure-strategies.md)

- <span data-ttu-id="fe8a1-142">**Отказоустойчивость подключения Entity Framework и логика повторных попыток (версия 6 и более поздние)**</span><span class="sxs-lookup"><span data-stu-id="fe8a1-142">**Entity Framework connection resiliency and retry logic (version 6 and later)**</span></span>

    [https://docs.microsoft.com/ef/ef6/fundamentals/connection-resiliency/retry-logic](/ef/ef6/fundamentals/connection-resiliency/retry-logic)

- <span data-ttu-id="fe8a1-143">**Блок приложения обработки временной ошибки**</span><span class="sxs-lookup"><span data-stu-id="fe8a1-143">**The Transient Fault Handling Application Block**</span></span>

- <https://docs.microsoft.com/previous-versions/msp-n-p/hh680934(v=pandp.50)>

- <span data-ttu-id="fe8a1-144">**Библиотека Polly для устойчивого обмена данными по протоколу HTTP**</span><span class="sxs-lookup"><span data-stu-id="fe8a1-144">**Polly library for resilient HTTP communication**</span></span>

    https://github.com/App-vNext/Polly

>[!div class="step-by-step"]
><span data-ttu-id="fe8a1-145">[Назад](when-to-deploy-windows-containers-to-azure-container-service-kubernetes.md)
>[Вперед](modernize-your-apps-with-monitoring-and-telemetry.md)</span><span class="sxs-lookup"><span data-stu-id="fe8a1-145">[Previous](when-to-deploy-windows-containers-to-azure-container-service-kubernetes.md)
[Next](modernize-your-apps-with-monitoring-and-telemetry.md)</span></span>
