---
title: Асинхронные типы возвращаемых значений (C#)
ms.date: 05/29/2017
ms.assetid: ddb2539c-c898-48c1-ad92-245e4a996df8
ms.openlocfilehash: 9926fea5308f9088ad924bcc98d8deed319c6300
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2020
ms.locfileid: "79170043"
---
# <a name="async-return-types-c"></a><span data-ttu-id="7ea69-102">Асинхронные типы возвращаемых значений (C#)</span><span class="sxs-lookup"><span data-stu-id="7ea69-102">Async Return Types (C#)</span></span>
<span data-ttu-id="7ea69-103">Асинхронные методы могут иметь следующие типы возвращаемых значений:</span><span class="sxs-lookup"><span data-stu-id="7ea69-103">Async methods can have the following return types:</span></span>

- <span data-ttu-id="7ea69-104"><xref:System.Threading.Tasks.Task%601> для асинхронного метода, возвращающего значение.</span><span class="sxs-lookup"><span data-stu-id="7ea69-104"><xref:System.Threading.Tasks.Task%601>, for an async method that returns a value.</span></span>

- <span data-ttu-id="7ea69-105"><xref:System.Threading.Tasks.Task> для асинхронного метода, который выполняет операцию, но не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="7ea69-105"><xref:System.Threading.Tasks.Task>, for an async method that performs an operation but returns no value.</span></span>

- <span data-ttu-id="7ea69-106">`void` для обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="7ea69-106">`void`, for an event handler.</span></span>

- <span data-ttu-id="7ea69-107">Начиная с версии 7.0 в языке C# поддерживаются любые типы с доступным методом `GetAwaiter`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-107">Starting with C# 7.0, any type that has an accessible `GetAwaiter` method.</span></span> <span data-ttu-id="7ea69-108">Объект, возвращаемый методом `GetAwaiter`, должен реализовывать интерфейс <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7ea69-108">The object returned by the `GetAwaiter` method must implement the <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType> interface.</span></span>
  
<span data-ttu-id="7ea69-109">Дополнительные сведения об асинхронных методах см. в разделе [Асинхронное программирование с использованием ключевых слов Async и Await (C#)](./index.md).</span><span class="sxs-lookup"><span data-stu-id="7ea69-109">For more information about async methods, see [Asynchronous Programming with async and await (C#)](./index.md).</span></span>  
  
<span data-ttu-id="7ea69-110">Каждый тип возвращаемого значения рассматривается в одном из следующих разделов, а полный пример, в котором используются все три типа, вы найдете в конце этого раздела.</span><span class="sxs-lookup"><span data-stu-id="7ea69-110">Each return type is examined in one of the following sections, and you can find a full example that uses all three types at the end of the topic.</span></span>  
  
## <a name="BKMK_TaskTReturnType"></a> <span data-ttu-id="7ea69-111">Задача\<TResult\> Тип возвращаемого значения</span><span class="sxs-lookup"><span data-stu-id="7ea69-111">Task\<TResult\> Return Type</span></span>  
<span data-ttu-id="7ea69-112">Тип возвращаемого значения <xref:System.Threading.Tasks.Task%601> используется для асинхронного метода, содержащего инструкцию [return](../../../language-reference/keywords/return.md) (C#), в которой операнд имеет тип `TResult`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-112">The <xref:System.Threading.Tasks.Task%601> return type is used for an async method that contains a [return](../../../language-reference/keywords/return.md) (C#) statement in which the operand has type `TResult`.</span></span>  
  
<span data-ttu-id="7ea69-113">В следующем примере асинхронный метод `GetLeisureHours` содержит инструкцию `return`, которая возвращает целое число.</span><span class="sxs-lookup"><span data-stu-id="7ea69-113">In the following example, the `GetLeisureHours` async method contains a `return` statement that returns an integer.</span></span> <span data-ttu-id="7ea69-114">Поэтому в объявлении метода должен указываться тип возвращаемого значения `Task<int>`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-114">Therefore, the method declaration must specify a return type of `Task<int>`.</span></span>  <span data-ttu-id="7ea69-115">Асинхронный метод <xref:System.Threading.Tasks.Task.FromResult%2A> представляет собой заполнитель для операции, которая возвращает строку.</span><span class="sxs-lookup"><span data-stu-id="7ea69-115">The <xref:System.Threading.Tasks.Task.FromResult%2A> async method is a placeholder for an operation that returns a string.</span></span>
  
[!code-csharp[return-value](../../../../../samples/snippets/csharp/programming-guide/async/async-returns1.cs)]

<span data-ttu-id="7ea69-116">При вызове `GetLeisureHours` из выражения await в методе `ShowTodaysInfo` это выражение await извлекает целочисленное значение (значение `leisureHours`), хранящееся в задаче, которая возвращается методом `GetLeisureHours`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-116">When `GetLeisureHours` is called from within an await expression in the `ShowTodaysInfo` method, the await expression retrieves the integer value (the value of `leisureHours`) that's stored in the task returned by the `GetLeisureHours` method.</span></span> <span data-ttu-id="7ea69-117">Дополнительные сведения о выражениях await см. в разделе [await](../../../language-reference/operators/await.md).</span><span class="sxs-lookup"><span data-stu-id="7ea69-117">For more information about await expressions, see [await](../../../language-reference/operators/await.md).</span></span>  
  
<span data-ttu-id="7ea69-118">Чтобы лучше понять, как это происходит, отделите вызов метода `GetLeisureHours` от применения `await`, как показано в следующем коде.</span><span class="sxs-lookup"><span data-stu-id="7ea69-118">You can better understand how this happens by separating the call to `GetLeisureHours` from the application of `await`, as the following code shows.</span></span> <span data-ttu-id="7ea69-119">Вызов метода `GetLeisureHours`, который не ожидается немедленно, возвращает `Task<int>`, как и следовало ожидать из объявления метода.</span><span class="sxs-lookup"><span data-stu-id="7ea69-119">A call to method `GetLeisureHours` that isn't immediately awaited returns a `Task<int>`, as you would expect from the declaration of the method.</span></span> <span data-ttu-id="7ea69-120">В данном примере эта задача назначается переменной `integerTask`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-120">The task is assigned to the `integerTask` variable in the example.</span></span> <span data-ttu-id="7ea69-121">Поскольку `integerTask` является <xref:System.Threading.Tasks.Task%601>, она содержит свойство <xref:System.Threading.Tasks.Task%601.Result> типа `TResult`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-121">Because `integerTask` is a <xref:System.Threading.Tasks.Task%601>, it contains a <xref:System.Threading.Tasks.Task%601.Result> property of type `TResult`.</span></span> <span data-ttu-id="7ea69-122">В этом примере `TResult` представляет собой целочисленный тип.</span><span class="sxs-lookup"><span data-stu-id="7ea69-122">In this case, `TResult` represents an integer type.</span></span> <span data-ttu-id="7ea69-123">Если выражение `await` применяется к `integerTask`, выражение await вычисляется как содержимое свойства <xref:System.Threading.Tasks.Task%601.Result%2A> объекта `integerTask`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-123">When `await` is applied to `integerTask`, the await expression evaluates to the contents of the <xref:System.Threading.Tasks.Task%601.Result%2A> property of `integerTask`.</span></span> <span data-ttu-id="7ea69-124">Это значение присваивается переменной `ret`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-124">The value is assigned to the `ret` variable.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="7ea69-125">Свойство <xref:System.Threading.Tasks.Task%601.Result%2A> является блокирующим свойством.</span><span class="sxs-lookup"><span data-stu-id="7ea69-125">The <xref:System.Threading.Tasks.Task%601.Result%2A> property is a blocking property.</span></span> <span data-ttu-id="7ea69-126">При попытке доступа к нему до завершения его задачи поток, который в текущий момент активен, блокируется до того момента, пока задача не будет завершена, а ее значение не станет доступным.</span><span class="sxs-lookup"><span data-stu-id="7ea69-126">If you try to access it before its task is finished, the thread that's currently active is blocked until the task completes and the value is available.</span></span> <span data-ttu-id="7ea69-127">В большинстве случаев следует получать доступ к этому значению с помощью `await` вместо прямого обращения к свойству.</span><span class="sxs-lookup"><span data-stu-id="7ea69-127">In most cases, you should access the value by using `await` instead of accessing the property directly.</span></span> <br/> <span data-ttu-id="7ea69-128">В предыдущем примере извлекалось значение свойства <xref:System.Threading.Tasks.Task%601.Result%2A> для блокировки основного потока. Это позволяет закончить выполнение метода `ShowTodaysInfo` до того, как завершится работа приложения.</span><span class="sxs-lookup"><span data-stu-id="7ea69-128">The previous example retrieved the value of the <xref:System.Threading.Tasks.Task%601.Result%2A> property to block the main thread so that the `ShowTodaysInfo` method could finish execution before the application ended.</span></span>  

[!code-csharp[return-value](../../../../../samples/snippets/csharp/programming-guide/async/async-returns1a.cs#1)]
  
## <a name="BKMK_TaskReturnType"></a> <span data-ttu-id="7ea69-129">Тип возвращаемого значения Task</span><span class="sxs-lookup"><span data-stu-id="7ea69-129">Task Return Type</span></span>  
<span data-ttu-id="7ea69-130">Асинхронные методы, не содержащие инструкцию `return` или содержащие инструкцию `return`, которая не возвращает операнд, обычно имеют тип возвращаемого значения <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="7ea69-130">Async methods that don't contain a `return` statement or that contain a `return` statement that doesn't return an operand usually have a return type of <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="7ea69-131">При синхронном выполнении такие методы возвращают `void`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-131">Such methods return `void` if they run synchronously.</span></span> <span data-ttu-id="7ea69-132">Если для асинхронного метода вы используете тип возвращаемого значения <xref:System.Threading.Tasks.Task>, вызывающий метод может использовать оператор `await` для приостановки выполнения вызывающего объекта до завершения вызванного асинхронного метода.</span><span class="sxs-lookup"><span data-stu-id="7ea69-132">If you use a <xref:System.Threading.Tasks.Task> return type for an async method, a calling method can use an `await` operator to suspend the caller's completion until the called async method has finished.</span></span>  
  
<span data-ttu-id="7ea69-133">В следующем примере асинхронный метод `WaitAndApologize` не содержит инструкцию `return`, в связи с чем он возвращает объект <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="7ea69-133">In the following example, the `WaitAndApologize` async method doesn't contain a `return` statement, so the method returns a <xref:System.Threading.Tasks.Task> object.</span></span> <span data-ttu-id="7ea69-134">Это позволяет реализовать ожидание `WaitAndApologize`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-134">This enables `WaitAndApologize` to be awaited.</span></span> <span data-ttu-id="7ea69-135">Обратите внимание, что тип <xref:System.Threading.Tasks.Task> не имеет возвращаемого значения и, соответственно, не содержит свойство `Result`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-135">Note that the <xref:System.Threading.Tasks.Task> type doesn't include a `Result` property because it has no return value.</span></span>  

[!code-csharp[return-value](../../../../../samples/snippets/csharp/programming-guide/async/async-returns2.cs)]  
  
<span data-ttu-id="7ea69-136">`WaitAndApologize` вызывается и ожидается с помощью инструкции await (вместо выражения await), похожей на инструкцию вызова для синхронного метода, возвращающего значение void.</span><span class="sxs-lookup"><span data-stu-id="7ea69-136">`WaitAndApologize` is awaited by using an await statement instead of an await expression, similar to the calling statement for a synchronous void-returning method.</span></span> <span data-ttu-id="7ea69-137">Применение оператора await в этом случае не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="7ea69-137">The application of an await operator in this case doesn't produce a value.</span></span>  
  
<span data-ttu-id="7ea69-138">Как и в предыдущем примере <xref:System.Threading.Tasks.Task%601>, вы можете отделить вызов `WaitAndApologize` от применения инструкции await, как показывает следующий код.</span><span class="sxs-lookup"><span data-stu-id="7ea69-138">As in the previous <xref:System.Threading.Tasks.Task%601> example, you can separate the call to `WaitAndApologize` from the application of an await operator, as the following code shows.</span></span> <span data-ttu-id="7ea69-139">Однако следует помнить, что `Task` не содержит свойство `Result`, и при применении оператора await к `Task` никакое значение не создается.</span><span class="sxs-lookup"><span data-stu-id="7ea69-139">However, remember that a `Task` doesn't have a `Result` property, and that no value is produced when an await operator is applied to a `Task`.</span></span>  
  
<span data-ttu-id="7ea69-140">В следующем коде вызов метода `WaitAndApologize` отделяется от ожидания задачи, которую возвращает этот метод.</span><span class="sxs-lookup"><span data-stu-id="7ea69-140">The following code separates calling the `WaitAndApologize` method from awaiting the task that the method returns.</span></span>  

[!code-csharp[return-value](../../../../../samples/snippets/csharp/programming-guide/async/async-returns2a.cs#1)]  

## <a name="BKMK_VoidReturnType"></a> <span data-ttu-id="7ea69-141">Тип возвращаемого значения Void</span><span class="sxs-lookup"><span data-stu-id="7ea69-141">Void return type</span></span>

<span data-ttu-id="7ea69-142">Тип возвращаемого значения `void` используется в асинхронных обработчиках событий, для которых требуется тип возвращаемого значения `void`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-142">You use the `void` return type in asynchronous event handlers, which require a `void` return type.</span></span> <span data-ttu-id="7ea69-143">Поскольку методы, не являющиеся обработчиками событий, не возвращают значения, вместо этого необходимо вернуть <xref:System.Threading.Tasks.Task>. Это вызвано тем, что для асинхронных методов, возвращающих значение `void`, ожидание невозможно.</span><span class="sxs-lookup"><span data-stu-id="7ea69-143">For methods other than event handlers that don't return a value, you should return a <xref:System.Threading.Tasks.Task> instead, because an async method that returns `void` can't be awaited.</span></span> <span data-ttu-id="7ea69-144">Любой вызывающий объект такого метода должен иметь возможность завершить свою работу, не дожидаясь завершения вызванного асинхронного метода, и он не должен зависеть ни от каких значений и исключений, создаваемых асинхронным методом.</span><span class="sxs-lookup"><span data-stu-id="7ea69-144">Any caller of such a method must be able to continue to completion without waiting for the called async method to finish, and the caller must be independent of any values or exceptions that the async method generates.</span></span>  
  
<span data-ttu-id="7ea69-145">Вызывающий объект асинхронного метода, возвращающего void, не может перехватывать исключения, создаваемые методом, и такие необработанные исключения могут привести к сбою приложения.</span><span class="sxs-lookup"><span data-stu-id="7ea69-145">The caller of a void-returning async method can't catch exceptions that are thrown from the method, and such unhandled exceptions are likely to cause your application to fail.</span></span> <span data-ttu-id="7ea69-146">Если исключение возникает в асинхронном методе, который возвращает <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601>, исключение хранится в возвращенной задаче и повторно вызывается при ожидании задачи.</span><span class="sxs-lookup"><span data-stu-id="7ea69-146">If an exception occurs in an async method that returns a <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601>, the exception is stored in the returned task and is rethrown when the task is awaited.</span></span> <span data-ttu-id="7ea69-147">Поэтому убедитесь, что любой асинхронный метод, который может вызвать исключение, имеет тип возвращаемого значения <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601> и что вызовы метода являются ожидаемыми.</span><span class="sxs-lookup"><span data-stu-id="7ea69-147">Therefore, make sure that any async method that can produce an exception has a return type of <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> and that calls to the method are awaited.</span></span>  
  
<span data-ttu-id="7ea69-148">Дополнительные сведения о перехвате исключений в асинхронных методах см. в разделе [Исключения в асинхронных методах](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) в статье о [try-catch](../../../language-reference/keywords/try-catch.md).</span><span class="sxs-lookup"><span data-stu-id="7ea69-148">For more information about how to catch exceptions in async methods, see the [Exceptions in Async Methods](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) section of the [try-catch](../../../language-reference/keywords/try-catch.md) topic.</span></span>  
  
<span data-ttu-id="7ea69-149">В следующем примере показано поведение асинхронного обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="7ea69-149">The following example shows the behavior of an async event handler.</span></span> <span data-ttu-id="7ea69-150">Обратите внимание, что в примере кода асинхронный обработчик событий должен сообщить основному потоку о завершении своей работы.</span><span class="sxs-lookup"><span data-stu-id="7ea69-150">Note that in the example code, an async event handler must let the main thread know when it finishes.</span></span> <span data-ttu-id="7ea69-151">Основной поток может ожидать завершения работы асинхронного обработчика событий перед выходом из программы.</span><span class="sxs-lookup"><span data-stu-id="7ea69-151">Then the main thread can wait for an async event handler to complete before exiting the program.</span></span>

[!code-csharp[return-value](../../../../../samples/snippets/csharp/programming-guide/async/async-returns3.cs)]  

## <a name="generalized-async-return-types-and-valuetasktresult"></a><span data-ttu-id="7ea69-152">Обобщенные асинхронные типы возвращаемых значений и ValueTask\<TResult\></span><span class="sxs-lookup"><span data-stu-id="7ea69-152">Generalized async return types and ValueTask\<TResult\></span></span>

<span data-ttu-id="7ea69-153">Начиная с C# 7.0 асинхронные методы могут возвращать любой тип, имеющий доступный метод `GetAwaiter`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-153">Starting with C# 7.0, an async method can return any type that has an accessible `GetAwaiter` method.</span></span>

<span data-ttu-id="7ea69-154">Поскольку <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601> являются ссылочными типами, выделение памяти во влияющих на производительность сегментах (особенно при выделении памяти в ограниченных циклах) может серьезно снизить производительность.</span><span class="sxs-lookup"><span data-stu-id="7ea69-154">Because <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> are reference types, memory allocation in performance-critical paths, particularly when allocations occur in tight loops, can adversely affect performance.</span></span> <span data-ttu-id="7ea69-155">Поддержка обобщенных типов возвращаемых значений позволяет возвращать небольшой тип значения вместо ссылочного типа, благодаря чему удается предотвратить избыточное выделение памяти.</span><span class="sxs-lookup"><span data-stu-id="7ea69-155">Support for generalized return types means that you can return a lightweight value type instead of a reference type to avoid additional memory allocations.</span></span>

<span data-ttu-id="7ea69-156">На платформе .NET представлена структура <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, которая является упрощенной реализацией обобщенного значения, возвращающего задачу.</span><span class="sxs-lookup"><span data-stu-id="7ea69-156">.NET provides the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> structure as a lightweight implementation of a generalized task-returning value.</span></span> <span data-ttu-id="7ea69-157">Чтобы использовать тип <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, необходимо добавить в проект пакет NuGet `System.Threading.Tasks.Extensions`.</span><span class="sxs-lookup"><span data-stu-id="7ea69-157">To use the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> type, you must add the `System.Threading.Tasks.Extensions` NuGet package to your project.</span></span> <span data-ttu-id="7ea69-158">В следующем примере структура <xref:System.Threading.Tasks.ValueTask%601> используется для извлечения значений двух игральных костей.</span><span class="sxs-lookup"><span data-stu-id="7ea69-158">The following example uses the <xref:System.Threading.Tasks.ValueTask%601> structure to retrieve the value of two dice rolls.</span></span>
  
[!code-csharp[return-value](../../../../../samples/snippets/csharp/programming-guide/async/async-valuetask.cs)]

## <a name="see-also"></a><span data-ttu-id="7ea69-159">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="7ea69-159">See also</span></span>

- <xref:System.Threading.Tasks.Task.FromResult%2A>
- <span data-ttu-id="7ea69-160">[Walkthrough: Accessing the Web by Using async and await (C#)](./walkthrough-accessing-the-web-by-using-async-and-await.md) (Пошаговое руководство. Обращение к веб-сайтам с помощью async и await в C#)</span><span class="sxs-lookup"><span data-stu-id="7ea69-160">[Walkthrough: Accessing the Web by Using async and await (C#)](./walkthrough-accessing-the-web-by-using-async-and-await.md)</span></span>
- [<span data-ttu-id="7ea69-161">Поток управления в асинхронных программах (C#)</span><span class="sxs-lookup"><span data-stu-id="7ea69-161">Control Flow in Async Programs (C#)</span></span>](./control-flow-in-async-programs.md)
- [<span data-ttu-id="7ea69-162">async</span><span class="sxs-lookup"><span data-stu-id="7ea69-162">async</span></span>](../../../language-reference/keywords/async.md)
- [<span data-ttu-id="7ea69-163">await</span><span class="sxs-lookup"><span data-stu-id="7ea69-163">await</span></span>](../../../language-reference/operators/await.md)
