---
title: Руководство по программированию на C#. Подписка и отмена подписки на события
ms.date: 07/20/2015
helpviewer_keywords:
- event handlers [C#], creating
- Code Editor, event handlers
- events [C#], creating using the IDE
ms.assetid: 6319f39f-282c-4173-8a62-6c4657cf51cd
ms.openlocfilehash: 3df357cb15f7f77cefbf360dd9615ce246afe2ea
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2020
ms.locfileid: "75705331"
---
# <a name="how-to-subscribe-to-and-unsubscribe-from-events-c-programming-guide"></a>Руководство по программированию на C#. Подписка и отмена подписки на события
Необходимость подписки на событие, опубликованное другим классом, может возникнуть, когда требуется написать пользовательский код, вызываемый при инициировании такого события. Например, можно подписаться на событие кнопки `click`, чтобы приложение выполняло некоторое действие при нажатии пользователем кнопки.  
  
### <a name="to-subscribe-to-events-by-using-the-visual-studio-ide"></a>Подписка на события в интегрированной среде разработки Visual Studio  
  
1. Если окно **Свойства** закрыто, в представлении **Конструктор** щелкните правой кнопкой мыши форму или элемент управления, для которого требуется создать обработчик событий, и выберите пункт **Свойства**.  
  
2. Вверху окна **Свойства** щелкните значок **События**.  
  
3. Дважды щелкните событие, которое требуется создать, например событие `Load`.  
  
     Visual C# создаст пустой метод обработчика событий и добавит его в код. Код можно также добавить вручную в представлении **Код**. Например, приведенные ниже строки кода объявляют метод обработчика событий, который будет выполнен при вызове классом `Form` события `Load`.  
  
     [!code-csharp[csProgGuideEvents#11](~/samples/snippets/csharp/VS_Snippets_VBCSharp/csProgGuideEvents/CS/Events.cs#11)]  
  
     Строка кода, требуемая для подписки на событие, также создается автоматически в методе `InitializeComponent` в файле Form1.Designer.cs проекта. Она имеет следующий вид:  
  
    ```csharp
    this.Load += new System.EventHandler(this.Form1_Load);  
    ```  
  
### <a name="to-subscribe-to-events-programmatically"></a>Подписка на события программными средствами  
  
1. Определите метод обработчика событий, сигнатура которого соответствует сигнатуре делегата для события. Например, если событие основано на типе делегата <xref:System.EventHandler>, то следующий код представляет заглушку метода:  
  
    ```csharp
    void HandleCustomEvent(object sender, CustomEventArgs a)  
    {  
       // Do something useful here.  
    }  
    ```  
  
2. Чтобы присоединить обработчик событий к событию, используйте оператор присваивания сложения (`+=`). В приведенном ниже примере предположим, что объект с именем `publisher` имеет событие с именем `RaiseCustomEvent`. Обратите внимание на то, что классу подписчика требуется ссылка на класс издателя, чтобы подписаться на его события.  
  
    ```csharp
    publisher.RaiseCustomEvent += HandleCustomEvent;  
    ```  
  
     Обратите внимание, что приведенный выше синтаксис появился только в C# 2.0. Он в точности соответствует синтаксису C# 1.0, в котором с помощью ключевого слова `new` должен быть явно создан инкапсулирующий делегат.  
  
    ```csharp
    publisher.RaiseCustomEvent += new CustomEventHandler(HandleCustomEvent);  
    ```  
  
     Чтобы указать обработчик событий, можно также воспользоваться [лямбда-выражением](../statements-expressions-operators/lambda-expressions.md):
  
    ```csharp
    public Form1()  
    {  
        InitializeComponent();  
        this.Click += (s,e) =>
            {
                MessageBox.Show(((MouseEventArgs)e).Location.ToString());
            };
    }  
    ```  
  
### <a name="to-subscribe-to-events-by-using-an-anonymous-method"></a>Подписка на события с помощью анонимного метода  
  
- Если не нужно будет позже отменять подписку на событие, можно использовать оператор присваивания сложения (`+=`) для прикрепления к событию анонимного метода. В следующем примере предположим, что объект с именем `publisher` имеет событие с именем `RaiseCustomEvent` и что класс `CustomEventArgs` также был определен и содержит некие относящиеся к событию сведения. Обратите внимание на то, что классу подписчика требуется ссылка на `publisher`, чтобы подписаться на его события.  
  
    ```csharp
    publisher.RaiseCustomEvent += delegate(object o, CustomEventArgs e)  
    {  
      string s = o.ToString() + " " + e.ToString();  
      Console.WriteLine(s);  
    };  
    ```  
  
     Важно отметить, что отменить подписку на событие не так просто, если для подписки на него использовалась анонимная функция. Чтобы отменить подписку в этом случае, необходимо вернуться к коду, в котором была выполнена подписка на событие, сохранить анонимный метод в переменной делегата, а затем добавить делегат к событию. Как правило, мы рекомендуем не использовать анонимных функций для подписки на события, если предполагается, что в будущем будет нужно отменять подписку на событие. Дополнительные сведения об анонимных функциях см. в разделе [Анонимные функции](../statements-expressions-operators/anonymous-functions.md).  
  
## <a name="unsubscribing"></a>Отмена подписки  
 Чтобы предотвратить вызов обработчика событий при инициировании события, подписку на событие необходимо отменить. Во избежание утечки ресурсов отменять подписку на события следует до удаления объекта подписчика. До тех пор пока подписка на событие не отменена, делегат многоадресной рассылки, лежащий в основе события в публикующем объекте, будет ссылаться на делегат, инкапсулирующий обработчик событий подписчика. Если ссылка присутствует в публикующем объекте, объект подписчика не будет удален при сборке мусора.  
  
#### <a name="to-unsubscribe-from-an-event"></a>Отмена подписки на событие  
  
- Чтобы отменить подписку на событие, воспользуйтесь оператором присваивания вычитания (`-=`).  
  
    ```csharp
    publisher.RaiseCustomEvent -= HandleCustomEvent;  
    ```  
  
     Если подписка на событие отменена для всех подписчиков, экземпляр события в классе издателя получает значение `null`.  
  
## <a name="see-also"></a>См. также раздел

- [События](./index.md)
- [event](../../language-reference/keywords/event.md)
- [Практическое руководство. Публикация событий, соответствующих рекомендациям .NET Framework](./how-to-publish-events-that-conform-to-net-framework-guidelines.md)
- [Операторы - и -=](../../language-reference/operators/subtraction-operator.md)
- [Операторы + и +=](../../language-reference/operators/addition-operator.md)
