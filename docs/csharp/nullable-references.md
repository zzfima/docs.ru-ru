---
title: Ссылочные типы, допускающие значение null
description: В этой статье представлен обзор ссылочных типов, допускающих значение NULL, добавленных в C# 8. Вы узнаете, как эта функция обеспечивает безопасность от исключений, связанных со ссылочными типами, допускающими значение NULL, в новых и существующих проектах.
ms.date: 02/19/2019
ms.openlocfilehash: 1eb4ccb5ec4397cb81aab37c13a31c41533238e9
ms.sourcegitcommit: 41c0637e894fbcd0713d46d6ef1866f08dc321a2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57411549"
---
# <a name="nullable-reference-types"></a>Ссылочные типы, допускающие значение null

C# 8.0 представляет **ссылочные типы, допускающие значение NULL** и **ссылочные типы, не допускающие значение NULL**, которые позволяют делать важные заявления о свойствах для переменных ссылочного типа:

- **Ссылка не должна иметь значение NULL**. Когда переменные не должны иметь значение NULL, компилятор принудительно применяет правила, которые гарантируют, что можно разыменовать эти переменные без предварительной проверки того, что они не имеют значение NULL:
  - Переменную необходимо инициализировать со значением, отличным от NULL.
  - Переменной не может быть присвоено значение `null`.
- **Ссылка может иметь значение NULL**. Когда переменные могут иметь значение NULL, компилятор применяет различные правила, чтобы убедиться, что вы правильно проверили наличие пустой ссылки:
  - Переменная может быть разыменована только в том случае, когда компилятор может гарантировать, что значение не равно NULL.
  - Эти переменные могут быть инициализированы со значением по умолчанию `null`, и им можно присвоить значение `null` в другом коде.

Эта новая функция предоставляет значительные преимущества по сравнению с обработкой ссылочных переменных в более ранних версиях C#, где назначение кода невозможно было определить по объявлению переменной. Компилятор не обеспечивает безопасность от исключений, связанных с пустой ссылкой, для ссылочных типов:

- **Ссылка может иметь значение NULL**. Предупреждения не выдаются, если ссылочный тип инициализируется со значением NULL либо позднее получает значение NULL.
- **Предполагается, что ссылка не имеет значение NULL**. Компилятор не выдает предупреждения, когда ссылочные типы разыменованы. (Со ссылками, допускающими значение NULL, компилятор выдает предупреждения, когда вы разыменовываете переменную, которая может иметь значение NULL).

С появлением ссылочных типов, допускающих значение NULL, вы можете более четко объявить свое намерение. Значение `null` — это правильный способ представить, что переменная не ссылается на значение. Эта функция не предназначена для удаления всех значений `null` из кода. Вместо этого следует объявить свое намерение компилятору и другим разработчикам, которые читают ваш код. Если вы объявите свое намерение, компилятор сообщит, когда ваш код не соответствует этому намерению.

**Ссылочный тип, допускающий значение NULL** использует тот же синтаксис, что и [тип значения, допускающего значение NULL](programming-guide/nullable-types/index.md): к типу переменной добавляется `?`. Например, следующее объявление переменной представляет строковую переменную, допускающую значение NULL, `name`:

```csharp
string? name;
```

Любая переменная, где `?` не добавляется к имени типа, является **ссылочным типом, не допускающим значение NULL**. Сюда входят все переменные ссылочных типов в существующем коде, если вы включили эту функцию.

Компилятор использует статический анализ, чтобы определить, что ссылка, допускающая значение NULL, имеет значение, отличное от NULL. Компилятор выдает предупреждение, если вы разыменовываете ссылку, допускающую значение NULL, когда она может иметь значение NULL. Это поведение можно переопределить с помощью **оператора допуска NULL** (`!`) после имени переменной. Например, если вы знаете, что переменная `name` не имеет значение NULL, а компилятор выдает предупреждение, напишите следующий код, чтобы переопределить анализ компилятора:

```csharp
name!.Length;
```

Дополнительные сведения об этом операторе см. в черновике спецификации [ссылочных типов, допускающих значение NULL](https://github.com/dotnet/csharplang/blob/master/proposals/csharp-8.0/nullable-reference-types-specification.md#the-null-forgiving-operator) на GitHub.

## <a name="nullability-of-types"></a>Допустимость значений NULL для типов

Любой ссылочный тип может иметь один из четырех уровней *допустимости значений NULL*, который описывает, когда создаются предупреждения:

- *Не допускает значения NULL*: значение NULL нельзя присвоить переменным этого типа. Переменные этого типа не нужно проверять на значение NULL перед разыменованием.
- *Допускает значение NULL*: значение NULL можно присвоить переменным этого типа. Разыменование переменных этого типа без предварительной проверки `null` вызывает предупреждение.
- *Игнорировать*: существовало до версии C# 8. Переменные этого типа можно разыменовать или назначить без предупреждения.
- *Неизвестно*: обычно относится к параметрам типа, где ограничения не сообщают компилятору, что тип должен *допускать* или *не допускать значение NULL*.

Допустимость значений NULL для типа в объявлении переменной управляется *контекстом допустимости значения NULL*, в котором объявлена переменная.

## <a name="nullable-contexts"></a>Контексты допустимости значения NULL

Контексты допустимости значения NULL детально контролируют, как компилятор интерпретирует переменные ссылочного типа. **Контекст с заметками о допустимости значения NULL** любой исходной строки — `enabled` или `disabled`. Представьте себе, что компилятор до версии C# 8 компилирует весь код в контексте, допускающем значения NULL, `disabled`: Любой ссылочный тип может иметь значение NULL. **Контекст с предупреждениями о допустимости значения NULL** может иметь значение `enabled`, `disabled` или `safeonly`. Контекст с предупреждениями о допустимости значения NULL указывает предупреждения, созданные компилятором с помощью анализа потока.

Контекст с заметками о допустимости значения NULL и контекст с предупреждениями о допустимости значения NULL можно задать для проекта с помощью элемента `NullableContextOptions` в файле `csproj`. Этот элемент настраивает, как компилятор интерпретирует допустимость значений NULL для типов и какие предупреждения создаются. Допустимые значения:

- `enable`: Контекст с заметками о допустимости значения NULL **включен**. Контекст с предупреждениями о допустимости значения NULL **включен**.
  - Переменные ссылочного типа, например `string`, не допускают значения NULL.  Все предупреждения о допустимости значений NULL включены.
- `disable`: Контекст с заметками о допустимости значения NULL **отключен**. Контекст с предупреждениями о допустимости значения NULL **отключен**.
  - Переменные ссылочного типа игнорируют допустимость, как и в более ранних версиях C#. Все предупреждения о допустимости значений NULL отключены.
- `safeonly`: Контекст с заметками о допустимости значения NULL **включен**. Контекст с предупреждениями о допустимости значения NULL — **safeonly**.
  - Переменные ссылочного типа не допускают значение NULL. Все предупреждения о безопасности значений NULL включены.
- `warnings`: Контекст с заметками о допустимости значения NULL **отключен**. Контекст с предупреждениями о допустимости значения NULL **включен**.
  - Переменные ссылочного типа игнорируют допустимость. Все предупреждения о допустимости значений NULL включены.
- `safeonlywarnings`: Контекст с заметками о допустимости значения NULL **отключен**. Контекст с предупреждениями о допустимости значения NULL — **safeonly**.
  - Переменные ссылочного типа игнорируют допустимость. Все предупреждения о безопасности значений NULL включены.

Также можно использовать директивы для задания этих контекстов в любом месте в проекте:

- `#nullable enable`: Устанавливает контекст с заметками о допустимости значений NULL и контекст с предупреждениями о допустимости значений NULL в режим **включен**.
- `#nullable disable`: Устанавливает контекст с заметками о допустимости значений NULL и контекст с предупреждениями о допустимости значений NULL в режим **отключен**.
- `#nullable safeonly`: Устанавливает контекст с заметками о допустимости значений NULL в режим **включен**, а контекст с предупреждениями о допустимости значений NULL — в режим **safeonly**.
- `#nullable restore`: Восстанавливает контекст с заметками о допустимости значений NULL и контекст с предупреждениями о допустимости значений NULL в соответствии с параметрами проекта.
- `#pragma warning disable nullable`: Устанавливает контекст с предупреждениями о допустимости значения NULL в режим **отключен**.
- `#pragma warning enable nullable`: Устанавливает контекст с предупреждениями о допустимости значения NULL в режим **включен**.
- `#pragma warning restore nullable`: Восстанавливает контекст с предупреждениями о допустимости NULL в соответствии с параметрами проекта.
- `#pragma warning safeonly nullable`: Устанавливает контекст с предупреждениями о допустимости значения NULL в режим **safeonly**.

Контексты с заметками и предупреждениями о допустимости значения NULL по умолчанию — `disabled`. Это решение означает, что существующий код компилируется без изменений и без создания новых предупреждений.

Различие между контекстами с предупреждениями о допустимости значения NULL `enabled` и `safeonly` заключается в предупреждениях о назначении ссылки, допускающей значение NULL, ссылке, не допускающей значение NULL. Следующее назначение создает предупреждение в контексте `enabled`, но не в контексте `safeonly`. Однако во второй строке, где `s` разыменовано, создается предупреждение в контексте `safeonly`:

```csharp
string s = null; // warning when nullable warning context is enabled.
var txt = s.ToString(); // warning when nullable warnings context is safeonly, or enabled.
```

### <a name="nullable-annotation-context"></a>Контекст с заметками о допустимости значений NULL

Компилятор использует следующие правила в отключенном контексте с заметками о допустимости значения NULL:

- Нельзя объявлять ссылки, допускающие значение NULL, в отключенном контексте.
- Всем ссылочным переменным можно присвоить значение NULL.
- При разыменовании переменной ссылочного типа не выдаются предупреждения.
- Оператор, допускающий NULL, нельзя использовать в отключенном контексте.

Это поведение аналогично предыдущим версиям C#.

Компилятор использует следующие правила во включенном контексте с заметками о допустимости значения NULL:

- Любая переменная ссылочного типа является **ссылкой, не допускающей значение NULL**.
- Любая ссылка, не допускающая значение NULL, может быть безопасно разыменована.
- Любой ссылочный тип, допускающий значение NULL, (с `?` после типа в объявлении переменной) может иметь значение NULL. Статический анализ определяет, что значение не имеет значение NULL при разыменовывании. В противном случае компилятор выдает предупреждение.
- Оператор допустимости значения NULL можно использовать для объявления того, что ссылка, допускающая значение NULL, не имеет значение NULL.

Во включенном контексте с заметками о допустимости значения NULL символ `?`, добавленный к ссылочному типу, объявляет **ссылочный тип, допускающий значение NULL**. **Оператор допустимости значения NULL** (`!`) можно добавить в выражение, чтобы объявить, что выражение не имеет значение NULL.

## <a name="nullable-warning-context"></a>Контекст с предупреждениями о допустимости значений NULL

Контекст с заметками о допустимости значений NULL отличается от контекста с предупреждениями. Предупреждения можно включить даже в том случае, если заметки отключены. Компилятор использует статический анализ потока для определения **состояния значения NULL** любой ссылки. Состояние значения NULL может быть **не NULL** или **может быть NULL**, если *контекст с предупреждениями о допустимости значения NULL* не **отключен**. Если вы пытаетесь разыменовать ссылку, когда компилятор определяет, что она может **иметь значение NULL**, компилятор выдает предупреждение. Состояние ссылки — **может иметь значение NULL**, если компилятор может определить одно из двух условий:

1. Переменной определенно присвоено значение, отличное от NULL.
1. Переменная или выражение проверены на значение NULL до разыменования.

Компилятор выдает предупреждения при каждом разыменовании переменной или выражения в состоянии **может иметь значение NULL**, если контекст с предупреждением о допустимости значения NULL — `enabled` или `safeonly`. Кроме того, предупреждения создаются, когда переменная или выражение в состоянии **может иметь значение NULL** присваиваются ссылочному типу, не допускающему значение NULL, когда установлен контекст с заметками `enabled`.

## <a name="learn-more"></a>Дополнительные сведения

- [Черновик спецификации ссылок, допускающих значение NULL](https://github.com/dotnet/csharplang/blob/master/proposals/csharp-8.0/nullable-reference-types-specification.md)
- [Учебник "Введение в ссылки, допускающие значения NULL"](tutorials/nullable-reference-types.md)
- [Перенос существующей базы кода на ссылки, допускающие значение NULL](tutorials/upgrade-to-nullable-references.md)
