---
title: Вопросы производительности при взаимодействии Direct3D9 и WPF
titleSuffix: ''
ms.date: 03/30/2017
helpviewer_keywords:
- WPF [WPF], Direct3D9 interop performance
- Direct3D9 [WPF interoperability], performance
ms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd
ms.openlocfilehash: 2445732c27d210a41da26303d6a9ce07ef6fcc94
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76743929"
---
# <a name="performance-considerations-for-direct3d9-and-wpf-interoperability"></a><span data-ttu-id="bc4f2-102">Вопросы производительности, связанные с взаимодействием Direct3D9 и WPF</span><span class="sxs-lookup"><span data-stu-id="bc4f2-102">Performance Considerations for Direct3D9 and WPF Interoperability</span></span>
<span data-ttu-id="bc4f2-103">Содержимое Direct3D9 можно разместить с помощью класса <xref:System.Windows.Interop.D3DImage>.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-103">You can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class.</span></span> <span data-ttu-id="bc4f2-104">Размещение содержимого Direct3D9 может повлиять на производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-104">Hosting Direct3D9 content can affect the performance of your application.</span></span> <span data-ttu-id="bc4f2-105">В этом разделе описываются рекомендации по оптимизации производительности при размещении содержимого Direct3D9 в приложении Windows Presentation Foundation (WPF).</span><span class="sxs-lookup"><span data-stu-id="bc4f2-105">This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application.</span></span> <span data-ttu-id="bc4f2-106">Эти рекомендации включают использование <xref:System.Windows.Interop.D3DImage> и рекомендации при использовании Windows Vista, Windows XP и нескольких мониторов.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-106">These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc4f2-107">Примеры кода, демонстрирующие эти рекомендации, см. в разделе [взаимодействие WPF и Direct3D9](wpf-and-direct3d9-interoperation.md).</span><span class="sxs-lookup"><span data-stu-id="bc4f2-107">For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="use-d3dimage-sparingly"></a><span data-ttu-id="bc4f2-108">Использовать D3DImage с осторожностью</span><span class="sxs-lookup"><span data-stu-id="bc4f2-108">Use D3DImage Sparingly</span></span>  
 <span data-ttu-id="bc4f2-109">Содержимое Direct3D9, размещенное в экземпляре <xref:System.Windows.Interop.D3DImage>, не отображается так быстро, как в чистом приложении Direct3D.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-109">Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application.</span></span> <span data-ttu-id="bc4f2-110">Копирование поверхности и очистка буфера команд может быть дорогостоящими операциями.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-110">Copying the surface and flushing the command buffer can be costly operations.</span></span> <span data-ttu-id="bc4f2-111">По мере увеличения числа экземпляров <xref:System.Windows.Interop.D3DImage> происходит дополнительная очистка и снижается производительность.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-111">As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades.</span></span> <span data-ttu-id="bc4f2-112">Поэтому следует использовать <xref:System.Windows.Interop.D3DImage> с осторожностью.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-112">Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly.</span></span>  
  
## <a name="best-practices-on-windows-vista"></a><span data-ttu-id="bc4f2-113">Рекомендации по использованию Windows Vista</span><span class="sxs-lookup"><span data-stu-id="bc4f2-113">Best Practices on Windows Vista</span></span>  
 <span data-ttu-id="bc4f2-114">Чтобы обеспечить наилучшую производительность Windows Vista с отображением, настроенным на использование модели Windows дисплея (WDDM), создайте поверхность Direct3D9 на устройстве `IDirect3DDevice9Ex`.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-114">For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device.</span></span> <span data-ttu-id="bc4f2-115">Это обеспечивает общий доступ к поверхности.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-115">This enables surface sharing.</span></span> <span data-ttu-id="bc4f2-116">Видеоадаптер должен поддерживать функции драйверов `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` и `D3DCAPS2_CANSHARERESOURCE` в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-116">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista.</span></span> <span data-ttu-id="bc4f2-117">Другие параметры приводят к тому, что поверхность копируется в программное обеспечение, что значительно снижает производительность.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-117">Any other settings cause the surface to be copied through software, which reduces performance significantly.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc4f2-118">Если в Windows Vista имеется дисплей, настроенный на использование модели Windows XP дисплея (КСДДМ), поверхность всегда копируется через программное обеспечение независимо от параметров.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-118">If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings.</span></span> <span data-ttu-id="bc4f2-119">Благодаря правильным параметрам и видеоадаптеру в Windows Vista вы увидите лучшую производительность при использовании WDDM, поскольку копирование поверхностей выполняется на оборудовании.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-119">With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.</span></span>  
  
## <a name="best-practices-on-windows-xp"></a><span data-ttu-id="bc4f2-120">Рекомендации по Windows XP</span><span class="sxs-lookup"><span data-stu-id="bc4f2-120">Best Practices on Windows XP</span></span>  
 <span data-ttu-id="bc4f2-121">Для лучшей производительности в Windows XP, которая использует модель видеодрайверов Windows XP (КСДДМ), создайте блокируемую поверхность, которая правильно работает при вызове метода `IDirect3DSurface9::GetDC`.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-121">For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called.</span></span> <span data-ttu-id="bc4f2-122">На внутреннем уровне метод `BitBlt` передает поверхность между устройствами в оборудовании.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-122">Internally, the `BitBlt` method transfers the surface across devices in hardware.</span></span> <span data-ttu-id="bc4f2-123">Метод `GetDC` всегда работает на поверхностях КСРГБ.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-123">The `GetDC` method always works on XRGB surfaces.</span></span> <span data-ttu-id="bc4f2-124">Однако если клиентский компьютер работает под управлением Windows XP с пакетом обновления 3 (SP3) или с пакетом обновления 2 (SP2), а также если у клиента есть исправление для функции многоуровневого окна, этот метод работает только на поверхностях ARGB.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-124">However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces.</span></span> <span data-ttu-id="bc4f2-125">Видеоадаптер должен поддерживать возможность использования драйвера `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-125">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability.</span></span>  
  
 <span data-ttu-id="bc4f2-126">16-разрядная глубина экрана может значительно снизить производительность.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-126">A 16-bit desktop display depth can significantly reduce performance.</span></span> <span data-ttu-id="bc4f2-127">Рекомендуется использовать 32-разрядный компьютер.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-127">A 32-bit desktop is recommended.</span></span>  
  
 <span data-ttu-id="bc4f2-128">При разработке для Windows Vista и Windows XP следует протестировать производительность Windows XP.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-128">If you are developing for Windows Vista and Windows XP, test the performance on Windows XP.</span></span> <span data-ttu-id="bc4f2-129">В Windows XP возникает проблема, связанная с нехваткой видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-129">Running out of video memory on Windows XP is a concern.</span></span> <span data-ttu-id="bc4f2-130">Кроме того, <xref:System.Windows.Interop.D3DImage> в Windows XP использует больший объем видеопамяти и пропускной способности, чем в Windows Vista WDDM из-за необходимости в дополнительной копии видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-130">In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy.</span></span> <span data-ttu-id="bc4f2-131">Таким образом, производительность может быть хуже в Windows XP, чем в Windows Vista для одного и того же видеооборудования.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-131">Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc4f2-132">КСДДМ доступен как в Windows XP, так и в Windows Vista; Однако WDDM доступен только в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-132">XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.</span></span>  
  
## <a name="general-best-practices"></a><span data-ttu-id="bc4f2-133">Общие рекомендации</span><span class="sxs-lookup"><span data-stu-id="bc4f2-133">General Best Practices</span></span>  
 <span data-ttu-id="bc4f2-134">При создании устройства используйте флаг создания `D3DCREATE_MULTITHREADED`.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-134">When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag.</span></span> <span data-ttu-id="bc4f2-135">Это снижает производительность, но система отрисовки WPF вызывает методы на этом устройстве из другого потока.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-135">This reduces performance, but the WPF rendering system calls methods on this device from another thread.</span></span> <span data-ttu-id="bc4f2-136">Не забудьте правильно следовать протоколу блокировки, чтобы ни один из двух потоков не одновременно выполнял доступ к устройству.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-136">Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.</span></span>  
  
 <span data-ttu-id="bc4f2-137">Если отрисовка выполняется в управляемом потоке WPF, настоятельно рекомендуется создать устройство с флагом создания `D3DCREATE_FPU_PRESERVE`.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-137">If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag.</span></span> <span data-ttu-id="bc4f2-138">Без этого параметра визуализация D3D может снизить точность операций двойной точности WPF и вызвать проблемы отрисовки.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-138">Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.</span></span>  
  
 <span data-ttu-id="bc4f2-139">Мозаичное заполнение <xref:System.Windows.Interop.D3DImage> выполняется быстрее, если не pow2 поверхность без поддержки оборудования или если плитка <xref:System.Windows.Media.DrawingBrush> или <xref:System.Windows.Media.VisualBrush>, содержащей <xref:System.Windows.Interop.D3DImage>.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-139">Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>.</span></span>  
  
## <a name="best-practices-for-multi-monitor-displays"></a><span data-ttu-id="bc4f2-140">Рекомендации по отображению нескольких мониторов</span><span class="sxs-lookup"><span data-stu-id="bc4f2-140">Best Practices for Multi-Monitor Displays</span></span>  
 <span data-ttu-id="bc4f2-141">Если вы используете компьютер с несколькими мониторами, следуйте приведенным выше рекомендациям.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-141">If you are using a computer that has multiple monitors, you should follow the previously described best practices.</span></span> <span data-ttu-id="bc4f2-142">Кроме того, для конфигурации с несколькими мониторами также необходимо учитывать некоторые дополнительные факторы.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-142">There are also some additional performance considerations for a multi-monitor configuration.</span></span>  
  
 <span data-ttu-id="bc4f2-143">При создании заднего буфера он создается на определенном устройстве и адаптере, но WPF может отображать передний буфер на любом адаптере.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-143">When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter.</span></span> <span data-ttu-id="bc4f2-144">Копирование между адаптерами для обновления внешнего буфера может быть очень дорогим.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-144">Copying across adapters to update the front buffer can be very expensive.</span></span> <span data-ttu-id="bc4f2-145">В Windows Vista, настроенном для использования WDDM с несколькими видеоадаптерами и с `IDirect3DDevice9Ex` устройством, если передний буфер находится на другом адаптере, но по-прежнему один видеоадаптер, производительность не снижается.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-145">On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty.</span></span> <span data-ttu-id="bc4f2-146">Однако в Windows XP и КСДДМ с несколькими видеоадаптерами значительно снижается производительность при отображении внешнего буфера на адаптере, отличном от адаптера заднего буфера.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-146">However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer.</span></span> <span data-ttu-id="bc4f2-147">Дополнительные сведения см. в разделе [взаимодействие WPF и Direct3D9](wpf-and-direct3d9-interoperation.md).</span><span class="sxs-lookup"><span data-stu-id="bc4f2-147">For more information, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="performance-summary"></a><span data-ttu-id="bc4f2-148">Сводка по производительности</span><span class="sxs-lookup"><span data-stu-id="bc4f2-148">Performance Summary</span></span>  
 <span data-ttu-id="bc4f2-149">В следующей таблице показана производительность обновления переднего буфера в виде функции операционной системы, формата пикселей и блокировки поверхности.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-149">The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability.</span></span> <span data-ttu-id="bc4f2-150">Предполагается, что интерфейсный буфер и задний буфер находятся на одном адаптере.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-150">The front buffer and back buffer are assumed to be on the same adapter.</span></span> <span data-ttu-id="bc4f2-151">В зависимости от конфигурации адаптера обновления оборудования обычно выполняются гораздо быстрее, чем обновления программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="bc4f2-151">Depending on the adapter configuration, hardware updates are generally much faster than software updates.</span></span>  
  
|<span data-ttu-id="bc4f2-152">Формат пиксельной поверхности</span><span class="sxs-lookup"><span data-stu-id="bc4f2-152">Surface pixel format</span></span>|<span data-ttu-id="bc4f2-153">Windows Vista, WDDM и 9Ex</span><span class="sxs-lookup"><span data-stu-id="bc4f2-153">Windows Vista, WDDM and 9Ex</span></span>|<span data-ttu-id="bc4f2-154">Другие конфигурации Windows Vista</span><span class="sxs-lookup"><span data-stu-id="bc4f2-154">Other Windows Vista configurations</span></span>|<span data-ttu-id="bc4f2-155">Исправление для Windows XP SP3 или с пакетом обновления 2 (SP2)</span><span class="sxs-lookup"><span data-stu-id="bc4f2-155">Windows XP SP3 or SP2 w/ hotfix</span></span>|<span data-ttu-id="bc4f2-156">Windows XP с пакетом обновления 2 (SP2)</span><span class="sxs-lookup"><span data-stu-id="bc4f2-156">Windows XP SP2</span></span>|  
|--------------------------|---------------------------------|----------------------------------------|--------------------------------------|--------------------|  
|<span data-ttu-id="bc4f2-157">D3DFMT_X8R8G8B8 (не блокируемый)</span><span class="sxs-lookup"><span data-stu-id="bc4f2-157">D3DFMT_X8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="bc4f2-158">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-158">**Hardware Update**</span></span>|<span data-ttu-id="bc4f2-159">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-159">Software Update</span></span>|<span data-ttu-id="bc4f2-160">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-160">Software Update</span></span>|<span data-ttu-id="bc4f2-161">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-161">Software Update</span></span>|  
|<span data-ttu-id="bc4f2-162">D3DFMT_X8R8G8B8 (блокируемый)</span><span class="sxs-lookup"><span data-stu-id="bc4f2-162">D3DFMT_X8R8G8B8 (lockable)</span></span>|<span data-ttu-id="bc4f2-163">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-163">**Hardware Update**</span></span>|<span data-ttu-id="bc4f2-164">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-164">Software Update</span></span>|<span data-ttu-id="bc4f2-165">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-165">**Hardware Update**</span></span>|<span data-ttu-id="bc4f2-166">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-166">**Hardware Update**</span></span>|  
|<span data-ttu-id="bc4f2-167">D3DFMT_A8R8G8B8 (не блокируемый)</span><span class="sxs-lookup"><span data-stu-id="bc4f2-167">D3DFMT_A8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="bc4f2-168">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-168">**Hardware Update**</span></span>|<span data-ttu-id="bc4f2-169">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-169">Software Update</span></span>|<span data-ttu-id="bc4f2-170">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-170">Software Update</span></span>|<span data-ttu-id="bc4f2-171">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-171">Software Update</span></span>|  
|<span data-ttu-id="bc4f2-172">D3DFMT_A8R8G8B8 (блокируемый)</span><span class="sxs-lookup"><span data-stu-id="bc4f2-172">D3DFMT_A8R8G8B8 (lockable)</span></span>|<span data-ttu-id="bc4f2-173">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-173">**Hardware Update**</span></span>|<span data-ttu-id="bc4f2-174">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-174">Software Update</span></span>|<span data-ttu-id="bc4f2-175">**Обновление оборудования**</span><span class="sxs-lookup"><span data-stu-id="bc4f2-175">**Hardware Update**</span></span>|<span data-ttu-id="bc4f2-176">Обновление программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="bc4f2-176">Software Update</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="bc4f2-177">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="bc4f2-177">See also</span></span>

- <xref:System.Windows.Interop.D3DImage>
- [<span data-ttu-id="bc4f2-178">Взаимодействие WPF и Direct3D9</span><span class="sxs-lookup"><span data-stu-id="bc4f2-178">WPF and Direct3D9 Interoperation</span></span>](wpf-and-direct3d9-interoperation.md)
- [<span data-ttu-id="bc4f2-179">Пошаговое руководство. Создание содержимого Direct3D9 для размещения в WPF</span><span class="sxs-lookup"><span data-stu-id="bc4f2-179">Walkthrough: Creating Direct3D9 Content for Hosting in WPF</span></span>](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)
- [<span data-ttu-id="bc4f2-180">Пошаговое руководство. Размещение содержимого Direct3D9 в WPF</span><span class="sxs-lookup"><span data-stu-id="bc4f2-180">Walkthrough: Hosting Direct3D9 Content in WPF</span></span>](walkthrough-hosting-direct3d9-content-in-wpf.md)
