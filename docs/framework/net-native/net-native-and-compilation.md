---
title: Машинный код .NET и компиляция
ms.date: 03/30/2017
ms.assetid: e38ae4f3-3e3d-42c3-a4b8-db1aa9d84f85
ms.openlocfilehash: cf5c9f05b2f2cb4ca15e4add5b53bc9bdca757a3
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73128247"
---
# <a name="net-native-and-compilation"></a>Машинный код .NET и компиляция

Приложения Windows 8.1 и классические приложения Windows, предназначенные для платформы .NET Framework, создаются на определенном языке программирования и компилируются в промежуточный язык (IL). Перед выполнением какого-либо метода в первый раз JIT-компилятор компилирует IL-код в машинный код для локального компьютера. В противоположность этому цепочка инструментов .NET Native преобразует исходный код в машинный код во время компиляции. В этом разделе сравнивается .NET Native с другими технологиями компиляции, доступными для приложений .NET Framework, а также детально рассматривается, как цепочка инструментов .NET Native создает исходный код, что поможет вам понять, почему исключения, возникающие в коде, скомпилированном .NET Native, не возникают в JIT-скомпилированном коде.

## <a name="net-native-generating-native-binaries"></a>.NET Native: создание двоичных файлов машинного кода

Приложение, предназначенное для .NET Framework и не скомпилированное с помощью цепочки инструментов .NET Native, состоит из сборки приложения, которая включает следующее:

- [Метаданные](../../standard/metadata-and-self-describing-components.md), описывающие сборку, ее зависимости, типы, которые она содержит, и их члены. Метаданные используется для отражения и доступа через позднее связывание, а также в некоторых случаях для средств компиляции и построения.

- Код реализации. Он состоит из кодов операций промежуточного языка (IL). Во время выполнения JIT-компилятор преобразует его в машинный код для целевой платформы.

 Для приложения, помимо главной сборки, требуется присутствие следующего:

- Все дополнительные библиотеки классов и сборки сторонних производителей, необходимые приложению. Эти сборки точно так же включают метаданные, описывающие сборку, ее типы и члены, а также IL-код, который реализует все члены типов.

- Библиотека классов .NET Framework. Это коллекция сборок, устанавливаемая на локальном компьютере при установке платформы .NET Framework. Сборки, включенные в библиотеку классов .NET Framework, содержат полный набор метаданных и кода реализации.

- Среда CLR. Это коллекция библиотек DLL, которые выполняют такие операции, как загрузка сборок, управление памятью, сбор мусора, обработка исключений, JIT-компиляция, удаленное и локальное взаимодействие. Как и библиотека классов, среда выполнения устанавливается на локальном компьютере в процессе установки .NET Framework.

Обратите внимание, для успешного выполнения приложения должны присутствовать: вся среда CLR, метаданные, IL-код для всех типов в сборках, специфичных для приложения, сторонние сборки и системные сборки.

## <a name="net-native-and-just-in-time-compilation"></a>.NET Native и JIT-компиляция

Входные данные для цепочки инструментов машинного кода .NET — приложение Магазина Windows, сборка которого выполнена компилятором C# или Visual Basic. Другими словами, цепочка инструментов машинного кода .NET Nativeначинает выполнение после того, как компилятор завершит компиляцию приложения Магазина Windows.

> [!TIP]
> Так как входные данные .NET Native — промежуточный язык (IL) и метаданные, записанные в сборки управляемого кода, то вы по-прежнему можете выполнять создание собственного кода или другие пользовательские операции посредством событий "перед сборкой" и "после сборки" или путем изменения файла проекта MSBuild.
>
> Однако не поддерживаются инструменты, изменяющие IL-код и тем самым препятствующие анализу приложения IL цепочкой инструментов .NET. Средства запутывания являются наиболее важными средствами этого типа.

Во время преобразования приложения из промежуточного языка в машинный код цепочка инструментов .NET Native выполняет следующие операции:

- Для некоторых ветвей кода  заменяется код, основанный на отражении и метаданных, на статический машинный код. Например, если тип значения не переопределяет метод <xref:System.ValueType.Equals%2A?displayProperty=nameWithType>, то стандартный тест на эквивалентность использует отражение для получения объектов <xref:System.Reflection.FieldInfo>, представляющих поля этого типа значения, а затем сравнивает значения полей двух экземпляров. При компиляции в машинный код цепочка инструментов .NET Native заменяет код отражения и метаданные на статическое сравнение значений полей.

- Везде, где возможно, делается попытка исключить все метаданные.

- .NET Native включает в заключительные сборки приложения только тот код реализации, который фактически вызывается приложением. Особенно это касается кода сторонних библиотек и кода в библиотеке классов .NET Framework. В результате приложение больше не зависит от сторонних библиотек или всей библиотеки классов .NET Framework; вместо этого код сторонних библиотек и библиотек классов .NET Framework теперь является локальным для приложения.

- .NET Native заменяет полную среду CLR на оптимизированную среды выполнения, которая в первую очередь содержит сборщика мусора. Оптимизированная среда выполнения находится в библиотеке mrt100_app.dll, которая является локальной для приложения и имеет размер только несколько сотен килобайт. Это возможно потому, что статическое связывание устраняет необходимость во многих операциях, реализуемых средой CLR.

  > [!NOTE]
  > .NET Native использует тот же сборщик мусора, что и стандартная среда CLR. В сборщике мусора .NET Native фоновая сборка мусора включена по умолчанию. Дополнительные сведения о сборке мусора см. в разделе [Основы сборки мусора](../../standard/garbage-collection/fundamentals.md).

> [!IMPORTANT]
> .NET Native компилирует все приложение в приложение машинного кода. .NET Native не позволяет компилировать одну сборку, которая содержит библиотеку классов, в машинный код, для того чтобы его можно было вызывать напрямую из управляемого кода.

Итоговое приложение, созданное цепочкой инструментов .NET Native, записывается в каталог ilc.out в каталоге отладки или выпуска каталога проекта. Итоговое приложение состоит из следующих файлов:

- *\<имя_приложения>* .exe — заглушка исполняемого файла, которая просто передает управление специальной функции `Main`, экспортируемой библиотекой *\<имя_приложения>* .dll.

- *\<имя_приложения>* .dll — библиотека DLL, содержащая весь код приложения, а также код из библиотеки классов .NET Framework и любых сторонних библиотек, от которых есть зависимости.  Итоговое приложение также содержит код поддержки, например код, необходимый для взаимодействия с Windows и сериализации объектов в приложении.

- mrt100_app.dll — оптимизированная среда выполнения, которая предоставляет сервисы реального времени, такие как сборка мусора.

 APPX-манифестом приложения регистрируются все зависимости.  Помимо EXE-файла приложения, библиотеки DLL и среды выполнения mrt100_app.dll, которые входят непосредственно в APPX-пакет, пакет включает два дополнительных файла:

- msvcr140_app.dll — библиотека языка C времени выполнения (CRT), используемая mrt100_app.dll. Она включается по ссылке платформы в пакете.

- mrt100.dll. Эта библиотека содержит функции, которые могут повысить производительность библиотеки mrt100_app.dll, хотя ее отсутствие не препятствует функционированию mrt100_app.dll. Она загружается из папки system32 на локальном компьютере, если там она имеется.

Поскольку цепочка инструментов .NET Native связывает код реализации в приложении только в том случае, если известно, что приложение вызывает этот код, могут не включаться вместе с приложением метаданные или код реализации, требуемые в следующих сценариях:

- Отражение.

- динамический вызов или вызов посредством позднего связывания;

- сериализация и десериализация;

- COM-взаимодействие.

Если во время выполнения метаданные или необходимый код отсутствуют, среда выполнения .NET Native вызывает исключение. Чтобы предотвратить эти исключения, убедитесь, что цепочка инструментов .NET Native включает необходимые метаданные и код реализации, с помощью [файла директив времени выполнения](runtime-directives-rd-xml-configuration-file-reference.md). Это XML-файл, указывающий элементы программы, чьи метаданные или код реализации должны быть доступны во время выполнения, и назначающий им политику времени выполнения. Ниже приведен стандартный файл директив среды выполнения, который добавляется в проект Магазина Windows, компилируемый цепочкой инструментов .NET Native:

```xml
<Directives xmlns="http://schemas.microsoft.com/netfx/2013/01/metadata">
  <Application>
    <Assembly Name="*Application*" Dynamic="Required All" />
  </Application>
</Directives>
```

Благодаря этому становятся доступными для отражения и динамического вызова все типы и их члены во всех сборках в пакете приложения. Однако это не позволяет выполнять отражение или динамическую активацию типов в сборках библиотеки классов .NET Framework. В большинстве случаев этого достаточно.

## <a name="net-native-and-ngen"></a>.NET Native и NGEN

[Генератор образов в машинном коде](../tools/ngen-exe-native-image-generator.md) (NGEN) компилирует сборки в машинный код и устанавливает их в кэш образов в машинном коде на локальном компьютере. Однако хотя NGEN, как и .NET Native, создает машинный код, NGEN имеет существенные отличия от .NET Native:

- Если для конкретного метода нет образа в машинном коде, NGEN переключается на JIT-компиляцию кода. Это означает, что образы в машинном коде должны продолжать включать метаданные и IL-код для того случая, если генератору NGEN необходимо переключиться на JIT-компиляцию. В противоположность этому .NET Native только создает образы в машинном коде и не переключается на JIT-компиляцию. В результате должны сохраняться метаданные, необходимые только для некоторых сценариев отражения, сериализации и  взаимодействия.

- NGEN по-прежнему полагается на полную среду CLR для таких сервисов, как загрузка сборок, удаленное и локальное взаимодействие, управление памятью, сбор мусора и, при необходимости, JIT-компиляция. В .NET Native многие из этих сервисов являются либо ненужными (JIT-компиляции), либо разрешаются во время построения и включаются в сборку приложения. Остальные сервисы, наиболее важным из которых является сбор мусора, включены в гораздо более компактную, оптимизированную среду выполнения mrt100_app.dll.

- Образы NGEN, как правило, хрупкие. Например, обновление или изменение зависимости обычно требует, чтобы сборки, которые его используют, также были пересозданы NGEN. Это особенно верно для системных сборок в библиотеке классов .NET Framework. В противоположность этому .NET Native позволяет обслуживать приложения независимо друг от друга.

## <a name="see-also"></a>См. также

- [Метаданные и компоненты с самоописанием](../../standard/metadata-and-self-describing-components.md)
- [Внутри .NET Native (видео на канале 9)](https://channel9.msdn.com/Shows/Going+Deep/Inside-NET-Native)
- [Отражение и .NET Native](reflection-and-net-native.md)
- [.NET Native. Устранение общих неполадок](net-native-general-troubleshooting.md)
