---
title: Изменения в аутентификации NTLM для HttpWebRequest в версии 3.5 с пакетом обновления 1 (SP1)
ms.date: 03/30/2017
ms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a
ms.openlocfilehash: 388e6dc648e1fd68e24a852cb08de107f09f9c9f
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2020
ms.locfileid: "64754875"
---
# <a name="changes-to-ntlm-authentication-for-httpwebrequest-in-version-35-sp1"></a><span data-ttu-id="45033-102">Изменения в аутентификации NTLM для HttpWebRequest в версии 3.5 с пакетом обновления 1 (SP1)</span><span class="sxs-lookup"><span data-stu-id="45033-102">Changes to NTLM authentication for HttpWebRequest in Version 3.5 SP1</span></span>

<span data-ttu-id="45033-103">В .NET Framework версии 3.5 с пакетом обновления 1 (SP1) и более поздних внесены касающиеся безопасности изменения, влияющие на обработку встроенной проверки подлинности Windows классами <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream> и связанными классами в пространстве имен System.Net.</span><span class="sxs-lookup"><span data-stu-id="45033-103">Security changes were made in .NET Framework version 3.5 SP1 and later that affect how integrated Windows authentication is handled by the <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream>, and related classes in the System.Net namespace.</span></span> <span data-ttu-id="45033-104">Эти изменения могут влиять на приложения, которые используют данные классы для выполнения веб-запросов и получения ответов с применением встроенной проверки подлинности Windows на основе NTLM.</span><span class="sxs-lookup"><span data-stu-id="45033-104">These changes can affect applications that use these classes to make web requests and receive responses where integrated Windows authentication based on NTLM is used.</span></span> <span data-ttu-id="45033-105">Они также могут повлиять на веб-серверы и клиентские приложения, в которых используется встроенная проверка подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="45033-105">This change can impact web servers and client applications that are configured to use integrated Windows authentication.</span></span>

## <a name="overview"></a><span data-ttu-id="45033-106">Обзор</span><span class="sxs-lookup"><span data-stu-id="45033-106">Overview</span></span>

<span data-ttu-id="45033-107">Структура встроенной проверки подлинности Windows позволяет формировать универсальные ответы на некоторые запросы учетных данных. Это означает, что эти ответы можно использовать повторно или перенаправлять.</span><span class="sxs-lookup"><span data-stu-id="45033-107">The design of integrated Windows authentication allows for some credential responses to be universal, meaning they can be re-used or forwarded.</span></span> <span data-ttu-id="45033-108">Если эта функция не нужна, то протоколы проверки подлинности должны передавать сведения, относящиеся к целевому объекту и каналу.</span><span class="sxs-lookup"><span data-stu-id="45033-108">If this particular design feature is not needed, then the authentication protocols should carry target specific information as well as channel specific information.</span></span> <span data-ttu-id="45033-109">Кроме того, службы могут предоставлять расширенную защиту, чтобы в ответах на запросы учетных данных также содержались сведения о службе, например имя субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="45033-109">Services can then provide extended protection to ensure that credential responses contain service specific information such as a Service Principal Name (SPN).</span></span> <span data-ttu-id="45033-110">С включением этих сведений в ответы на запросы учетных данных службы могут обеспечить лучшую защиту при изменении ответов злоумышленниками.</span><span class="sxs-lookup"><span data-stu-id="45033-110">With this information in the credential exchanges, services are able to better protect against malicious use of credential responses that might have been improperly obtained.</span></span>

<span data-ttu-id="45033-111">Несколько компонентов в пространствах имен <xref:System.Net> и <xref:System.Net.Security> выполняют встроенную проверку подлинности Windows от имени вызывающего приложения.</span><span class="sxs-lookup"><span data-stu-id="45033-111">Multiple components in the <xref:System.Net> and <xref:System.Net.Security> namespaces perform integrated Windows authentication on behalf of a calling application.</span></span> <span data-ttu-id="45033-112">В этом разделе описаны изменения в компонентах System.Net для добавления расширенной защиты при использовании встроенной проверки подлинности Windows в этих компонентах.</span><span class="sxs-lookup"><span data-stu-id="45033-112">This section describes changes to System.Net components to add extended protection in their use of integrated Windows authentication.</span></span>

## <a name="changes"></a><span data-ttu-id="45033-113">Изменения</span><span class="sxs-lookup"><span data-stu-id="45033-113">Changes</span></span>

<span data-ttu-id="45033-114">Процесс проверки подлинности NTLM, используемый со встроенной проверкой подлинности Windows, включает в себя запрос, который выдается конечным компьютером и отправляется обратно на клиентский компьютер.</span><span class="sxs-lookup"><span data-stu-id="45033-114">The NTLM authentication process used with integrated Windows authentication includes a challenge issued by the destination computer and sent back to the client computer.</span></span> <span data-ttu-id="45033-115">Когда компьютер получает созданный им самим запрос, проверку подлинности пройти не удается, если только подключение не замыкается на себя (например, как в случае с IPv4-адресом 127.0.0.1).</span><span class="sxs-lookup"><span data-stu-id="45033-115">When a computer receives a challenge it generated itself, the authentication will fail unless the connection is a loop back connection (IPv4 address 127.0.0.1, for example).</span></span>

<span data-ttu-id="45033-116">Доступ к службе, работающей на внутреннем веб-сервере, часто осуществляется по URL-адресу, похожему на `http://contoso/service` или `https://contoso/service`.</span><span class="sxs-lookup"><span data-stu-id="45033-116">When accessing a service running on an internal Web server, it is common to access the service using a URL similar to `http://contoso/service` or `https://contoso/service`.</span></span> <span data-ttu-id="45033-117">Здесь contoso часто не является именем компьютера, на котором развернута служба.</span><span class="sxs-lookup"><span data-stu-id="45033-117">The name "contoso" is often not the computer name of the computer on which the service is deployed.</span></span> <span data-ttu-id="45033-118"><xref:System.Net> и связанные пространства имен поддерживают использование Active Directory, DNS, NetBIOS, файла hosts локального компьютера (например, WINDOWS\system32\drivers\etc\hosts) или файла lmhosts локального компьютера (например, WINDOWS\system32\drivers\etc\lmhosts) для разрешения имен в адреса.</span><span class="sxs-lookup"><span data-stu-id="45033-118">The <xref:System.Net> and related namespaces support using Active Directory, DNS, NetBIOS, the local computer's hosts file (typically WINDOWS\system32\drivers\etc\hosts, for example), or the local computer's lmhosts file (typically WINDOWS\system32\drivers\etc\lmhosts, for example) to resolve names to addresses.</span></span> <span data-ttu-id="45033-119">Имя contoso разрешается так, что адресуемые на него запросы отправляются на соответствующий сервер.</span><span class="sxs-lookup"><span data-stu-id="45033-119">The name "contoso" is resolved so that requests sent to "contoso" are sent to the appropriate server computer.</span></span>

<span data-ttu-id="45033-120">При настройке больших развертываний также часто бывает так, что одно имя виртуального сервера присваивается всему развертыванию, а имена входящих в него компьютеров никогда не используются клиентскими приложениями и пользователями.</span><span class="sxs-lookup"><span data-stu-id="45033-120">When configured for large deployments, it is also common for a single virtual server name to be given to the deployment with the underlying machine names never used by client applications and end users.</span></span> <span data-ttu-id="45033-121">Например, можно вызвать сервер `www.contoso.com`, но во внутренней сети достаточно указать просто contoso.</span><span class="sxs-lookup"><span data-stu-id="45033-121">For example, you might call the server `www.contoso.com`, but on an internal network simply use "contoso".</span></span> <span data-ttu-id="45033-122">Это имя называется заголовком узла в веб-запросе клиента.</span><span class="sxs-lookup"><span data-stu-id="45033-122">This name is called the Host header in the client web request.</span></span> <span data-ttu-id="45033-123">Согласно спецификации протокола HTTP в поле заголовка узла в запросе указываются узел в Интернете и номер порта запрашиваемого ресурса.</span><span class="sxs-lookup"><span data-stu-id="45033-123">As specified by the HTTP protocol, the Host request-header field specifies the Internet host and port number of the resource being requested.</span></span> <span data-ttu-id="45033-124">Эти сведения берутся из исходного универсального кода ресурса (URI), предоставленного пользователем или ссылающимся ресурсом (как правило, это URL-адрес HTTP).</span><span class="sxs-lookup"><span data-stu-id="45033-124">This information is obtained from the original URI given by the user or referring resource (generally an HTTP URL).</span></span> <span data-ttu-id="45033-125">В .NET Framework версии 4 эти сведения также могут быть заданы клиентом с помощью нового свойства <xref:System.Net.HttpWebRequest.Host%2A>.</span><span class="sxs-lookup"><span data-stu-id="45033-125">On .NET Framework version 4, this information can also be set by the client using the new <xref:System.Net.HttpWebRequest.Host%2A> property.</span></span>

<span data-ttu-id="45033-126">Класс <xref:System.Net.AuthenticationManager> контролирует управляемые компоненты (модули) проверки подлинности, которые используются производными классами <xref:System.Net.WebRequest> и классом <xref:System.Net.WebClient>.</span><span class="sxs-lookup"><span data-stu-id="45033-126">The <xref:System.Net.AuthenticationManager> class controls the managed authentication components ("modules") that are used by <xref:System.Net.WebRequest> derivative classes and the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="45033-127">Класс <xref:System.Net.AuthenticationManager> предоставляет свойство, обеспечивающее доступ к объекту <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>, который индексируется по строке URI. С его помощью приложения указывают пользовательскую строку с именем субъекта-службы, которая должна использоваться во время проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="45033-127">The <xref:System.Net.AuthenticationManager> class provides a property that exposes a <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType> object, indexed by URI string, for applications to supply a custom SPN string to be used during authentication.</span></span>

<span data-ttu-id="45033-128">Если свойство <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> не задано, то при обмене данными для проверки подлинности NTLM в версии 3.5 с пакетом обновления  1 (SP1) в качестве имени субъекта-службы по умолчанию указывается имя узла, используемое в URL-адресе запроса.</span><span class="sxs-lookup"><span data-stu-id="45033-128">Version 3.5 SP1 now defaults to specifying the host name used in the request URL in the SPN in the NTLM (NT LAN Manager) authentication exchange when the <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> property is not set.</span></span> <span data-ttu-id="45033-129">Имя узла, используемое в URL-адресе запроса, может отличаться от заголовка узла, указанного в <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> в запросе клиента.</span><span class="sxs-lookup"><span data-stu-id="45033-129">The host name used in the request URL may be different from the Host header specified in the <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> in the client request.</span></span> <span data-ttu-id="45033-130">Кроме того, оно может отличаться от фактического имени узла сервера, имени компьютера сервера, IP-адреса компьютера или петлевого адреса.</span><span class="sxs-lookup"><span data-stu-id="45033-130">The host name used in the request URL may be different from the actual host name of the server, the machine name of the server, the computer's IP address, or the loopback address.</span></span> <span data-ttu-id="45033-131">В таких случаях Windows отклонит запрос проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="45033-131">In these cases, Windows will fail the authentication request.</span></span> <span data-ttu-id="45033-132">Для решения этой проблемы необходимо уведомить Windows о том, что имя узла, используемое в URL-адресе запроса клиента (например, contoso), на самом деле является альтернативным именем локального компьютера.</span><span class="sxs-lookup"><span data-stu-id="45033-132">To address the issue, we need to notify Windows that the host name used in the request URL in the client request ("contoso", for example) is actually an alternate name for the local computer.</span></span>

<span data-ttu-id="45033-133">Адаптировать серверное приложение к этому изменению можно несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="45033-133">There are several possible methods for a server application to work around this change.</span></span> <span data-ttu-id="45033-134">Рекомендуемый подход заключается в сопоставлении имени узла, используемого в URL-адресе запроса, с разделом реестра `BackConnectionHostNames` на сервере.</span><span class="sxs-lookup"><span data-stu-id="45033-134">The recommended approach is to map the host name used in the request URL to the `BackConnectionHostNames` key in the registry on the server.</span></span> <span data-ttu-id="45033-135">Раздел реестра `BackConnectionHostNames`, как правило, служит для сопоставления имени узла с петлевым адресом.</span><span class="sxs-lookup"><span data-stu-id="45033-135">The `BackConnectionHostNames` registry key is normally used to map a host name to a loopback address.</span></span> <span data-ttu-id="45033-136">Необходимые действия описаны ниже.</span><span class="sxs-lookup"><span data-stu-id="45033-136">The steps are listed below.</span></span>

<span data-ttu-id="45033-137">Чтобы указать имена узлов, которые сопоставлены с петлевым адресом и с которых возможно подключение к веб-сайтам на локальном компьютере, выполните указанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="45033-137">To specify the host names that are mapped to the loopback address and can connect to Web sites on a local computer, follow these steps:</span></span>

1. <span data-ttu-id="45033-138">Нажмите кнопку "Пуск", щелкните "Выполнить", введите команду "regedit" и нажмите кнопку "ОК".</span><span class="sxs-lookup"><span data-stu-id="45033-138">Click Start, click Run, type regedit, and then click OK.</span></span>

2. <span data-ttu-id="45033-139">В редакторе реестра найдите следующий раздел реестра и выберите его:</span><span class="sxs-lookup"><span data-stu-id="45033-139">In Registry Editor, locate and then click the following registry key:</span></span>

    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0`

3. <span data-ttu-id="45033-140">Щелкните раздел MSV1_0 правой кнопкой мыши, наведите указатель на пункт "Создать" и выберите пункт "Мультистроковый параметр".</span><span class="sxs-lookup"><span data-stu-id="45033-140">Right-click MSV1_0, point to New, and then click Multi-String Value.</span></span>

4. <span data-ttu-id="45033-141">Введите `BackConnectionHostNames` и нажмите клавишу ВВОД.</span><span class="sxs-lookup"><span data-stu-id="45033-141">Type `BackConnectionHostNames`, and then press ENTER.</span></span>

5. <span data-ttu-id="45033-142">Щелкните параметр `BackConnectionHostNames` правой кнопкой мыши и выберите пункт "Изменить".</span><span class="sxs-lookup"><span data-stu-id="45033-142">Right-click `BackConnectionHostNames`, and then click Modify.</span></span>

6. <span data-ttu-id="45033-143">В поле "Значение" введите одно или несколько имен узлов для сайтов, размещенных на локальном компьютере (то есть имена узлов, используемых в URL-адресе запроса), и нажмите кнопку "ОК".</span><span class="sxs-lookup"><span data-stu-id="45033-143">In the Value data box, type the host name or the host names for the sites (the host name used in the request URL) that are on the local computer, and then click OK.</span></span>

7. <span data-ttu-id="45033-144">Закройте редактор реестра, перезапустите службу IISAdmin и выполните команду IISReset.</span><span class="sxs-lookup"><span data-stu-id="45033-144">Quit Registry Editor, and then restart the IISAdmin service and run IISReset.</span></span>

<span data-ttu-id="45033-145">Менее безопасный способ — отключить проверку замыкания на себя, как описано на странице <https://support.microsoft.com/kb/896861>.</span><span class="sxs-lookup"><span data-stu-id="45033-145">A less secure work around is to disable the loop back check, as described in <https://support.microsoft.com/kb/896861>.</span></span> <span data-ttu-id="45033-146">При этом отключается защита от атак отражением.</span><span class="sxs-lookup"><span data-stu-id="45033-146">This disables the protection against reflection attacks.</span></span> <span data-ttu-id="45033-147">Поэтому лучше ограничить набор альтернативных имен только теми, которые действительно будут использоваться компьютером.</span><span class="sxs-lookup"><span data-stu-id="45033-147">So it is better to constrain the set of alternate names to only those you expect the machine to actually use.</span></span>

## <a name="see-also"></a><span data-ttu-id="45033-148">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="45033-148">See also</span></span>

- <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>
- <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>
- <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>
