---
title: Изменения в аутентификации NTLM для HttpWebRequest в версии 3.5 с пакетом обновления 1 (SP1)
ms.date: 03/30/2017
ms.assetid: 8bf0b428-5a21-4299-8d6e-bf8251fd978a
ms.openlocfilehash: 388e6dc648e1fd68e24a852cb08de107f09f9c9f
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2020
ms.locfileid: "64754875"
---
# <a name="changes-to-ntlm-authentication-for-httpwebrequest-in-version-35-sp1"></a>Изменения в аутентификации NTLM для HttpWebRequest в версии 3.5 с пакетом обновления 1 (SP1)

В .NET Framework версии 3.5 с пакетом обновления 1 (SP1) и более поздних внесены касающиеся безопасности изменения, влияющие на обработку встроенной проверки подлинности Windows классами <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Security.NegotiateStream> и связанными классами в пространстве имен System.Net. Эти изменения могут влиять на приложения, которые используют данные классы для выполнения веб-запросов и получения ответов с применением встроенной проверки подлинности Windows на основе NTLM. Они также могут повлиять на веб-серверы и клиентские приложения, в которых используется встроенная проверка подлинности Windows.

## <a name="overview"></a>Обзор

Структура встроенной проверки подлинности Windows позволяет формировать универсальные ответы на некоторые запросы учетных данных. Это означает, что эти ответы можно использовать повторно или перенаправлять. Если эта функция не нужна, то протоколы проверки подлинности должны передавать сведения, относящиеся к целевому объекту и каналу. Кроме того, службы могут предоставлять расширенную защиту, чтобы в ответах на запросы учетных данных также содержались сведения о службе, например имя субъекта-службы. С включением этих сведений в ответы на запросы учетных данных службы могут обеспечить лучшую защиту при изменении ответов злоумышленниками.

Несколько компонентов в пространствах имен <xref:System.Net> и <xref:System.Net.Security> выполняют встроенную проверку подлинности Windows от имени вызывающего приложения. В этом разделе описаны изменения в компонентах System.Net для добавления расширенной защиты при использовании встроенной проверки подлинности Windows в этих компонентах.

## <a name="changes"></a>Изменения

Процесс проверки подлинности NTLM, используемый со встроенной проверкой подлинности Windows, включает в себя запрос, который выдается конечным компьютером и отправляется обратно на клиентский компьютер. Когда компьютер получает созданный им самим запрос, проверку подлинности пройти не удается, если только подключение не замыкается на себя (например, как в случае с IPv4-адресом 127.0.0.1).

Доступ к службе, работающей на внутреннем веб-сервере, часто осуществляется по URL-адресу, похожему на `http://contoso/service` или `https://contoso/service`. Здесь contoso часто не является именем компьютера, на котором развернута служба. <xref:System.Net> и связанные пространства имен поддерживают использование Active Directory, DNS, NetBIOS, файла hosts локального компьютера (например, WINDOWS\system32\drivers\etc\hosts) или файла lmhosts локального компьютера (например, WINDOWS\system32\drivers\etc\lmhosts) для разрешения имен в адреса. Имя contoso разрешается так, что адресуемые на него запросы отправляются на соответствующий сервер.

При настройке больших развертываний также часто бывает так, что одно имя виртуального сервера присваивается всему развертыванию, а имена входящих в него компьютеров никогда не используются клиентскими приложениями и пользователями. Например, можно вызвать сервер `www.contoso.com`, но во внутренней сети достаточно указать просто contoso. Это имя называется заголовком узла в веб-запросе клиента. Согласно спецификации протокола HTTP в поле заголовка узла в запросе указываются узел в Интернете и номер порта запрашиваемого ресурса. Эти сведения берутся из исходного универсального кода ресурса (URI), предоставленного пользователем или ссылающимся ресурсом (как правило, это URL-адрес HTTP). В .NET Framework версии 4 эти сведения также могут быть заданы клиентом с помощью нового свойства <xref:System.Net.HttpWebRequest.Host%2A>.

Класс <xref:System.Net.AuthenticationManager> контролирует управляемые компоненты (модули) проверки подлинности, которые используются производными классами <xref:System.Net.WebRequest> и классом <xref:System.Net.WebClient>. Класс <xref:System.Net.AuthenticationManager> предоставляет свойство, обеспечивающее доступ к объекту <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>, который индексируется по строке URI. С его помощью приложения указывают пользовательскую строку с именем субъекта-службы, которая должна использоваться во время проверки подлинности.

Если свойство <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A> не задано, то при обмене данными для проверки подлинности NTLM в версии 3.5 с пакетом обновления  1 (SP1) в качестве имени субъекта-службы по умолчанию указывается имя узла, используемое в URL-адресе запроса. Имя узла, используемое в URL-адресе запроса, может отличаться от заголовка узла, указанного в <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType> в запросе клиента. Кроме того, оно может отличаться от фактического имени узла сервера, имени компьютера сервера, IP-адреса компьютера или петлевого адреса. В таких случаях Windows отклонит запрос проверки подлинности. Для решения этой проблемы необходимо уведомить Windows о том, что имя узла, используемое в URL-адресе запроса клиента (например, contoso), на самом деле является альтернативным именем локального компьютера.

Адаптировать серверное приложение к этому изменению можно несколькими способами. Рекомендуемый подход заключается в сопоставлении имени узла, используемого в URL-адресе запроса, с разделом реестра `BackConnectionHostNames` на сервере. Раздел реестра `BackConnectionHostNames`, как правило, служит для сопоставления имени узла с петлевым адресом. Необходимые действия описаны ниже.

Чтобы указать имена узлов, которые сопоставлены с петлевым адресом и с которых возможно подключение к веб-сайтам на локальном компьютере, выполните указанные ниже действия.

1. Нажмите кнопку "Пуск", щелкните "Выполнить", введите команду "regedit" и нажмите кнопку "ОК".

2. В редакторе реестра найдите следующий раздел реестра и выберите его:

    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0`

3. Щелкните раздел MSV1_0 правой кнопкой мыши, наведите указатель на пункт "Создать" и выберите пункт "Мультистроковый параметр".

4. Введите `BackConnectionHostNames` и нажмите клавишу ВВОД.

5. Щелкните параметр `BackConnectionHostNames` правой кнопкой мыши и выберите пункт "Изменить".

6. В поле "Значение" введите одно или несколько имен узлов для сайтов, размещенных на локальном компьютере (то есть имена узлов, используемых в URL-адресе запроса), и нажмите кнопку "ОК".

7. Закройте редактор реестра, перезапустите службу IISAdmin и выполните команду IISReset.

Менее безопасный способ — отключить проверку замыкания на себя, как описано на странице <https://support.microsoft.com/kb/896861>. При этом отключается защита от атак отражением. Поэтому лучше ограничить набор альтернативных имен только теми, которые действительно будут использоваться компьютером.

## <a name="see-also"></a>См. также раздел

- <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A?displayProperty=nameWithType>
- <xref:System.Net.HttpRequestHeader?displayProperty=nameWithType>
- <xref:System.Net.HttpWebRequest.Host%2A?displayProperty=nameWithType>
