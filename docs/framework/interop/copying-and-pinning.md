---
title: Копирование и закрепление
ms.date: 03/30/2017
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
ms.openlocfilehash: f6db7d37293015911c1285d39e19bf7542a7ac59
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73123645"
---
# <a name="copying-and-pinning"></a><span data-ttu-id="3442e-102">Копирование и закрепление</span><span class="sxs-lookup"><span data-stu-id="3442e-102">Copying and Pinning</span></span>

<span data-ttu-id="3442e-103">При маршалировании данных маршалер может копировать или закреплять включаемые в процесс данные.</span><span class="sxs-lookup"><span data-stu-id="3442e-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="3442e-104">В ходе этого процесса копия данных переносится из одного расположения в памяти в другое.</span><span class="sxs-lookup"><span data-stu-id="3442e-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="3442e-105">На следующем рисунке показаны различия между копированием типа значения и типа, передаваемого по ссылке, из управляемой памяти в неуправляемую.</span><span class="sxs-lookup"><span data-stu-id="3442e-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>

![Схема, на которой показано, как копируются тип значения и ссылочный тип.](./media/copying-and-pinning/interop-marshal-copy.gif)

<span data-ttu-id="3442e-107">Аргументы метода, передаваемые по значению, маршалируются в неуправляемый код как значения в стеке.</span><span class="sxs-lookup"><span data-stu-id="3442e-107">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="3442e-108">Процесс копирования является прямым.</span><span class="sxs-lookup"><span data-stu-id="3442e-108">The copying process is direct.</span></span> <span data-ttu-id="3442e-109">Аргументы, передаваемые по ссылке, передаются как указатели на стек.</span><span class="sxs-lookup"><span data-stu-id="3442e-109">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="3442e-110">Ссылочные типы также могут передаваться по значению и по ссылке.</span><span class="sxs-lookup"><span data-stu-id="3442e-110">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="3442e-111">Как показано на следующем рисунке, ссылочные типы, передаваемые по значению, либо копируются, либо закрепляются.</span><span class="sxs-lookup"><span data-stu-id="3442e-111">As the following illustration shows, reference types passed by value are either copied or pinned:</span></span>

![Схема, на которой показаны ссылочные типы, передаваемые по значению и по ссылке.](./media/copying-and-pinning/interop-marshal-reference-pin.gif)

<span data-ttu-id="3442e-113">При закреплении данные временно блокируются в текущем положении в памяти, в результате чего исключается их перемещение стандартным сборщиком мусора общеязыковой среды выполнения.</span><span class="sxs-lookup"><span data-stu-id="3442e-113">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="3442e-114">Маршалер закрепляет данные, чтобы сократить затраты ресурсов на копирование и повысить производительность.</span><span class="sxs-lookup"><span data-stu-id="3442e-114">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="3442e-115">Копирование или закрепление данных в рамках процесса маршалинга осуществляется в зависимости от типа этих данных.</span><span class="sxs-lookup"><span data-stu-id="3442e-115">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="3442e-116">Закрепление автоматически выполняется во время маршалинга для таких объектов, как <xref:System.String>. Также их можно закрепить вручную с использованием класса <xref:System.Runtime.InteropServices.GCHandle>.</span><span class="sxs-lookup"><span data-stu-id="3442e-116">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>

## <a name="formatted-blittable-classes"></a><span data-ttu-id="3442e-117">Форматированные непреобразуемые классы</span><span class="sxs-lookup"><span data-stu-id="3442e-117">Formatted Blittable Classes</span></span>

<span data-ttu-id="3442e-118">Форматированные [непреобразуемые](blittable-and-non-blittable-types.md) классы имеют фиксированную структуру (форматирование) и общее представление данных как в управляемой, так и в неуправляемой памяти.</span><span class="sxs-lookup"><span data-stu-id="3442e-118">Formatted [blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="3442e-119">Если требуется выполнить маршалинг таких типов, вызываемому объекту напрямую передается указатель на объект в куче.</span><span class="sxs-lookup"><span data-stu-id="3442e-119">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="3442e-120">Вызываемый объект может изменять содержимое в расположении в памяти, на которое ссылается указатель.</span><span class="sxs-lookup"><span data-stu-id="3442e-120">The callee can change the contents of the memory location being referenced by the pointer.</span></span>

> [!NOTE]
> <span data-ttu-id="3442e-121">Вызываемый объект может изменить содержимое памяти, если параметр помечен как out или in/out. В отличие от этого вызываемый объект должен избегать изменения содержимого, если параметру присвоено значение Marshal, как в, что является значением по умолчанию для отформатированных непреобразуемых типов.</span><span class="sxs-lookup"><span data-stu-id="3442e-121">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="3442e-122">Если объект ввода изменяется, это может привести к проблемам при экспорте того же класса в библиотеку типов и его использовании для выполнения вызовов между подразделениями.</span><span class="sxs-lookup"><span data-stu-id="3442e-122">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>

## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="3442e-123">Форматированные преобразуемые классы</span><span class="sxs-lookup"><span data-stu-id="3442e-123">Formatted Non-Blittable Classes</span></span>

<span data-ttu-id="3442e-124">Форматированные [преобразуемые](blittable-and-non-blittable-types.md) классы имеют фиксированную структуру (форматирование), но разное представление данных в управляемой и неуправляемой памяти.</span><span class="sxs-lookup"><span data-stu-id="3442e-124">Formatted [non-blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="3442e-125">В следующих ситуациях может потребоваться преобразование данных:</span><span class="sxs-lookup"><span data-stu-id="3442e-125">The data can require transformation under the following conditions:</span></span>

- <span data-ttu-id="3442e-126">Если преобразуемый класс маршалируется по значению, вызываемый объект получает указатель на копию структуры данных.</span><span class="sxs-lookup"><span data-stu-id="3442e-126">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="3442e-127">Если преобразуемый класс маршалируется по ссылке, вызываемый объект получает указатель на указатель на копию структуры данных.</span><span class="sxs-lookup"><span data-stu-id="3442e-127">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="3442e-128">Если установлен атрибут <xref:System.Runtime.InteropServices.InAttribute>, для инициализации этой копии всегда используется состояние экземпляра и при необходимости выполняется маршалинг.</span><span class="sxs-lookup"><span data-stu-id="3442e-128">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>

- <span data-ttu-id="3442e-129">Если установлен атрибут <xref:System.Runtime.InteropServices.OutAttribute>, состояние всегда копируется обратно в экземпляр при возврате и при необходимости выполняется маршалинг.</span><span class="sxs-lookup"><span data-stu-id="3442e-129">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>

- <span data-ttu-id="3442e-130">Если установлены одновременно атрибуты **InAttribute** и **OutAttribute**, обе операции копирования выполняются обязательно.</span><span class="sxs-lookup"><span data-stu-id="3442e-130">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="3442e-131">Если один из атрибутов опущен, в целях оптимизации маршалер может исключить другую операцию копирования.</span><span class="sxs-lookup"><span data-stu-id="3442e-131">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>

## <a name="reference-types"></a><span data-ttu-id="3442e-132">Ссылочные типы</span><span class="sxs-lookup"><span data-stu-id="3442e-132">Reference Types</span></span>

<span data-ttu-id="3442e-133">Ссылочные типы могут передаваться по значению или по ссылке.</span><span class="sxs-lookup"><span data-stu-id="3442e-133">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="3442e-134">При передаче по значению в стек передается указатель на тип.</span><span class="sxs-lookup"><span data-stu-id="3442e-134">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="3442e-135">При передаче по ссылке в стек передается указатель на указатель на тип.</span><span class="sxs-lookup"><span data-stu-id="3442e-135">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>

<span data-ttu-id="3442e-136">Ссылочные типы имеют следующие условные характеристики:</span><span class="sxs-lookup"><span data-stu-id="3442e-136">Reference types have the following conditional behavior:</span></span>

- <span data-ttu-id="3442e-137">Если ссылочный тип передается по значению и содержит члены преобразуемых типов, типы преобразуются дважды:</span><span class="sxs-lookup"><span data-stu-id="3442e-137">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>

  - <span data-ttu-id="3442e-138">Когда аргумент передается в неуправляемый код.</span><span class="sxs-lookup"><span data-stu-id="3442e-138">When an argument is passed to the unmanaged side.</span></span>

  - <span data-ttu-id="3442e-139">При возврате из вызова.</span><span class="sxs-lookup"><span data-stu-id="3442e-139">On return from the call.</span></span>

  <span data-ttu-id="3442e-140">Чтобы исключить лишние операции копирования и преобразования, эти типы маршалируются как параметры ввода.</span><span class="sxs-lookup"><span data-stu-id="3442e-140">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="3442e-141">Чтобы вызывающий объект мог видеть изменения, выполненные вызывающим объектом, необходимо явно применить атрибуты **InAttribute** и **OutAttribute** к аргументу.</span><span class="sxs-lookup"><span data-stu-id="3442e-141">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>

- <span data-ttu-id="3442e-142">Если ссылочный тип передается по значению и содержит только члены непреобразуемых типов, он может быть закреплен в процессе маршалирования, а любые изменения членов типа, выполненные вызываемым объектом, будут видны вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="3442e-142">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="3442e-143">Чтобы реализовать такое поведение, явно примените атрибуты **InAttribute** и **OutAttribute**.</span><span class="sxs-lookup"><span data-stu-id="3442e-143">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="3442e-144">Без этих атрибутов направления маршалер взаимодействия не экспортирует информацию о направлении в библиотеку типов (экспортируется как параметр ввода, то есть реализуется поведение по умолчанию), что может вызвать проблемы с маршалингом COM между подразделениями.</span><span class="sxs-lookup"><span data-stu-id="3442e-144">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>

- <span data-ttu-id="3442e-145">Если ссылочный тип передается по ссылке, он будет по умолчанию маршалироваться как параметр ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="3442e-145">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>

## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="3442e-146">System.String и System.Text.StringBuilder</span><span class="sxs-lookup"><span data-stu-id="3442e-146">System.String and System.Text.StringBuilder</span></span>

<span data-ttu-id="3442e-147">При маршалинге данных в неуправляемый код по значению или по ссылке маршалер обычно копирует данные во вторичный буфер (в процессе копирования может выполняться преобразование кодировки) и передает вызываемому объекту ссылку на буфер.</span><span class="sxs-lookup"><span data-stu-id="3442e-147">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="3442e-148">Если ссылка не является объектом **BSTR** (для выделения используется **SysAllocString**), выделение памяти всегда осуществляется с помощью **CoTaskMemAlloc**.</span><span class="sxs-lookup"><span data-stu-id="3442e-148">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>

<span data-ttu-id="3442e-149">В целях оптимизации при маршалинге строк любого типа по значению (например, строка символов Юникода) маршалер передает вызываемому объекту прямой указатель на управляемые строки во внутреннем буфере Юникода вместо копирования в новый буфер.</span><span class="sxs-lookup"><span data-stu-id="3442e-149">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>

> [!CAUTION]
> <span data-ttu-id="3442e-150">Если строка передается по значению, вызываемый объект не должен изменять ссылку, передаваемую маршалером.</span><span class="sxs-lookup"><span data-stu-id="3442e-150">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="3442e-151">Это может привести к повреждению управляемой кучи.</span><span class="sxs-lookup"><span data-stu-id="3442e-151">Doing so can corrupt the managed heap.</span></span>

<span data-ttu-id="3442e-152">Если <xref:System.String?displayProperty=nameWithType> передается по ссылке, маршалер копирует содержимое строки во вторичный буфер, прежде чем выполнять вызов.</span><span class="sxs-lookup"><span data-stu-id="3442e-152">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="3442e-153">После этого содержимое буфера копируется в новую строку при возврате из вызова.</span><span class="sxs-lookup"><span data-stu-id="3442e-153">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="3442e-154">Такой подход гарантирует, что неизменяемая управляемая строка останется без изменений.</span><span class="sxs-lookup"><span data-stu-id="3442e-154">This technique ensures that the immutable managed string remains unaltered.</span></span>

<span data-ttu-id="3442e-155">Если <xref:System.Text.StringBuilder?displayProperty=nameWithType> передается по значению, маршалер передает ссылку на внутренний буфер **StringBuilder** напрямую вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="3442e-155">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="3442e-156">Вызывающий и вызываемый объекты должны согласовывать размер буфера.</span><span class="sxs-lookup"><span data-stu-id="3442e-156">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="3442e-157">Вызывающий объект отвечает за создание буфера **StringBuilder** соответствующей длины.</span><span class="sxs-lookup"><span data-stu-id="3442e-157">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="3442e-158">Вызываемый объект должен принимать необходимые меры предосторожности, чтобы предотвратить переполнение буфера.</span><span class="sxs-lookup"><span data-stu-id="3442e-158">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="3442e-159">**StringBuilder** является исключением из правила, согласно которому ссылочные типы, передаваемые по значению, по умолчанию передаются в виде параметра ввода.</span><span class="sxs-lookup"><span data-stu-id="3442e-159">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="3442e-160">Он всегда передается как параметр ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="3442e-160">It is always passed as In/Out.</span></span>

## <a name="see-also"></a><span data-ttu-id="3442e-161">См. также</span><span class="sxs-lookup"><span data-stu-id="3442e-161">See also</span></span>

- [<span data-ttu-id="3442e-162">Характеристики маршалинга по умолчанию</span><span class="sxs-lookup"><span data-stu-id="3442e-162">Default Marshaling Behavior</span></span>](default-marshaling-behavior.md)
- <span data-ttu-id="3442e-163">[Directional Attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100)) (Атрибуты направления)</span><span class="sxs-lookup"><span data-stu-id="3442e-163">[Directional Attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span></span>
- [<span data-ttu-id="3442e-164">Маршалинг взаимодействия</span><span class="sxs-lookup"><span data-stu-id="3442e-164">Interop Marshaling</span></span>](interop-marshaling.md)
