---
title: Пошаговое руководство. Реализация формы, в который выполняется фоновая операция
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
- cpp
helpviewer_keywords:
- threading [Windows Forms], forms
- BackgroundWorker component
- background tasks
- forms [Windows Forms], multithreading
- threading [Windows Forms], walkthroughs
- forms [Windows Forms], background operations
- threading [Windows Forms], background operations
- background operations
ms.assetid: 4691b796-9200-471a-89c3-ba4c7cc78c03
ms.openlocfilehash: 042861b2d79d0b638600a5463673fb922f3b4881
ms.sourcegitcommit: 2b986afe4ce9e13bbeec929c9737757eb61de60e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/22/2019
ms.locfileid: "56664397"
---
# <a name="walkthrough-implementing-a-form-that-uses-a-background-operation"></a><span data-ttu-id="3674f-102">Пошаговое руководство. Реализация формы, в который выполняется фоновая операция</span><span class="sxs-lookup"><span data-stu-id="3674f-102">Walkthrough: Implementing a Form That Uses a Background Operation</span></span>
<span data-ttu-id="3674f-103">Если у вас есть операция будет выполняться долго для завершения, и не требуется пользовательский интерфейс (UI) перестает отвечать на запросы или «зависания», можно использовать <xref:System.ComponentModel.BackgroundWorker> класс для выполнения операции в другом потоке.</span><span class="sxs-lookup"><span data-stu-id="3674f-103">If you have an operation that will take a long time to complete, and you do not want your user interface (UI) to stop responding or "hang," you can use the <xref:System.ComponentModel.BackgroundWorker> class to execute the operation on another thread.</span></span>  
  
 <span data-ttu-id="3674f-104">В этом пошаговом руководстве показано, как использовать <xref:System.ComponentModel.BackgroundWorker> класса для выполнения длительных вычислений «в фоновом режиме», а пользовательский интерфейс продолжает отвечать.</span><span class="sxs-lookup"><span data-stu-id="3674f-104">This walkthrough illustrates how to use the <xref:System.ComponentModel.BackgroundWorker> class to perform time-consuming computations "in the background," while the user interface remains responsive.</span></span>  <span data-ttu-id="3674f-105">По завершении работы будет создано приложение, вычисляющее числа Фибоначчи в асинхронном режиме.</span><span class="sxs-lookup"><span data-stu-id="3674f-105">When you are through, you will have an application that computes Fibonacci numbers asynchronously.</span></span> <span data-ttu-id="3674f-106">Несмотря на то что вычисление крупных чисел Фибоначчи может занимать много времени, основной поток пользовательского интерфейса в результате этой задержки прерываться не будет, а форма в ходе вычисления останется рабочей.</span><span class="sxs-lookup"><span data-stu-id="3674f-106">Even though computing a large Fibonacci number can take a noticeable amount of time, the main UI thread will not be interrupted by this delay, and the form will be responsive during the calculation.</span></span>  
  
 <span data-ttu-id="3674f-107">В данном пошаговом руководстве представлены следующие задачи.</span><span class="sxs-lookup"><span data-stu-id="3674f-107">Tasks illustrated in this walkthrough include:</span></span>  
  
-   <span data-ttu-id="3674f-108">Создание приложения на базе Windows</span><span class="sxs-lookup"><span data-stu-id="3674f-108">Creating a Windows-based Application</span></span>  
  
-   <span data-ttu-id="3674f-109">Создание <xref:System.ComponentModel.BackgroundWorker> в форме</span><span class="sxs-lookup"><span data-stu-id="3674f-109">Creating a <xref:System.ComponentModel.BackgroundWorker> in Your Form</span></span>  
  
-   <span data-ttu-id="3674f-110">Добавление обработчиков асинхронных событий</span><span class="sxs-lookup"><span data-stu-id="3674f-110">Adding Asynchronous Event Handlers</span></span>  
  
-   <span data-ttu-id="3674f-111">Добавление отчетов о ходе выполнения и поддержка отмены</span><span class="sxs-lookup"><span data-stu-id="3674f-111">Adding Progress Reporting and Support for Cancellation</span></span>  
  
 <span data-ttu-id="3674f-112">Полный код, используемый в этом примере, см. в разделе [как: Реализация формы, в который выполняется фоновая операция](../../../../docs/framework/winforms/controls/how-to-implement-a-form-that-uses-a-background-operation.md).</span><span class="sxs-lookup"><span data-stu-id="3674f-112">For a complete listing of the code used in this example, see [How to: Implement a Form That Uses a Background Operation](../../../../docs/framework/winforms/controls/how-to-implement-a-form-that-uses-a-background-operation.md).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="3674f-113">Отображаемые диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от текущих параметров или выпуска.</span><span class="sxs-lookup"><span data-stu-id="3674f-113">The dialog boxes and menu commands you see might differ from those described in Help depending on your active settings or edition.</span></span> <span data-ttu-id="3674f-114">Чтобы изменить параметры, выберите в меню **Сервис** пункт **Импорт и экспорт параметров** .</span><span class="sxs-lookup"><span data-stu-id="3674f-114">To change your settings, choose **Import and Export Settings** on the **Tools** menu.</span></span> <span data-ttu-id="3674f-115">Дополнительные сведения см. в разделе [Персонализация интегрированной среды разработки Visual Studio](/visualstudio/ide/personalizing-the-visual-studio-ide).</span><span class="sxs-lookup"><span data-stu-id="3674f-115">For more information, see [Personalize the Visual Studio IDE](/visualstudio/ide/personalizing-the-visual-studio-ide).</span></span>  
  
## <a name="creating-the-project"></a><span data-ttu-id="3674f-116">Создание проекта</span><span class="sxs-lookup"><span data-stu-id="3674f-116">Creating the Project</span></span>  
 <span data-ttu-id="3674f-117">Первым шагом являются создание проекта и настройка формы.</span><span class="sxs-lookup"><span data-stu-id="3674f-117">The first step is to create the project and to set up the form.</span></span>  
  
#### <a name="to-create-a-form-that-uses-a-background-operation"></a><span data-ttu-id="3674f-118">Создание формы, в которой выполняется фоновая операция</span><span class="sxs-lookup"><span data-stu-id="3674f-118">To create a form that uses a background operation</span></span>  
  
1.  <span data-ttu-id="3674f-119">Создайте проект приложения на основе Windows с именем `BackgroundWorkerExample` (**файл** > **New** > **проекта**  >  **Visual C#** или **Visual Basic** > **классический рабочий стол** > **Windows Forms Application**).</span><span class="sxs-lookup"><span data-stu-id="3674f-119">Create a Windows-based application project called `BackgroundWorkerExample` (**File** > **New** > **Project** > **Visual C#** or **Visual Basic** > **Classic Desktop** > **Windows Forms Application**).</span></span>  
  
2.  <span data-ttu-id="3674f-120">В **обозревателе решений** щелкните правой кнопкой мыши **Form1** и выберите в контекстном меню команду **Переименовать**.</span><span class="sxs-lookup"><span data-stu-id="3674f-120">In **Solution Explorer**, right-click **Form1** and select **Rename** from the shortcut menu.</span></span> <span data-ttu-id="3674f-121">Измените имя файла на `FibonacciCalculator`.</span><span class="sxs-lookup"><span data-stu-id="3674f-121">Change the file name to `FibonacciCalculator`.</span></span> <span data-ttu-id="3674f-122">Чтобы переименовать все ссылки на элемент кода '`Form1`', в соответствующем запросе нажмите кнопку **Да**.</span><span class="sxs-lookup"><span data-stu-id="3674f-122">Click the **Yes** button when you are asked if you want to rename all references to the code element '`Form1`'.</span></span>  
  
3.  <span data-ttu-id="3674f-123">Перетащите <xref:System.Windows.Forms.NumericUpDown> управления из **элементов** на форму.</span><span class="sxs-lookup"><span data-stu-id="3674f-123">Drag a <xref:System.Windows.Forms.NumericUpDown> control from the **Toolbox** onto the form.</span></span> <span data-ttu-id="3674f-124">Задайте <xref:System.Windows.Forms.NumericUpDown.Minimum%2A> свойства `1` и <xref:System.Windows.Forms.NumericUpDown.Maximum%2A> свойства `91`.</span><span class="sxs-lookup"><span data-stu-id="3674f-124">Set the <xref:System.Windows.Forms.NumericUpDown.Minimum%2A> property to `1` and the <xref:System.Windows.Forms.NumericUpDown.Maximum%2A> property to `91`.</span></span>  
  
4.  <span data-ttu-id="3674f-125">Добавьте два <xref:System.Windows.Forms.Button> элементов управления в форму.</span><span class="sxs-lookup"><span data-stu-id="3674f-125">Add two <xref:System.Windows.Forms.Button> controls to the form.</span></span>  
  
5.  <span data-ttu-id="3674f-126">Переименуйте первый <xref:System.Windows.Forms.Button> управления `startAsyncButton` и задайте <xref:System.Windows.Forms.Control.Text%2A> свойства `Start Async`.</span><span class="sxs-lookup"><span data-stu-id="3674f-126">Rename the first <xref:System.Windows.Forms.Button> control `startAsyncButton` and set the <xref:System.Windows.Forms.Control.Text%2A> property to `Start Async`.</span></span> <span data-ttu-id="3674f-127">Переименуйте второй <xref:System.Windows.Forms.Button> управления `cancelAsyncButton`и задайте <xref:System.Windows.Forms.Control.Text%2A> свойства `Cancel Async`.</span><span class="sxs-lookup"><span data-stu-id="3674f-127">Rename the second <xref:System.Windows.Forms.Button> control `cancelAsyncButton`, and set the <xref:System.Windows.Forms.Control.Text%2A> property to `Cancel Async`.</span></span> <span data-ttu-id="3674f-128">Задайте его <xref:System.Windows.Forms.Control.Enabled%2A> свойства `false`.</span><span class="sxs-lookup"><span data-stu-id="3674f-128">Set its <xref:System.Windows.Forms.Control.Enabled%2A> property to `false`.</span></span>  
  
6.  <span data-ttu-id="3674f-129">Создайте обработчик событий для обоих <xref:System.Windows.Forms.Button> элементов управления <xref:System.Windows.Forms.Control.Click> события.</span><span class="sxs-lookup"><span data-stu-id="3674f-129">Create an event handler for both of the <xref:System.Windows.Forms.Button> controls' <xref:System.Windows.Forms.Control.Click> events.</span></span> <span data-ttu-id="3674f-130">Подробную информацию см. в разделе [Практическое руководство. Создание обработчиков событий с помощью конструктора](https://docs.microsoft.com/previous-versions/visualstudio/visual-studio-2010/zwwsdtbk(v=vs.100)).</span><span class="sxs-lookup"><span data-stu-id="3674f-130">For details, see [How to: Create Event Handlers Using the Designer](https://docs.microsoft.com/previous-versions/visualstudio/visual-studio-2010/zwwsdtbk(v=vs.100)).</span></span>  
  
7.  <span data-ttu-id="3674f-131">Перетащите <xref:System.Windows.Forms.Label> управления из **элементов** на форму и переименуйте его `resultLabel`.</span><span class="sxs-lookup"><span data-stu-id="3674f-131">Drag a <xref:System.Windows.Forms.Label> control from the **Toolbox** onto the form and rename it `resultLabel`.</span></span>  
  
8.  <span data-ttu-id="3674f-132">Перетащите <xref:System.Windows.Forms.ProgressBar> управления из **элементов** на форму.</span><span class="sxs-lookup"><span data-stu-id="3674f-132">Drag a <xref:System.Windows.Forms.ProgressBar> control from the **Toolbox** onto the form.</span></span>  
  
## <a name="creating-a-backgroundworker-in-your-form"></a><span data-ttu-id="3674f-133">Создание BackgroundWorker в форме</span><span class="sxs-lookup"><span data-stu-id="3674f-133">Creating a BackgroundWorker in Your Form</span></span>  
 <span data-ttu-id="3674f-134">Можно создать <xref:System.ComponentModel.BackgroundWorker> для асинхронной операции с помощью **Windows** **конструктора**.</span><span class="sxs-lookup"><span data-stu-id="3674f-134">You can create the <xref:System.ComponentModel.BackgroundWorker> for your asynchronous operation using the **Windows** **Forms Designer**.</span></span>  
  
#### <a name="to-create-a-backgroundworker-with-the-designer"></a><span data-ttu-id="3674f-135">Создание BackgroundWorker с помощью конструктора</span><span class="sxs-lookup"><span data-stu-id="3674f-135">To create a BackgroundWorker with the Designer</span></span>  
  
-   <span data-ttu-id="3674f-136">Из **компоненты** вкладке **элементов**, перетащите <xref:System.ComponentModel.BackgroundWorker> на форму.</span><span class="sxs-lookup"><span data-stu-id="3674f-136">From the **Components** tab of the **Toolbox**, drag a <xref:System.ComponentModel.BackgroundWorker> onto the form.</span></span>  
  
## <a name="adding-asynchronous-event-handlers"></a><span data-ttu-id="3674f-137">Добавление обработчиков асинхронных событий</span><span class="sxs-lookup"><span data-stu-id="3674f-137">Adding Asynchronous Event Handlers</span></span>  
 <span data-ttu-id="3674f-138">Теперь вы готовы добавить обработчики событий для <xref:System.ComponentModel.BackgroundWorker> асинхронных событий компонента.</span><span class="sxs-lookup"><span data-stu-id="3674f-138">You are now ready to add event handlers for the <xref:System.ComponentModel.BackgroundWorker> component's asynchronous events.</span></span> <span data-ttu-id="3674f-139">Один из этих обработчиков вызывает длительную операцию, вычисляющую числа Фибоначчи в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="3674f-139">The time-consuming operation that will run in the background, which computes Fibonacci numbers, is called by one of these event handlers.</span></span>  
  
#### <a name="to-implement-asynchronous-event-handlers"></a><span data-ttu-id="3674f-140">Реализация обработчиков асинхронных событий</span><span class="sxs-lookup"><span data-stu-id="3674f-140">To implement asynchronous event handlers</span></span>  
  
1.  <span data-ttu-id="3674f-141">В **свойства** окне с <xref:System.ComponentModel.BackgroundWorker> компонент все еще выбран, щелкните **события** кнопки.</span><span class="sxs-lookup"><span data-stu-id="3674f-141">In the **Properties** window, with the <xref:System.ComponentModel.BackgroundWorker> component still selected, click the **Events** button.</span></span> <span data-ttu-id="3674f-142">Дважды щелкните <xref:System.ComponentModel.BackgroundWorker.DoWork> и <xref:System.ComponentModel.BackgroundWorker.RunWorkerCompleted> событий, чтобы создать обработчики событий.</span><span class="sxs-lookup"><span data-stu-id="3674f-142">Double-click the <xref:System.ComponentModel.BackgroundWorker.DoWork> and <xref:System.ComponentModel.BackgroundWorker.RunWorkerCompleted> events to create event handlers.</span></span> <span data-ttu-id="3674f-143">Дополнительные сведения об использовании обработчиков событий см. в разделе [как: Создание обработчиков событий с помощью конструктора](https://docs.microsoft.com/previous-versions/visualstudio/visual-studio-2010/zwwsdtbk(v=vs.100)).</span><span class="sxs-lookup"><span data-stu-id="3674f-143">For more information about how to use event handlers, see [How to: Create Event Handlers Using the Designer](https://docs.microsoft.com/previous-versions/visualstudio/visual-studio-2010/zwwsdtbk(v=vs.100)).</span></span>  
  
2.  <span data-ttu-id="3674f-144">Создайте в форме новый метод с именем `ComputeFibonacci`.</span><span class="sxs-lookup"><span data-stu-id="3674f-144">Create a new method, called `ComputeFibonacci`, in your form.</span></span> <span data-ttu-id="3674f-145">Этот метод выполняет фактическую работу и делает это в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="3674f-145">This method does the actual work, and it will run in the background.</span></span> <span data-ttu-id="3674f-146">Данный код демонстрирует рекурсивную реализацию алгоритма Фибоначчи — она довольно неэффективна и занимает в разы больше времени при работе с большими числами.</span><span class="sxs-lookup"><span data-stu-id="3674f-146">This code demonstrates the recursive implementation of the Fibonacci algorithm, which is notably inefficient, taking exponentially longer time to complete for larger numbers.</span></span> <span data-ttu-id="3674f-147">Он приводится в иллюстративных целях, чтобы показать, что операция может значительно замедлить работу вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="3674f-147">It is used here for illustrative purposes, to show an operation that can introduce long delays in your application.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#10](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#10)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#10](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#10)]
     [!code-vb[System.ComponentModel.BackgroundWorker#10](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#10)]  
  
3.  <span data-ttu-id="3674f-148">В <xref:System.ComponentModel.BackgroundWorker.DoWork> обработчик событий, добавьте вызов `ComputeFibonacci` метод.</span><span class="sxs-lookup"><span data-stu-id="3674f-148">In the <xref:System.ComponentModel.BackgroundWorker.DoWork> event handler, add a call to the `ComputeFibonacci` method.</span></span> <span data-ttu-id="3674f-149">Возьмите первый параметр `ComputeFibonacci` из <xref:System.ComponentModel.DoWorkEventArgs.Argument%2A> свойство <xref:System.ComponentModel.DoWorkEventArgs>.</span><span class="sxs-lookup"><span data-stu-id="3674f-149">Take the first parameter for `ComputeFibonacci` from the <xref:System.ComponentModel.DoWorkEventArgs.Argument%2A> property of the <xref:System.ComponentModel.DoWorkEventArgs>.</span></span> <span data-ttu-id="3674f-150"><xref:System.ComponentModel.BackgroundWorker> И <xref:System.ComponentModel.DoWorkEventArgs> параметры будут использоваться позже для отчетов о ходе выполнения и отмены поддержки.</span><span class="sxs-lookup"><span data-stu-id="3674f-150">The <xref:System.ComponentModel.BackgroundWorker> and <xref:System.ComponentModel.DoWorkEventArgs> parameters will be used later for progress reporting and cancellation support.</span></span> <span data-ttu-id="3674f-151">Присвойте возвращаемое значение из `ComputeFibonacci` для <xref:System.ComponentModel.DoWorkEventArgs.Result%2A> свойство <xref:System.ComponentModel.DoWorkEventArgs>.</span><span class="sxs-lookup"><span data-stu-id="3674f-151">Assign the return value from `ComputeFibonacci` to the <xref:System.ComponentModel.DoWorkEventArgs.Result%2A> property of the <xref:System.ComponentModel.DoWorkEventArgs>.</span></span> <span data-ttu-id="3674f-152">Этот результат будет доступен для <xref:System.ComponentModel.BackgroundWorker.RunWorkerCompleted> обработчик событий.</span><span class="sxs-lookup"><span data-stu-id="3674f-152">This result will be available to the <xref:System.ComponentModel.BackgroundWorker.RunWorkerCompleted> event handler.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="3674f-153"><xref:System.ComponentModel.BackgroundWorker.DoWork> Не ссылается на обработчик событий `backgroundWorker1` переменную экземпляра напрямую, так как это может привязать этот обработчик событий для определенного экземпляра <xref:System.ComponentModel.BackgroundWorker>.</span><span class="sxs-lookup"><span data-stu-id="3674f-153">The <xref:System.ComponentModel.BackgroundWorker.DoWork> event handler does not reference the `backgroundWorker1` instance variable directly, as this would couple this event handler to a specific instance of <xref:System.ComponentModel.BackgroundWorker>.</span></span> <span data-ttu-id="3674f-154">Вместо этого ссылка <xref:System.ComponentModel.BackgroundWorker> , создавший событие, берется из `sender` параметра.</span><span class="sxs-lookup"><span data-stu-id="3674f-154">Instead, a reference to the <xref:System.ComponentModel.BackgroundWorker> that raised this event is recovered from the `sender` parameter.</span></span> <span data-ttu-id="3674f-155">Это важно, если в форме размещено несколько <xref:System.ComponentModel.BackgroundWorker>.</span><span class="sxs-lookup"><span data-stu-id="3674f-155">This is important when the form hosts more than one <xref:System.ComponentModel.BackgroundWorker>.</span></span> <span data-ttu-id="3674f-156">Это также не следует выполнять операции все объекты пользовательского интерфейса в вашей <xref:System.ComponentModel.BackgroundWorker.DoWork> обработчик событий.</span><span class="sxs-lookup"><span data-stu-id="3674f-156">It is also important not to manipulate any user-interface objects in your <xref:System.ComponentModel.BackgroundWorker.DoWork> event handler.</span></span> <span data-ttu-id="3674f-157">Вместо этого для взаимодействия в пользовательский интерфейс, через <xref:System.ComponentModel.BackgroundWorker> события.</span><span class="sxs-lookup"><span data-stu-id="3674f-157">Instead, communicate to the user interface through the <xref:System.ComponentModel.BackgroundWorker> events.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#5](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#5)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#5](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#5)]
     [!code-vb[System.ComponentModel.BackgroundWorker#5](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#5)]  
  
4.  <span data-ttu-id="3674f-158">В `startAsyncButton` элемента управления <xref:System.Windows.Forms.Control.Click> обработчик событий, добавьте код, который запускает асинхронную операцию.</span><span class="sxs-lookup"><span data-stu-id="3674f-158">In the `startAsyncButton` control's <xref:System.Windows.Forms.Control.Click> event handler, add the code that starts the asynchronous operation.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#13](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#13)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#13](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#13)]
     [!code-vb[System.ComponentModel.BackgroundWorker#13](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#13)]  
  
5.  <span data-ttu-id="3674f-159">В <xref:System.ComponentModel.BackgroundWorker.RunWorkerCompleted> обработчик событий, результат вычисления, которое необходимо присвоить `resultLabel` элемента управления.</span><span class="sxs-lookup"><span data-stu-id="3674f-159">In the <xref:System.ComponentModel.BackgroundWorker.RunWorkerCompleted> event handler, assign the result of the calculation to the `resultLabel` control.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#6](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#6)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#6](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#6)]
     [!code-vb[System.ComponentModel.BackgroundWorker#6](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#6)]  
  
## <a name="adding-progress-reporting-and-support-for-cancellation"></a><span data-ttu-id="3674f-160">Добавление отчетов о ходе выполнения и поддержка отмены</span><span class="sxs-lookup"><span data-stu-id="3674f-160">Adding Progress Reporting and Support for Cancellation</span></span>  
 <span data-ttu-id="3674f-161">В случае асинхронных операций, занимающих долгое время, желательно сообщать пользователю о ходе выполнения, чтобы пользователь мог отменить операцию.</span><span class="sxs-lookup"><span data-stu-id="3674f-161">For asynchronous operations that will take a long time, it is often desirable to report progress to the user and to allow the user to cancel the operation.</span></span> <span data-ttu-id="3674f-162"><xref:System.ComponentModel.BackgroundWorker> Класс предоставляет событие, которое позволяет публиковать ход выполнения фоновой операции.</span><span class="sxs-lookup"><span data-stu-id="3674f-162">The <xref:System.ComponentModel.BackgroundWorker> class provides an event that allows you to post progress as your background operation proceeds.</span></span> <span data-ttu-id="3674f-163">Он также предоставляет флаг, позволяющий рабочему коду обнаружить вызов <xref:System.ComponentModel.BackgroundWorker.CancelAsync%2A> и прервать свое выполнение.</span><span class="sxs-lookup"><span data-stu-id="3674f-163">It also provides a flag that allows your worker code to detect a call to <xref:System.ComponentModel.BackgroundWorker.CancelAsync%2A> and interrupt itself.</span></span>  
  
#### <a name="to-implement-progress-reporting"></a><span data-ttu-id="3674f-164">Реализация отчета о ходе выполнения</span><span class="sxs-lookup"><span data-stu-id="3674f-164">To implement progress reporting</span></span>  
  
1.  <span data-ttu-id="3674f-165">В окне **Свойства** выберите `backgroundWorker1`.</span><span class="sxs-lookup"><span data-stu-id="3674f-165">In the **Properties**, window, select `backgroundWorker1`.</span></span> <span data-ttu-id="3674f-166">Задайте для свойств <xref:System.ComponentModel.BackgroundWorker.WorkerReportsProgress%2A> и <xref:System.ComponentModel.BackgroundWorker.WorkerSupportsCancellation%2A> значение `true`.</span><span class="sxs-lookup"><span data-stu-id="3674f-166">Set the <xref:System.ComponentModel.BackgroundWorker.WorkerReportsProgress%2A> and <xref:System.ComponentModel.BackgroundWorker.WorkerSupportsCancellation%2A> properties to `true`.</span></span>  
  
2.  <span data-ttu-id="3674f-167">Объявите две переменные в форме `FibonacciCalculator`.</span><span class="sxs-lookup"><span data-stu-id="3674f-167">Declare two variables in the `FibonacciCalculator` form.</span></span> <span data-ttu-id="3674f-168">Они будут использоваться для отслеживания хода выполнения.</span><span class="sxs-lookup"><span data-stu-id="3674f-168">These will be used to track progress.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#14](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#14)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#14](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#14)]
     [!code-vb[System.ComponentModel.BackgroundWorker#14](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#14)]  
  
3.  <span data-ttu-id="3674f-169">Добавьте обработчик для события <xref:System.ComponentModel.BackgroundWorker.ProgressChanged>.</span><span class="sxs-lookup"><span data-stu-id="3674f-169">Add an event handler for the <xref:System.ComponentModel.BackgroundWorker.ProgressChanged> event.</span></span> <span data-ttu-id="3674f-170">В <xref:System.ComponentModel.BackgroundWorker.ProgressChanged> обработчик событий, обновите <xref:System.Windows.Forms.ProgressBar> с <xref:System.ComponentModel.ProgressChangedEventArgs.ProgressPercentage%2A> свойство <xref:System.ComponentModel.ProgressChangedEventArgs> параметр.</span><span class="sxs-lookup"><span data-stu-id="3674f-170">In the <xref:System.ComponentModel.BackgroundWorker.ProgressChanged> event handler, update the <xref:System.Windows.Forms.ProgressBar> with the <xref:System.ComponentModel.ProgressChangedEventArgs.ProgressPercentage%2A> property of the <xref:System.ComponentModel.ProgressChangedEventArgs> parameter.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#7](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#7)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#7](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#7)]
     [!code-vb[System.ComponentModel.BackgroundWorker#7](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#7)]  
  
#### <a name="to-implement-support-for-cancellation"></a><span data-ttu-id="3674f-171">Реализация поддержки отмены</span><span class="sxs-lookup"><span data-stu-id="3674f-171">To implement support for cancellation</span></span>  
  
1.  <span data-ttu-id="3674f-172">В `cancelAsyncButton` элемента управления <xref:System.Windows.Forms.Control.Click> обработчик событий, добавьте код, отменяющий асинхронную операцию.</span><span class="sxs-lookup"><span data-stu-id="3674f-172">In the `cancelAsyncButton` control's <xref:System.Windows.Forms.Control.Click> event handler, add the code that cancels the asynchronous operation.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#4](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#4)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#4](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#4)]
     [!code-vb[System.ComponentModel.BackgroundWorker#4](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#4)]  
  
2.  <span data-ttu-id="3674f-173">Следующие фрагменты кода в методе `ComputeFibonacci` сообщают о ходе выполнения и поддерживают отмену.</span><span class="sxs-lookup"><span data-stu-id="3674f-173">The following code fragments in the `ComputeFibonacci` method report progress and support cancellation.</span></span>  
  
     [!code-cpp[System.ComponentModel.BackgroundWorker#11](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#11)]
     [!code-csharp[System.ComponentModel.BackgroundWorker#11](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#11)]
     [!code-vb[System.ComponentModel.BackgroundWorker#11](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#11)]  
    [!code-cpp[System.ComponentModel.BackgroundWorker#12](../../../../samples/snippets/cpp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CPP/fibonacciform.cpp#12)]
    [!code-csharp[System.ComponentModel.BackgroundWorker#12](../../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/CS/fibonacciform.cs#12)]
    [!code-vb[System.ComponentModel.BackgroundWorker#12](../../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.BackgroundWorker/VB/fibonacciform.vb#12)]  
  
## <a name="checkpoint"></a><span data-ttu-id="3674f-174">Контрольная точка</span><span class="sxs-lookup"><span data-stu-id="3674f-174">Checkpoint</span></span>  
 <span data-ttu-id="3674f-175">На этом этапе можно скомпилировать и запустить приложение калькулятора Фибоначчи.</span><span class="sxs-lookup"><span data-stu-id="3674f-175">At this point, you can compile and run the Fibonacci Calculator application.</span></span>  
  
#### <a name="to-test-your-project"></a><span data-ttu-id="3674f-176">Тестирование проекта</span><span class="sxs-lookup"><span data-stu-id="3674f-176">To test your project</span></span>  
  
-   <span data-ttu-id="3674f-177">Чтобы скомпилировать и запустить приложение, нажмите клавишу F5.</span><span class="sxs-lookup"><span data-stu-id="3674f-177">Press F5 to compile and run the application.</span></span>  
  
     <span data-ttu-id="3674f-178">Пока вычисление выполняется в фоновом режиме, вы увидите <xref:System.Windows.Forms.ProgressBar> отображением хода выполнения вычислений.</span><span class="sxs-lookup"><span data-stu-id="3674f-178">While the calculation is running in the background, you will see the <xref:System.Windows.Forms.ProgressBar> displaying the progress of the calculation toward completion.</span></span> <span data-ttu-id="3674f-179">Операцию, ожидающую выполнения, можно отменить.</span><span class="sxs-lookup"><span data-stu-id="3674f-179">You can also cancel the pending operation.</span></span>  
  
     <span data-ttu-id="3674f-180">Если числа небольшие, вычисления выполняются быстро, а с крупными числами занимают заметно больше времени.</span><span class="sxs-lookup"><span data-stu-id="3674f-180">For small numbers, the calculation should be very fast, but for larger numbers, you should see a noticeable delay.</span></span> <span data-ttu-id="3674f-181">Если ввести значение 30 или больше, задержка составит несколько секунд, в зависимости от скорости работы вашего компьютера.</span><span class="sxs-lookup"><span data-stu-id="3674f-181">If you enter a value of 30 or greater, you should see a delay of several seconds, depending on the speed of your computer.</span></span> <span data-ttu-id="3674f-182">Для значений больше 40 вычисление может затянуться на несколько часов.</span><span class="sxs-lookup"><span data-stu-id="3674f-182">For values greater than 40, it may take minutes or hours to finish the calculation.</span></span> <span data-ttu-id="3674f-183">Пока калькулятор вычисляет большое число Фибоначчи, форму можно свободно переместить, свернуть, развернуть и даже закрыть.</span><span class="sxs-lookup"><span data-stu-id="3674f-183">While the calculator is busy computing a large Fibonacci number, notice that you can freely move the form around, minimize, maximize, and even dismiss it.</span></span> <span data-ttu-id="3674f-184">Это связано с тем, что основной поток пользовательского интерфейса не дожидается, пока вычисление будет завершено.</span><span class="sxs-lookup"><span data-stu-id="3674f-184">This is because the main UI thread is not waiting for the calculation to finish.</span></span>  
  
## <a name="next-steps"></a><span data-ttu-id="3674f-185">Следующие шаги</span><span class="sxs-lookup"><span data-stu-id="3674f-185">Next Steps</span></span>  
 <span data-ttu-id="3674f-186">Теперь, когда вы реализовали форму, которая использует <xref:System.ComponentModel.BackgroundWorker> компонент для вычислений в фоновом режиме, вы можете изучить другие возможности для асинхронных операций:</span><span class="sxs-lookup"><span data-stu-id="3674f-186">Now that you have implemented a form that uses a <xref:System.ComponentModel.BackgroundWorker> component to execute a computation in the background, you can explore other possibilities for asynchronous operations:</span></span>  
  
-   <span data-ttu-id="3674f-187">Используйте несколько <xref:System.ComponentModel.BackgroundWorker> объектов для нескольких одновременных операций.</span><span class="sxs-lookup"><span data-stu-id="3674f-187">Use multiple <xref:System.ComponentModel.BackgroundWorker> objects for several simultaneous operations.</span></span>  
  
-   <span data-ttu-id="3674f-188">Отладка многопоточных приложений, см. в разделе [как: Использование окна потоков](/visualstudio/debugger/how-to-use-the-threads-window).</span><span class="sxs-lookup"><span data-stu-id="3674f-188">To debug your multithreaded application, see [How to: Use the Threads Window](/visualstudio/debugger/how-to-use-the-threads-window).</span></span>  
  
-   <span data-ttu-id="3674f-189">Реализация собственного компонента, поддерживающего модель асинхронного программирования.</span><span class="sxs-lookup"><span data-stu-id="3674f-189">Implement your own component that supports the asynchronous programming model.</span></span> <span data-ttu-id="3674f-190">Дополнительные сведения см. в разделе [Обзор асинхронной модели на основе событий](../../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span><span class="sxs-lookup"><span data-stu-id="3674f-190">For more information, see [Event-based Asynchronous Pattern Overview](../../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span></span>  
  
    > [!CAUTION]
    >  <span data-ttu-id="3674f-191">При использовании любой многопоточности существует потенциальная возможность возникновения серьезных ошибок.</span><span class="sxs-lookup"><span data-stu-id="3674f-191">When using multithreading of any sort, you potentially expose yourself to very serious and complex bugs.</span></span> <span data-ttu-id="3674f-192">Перед реализацией любого решения, в котором используется многопоточность, ознакомьтесь с разделом [Рекомендации по работе с потоками](../../../../docs/standard/threading/managed-threading-best-practices.md).</span><span class="sxs-lookup"><span data-stu-id="3674f-192">Consult the [Managed Threading Best Practices](../../../../docs/standard/threading/managed-threading-best-practices.md) before implementing any solution that uses multithreading.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="3674f-193">См. также</span><span class="sxs-lookup"><span data-stu-id="3674f-193">See also</span></span>

- <xref:System.ComponentModel.BackgroundWorker?displayProperty=nameWithType>
- [<span data-ttu-id="3674f-194">Управляемая поточность</span><span class="sxs-lookup"><span data-stu-id="3674f-194">Managed Threading</span></span>](../../../../docs/standard/threading/index.md)
- [<span data-ttu-id="3674f-195">Рекомендации по работе с потоками</span><span class="sxs-lookup"><span data-stu-id="3674f-195">Managed Threading Best Practices</span></span>](../../../../docs/standard/threading/managed-threading-best-practices.md)
- [<span data-ttu-id="3674f-196">Обзор асинхронной модели, основанной на событиях</span><span class="sxs-lookup"><span data-stu-id="3674f-196">Event-based Asynchronous Pattern Overview</span></span>](../../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md)
- [<span data-ttu-id="3674f-197">Практическое руководство. Реализация формы, в которой выполняется фоновая операция</span><span class="sxs-lookup"><span data-stu-id="3674f-197">How to: Implement a Form That Uses a Background Operation</span></span>](how-to-implement-a-form-that-uses-a-background-operation.md)
- [<span data-ttu-id="3674f-198">Пошаговое руководство: Выполнение операции в фоновом режиме</span><span class="sxs-lookup"><span data-stu-id="3674f-198">Walkthrough: Running an Operation in the Background</span></span>](walkthrough-running-an-operation-in-the-background.md)
- [<span data-ttu-id="3674f-199">Компонент BackgroundWorker</span><span class="sxs-lookup"><span data-stu-id="3674f-199">BackgroundWorker Component</span></span>](backgroundworker-component.md)
