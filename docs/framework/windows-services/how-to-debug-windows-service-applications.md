---
title: Практическое руководство. Отладка приложений служб Windows
ms.date: 03/30/2017
helpviewer_keywords:
- debugging Windows Service applications
- debugging [Visual Studio], Windows services
- Windows NT services, debugging
- Windows Service applications, debugging
- services, debugging
ms.assetid: 63ab0800-0f05-4f1e-88e6-94c73fd920a2
author: ghogen
ms.openlocfilehash: 3f8dfff59acaa10fa99874dde2eb6eb6ed04e8fb
ms.sourcegitcommit: fb78d8abbdb87144a3872cf154930157090dd933
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2018
ms.locfileid: "47399941"
---
# <a name="how-to-debug-windows-service-applications"></a>Практическое руководство. Отладка приложений служб Windows
Служба должна запускаться из диспетчера управления службами, а не из Visual Studio. Поэтому, процесс отладки службы сложнее, чем отладка приложений Visual Studio других типов. Для отладки службы необходимо запустить службу, а затем подключить отладчик к процессу, в котором она выполняется. Приложение можно отлаживать с помощью всех стандартных средств отладки Visual Studio.  
  
> [!CAUTION]
>  Не следует присоединять к процессу, если неизвестно, что собой представляет данный процесс, и неясны последствия подключения к процессу (включая даже уничтожение этого процесса). Например, при подключении к процессу WinLogon и последующей остановке процесса отладки система будет остановлена, так как она не может работать без данного процесса.  
  
 Отладчик можно прикреплять только к выполняющейся службе. Процесс подключения прерывает текущую работу службы (фактически он не останавливает и не приостанавливает ее). То есть, если служба уже выполнялась на момент запуска процесса отладки, она по-прежнему технически находится в состоянии "Started" в ходе отладки, однако ее работа приостанавливается.  
  
 После присоединения к процессу можно установить точки останова и использовать их для отладки кода. После выхода из диалогового окна, используемого для подключения к процессу, вы продолжаете оставаться в режиме отладки. Для запуска, остановки, приостановки и продолжения работы служб (то есть, попадания в заданные точки) можно использовать диспетчер управления службами. Позднее эту фиктивную службу можно удалить после успешного завершения отладки.  
  
 В этой статье рассматривается процесс отладки службы, выполняемой на локальном компьютере (также можно выполнять отладку служб Windows, которые выполняются на удаленном компьютере). См. статью об [удаленной отладке](/visualstudio/debugger/debug-installed-app-package).  
  
> [!NOTE]
>  Процесс отладки метода <xref:System.ServiceProcess.ServiceBase.OnStart%2A> может быть сложным, так как диспетчер управления службами накладывает ограничение в 30 секунд на все попытки запуска службы. Дополнительные сведения см. в статье [Устранение неполадок: отладка служб Windows](../../../docs/framework/windows-services/troubleshooting-debugging-windows-services.md).  
  
> [!WARNING]
>  Для получения значимой информации для отладки отладчик Visual Studio должен найти файлы символов для двоичных файлов, для которых выполняется отладка. При отладке службы, созданной в Visual Studio, файлы символов (PDB-файлы) находятся в той же папке, что и исполняемый файл или библиотека, и отладчик загружает их автоматически. При отладке службы, которая не была построена, сначала следует найти символы для службы и убедиться, что они могут быть найдены отладчиком. См. статью [Указание файлов символов (.pdb) и файлов с исходным кодом в отладчике Visual Studio](https://msdn.microsoft.com/library/1105e169-5272-4e7c-b3e7-cda1b7798a6b). Если вы выполняете отладку системного процесса или хотите иметь символы для системных вызовов в своих службах, то необходимо добавить серверы символов Майкрософт. См. статью [об отладке с помощью символов](/windows/desktop/DxTechArts/debugging-with-symbols).  
  
### <a name="to-debug-a-service"></a>Отладка службы  
  
1.  Постройте службу в конфигурации отладки.  
  
2.  Установите службу. Для получения дополнительной информации см. [How to: Install and Uninstall Services](../../../docs/framework/windows-services/how-to-install-and-uninstall-services.md).  
  
3.  Запустите службу из **диспетчера служб**, **обозревателя сервера** или из кода. Дополнительные сведения см. в [практическом руководстве по запуску служб](../../../docs/framework/windows-services/how-to-start-services.md).  
  
4.  Запустите Visual Studio с учетными данными администратора, чтобы вы могли подключиться к системным процессам.  
  
5.  (Необязательное действие.) В строке меню Visual Studio последовательно выберите **Инструменты** и **Параметры**. В диалоговом окне **Параметры** последовательно выберите **Отладка** и **Символы**, установите флажок **Серверы символов Microsoft** и нажмите кнопку **ОК**.  
  
6.  В строке меню в меню **Отладка** или **Инструменты** выберите пункт **Присоединение к процессу**. (Комбинация клавиш: Ctrl+Alt+P)  
  
     Откроется диалоговое окно **Процессы**.  
  
7.  Установите флажок **Показать процессы, запущенные всеми пользователями**.  
  
8.  В разделе **Доступные процессы** выберите процесс для службы и нажмите кнопку **Присоединиться**.  
  
    > [!TIP]
    >  Процесс будет иметь то же имя, что и исполняемый файл для службы.  
  
     Откроется диалоговое окно **Присоединение к процессу** .  
  
9. Выберите соответствующие параметры, а затем нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.  
  
    > [!NOTE]
    >  Теперь вы находитесь в режиме отладки.  
  
10. Установите точки останова, которые буден нужно использовать в коде.  
  
11. Откройте диспетчер управления службами и выполните несколько операций со своей службой (выполните команды остановки, приостановки и продолжения), чтобы обнаружить свои точки останова. Дополнительные сведения о запуске диспетчера служб см. в статье [Практическое руководство. Запуск служб](../../../docs/framework/windows-services/how-to-start-services.md). Также см. статью [Устранение неполадок: отладка служб Windows](../../../docs/framework/windows-services/troubleshooting-debugging-windows-services.md).  
  
## <a name="debugging-tips-for-windows-services"></a>Советы по отладке для служб Windows  
 Присоединение к процессу службы позволяет отлаживать основную часть кода (но не весь код) для этой службы. Например, так как служба уже была запущена, нельзя выполнять отладку кода в методе <xref:System.ServiceProcess.ServiceBase.OnStart%2A> службы или кода в методе `Main`, который используется для загрузки службы подобным образом. Одним из способов обхода этого ограничения является создание временной второй службы в приложении службы, которая предназначена только для отладки. Можно установить обе службы,а затем запустить эту фиктивную службу для загрузки процесса службы. Когда временная служба запустит процесс, в Visual Studio в меню **Отладка** можно будет присоединиться к процессу службы.  
  
 Попробуйте добавлять вызовы в метод <xref:System.Threading.Thread.Sleep%2A> с целью задержки выполнения действия, пока вы не присоединитесь к процессу.  
  
 Попробуйте заменить программу на обычное консольное приложение. Для этого измените метод `Main` следующим образом, чтобы он мог быть запущен и как служба Windows, и как консольное приложение (в зависимости от способа запуска).  
  
#### <a name="how-to-run-a-windows-service-as-a-console-application"></a>Запуск службы Windows как консольного приложения  
  
1.  Добавьте метод в свою службу, которая запускает методы <xref:System.ServiceProcess.ServiceBase.OnStart%2A> и <xref:System.ServiceProcess.ServiceBase.OnStop%2A>:  
  
    ```csharp  
    internal void TestStartupAndStop(string[] args)  
    {  
        this.OnStart(args);  
        Console.ReadLine();  
        this.OnStop();  
    }  
    ```  
  
2.  Перепишите метод `Main` следующим образом:  
  
    ```csharp  
    static void Main(string[] args)  
    {  
        if (Environment.UserInteractive)  
        {  
            MyNewService service1 = new MyNewService(args);  
            service1.TestStartupAndStop(args);  
        }  
        else  
        {  
            // Put the body of your old Main method here.  
        }  
    }
    ```  
  
3.  В окне свойств проекта на вкладке **Приложение** задайте для параметра **Тип выходных данных** значение **Консольное приложение**.  
  
4.  Щелкните **Начать отладку** (F5).  
  
5.  Чтобы снова запустить программу как службу Windows, установите ее и запустите обычным образом (для службы Windows). Отменять эти изменения необязательно.  
  
 В некоторых случаях, например, если требуется устранить некоторую проблему, которая возникает только при запуске системы, необходимо использовать отладчик Windows. Установите [средства отладки для Windows](https://msdn.microsoft.com/windows/hardware/hh852365) и прочтите статью [Отладка служб Windows](https://support.microsoft.com/kb/824344).  
  
## <a name="see-also"></a>См. также  
 [Знакомство с приложениями служб Windows](../../../docs/framework/windows-services/introduction-to-windows-service-applications.md)  
 [Практическое руководство. Установка и удаление служб](../../../docs/framework/windows-services/how-to-install-and-uninstall-services.md)  
 [Практическое руководство. Запуск служб](../../../docs/framework/windows-services/how-to-start-services.md)  
 [Отладка службы](/windows/desktop/Services/debugging-a-service)
