---
title: Теневое копирование сборок
ms.date: 03/30/2017
helpviewer_keywords:
- assemblies [.NET Framework], shadow copying
- application domains, shadow copying assemblies
- shadow copying assemblies
ms.assetid: de8b8759-fca7-4260-896b-5a4973157672
ms.openlocfilehash: 9fc8a4aeeeca40f71ed9114a9db40b9a56e5fe6b
ms.sourcegitcommit: 81ad1f09b93f3b3e6706a7f2e4ddf50ef229ea3d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74204562"
---
# <a name="shadow-copying-assemblies"></a><span data-ttu-id="a56f2-102">Теневое копирование сборок</span><span class="sxs-lookup"><span data-stu-id="a56f2-102">Shadow Copying Assemblies</span></span>

<span data-ttu-id="a56f2-103">Теневое копирование позволяет обновлять используемые в домене приложения сборки без выгрузки домена приложения.</span><span class="sxs-lookup"><span data-stu-id="a56f2-103">Shadow copying enables assemblies that are used in an application domain to be updated without unloading the application domain.</span></span> <span data-ttu-id="a56f2-104">Это особенно полезно для приложений, которые должны быть доступны постоянно, таких как сайты ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a56f2-104">This is particularly useful for applications that must be available continuously, such as ASP.NET sites.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="a56f2-105">Shadow copying is not supported in Windows 8.x Store apps.</span><span class="sxs-lookup"><span data-stu-id="a56f2-105">Shadow copying is not supported in Windows 8.x Store apps.</span></span>

<span data-ttu-id="a56f2-106">При загрузке сборки среда CLR блокирует ее файл, поэтому его нельзя обновить до тех пор, пока сборка не выгружена.</span><span class="sxs-lookup"><span data-stu-id="a56f2-106">The common language runtime locks an assembly file when the assembly is loaded, so the file cannot be updated until the assembly is unloaded.</span></span> <span data-ttu-id="a56f2-107">Единственный способ выгрузить сборку из домена приложения — выгрузить сам домен. Таким образом, в обычных условиях сборку нельзя обновить на диске до тех пор, пока не выгружены все домены приложений, использующие ее.</span><span class="sxs-lookup"><span data-stu-id="a56f2-107">The only way to unload an assembly from an application domain is by unloading the application domain, so under normal circumstances, an assembly cannot be updated on disk until all the application domains that are using it have been unloaded.</span></span>

<span data-ttu-id="a56f2-108">Если для домена приложения настроено теневое копирование файлов, сборки по пути приложения копируются в другое расположение и загружаются из него.</span><span class="sxs-lookup"><span data-stu-id="a56f2-108">When an application domain is configured to shadow copy files, assemblies from the application path are copied to another location and loaded from that location.</span></span> <span data-ttu-id="a56f2-109">Копия блокируется, но исходный файл сборки разблокирован, и его можно обновить.</span><span class="sxs-lookup"><span data-stu-id="a56f2-109">The copy is locked, but the original assembly file is unlocked and can be updated.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="a56f2-110">Единственными сборками, которые подлежат теневому копированию, являются сборки, хранящиеся в каталоге приложения или в его подкаталогах, указанных в свойствах <xref:System.AppDomainSetup.ApplicationBase%2A> и <xref:System.AppDomainSetup.PrivateBinPath%2A> при настройке домена приложения.</span><span class="sxs-lookup"><span data-stu-id="a56f2-110">The only assemblies that can be shadow copied are those stored in the application directory or its subdirectories, specified by the <xref:System.AppDomainSetup.ApplicationBase%2A> and <xref:System.AppDomainSetup.PrivateBinPath%2A> properties when the application domain is configured.</span></span> <span data-ttu-id="a56f2-111">Хранящиеся в глобальном кэше сборки не подлежат теневому копированию.</span><span class="sxs-lookup"><span data-stu-id="a56f2-111">Assemblies stored in the global assembly cache are not shadow copied.</span></span>

<span data-ttu-id="a56f2-112">В этом разделе содержатся следующие подразделы:</span><span class="sxs-lookup"><span data-stu-id="a56f2-112">This article contains the following sections:</span></span>

- <span data-ttu-id="a56f2-113">[Включение и использование теневого копирования](#EnablingAndUsing) — содержит описание основных принципов использования и параметров, доступных для теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="a56f2-113">[Enabling and Using Shadow Copying](#EnablingAndUsing) describes the basic use and the options that are available for shadow copying.</span></span>

- <span data-ttu-id="a56f2-114">[Производительность при запуске](#StartupPerformance) — содержит описание изменений, внесенных в теневое копирование в .NET Framework 4 с целью улучшить производительность при запуске, а также способов возврата к поведению более ранних версий.</span><span class="sxs-lookup"><span data-stu-id="a56f2-114">[Startup Performance](#StartupPerformance) describes the changes that are made to shadow copying in the .NET Framework 4 to improve startup performance, and how to revert to the behavior of earlier versions.</span></span>

- <span data-ttu-id="a56f2-115">[Устаревшие методы](#ObsoleteMethods) — содержит описание изменений, внесенных в свойства и методы, которые контролируют теневое копирование в .NET Framework 2.0.</span><span class="sxs-lookup"><span data-stu-id="a56f2-115">[Obsolete Methods](#ObsoleteMethods) describes the changes that were made to the properties and methods that control shadow copying in the .NET Framework 2.0.</span></span>

<a name="EnablingAndUsing"></a>

## <a name="enabling-and-using-shadow-copying"></a><span data-ttu-id="a56f2-116">Включение и использование теневого копирования</span><span class="sxs-lookup"><span data-stu-id="a56f2-116">Enabling and Using Shadow Copying</span></span>

<span data-ttu-id="a56f2-117">Чтобы настроить теневое копирование для домена приложения, можно использовать свойства класса <xref:System.AppDomainSetup>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-117">You can use the properties of the <xref:System.AppDomainSetup> class as follows to configure an application domain for shadow copying:</span></span>

- <span data-ttu-id="a56f2-118">Чтобы включить теневое копирование, присвойте свойству <xref:System.AppDomainSetup.ShadowCopyFiles%2A> строковое значение `"true"`.</span><span class="sxs-lookup"><span data-stu-id="a56f2-118">Enable shadow copying by setting the <xref:System.AppDomainSetup.ShadowCopyFiles%2A> property to the string value `"true"`.</span></span>

  <span data-ttu-id="a56f2-119">По умолчанию этот параметр вызывает копирование всех сборок по пути приложения в кэш загрузки перед их загрузкой.</span><span class="sxs-lookup"><span data-stu-id="a56f2-119">By default, this setting causes all assemblies in the application path to be copied to a download cache before they are loaded.</span></span> <span data-ttu-id="a56f2-120">Это тот же кэш, который поддерживается средой CLR для хранения файлов, загруженных с других компьютеров. Среда CLR автоматически удаляет файлы, если они больше не требуются.</span><span class="sxs-lookup"><span data-stu-id="a56f2-120">This is the same cache maintained by the common language runtime to store files downloaded from other computers, and the common language runtime automatically deletes the files when they are no longer needed.</span></span>

- <span data-ttu-id="a56f2-121">При необходимости задайте произвольное местоположение для теневой копии файлов с помощью свойств <xref:System.AppDomainSetup.CachePath%2A> и <xref:System.AppDomainSetup.ApplicationName%2A>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-121">Optionally set a custom location for shadow copied files by using the <xref:System.AppDomainSetup.CachePath%2A> property and the <xref:System.AppDomainSetup.ApplicationName%2A> property.</span></span>

  <span data-ttu-id="a56f2-122">Базовый путь к расположению формируется путем присоединения свойства <xref:System.AppDomainSetup.ApplicationName%2A> к свойству <xref:System.AppDomainSetup.CachePath%2A> в качестве подкаталога.</span><span class="sxs-lookup"><span data-stu-id="a56f2-122">The base path for the location is formed by concatenating the <xref:System.AppDomainSetup.ApplicationName%2A> property to the <xref:System.AppDomainSetup.CachePath%2A> property as a subdirectory.</span></span> <span data-ttu-id="a56f2-123">Сборки копируются в подкаталоги этого пути, а не в сам путь.</span><span class="sxs-lookup"><span data-stu-id="a56f2-123">Assemblies are shadow copied to subdirectories of this path, not to the base path itself.</span></span>

  > [!NOTE]
  > <span data-ttu-id="a56f2-124">Если свойство <xref:System.AppDomainSetup.ApplicationName%2A> не задано, то свойство <xref:System.AppDomainSetup.CachePath%2A> игнорируется и используется кэш загрузки.</span><span class="sxs-lookup"><span data-stu-id="a56f2-124">If the <xref:System.AppDomainSetup.ApplicationName%2A> property is not set, the <xref:System.AppDomainSetup.CachePath%2A> property is ignored and the download cache is used.</span></span> <span data-ttu-id="a56f2-125">Исключение не возникает.</span><span class="sxs-lookup"><span data-stu-id="a56f2-125">No exception is thrown.</span></span>

  <span data-ttu-id="a56f2-126">Если указано пользовательское расположение, вы самостоятельно выполняете очистку каталогов и скопированных файлов, если они больше не требуются.</span><span class="sxs-lookup"><span data-stu-id="a56f2-126">If you specify a custom location, you are responsible for cleaning up the directories and copied files when they are no longer needed.</span></span> <span data-ttu-id="a56f2-127">Автоматически они не удаляются.</span><span class="sxs-lookup"><span data-stu-id="a56f2-127">They are not deleted automatically.</span></span>

  <span data-ttu-id="a56f2-128">Существует несколько причин, по которым рекомендуется задать пользовательское расположение для теневой копии файлов.</span><span class="sxs-lookup"><span data-stu-id="a56f2-128">There are a few reasons why you might want to set a custom location for shadow copied files.</span></span> <span data-ttu-id="a56f2-129">Это может потребоваться сделать, если приложение создает большое количество копий.</span><span class="sxs-lookup"><span data-stu-id="a56f2-129">You might want to set a custom location for shadow copied files if your application generates a large number of copies.</span></span> <span data-ttu-id="a56f2-130">Кэш загрузки ограничен по размеру, а не по времени существования, поэтому возможно, что среда CLR попытается удалить файл, который все еще используется.</span><span class="sxs-lookup"><span data-stu-id="a56f2-130">The download cache is limited by size, not by lifetime, so it is possible that the common language runtime will attempt to delete a file that is still in use.</span></span> <span data-ttu-id="a56f2-131">Также пользовательское расположение следует указывать, если пользователи приложения не имеют прав на запись в каталог, который среда CLR использует для кэша загрузки.</span><span class="sxs-lookup"><span data-stu-id="a56f2-131">Another reason to set a custom location is when users running your application do not have write access to the directory location the common language runtime uses for the download cache.</span></span>

- <span data-ttu-id="a56f2-132">При необходимости можно ограничить сборки, подлежащие теневому копированию, с помощью свойства <xref:System.AppDomainSetup.ShadowCopyDirectories%2A>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-132">Optionally limit the assemblies that are shadow copied by using the <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> property.</span></span>

  <span data-ttu-id="a56f2-133">При включении теневого копирования для домена приложения по умолчанию будут копироваться все сборки из пути приложения, то есть из каталогов, указанных в свойствах <xref:System.AppDomainSetup.ApplicationBase%2A> и <xref:System.AppDomainSetup.PrivateBinPath%2A>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-133">When you enable shadow copying for an application domain, the default is to copy all assemblies in the application path — that is, in the directories specified by the <xref:System.AppDomainSetup.ApplicationBase%2A> and <xref:System.AppDomainSetup.PrivateBinPath%2A> properties.</span></span> <span data-ttu-id="a56f2-134">Вы можете ограничить копирование выбранных каталогов, создав строку, содержащую только те каталоги, теневые копии которых требуется создать, и присвоив эту строку свойству <xref:System.AppDomainSetup.ShadowCopyDirectories%2A>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-134">You can limit the copying to selected directories by creating a string that contains only those directories you want to shadow copy, and assigning the string to the <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> property.</span></span> <span data-ttu-id="a56f2-135">Для разделения каталогов используется точка с запятой.</span><span class="sxs-lookup"><span data-stu-id="a56f2-135">Separate the directories with semicolons.</span></span> <span data-ttu-id="a56f2-136">Единственными сборками, которые подлежат теневому копированию, являются сборки из выбранных каталогов.</span><span class="sxs-lookup"><span data-stu-id="a56f2-136">The only assemblies that are shadow copied are the ones in the selected directories.</span></span>

  > [!NOTE]
  > <span data-ttu-id="a56f2-137">Если не присвоить строку свойству <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> или присвоить ему значение `null`, выполняется теневое копирование всех сборок в каталогах, указанных в свойствах <xref:System.AppDomainSetup.ApplicationBase%2A> и <xref:System.AppDomainSetup.PrivateBinPath%2A>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-137">If you don’t assign a string to the <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> property, or if you set this property to `null`, all assemblies in the directories specified by the <xref:System.AppDomainSetup.ApplicationBase%2A> and <xref:System.AppDomainSetup.PrivateBinPath%2A> properties are shadow copied.</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="a56f2-138">Пути к каталогам не должны содержать точку с запятой, так как она является разделителем.</span><span class="sxs-lookup"><span data-stu-id="a56f2-138">Directory paths must not contain semicolons, because the semicolon is the delimiter character.</span></span> <span data-ttu-id="a56f2-139">Escape-символа для точки с запятой не существует.</span><span class="sxs-lookup"><span data-stu-id="a56f2-139">There is no escape character for semicolons.</span></span>

<a name="StartupPerformance"></a>

## <a name="startup-performance"></a><span data-ttu-id="a56f2-140">Производительность при запуске</span><span class="sxs-lookup"><span data-stu-id="a56f2-140">Startup Performance</span></span>

<span data-ttu-id="a56f2-141">Когда запускается домен приложения, использующий теневое копирование, возникает задержка, пока сборки копируются из каталога приложения в каталог теневого копирования или проверяются, если они уже находятся в этом каталоге.</span><span class="sxs-lookup"><span data-stu-id="a56f2-141">When an application domain that uses shadow copying starts, there is a delay while assemblies in the application directory are copied to the shadow copy directory, or verified if they are already in that location.</span></span> <span data-ttu-id="a56f2-142">До появления .NET Framework 4 все сборки копировались во временный каталог.</span><span class="sxs-lookup"><span data-stu-id="a56f2-142">Before the .NET Framework 4, all assemblies were copied to a temporary directory.</span></span> <span data-ttu-id="a56f2-143">Каждая сборка открывалась для проверки имени сборки и строгого имени.</span><span class="sxs-lookup"><span data-stu-id="a56f2-143">Each assembly was opened to verify the assembly name, and the strong name was validated.</span></span> <span data-ttu-id="a56f2-144">Каждая сборка проверялась на предмет того, обновлялась ли она позднее копии в каталоге теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="a56f2-144">Each assembly was checked to see whether it had been updated more recently than the copy in the shadow copy directory.</span></span> <span data-ttu-id="a56f2-145">Если это было так, сборка копировалась в каталог теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="a56f2-145">If so, it was copied to the shadow copy directory.</span></span> <span data-ttu-id="a56f2-146">Наконец, временные копии удалялись.</span><span class="sxs-lookup"><span data-stu-id="a56f2-146">Finally, the temporary copies were discarded.</span></span>

<span data-ttu-id="a56f2-147">Начиная с .NET Framework 4 при запуске по умолчанию происходит прямое сравнение даты и времени файла каждой сборки в каталоге приложения с датой и временем копии файла в каталоге теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="a56f2-147">Beginning with the .NET Framework 4, the default startup behavior is to directly compare the file date and time of each assembly in the application directory with the file date and time of the copy in the shadow copy directory.</span></span> <span data-ttu-id="a56f2-148">Если сборка была обновлена, она копируется с использованием той же процедуры, что и в более ранних версиях .NET Framework; в противном случае загружается копия из каталога теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="a56f2-148">If the assembly has been updated, it is copied by using the same procedure as in earlier versions of the .NET Framework; otherwise, the copy in the shadow copy directory is loaded.</span></span>

<span data-ttu-id="a56f2-149">Повышение итоговой производительности является наибольшим для приложений, сборки которых меняются нечасто, а изменения обычно появляются в небольшом подмножестве сборок.</span><span class="sxs-lookup"><span data-stu-id="a56f2-149">The resulting performance improvement is largest for applications in which assemblies do not change frequently and changes usually occur in a small subset of assemblies.</span></span> <span data-ttu-id="a56f2-150">Если большинство сборок приложения меняется часто, новое поведение по умолчанию может явиться причиной снижения производительности.</span><span class="sxs-lookup"><span data-stu-id="a56f2-150">If a majority of assemblies in an application change frequently, the new default behavior might cause a performance regression.</span></span> <span data-ttu-id="a56f2-151">Можно восстановить поведение при запуске предыдущих версий .NET Framework, добавив [элемент \<shadowCopyVerifyByTimestamp>](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md) в файл конфигурации с логическим значением `enabled="false"`.</span><span class="sxs-lookup"><span data-stu-id="a56f2-151">You can restore the startup behavior of previous versions of the .NET Framework by adding the [\<shadowCopyVerifyByTimestamp> element](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md) to the configuration file, with `enabled="false"`.</span></span>

<a name="ObsoleteMethods"></a>

## <a name="obsolete-methods"></a><span data-ttu-id="a56f2-152">Устаревшие методы</span><span class="sxs-lookup"><span data-stu-id="a56f2-152">Obsolete Methods</span></span>

<span data-ttu-id="a56f2-153">Класс <xref:System.AppDomain> имеет несколько методов, например <xref:System.AppDomain.SetShadowCopyFiles%2A> и <xref:System.AppDomain.ClearShadowCopyPath%2A>, которые можно использовать для управления теневым копированием в домене приложения, но в .NET Framework версии 2.0 они были помечены как устаревшие.</span><span class="sxs-lookup"><span data-stu-id="a56f2-153">The <xref:System.AppDomain> class has several methods, such as <xref:System.AppDomain.SetShadowCopyFiles%2A> and <xref:System.AppDomain.ClearShadowCopyPath%2A>, that can be used to control shadow copying on an application domain, but these have been marked obsolete in the .NET Framework version 2.0.</span></span> <span data-ttu-id="a56f2-154">Рекомендуемый способ настройки теневого копирования для домена приложения — это использование свойств класса <xref:System.AppDomainSetup>.</span><span class="sxs-lookup"><span data-stu-id="a56f2-154">The recommended way to configure an application domain for shadow copying is to use the properties of the <xref:System.AppDomainSetup> class.</span></span>

## <a name="see-also"></a><span data-ttu-id="a56f2-155">См. также</span><span class="sxs-lookup"><span data-stu-id="a56f2-155">See also</span></span>

- <xref:System.AppDomainSetup.ShadowCopyFiles%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.CachePath%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.ApplicationName%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.ShadowCopyDirectories%2A?displayProperty=nameWithType>
- [<span data-ttu-id="a56f2-156">Элемент \<shadowCopyVerifyByTimeStamp></span><span class="sxs-lookup"><span data-stu-id="a56f2-156">\<shadowCopyVerifyByTimestamp> Element</span></span>](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md)
