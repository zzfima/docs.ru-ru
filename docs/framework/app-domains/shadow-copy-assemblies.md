---
title: Теневое копирование сборок
ms.date: 03/30/2017
helpviewer_keywords:
- assemblies [.NET Framework], shadow copying
- application domains, shadow copying assemblies
- shadow copying assemblies
ms.assetid: de8b8759-fca7-4260-896b-5a4973157672
ms.openlocfilehash: 40a1b5062d45b7b540af7058b82b77c664070d2e
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73119781"
---
# <a name="shadow-copying-assemblies"></a>Теневое копирование сборок

Теневое копирование позволяет обновлять используемые в домене приложения сборки без выгрузки домена приложения. Это особенно полезно для приложений, которые должны быть доступны постоянно, таких как сайты ASP.NET.

> [!IMPORTANT]
> Теневое копирование не поддерживается в приложениях [!INCLUDE[win8_appname_long](../../../includes/win8-appname-long-md.md)].

При загрузке сборки среда CLR блокирует ее файл, поэтому его нельзя обновить до тех пор, пока сборка не выгружена. Единственный способ выгрузить сборку из домена приложения — выгрузить сам домен. Таким образом, в обычных условиях сборку нельзя обновить на диске до тех пор, пока не выгружены все домены приложений, использующие ее.

Если для домена приложения настроено теневое копирование файлов, сборки по пути приложения копируются в другое расположение и загружаются из него. Копия блокируется, но исходный файл сборки разблокирован, и его можно обновить.

> [!IMPORTANT]
> Единственными сборками, которые подлежат теневому копированию, являются сборки, хранящиеся в каталоге приложения или в его подкаталогах, указанных в свойствах <xref:System.AppDomainSetup.ApplicationBase%2A> и <xref:System.AppDomainSetup.PrivateBinPath%2A> при настройке домена приложения. Хранящиеся в глобальном кэше сборки не подлежат теневому копированию.

В этом разделе содержатся следующие подразделы:

- [Включение и использование теневого копирования](#EnablingAndUsing) — содержит описание основных принципов использования и параметров, доступных для теневого копирования.

- [Производительность при запуске](#StartupPerformance) — содержит описание изменений, внесенных в теневое копирование в .NET Framework 4 с целью улучшить производительность при запуске, а также способов возврата к поведению более ранних версий.

- [Устаревшие методы](#ObsoleteMethods) — содержит описание изменений, внесенных в свойства и методы, которые контролируют теневое копирование в .NET Framework 2.0.

<a name="EnablingAndUsing"></a>

## <a name="enabling-and-using-shadow-copying"></a>Включение и использование теневого копирования

Чтобы настроить теневое копирование для домена приложения, можно использовать свойства класса <xref:System.AppDomainSetup>.

- Чтобы включить теневое копирование, присвойте свойству <xref:System.AppDomainSetup.ShadowCopyFiles%2A> строковое значение `"true"`.

  По умолчанию этот параметр вызывает копирование всех сборок по пути приложения в кэш загрузки перед их загрузкой. Это тот же кэш, который поддерживается средой CLR для хранения файлов, загруженных с других компьютеров. Среда CLR автоматически удаляет файлы, если они больше не требуются.

- При необходимости задайте произвольное местоположение для теневой копии файлов с помощью свойств <xref:System.AppDomainSetup.CachePath%2A> и <xref:System.AppDomainSetup.ApplicationName%2A>.

  Базовый путь к расположению формируется путем присоединения свойства <xref:System.AppDomainSetup.ApplicationName%2A> к свойству <xref:System.AppDomainSetup.CachePath%2A> в качестве подкаталога. Сборки копируются в подкаталоги этого пути, а не в сам путь.

  > [!NOTE]
  > Если свойство <xref:System.AppDomainSetup.ApplicationName%2A> не задано, то свойство <xref:System.AppDomainSetup.CachePath%2A> игнорируется и используется кэш загрузки. Исключение не возникает.

  Если указано пользовательское расположение, вы самостоятельно выполняете очистку каталогов и скопированных файлов, если они больше не требуются. Автоматически они не удаляются.

  Существует несколько причин, по которым рекомендуется задать пользовательское расположение для теневой копии файлов. Это может потребоваться сделать, если приложение создает большое количество копий. Кэш загрузки ограничен по размеру, а не по времени существования, поэтому возможно, что среда CLR попытается удалить файл, который все еще используется. Также пользовательское расположение следует указывать, если пользователи приложения не имеют прав на запись в каталог, который среда CLR использует для кэша загрузки.

- При необходимости можно ограничить сборки, подлежащие теневому копированию, с помощью свойства <xref:System.AppDomainSetup.ShadowCopyDirectories%2A>.

  При включении теневого копирования для домена приложения по умолчанию будут копироваться все сборки из пути приложения, то есть из каталогов, указанных в свойствах <xref:System.AppDomainSetup.ApplicationBase%2A> и <xref:System.AppDomainSetup.PrivateBinPath%2A>. Вы можете ограничить копирование выбранных каталогов, создав строку, содержащую только те каталоги, теневые копии которых требуется создать, и присвоив эту строку свойству <xref:System.AppDomainSetup.ShadowCopyDirectories%2A>. Для разделения каталогов используется точка с запятой. Единственными сборками, которые подлежат теневому копированию, являются сборки из выбранных каталогов.

  > [!NOTE]
  > Если не присвоить строку свойству <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> или присвоить ему значение `null`, выполняется теневое копирование всех сборок в каталогах, указанных в свойствах <xref:System.AppDomainSetup.ApplicationBase%2A> и <xref:System.AppDomainSetup.PrivateBinPath%2A>.

  > [!IMPORTANT]
  > Пути к каталогам не должны содержать точку с запятой, так как она является разделителем. Escape-символа для точки с запятой не существует.

<a name="StartupPerformance"></a>

## <a name="startup-performance"></a>Производительность при запуске

Когда запускается домен приложения, использующий теневое копирование, возникает задержка, пока сборки копируются из каталога приложения в каталог теневого копирования или проверяются, если они уже находятся в этом каталоге. До появления .NET Framework 4 все сборки копировались во временный каталог. Каждая сборка открывалась для проверки имени сборки и строгого имени. Каждая сборка проверялась на предмет того, обновлялась ли она позднее копии в каталоге теневого копирования. Если это было так, сборка копировалась в каталог теневого копирования. Наконец, временные копии удалялись.

Начиная с .NET Framework 4 при запуске по умолчанию происходит прямое сравнение даты и времени файла каждой сборки в каталоге приложения с датой и временем копии файла в каталоге теневого копирования. Если сборка была обновлена, она копируется с использованием той же процедуры, что и в более ранних версиях .NET Framework; в противном случае загружается копия из каталога теневого копирования.

Повышение итоговой производительности является наибольшим для приложений, сборки которых меняются нечасто, а изменения обычно появляются в небольшом подмножестве сборок. Если большинство сборок приложения меняется часто, новое поведение по умолчанию может явиться причиной снижения производительности. Можно восстановить поведение при запуске предыдущих версий .NET Framework, добавив [элемент \<shadowCopyVerifyByTimestamp>](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md) в файл конфигурации с логическим значением `enabled="false"`.

<a name="ObsoleteMethods"></a>

## <a name="obsolete-methods"></a>Устаревшие методы

Класс <xref:System.AppDomain> имеет несколько методов, например <xref:System.AppDomain.SetShadowCopyFiles%2A> и <xref:System.AppDomain.ClearShadowCopyPath%2A>, которые можно использовать для управления теневым копированием в домене приложения, но в .NET Framework версии 2.0 они были помечены как устаревшие. Рекомендуемый способ настройки теневого копирования для домена приложения — это использование свойств класса <xref:System.AppDomainSetup>.

## <a name="see-also"></a>См. также

- <xref:System.AppDomainSetup.ShadowCopyFiles%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.CachePath%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.ApplicationName%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.ShadowCopyDirectories%2A?displayProperty=nameWithType>
- [Элемент \<shadowCopyVerifyByTimeStamp>](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md)
