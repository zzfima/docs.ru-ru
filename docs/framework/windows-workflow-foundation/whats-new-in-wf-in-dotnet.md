---
title: Новые возможности Windows Workflow Foundation в .NET 4.5
ms.date: 03/30/2017
ms.assetid: 195c43a8-e0a8-43d9-aead-d65a9e6751ec
ms.openlocfilehash: b14f18dce64bc5738f3d3c6af11d6d6224764486
ms.sourcegitcommit: 7e2128d4a4c45b4274bea3b8e5760d4694569ca1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75937890"
---
# <a name="whats-new-in-windows-workflow-foundation-in-net-45"></a>Новые возможности Windows Workflow Foundation в .NET 4.5

Windows Workflow Foundation (WF) в .NET Framework 4,5 содержит множество новых функций, таких как новые действия, возможности конструктора и модели разработки рабочих процессов. В повторно размещенном конструкторе рабочих процессов поддерживаются многие, но не все новые функции рабочего процесса, появившиеся в .NET Framework 4,5. Дополнительные сведения о новых поддерживаемых функциях см. [в разделе Поддержка новых функций Workflow Foundation 4,5 в переразмещенной конструктор рабочих процессов](wf-features-in-the-rehosted-workflow-designer.md). Дополнительные сведения о переносе приложений рабочих процессов .NET 3,0 и .NET 3,5 на использование последней версии см. в [руководстве по миграции](migration-guidance.md). В этом разделе приводятся общие сведения о новых возможностях рабочих процессов, появившихся в .NET Framework 4,5.

> [!WARNING]
> Новые функции Windows Workflow Foundation, появившиеся в .NET Framework 4,5, недоступны для проектов, предназначенных для предыдущих версий платформы. Если проект, предназначенный для .NET Framework 4,5, перенацелен на предыдущую версию платформы, могут возникнуть некоторые проблемы.
>
> - C#выражения будут заменены в конструкторе, при этом **значение сообщения было задано в XAML**.
> - Возникнут многие ошибки сборки, включая следующую.
>
> **Формат файла несовместим с текущей платформой для нацеливания. Чтобы преобразовать формат файла, необходимо явно сохранить файл. Это сообщение об ошибке будет отправлено после сохранения файла и повторного открытия конструктора.**

## <a name="BKMK_Versioning"></a>Управление версиями рабочих процессов

В .NET Framework 4,5 появились несколько новых функций управления версиями на основе нового класса <xref:System.Activities.WorkflowIdentity>. <xref:System.Activities.WorkflowIdentity> позволяет авторам приложений рабочего процесса сопоставить сохраненный экземпляр рабочего процесса с его определением.

- Разработчики, использующие среду размещения <xref:System.Activities.WorkflowApplication>, могут использовать <xref:System.Activities.WorkflowIdentity> для параллельного размещения нескольких версий рабочего процесса. Сохраненные экземпляры рабочего процесса можно загрузить с помощью нового класса <xref:System.Activities.WorkflowApplicationInstance>, а затем узел может использовать <xref:System.Activities.WorkflowApplicationInstance.DefinitionIdentity%2A> для предоставления правильной версии определения рабочего процесса при создании экземпляра <xref:System.Activities.WorkflowApplication>. Дополнительные сведения см. в статьях [Использование WorkflowIdentity и управление версиями](using-workflowidentity-and-versioning.md) и [инструкции: размещение нескольких версий рабочего процесса параллельно](how-to-host-multiple-versions-of-a-workflow-side-by-side.md).

- Узел <xref:System.ServiceModel.WorkflowServiceHost> может теперь содержать несколько версий. Когда развертывается новая версия службы рабочего процесса, новые экземпляры создаются с помощью новой службы, но существующие экземпляры завершают работу, используя предыдущую версию. Дополнительные сведения см. [в разделе параллельное управление версиями в WorkflowServiceHost](../wcf/feature-details/side-by-side-versioning-in-workflowservicehost.md).

- Введено динамическое обновление, которое позволяет обновить определение сохраненного экземпляра рабочего процесса. Дополнительные сведения см. в разделе [динамическое обновление](dynamic-update.md) и [инструкции: обновление определения выполняющегося экземпляра рабочего процесса](how-to-update-the-definition-of-a-running-workflow-instance.md).

- Для обновления баз данных сохраняемости, созданных с помощью скриптов базы данных .NET Framework 4, предоставляется скрипт базы данных SqlWorkflowInstanceStoreSchemaUpgrade. SQL. Этот сценарий обновляет .NET Framework 4 базы данных сохраняемости для поддержки новых возможностей управления версиями, появившихся в .NET Framework 4,5. Сохраняемые экземпляры рабочих процессов в базе данных получают значения управления версиями по умолчанию и могут участвовать в параллельном выполнении и динамическом обновлении. Дополнительные сведения см. [в статье обновление .NET Framework 4 базы данных сохраняемости для поддержки управления версиями рабочих процессов](using-workflowidentity-and-versioning.md#UpdatingWF4PersistenceDatabases).

## <a name="BKMK_NewActivities"></a>Процедур

Встроенная библиотека действий содержит новые действия, а также новые функции для существующих действий.

### <a name="BKMK_NoPersistScope"></a>Несохраняемая область

<xref:System.Activities.Statements.NoPersistScope> - новое действие контейнера, которое предотвращает сохранение рабочего процесса, когда выполняются дочерние действия NoPersistScope. Это полезно в сценариях, где рабочие процессы не должны сохраняться, например если рабочий процесс использует ресурсы конкретной машины (дескрипторы файлов и т. п.), или во время транзакций базы данных. Раньше для предотвращения сохранения во время выполнения действия требовался пользовательский класс <xref:System.Activities.NativeActivity>, который использовал <xref:System.Activities.NoPersistHandle>.

### <a name="BKMK_NewFlowchartCapabilities"></a>Новые возможности блок-схем

Блок-схемы обновляются для .NET Framework 4,5 и имеют следующие новые возможности:

- Свойство `DisplayName` действия <xref:System.Activities.Statements.FlowSwitch%601> или <xref:System.Activities.Statements.FlowDecision> теперь можно редактировать. Это позволит конструктору действий показать больше сведений о цели действия.

- Блок-схемы имеют новое свойство <xref:System.Activities.Statements.Flowchart.ValidateUnconnectedNodes%2A>. Значение этого свойства по умолчанию - `False`. Если назначить этому свойству значение `True`, несоединенные узлы блок-схемы вызовут ошибки проверки.

## <a name="support-for-partial-trust"></a>Поддержка частичного уровня доверия

Для рабочих процессов в .NET Framework 4 требуется полностью доверенный домен приложения. В .NET Framework 4,5 рабочие процессы могут обрабатываться в среде с частичным доверием. В среде с частичным уровнем доверия можно использовать компоненты сторонних производителей, не предоставляя им полный доступ к ресурсам узла. Выполнение рабочих процессов в частичном уровне доверия может создать следующие проблемы.

1. В режиме частичного уровня доверия компоненты прежних версий (включая правила) не могут использоваться в действии <xref:System.Activities.Statements.Interop>.

2. Выполнение рабочих процессов в <xref:System.ServiceModel.WorkflowServiceHost> в режиме частичного уровня доверия не поддерживается.

3. Сохранение исключений в сценариях с частичным доверием создает потенциальную угрозу безопасности. Чтобы исключения не сохранялись, необходимо добавить в проект расширение типа <xref:System.Activities.ExceptionPersistenceExtension>, чтобы явно отказаться от сохранения исключений. В следующем примере кода показано, как реализовать этот тип.

    ```csharp
    public class ExceptionPersistenceExtension
    {
        public ExceptionPersistenceExtension()
        {
            this.PersistExceptions = false;
        }
        public bool PersistExceptions { get; set; }
    }
    ```

     Если исключения не должны сериализоваться, убедитесь в том, что они используются в <xref:System.Activities.Statements.NoPersistScope>.

4. Создатели действия должны переопределить метод <xref:System.Activities.Activity.CacheMetadata%2A>, чтобы в среде выполнения рабочего процесса отражение не использовалось автоматически для этого типа. Аргументы и дочерние действия не должны иметь значение NULL, а метод <xref:System.Activities.ActivityMetadata.Bind%2A> должен вызываться явным образом. Дополнительные сведения о переопределении <xref:System.Activities.Activity.CacheMetadata%2A>см. в разделе [предоставление данных с помощью CacheMetadata](exposing-data-with-cachemetadata.md). Кроме того, экземпляры аргументов, которые имеют тип, `internal` или **Private** , должны быть явно созданы в <xref:System.Activities.Activity.CacheMetadata%2A>, чтобы избежать их создания с помощью отражения.

5. Типы не будут использовать <xref:System.Runtime.Serialization.ISerializable> или <xref:System.SerializableAttribute> для сериализации. Типы, которые должны быть сериализованы, должны поддерживать <xref:System.Runtime.Serialization.DataContractSerializer>.

6. Выражениям, в которых используется <xref:System.Activities.Expressions.LambdaValue%601>, требуется <xref:System.Security.Permissions.ReflectionPermissionAttribute.RestrictedMemberAccess%2A>. Следовательно, они не будут работать в режиме частичного уровня доверия. Рабочие процессы, использующие <xref:System.Activities.Expressions.LambdaValue%601>, должны заменить эти выражения на действия, производные от <xref:System.Activities.CodeActivity%601>. .

7. В режиме частичного уровня доверия выражения не могут компилироваться с помощью <xref:System.Activities.XamlIntegration.TextExpressionCompiler> или размещенного компилятора Visual Basic, но ранее скомпилированные выражения будут работать.

8. Одна сборка, использующая [прозрачность уровня 2](https://aka.ms/Level2Transparency) , не может использоваться в .NET Framework 4, [!INCLUDE[netfx_current_short](../../../includes/netfx-current-short-md.md)] с полным доверием и [!INCLUDE[netfx_current_short](../../../includes/netfx-current-short-md.md)] в режиме частичного доверия.

## <a name="BKMK_NewDesignerCapabilites"></a>Новые возможности конструктора

### <a name="BKMK_DesignerSearch"></a>Поиск в конструкторе

Чтобы лучше управлять крупными рабочими процессами, поиск в них теперь возможен по ключевому слову. Эта функция доступна только в Visual Studio; Эта функция недоступна в повторно размещенном конструкторе. Возможны два вида поиска.

- Быстрый поиск, инициированный с помощью **клавиш CTRL + F** или **Правка**, **Поиск и замена**, **Быстрый поиск**.

- Поиск в файлах, инициированный с помощью **клавиш CTRL + SHIFT + F** или **Правка**, **Поиск и замена**, **Поиск в файлах**.

Обратите внимание, что команда «Заменить» не поддерживается.

#### <a name="BKMK_QuickFind"></a>Быстрый поиск

Ключевые слова, по которым выполняется поиск в рабочих процессах, будут соответствовать следующим элементам конструктора.

- Свойства объектов <xref:System.Activities.Activity>, объектов <xref:System.Activities.Statements.FlowNode>, объектов <xref:System.Activities.Statements.State>, объектов <xref:System.Activities.Statements.Transition> и других пользовательских элементов управления потоками.

- Переменные

- Arguments

- Выражения

Быстрый поиск выполняется в дереве конструктора <xref:System.Activities.Presentation.Model.ModelItem>. Быстрый поиск не обнаружит пространства имен, импортированные в определение рабочего процесса.

#### <a name="BKMK_FindInFiles"></a>Найти в файлах

Ключевые слова, по которым выполняется поиск в рабочих процессах, будут соответствовать фактическому содержимому файлов рабочего процесса. Результаты поиска будут показаны на панели представления результатов поиска в Visual Studio. Если дважды щелкнуть элемент в результатах, произойдет переход к действию, содержащему искомый элемент в конструкторе рабочих процессов.

### <a name="BKMK_VariableDeleteContextMenu"></a>Удалить пункт контекстного меню в конструкторе переменных и аргументов

В .NET Framework 4 переменные и аргументы можно удалять только в конструкторе с помощью клавиатуры. Начиная с .NET Framework 4,5 переменные и аргументы можно удалить с помощью контекстного меню.

На следующем снимке экрана показано контекстное меню конструктора переменных и аргументов.

![Контекстное меню конструктора переменных и аргументов](./media/whats-new-in-wf-in-dotnet/designer-context-menu.png)

### <a name="BKMK_AutoSurround"></a>Автоматическое обрамление с последовательностью

Поскольку рабочий процесс или некоторые действия с контейнерами (например, <xref:System.Activities.Statements.NoPersistScope>) могут содержать только одно действие с текстом, при добавлении второго действия разработчик должен удалить первое действие, добавить действие <xref:System.Activities.Statements.Sequence>, а затем добавить оба действия в действие последовательности. Начиная с .NET Framework 4,5, при добавлении второго действия в рабочую область конструктора автоматически создается действие `Sequence` для создания оболочки обоих действий.

На следующем снимке экрана показано действие `WriteLine` в `Body` для `NoPersistScope`.

![Действие WriteLine в теле действия NoPersistScope.](./media/whats-new-in-wf-in-dotnet/auto-surround-write-line-activity.png)

На следующем снимке экрана показано автоматически созданное действие `Sequence` в `Body`, когда второй объект `WriteLine` сбрасывается ниже первого.

![Автоматически созданная последовательность в теле NoPersistScope.](./media/whats-new-in-wf-in-dotnet/auto-surround-sequence-activity.png)

### <a name="BKMK_PanMode"></a>Режим Pan

Для упрощения навигации по большому рабочему процессу в конструкторе можно включить панорамный режим, позволяющий разработчику перетаскивать мышью видимую часть рабочего процесса и не использовать полосы прокрутки. Кнопка для активации панорамного режима находится в правом нижнем углу конструктора.

На следующем снимке экрана показана кнопка панорамирования, расположенная в правом нижнем углу конструктора рабочих процессов.

![Кнопка сдвига, выделенная в конструкторе рабочих процессов.](./media/whats-new-in-wf-in-dotnet/pan-button-workflow-designer.png)

Панорамирование в конструкторе рабочих процессов возможно также с помощью средней кнопки мыши или клавиши пробела.

### <a name="BKMK_MultiSelect"></a>Множественный выбор

Для одновременного выбора нескольких действий можно растянуть вокруг них прямоугольник (если не включен панорамный режим) или последовательно щелкнуть необходимые действия при нажатой клавише CTRL.

Несколько выделенных действий можно перетаскивать внутри конструктора, а также взаимодействовать с ними с помощью контекстного меню.

### <a name="BKMK_DocumentOutline"></a>представление "Структура" элементов рабочего процесса

Для упрощения навигации по иерархическим рабочим процессам компоненты рабочего процесса отображаются в виде древовидной структуры. Представление структуры отображается в представлении « **Структура документа** ». Чтобы открыть это представление, в верхнем меню выберите **вид**, **другие окна**, **Структура документа**или нажмите клавиши CTRL W, U. Щелкнув узел в представлении структуры, можно перейти к соответствующему действию в конструкторе рабочих процессов. Представление структуры будет обновлено с отображением действий, выбранных в конструкторе.

На следующем снимке экрана завершенного рабочего процесса из [учебника начало работы](getting-started-tutorial.md) показано представление структуры с последовательным рабочим процессом.

![Снимок экрана: представление структуры с последовательным рабочим процессом в Visual Studio.](./media/whats-new-in-wf-in-dotnet/outline-view-in-workflow-designer.jpg)

### <a name="BKMK_CSharpExpressions"></a>C# Выражения

До .NET Framework 4,5 все выражения в рабочих процессах могут быть написаны только на Visual Basic. В .NET Framework 4,5 выражения Visual Basic используются только для проектов, созданных с помощью Visual Basic. Теперь в проектах Visual C# для выражений используется язык C#. Предоставлен полнофункциональный редактор выражений C# с такими возможностями, как выделение грамматики и технология Intellisense. Проекты рабочих процессов C#, созданные в предыдущих версиях с использованием выражений Visual Basic, будут по-прежнему работать.

Выражения на C# проверяются во время разработки. Ошибки в выражениях C# будут помечены подчеркиванием красной волнистой линией.

Дополнительные сведения о C# выражениях см. в разделе [ C# выражения](csharp-expressions.md).

### <a name="BKMK_Visibility"></a>Более полное управление видимостью панели оболочки и элементов заголовка

В повторно размещенном конструкторе некоторые из стандартных элементов управления пользовательского интерфейса могут не иметь значения для заданного рабочего процесса и могут быть отключены. В .NET Framework 4 Эта настройка поддерживается только в панели оболочки в нижней части конструктора. В .NET Framework 4,5 можно настроить видимость элементов заголовка оболочки в верхней части конструктора, задав <xref:System.Activities.Presentation.View.DesignerView.WorkflowShellHeaderItemsVisibility%2A> с соответствующим значением <xref:System.Activities.Presentation.View.ShellHeaderItemsVisibility>.

### <a name="BKMK_AutoConnect"></a>Автоматическое подключение и автоматическая вставка в блок-схеме и в рабочих процессах конечного автомата

В .NET Framework 4 подключения между узлами в рабочем процессе блок-схемы должны быть добавлены вручную. В .NET Framework 4,5, блок-схема и узлы конечного автомата имеют автоматические точки соединения, которые становятся видимыми при перетаскивании действия с панели элементов на поверхность конструктора. При сбросе действия в одной из этих точек автоматически добавляется действие вместе с необходимым соединением.

На следующем снимке экрана показаны точки присоединения, которые появляются при перетаскивании действия из области элементов.

![Начальный узел блок-схемы с точками автоматического подключения](./media/whats-new-in-wf-in-dotnet/auto-connect-points-start-node.png)

Действия можно также перетаскивать на соединения между узлами блок-схемы и состояниями для автоматической вставки узла между двумя другими узлами. На следующем снимке экрана показана выделенная соединительная линия, на которую можно перетаскивать действия из области элементов.

![Ручка автоматической вставки для действий сброса](./media/whats-new-in-wf-in-dotnet/auto-insert-connecting-line.png)

### <a name="BKMK_Annotations"></a>Заметки конструктора

Для упрощения разработки крупных рабочих процессов конструктор теперь поддерживает добавление заметок, помогающих отслеживать процесс проектирования. Заметки можно добавлять к действиям, состояниям, узлам блок-схемы, переменным и аргументам. На следующем снимке экрана показано контекстное меню, которое используется для добавления заметок к конструктору.

![Снимок экрана, показывающий меню для добавления заметок.](./media/whats-new-in-wf-in-dotnet/designer-annotations-context-menu.png)

### <a name="debugging-states"></a>Состояния отладки

В .NET Framework 4 элементы, не являющиеся элементами активности, не поддерживают отладочные точки останова, так как они не были единицами выполнения. Этот выпуск предоставляет механизм для добавления точек останова в объекты <xref:System.Activities.Statements.State>. Если задана точка останова на состоянии <xref:System.Activities.Statements.State>, выполнение прервется, когда произойдет переход в это состояние, прежде чем будут запланированы действия входа в состояние или триггеры.

### <a name="BKMK_ActivityDelegates"></a>Определение и использование объектов ActivityDelegate в конструкторе

Действия в .NET Framework 4 используются <xref:System.Activities.ActivityDelegate> объектов для предоставления точек выполнения, где другие части рабочего процесса могут взаимодействовать с выполнением рабочего процесса, но использование этих точек выполнения обычно требует достаточного количества кода. В этом выпуске разработчики могут определять и использовать делегаты действий с помощью конструктора рабочих процессов. Дополнительные сведения см. в разделе [инструкции. Определение и использование делегатов действий в конструктор рабочих процессов](/visualstudio/workflow-designer/how-to-define-and-consume-activity-delegates-in-the-workflow-designer).

### <a name="BKMK_BuildTimeValidation"></a>Проверка во время сборки

В .NET Framework 4 ошибки проверки рабочего процесса не учитывались как ошибки сборки во время сборки проекта рабочего процесса. Это значило, что сборка проекта рабочего процесса могло завершиться успешно даже при наличии ошибок проверки рабочего процесса. В .NET Framework 4,5 ошибки проверки рабочего процесса приводят к сбою сборки.

### <a name="BKMK_DesignTimeValidation"></a>Фоновая проверка во время разработки

В .NET Framework 4 рабочие процессы проверялись как процесс переднего плана, что потенциально может заблокировать пользовательский интерфейс во время сложных или длительных процессов проверки. Теперь проверка рабочего процесса выполняется в фоновом потоке, поэтому пользовательский интерфейс не блокируется.

### <a name="BKMK_ViewState"></a>Состояние представления, расположенное в отдельном месте в файлах XAML

В .NET Framework 4 сведения о состоянии представления для рабочего процесса хранятся в файле XAML во многих разных местах. Это неудобно для разработчиков, которым требуется прочитать язык XAML напрямую или написать код для извлечения информации о состоянии просмотра. В .NET Framework 4,5 сведения о состоянии представления в файле XAML сериализуются как отдельный элемент в файле XAML. Разработчики могут легко находить и изменять сведения о состоянии представления действия или полностью удалить состояние представления.

### <a name="BKMK_ExpressionExtensibility"></a>Расширяемость выражений

В .NET Framework 4,5 мы предоставляем разработчикам возможность создавать собственные выражения и функции создания выражений, которые можно подключить к конструктору рабочих процессов.

### <a name="BKMK_BackwardCompatRehostedDesigner"></a>Согласие на функции рабочего процесса 4,5 в повторно размещенном конструкторе

Для сохранения обратной совместимости некоторые новые функции, включенные в .NET Framework 4,5, не включены по умолчанию в повторно размещенном конструкторе. Таким образом, работа существующих приложений, использующих повторно размещенный конструктор, не нарушается обновлением до последней версии. Для включения новых возможностей в повторно размещенном конструкторе установите значение <xref:System.Activities.Presentation.DesignerConfigurationService.TargetFrameworkName%2A> для параметра «.NET Framework 4.5» или задайте отдельные элементы <xref:System.Activities.Presentation.DesignerConfigurationService>, чтобы включить отдельные возможности.

## <a name="BKMK_NewWFModels"></a>Новые модели разработки рабочих процессов

Помимо блок-схемы и последовательных моделей разработки рабочего процесса, этот выпуск включает рабочие процессы конечного автомата и службы рабочего процесса с первоначальным контрактом.

### <a name="BKMK_StateMachine"></a>Рабочие процессы конечного автомата

Рабочие процессы конечного автомата были представлены в составе .NET Framework 4, версии 4.0.1 в [Microsoft .NET Framework 4 платформы с обновлением 1](https://docs.microsoft.com/archive/blogs/endpoint/microsoft-net-framework-4-platform-update-1). Это обновление включило несколько новых классов и действий, которые дали возможность разработчикам создавать рабочие процессы конечного автомата. Эти классы и действия были обновлены для .NET Framework 4,5. Обновления включают следующее:

1. Возможность установки точек останова на состояниях

2. Возможность копирования и вставки переходов в конструкторе рабочих процессов

3. Поддержка совместного создания перехода триггера в конструкторе

4. Действия для создания рабочих процессов конечного автомата, включая <xref:System.Activities.Statements.StateMachine>, <xref:System.Activities.Statements.State> и <xref:System.Activities.Statements.Transition>

На следующем снимке экрана показан завершенный рабочий процесс конечного автомата из [руководства Начало работы](getting-started-tutorial.md) пошаговое руководство [. Создание рабочего процесса конечного автомата](how-to-create-a-state-machine-workflow.md).

![Иллюстрация, показывающая Завершенный рабочий процесс конечного автомата.](./media/whats-new-in-wf-in-dotnet/complete-state-machine-workflow.jpg)

Дополнительные сведения о создании рабочих процессов конечного автомата см. в разделе [рабочие процессы конечного автомата](state-machine-workflows.md).

### <a name="BKMK_ContractFirst"></a>Разработка рабочих процессов по контракту

Средство разработки рабочих процессов с контрактом от первого разработчика позволяет разработчику сначала спроектировать контракт в коде, а затем, выполнив несколько щелчков мышью в Visual Studio, автоматически создать шаблон действия на панели элементов, представляющем каждую операцию. Эти действия затем используются для создания рабочего процесса с операциями, указанными в контракте. Конструктор рабочих процессов проверяет службу рабочего процесса для проверки того, что эти операции реализованы, а сигнатура рабочего процесса соответствует сигнатуре контракта. Разработчик также может связать службу рабочего процесса с коллекцией реализованных контрактов. Дополнительные сведения о разработке службы рабочих процессов в зависимости от контракта см. в разделе [как создать службу рабочего процесса, которая использует существующий контракт службы](how-to-create-a-workflow-service-that-consumes-an-existing-service-contract.md).
