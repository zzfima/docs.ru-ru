---
title: Использование каналов OData из рабочего процесса — WF
ms.date: 03/30/2017
ms.assetid: 1b26617c-53e9-476a-81af-675c36d95919
ms.openlocfilehash: ceac2c2d07351fcb79e2345068f07fa22f356411
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76743792"
---
# <a name="consuming-odata-feeds-from-a-workflow"></a><span data-ttu-id="a3c6d-102">Использование каналов OData из рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="a3c6d-102">Consuming OData feeds from a workflow</span></span>

<span data-ttu-id="a3c6d-103">WCF Data Services является компонентом .NET Framework, который позволяет создавать службы, использующие Open Data Protocol (OData) для предоставления и использования данных в Интернете или интрасети с помощью семантики передачи состояния представления (остальное).</span><span class="sxs-lookup"><span data-stu-id="a3c6d-103">WCF Data Services is a component of the .NET Framework that enables you to create services that use the Open Data Protocol (OData) to expose and consume data over the Web or intranet by using the semantics of representational state transfer (REST).</span></span> <span data-ttu-id="a3c6d-104">OData предоставляет доступ к данным в виде ресурсов, которые адресуются по URI.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-104">OData exposes data as resources that are addressable by URIs.</span></span> <span data-ttu-id="a3c6d-105">Со службами данных, основанными на OData, может взаимодействовать любое приложение, которое способно отправить HTTP-запрос и обработать канал OData, возвращаемый службой данных.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-105">Any application can interact with an OData-based data service if it can send an HTTP request and process the OData feed that a data service returns.</span></span> <span data-ttu-id="a3c6d-106">Кроме того, WCF Data Services включает клиентские библиотеки, обеспечивающие более широкие возможности программирования при использовании веб-каналов OData из .NET Framework приложений.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-106">In addition, WCF Data Services includes client libraries that provide a richer programming experience when you consume OData feeds from .NET Framework applications.</span></span> <span data-ttu-id="a3c6d-107">В этом разделе представлены общие сведения об использовании каналов OData в рабочем процессе как с клиентскими библиотеками, так и без них.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-107">This topic provides an overview of consuming an OData feed in a workflow with and without using the client libraries.</span></span>

## <a name="using-the-sample-northwind-odata-service"></a><span data-ttu-id="a3c6d-108">Использование примера службы OData "Борей"</span><span class="sxs-lookup"><span data-stu-id="a3c6d-108">Using the sample Northwind OData service</span></span>

<span data-ttu-id="a3c6d-109">В примерах этого раздела используется образец службы данных Northwind, расположенный по адресу <https://services.odata.org/Northwind/Northwind.svc/>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-109">The examples in this topic use the sample Northwind data service located at <https://services.odata.org/Northwind/Northwind.svc/>.</span></span> <span data-ttu-id="a3c6d-110">Эта служба поставляется в составе [пакета SDK OData](https://www.odata.org/ecosystem/#sdk) и предоставляет доступ только для чтения к образцу базы данных "Борей".</span><span class="sxs-lookup"><span data-stu-id="a3c6d-110">This service is provided as part of the [OData SDK](https://www.odata.org/ecosystem/#sdk) and provides read-only access to the sample Northwind database.</span></span> <span data-ttu-id="a3c6d-111">Если необходим доступ для чтения или локальная служба данных WCF, то можно выполнить действия, описанные в [кратком руководстве по службам данных WCF](../data/wcf/quickstart-wcf-data-services.md) , чтобы создать локальную службу OData, обеспечивающую доступ к базе данных "Борей".</span><span class="sxs-lookup"><span data-stu-id="a3c6d-111">If write access is desired, or if a local WCF Data Service is desired, you can follow the steps of the [WCF Data Services Quickstart](../data/wcf/quickstart-wcf-data-services.md) to create a local OData service that provides access to the Northwind database.</span></span> <span data-ttu-id="a3c6d-112">При выполнении инструкций, описанных в кратком руководстве, необходимо заменить локальный URI на тот, который указан в коде в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-112">If you follow the quickstart, substitute the local URI for the one provided in the example code in this topic.</span></span>

## <a name="consuming-an-odata-feed-using-the-client-libraries"></a><span data-ttu-id="a3c6d-113">Использование веб-канала OData с помощью клиентских библиотек</span><span class="sxs-lookup"><span data-stu-id="a3c6d-113">Consuming an OData feed using the client libraries</span></span>

<span data-ttu-id="a3c6d-114">WCF Data Services включает клиентские библиотеки, которые позволяют более просто использовать веб-канал OData из .NET Framework и клиентских приложений.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-114">WCF Data Services includes client libraries that enable you to more easily consume an OData feed from .NET Framework and client applications.</span></span> <span data-ttu-id="a3c6d-115">Эти библиотеки упрощают отправку и получение сообщений HTTP.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-115">These libraries simplify sending and receiving HTTP messages.</span></span> <span data-ttu-id="a3c6d-116">Кроме того, они преобразуют полезные данные сообщений в объекты CLR, представляющие данные сущностей.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-116">They also translate the message payload into CLR objects that represent entity data.</span></span> <span data-ttu-id="a3c6d-117">Клиентские библиотеки содержат два базовых класса: <xref:System.Data.Services.Client.DataServiceContext> и <xref:System.Data.Services.Client.DataServiceQuery%601>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-117">The client libraries feature the two core classes <xref:System.Data.Services.Client.DataServiceContext> and <xref:System.Data.Services.Client.DataServiceQuery%601>.</span></span> <span data-ttu-id="a3c6d-118">Эти классы позволяют отправлять запросы к службе данных и работать с возвращенными данными сущностей как с объектами CLR.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-118">These classes enable you to query a data service and then work with the returned entity data as CLR objects.</span></span> <span data-ttu-id="a3c6d-119">В этом разделе описаны два подхода к созданию действий, в которых используются клиентские библиотеки.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-119">This section covers two approaches to creating activities that use the client libraries.</span></span>

### <a name="adding-a-service-reference-to-the-wcf-data-service"></a><span data-ttu-id="a3c6d-120">Добавление ссылки на службу WCF Data Service</span><span class="sxs-lookup"><span data-stu-id="a3c6d-120">Adding a service reference to the WCF Data service</span></span>

<span data-ttu-id="a3c6d-121">Чтобы создать клиентские библиотеки "Борей", можно использовать диалоговое окно **Добавление ссылки на службу** в Visual Studio 2012, чтобы добавить ссылку на службу OData "Борей".</span><span class="sxs-lookup"><span data-stu-id="a3c6d-121">To generate the Northwind client libraries, you can use the **Add Service Reference** dialog box in Visual Studio 2012 to add a reference to the Northwind OData service.</span></span>

![Снимок экрана, на котором показано диалоговое окно Добавление ссылки на службу.](./media/consuming-odata-feeds-from-a-workflow/add-service-reference-dialog.gif)

<span data-ttu-id="a3c6d-123">Обратите внимание, что эта служба не предоставляет доступ к операциям службы, а в списке **Службы** имеются элементы, представляющие сущности, предоставляемые службой данных «Борей».</span><span class="sxs-lookup"><span data-stu-id="a3c6d-123">Note that there are no service operations exposed by the service, and in the **Services** list there are items representing the entities exposed by the Northwind data service.</span></span> <span data-ttu-id="a3c6d-124">При добавлении ссылки на службу для этих сущностей будут созданы классы, которые будут использоваться в клиентском коде.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-124">When the service reference is added, classes will be generated for these entities and they can be used in the client code.</span></span> <span data-ttu-id="a3c6d-125">В примерах в этом разделе для выполнения запросов используются эти классы, а также `NorthwindEntities` .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-125">The examples in this topic use these classes and the `NorthwindEntities` class to perform the queries.</span></span>

> [!NOTE]
> <span data-ttu-id="a3c6d-126">Дополнительные сведения см. [в разделе Создание клиентской библиотеки службы данных (WCF Data Services)](../data/wcf/generating-the-data-service-client-library-wcf-data-services.md).</span><span class="sxs-lookup"><span data-stu-id="a3c6d-126">For more information, see [Generating the Data Service Client Library (WCF Data Services)](../data/wcf/generating-the-data-service-client-library-wcf-data-services.md).</span></span>

### <a name="using-asynchronous-methods"></a><span data-ttu-id="a3c6d-127">Использование асинхронных методов</span><span class="sxs-lookup"><span data-stu-id="a3c6d-127">Using asynchronous methods</span></span>

<span data-ttu-id="a3c6d-128">Для разрешения возможных проблем с задержками, которые могут произойти при обращении к ресурсам через Интернет, рекомендуется производить обращения к службам данных WCF асинхронно.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-128">To address possible latency issues that may occur when accessing resources over the Web, we recommend accessing WCF Data Services asynchronously.</span></span> <span data-ttu-id="a3c6d-129">WCF Data Services клиентские библиотеки содержат асинхронные методы для вызова запросов, а Windows Workflow Foundation (WF) предоставляет класс <xref:System.Activities.AsyncCodeActivity> для создания асинхронных действий.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-129">The WCF Data Services client libraries include asynchronous methods for invoking queries, and Windows Workflow Foundation (WF) provides the <xref:System.Activities.AsyncCodeActivity> class for authoring asynchronous activities.</span></span> <span data-ttu-id="a3c6d-130"><xref:System.Activities.AsyncCodeActivity> производных действий можно написать, чтобы воспользоваться преимуществами .NET Framework классов, которые имеют асинхронные методы, или код для асинхронного выполнения может быть помещен в метод и вызываться с помощью делегата.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-130"><xref:System.Activities.AsyncCodeActivity> derived activities can be written to take advantage of .NET Framework classes that have asynchronous methods, or the code to be executed asynchronously can be put into a method and invoked by using a delegate.</span></span> <span data-ttu-id="a3c6d-131">В этом разделе приводятся два примера действия, являющегося производным от <xref:System.Activities.AsyncCodeActivity> , - одно из них использует асинхронные методы клиентских библиотек служб данных WCF, а второе - делегат.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-131">This section provides two examples of an <xref:System.Activities.AsyncCodeActivity> derived activity; one that uses the asynchronous methods of the WCF Data Services client libraries and one that uses a delegate.</span></span>

> [!NOTE]
> <span data-ttu-id="a3c6d-132">Дополнительные сведения см. в разделе [асинхронные операции (WCF Data Services)](../data/wcf/asynchronous-operations-wcf-data-services.md) и [Создание асинхронных действий](creating-asynchronous-activities-in-wf.md).</span><span class="sxs-lookup"><span data-stu-id="a3c6d-132">For more information, see [Asynchronous Operations (WCF Data Services)](../data/wcf/asynchronous-operations-wcf-data-services.md) and [Creating Asynchronous Activities](creating-asynchronous-activities-in-wf.md).</span></span>

### <a name="using-client-library-asynchronous-methods"></a><span data-ttu-id="a3c6d-133">Использование асинхронных методов клиентской библиотеки</span><span class="sxs-lookup"><span data-stu-id="a3c6d-133">Using client library asynchronous methods</span></span>

<span data-ttu-id="a3c6d-134">Класс <xref:System.Data.Services.Client.DataServiceQuery%601> предусматривает методы <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> и <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> для асинхронных запросов службы OData.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-134">The <xref:System.Data.Services.Client.DataServiceQuery%601> class provides <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> and <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> methods for querying an OData service asynchronously.</span></span> <span data-ttu-id="a3c6d-135">Эти методы могут быть вызваны из переопределений <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> и <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> класса, производного от <xref:System.Activities.AsyncCodeActivity> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-135">These methods can be called from the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> overrides of an <xref:System.Activities.AsyncCodeActivity> derived class.</span></span> <span data-ttu-id="a3c6d-136">Когда переопределение <xref:System.Activities.AsyncCodeActivity> <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> возвращает, Рабочий процесс может переходить в режим простоя (но не сохраняться) и после завершения асинхронной работы <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> вызываться средой выполнения.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-136">When the <xref:System.Activities.AsyncCodeActivity> <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override returns, the workflow can go idle (but not persist), and when the asynchronous work is completed, <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> is invoked by the runtime.</span></span>

<span data-ttu-id="a3c6d-137">В следующем примере действие `OrdersByCustomer` определено с двумя входными аргументами.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-137">In the following example, an `OrdersByCustomer` activity is defined that has two input arguments.</span></span> <span data-ttu-id="a3c6d-138">Аргумент `CustomerId` представляет клиента, для которого необходимо вернуть заказы, а аргумент `ServiceUri` - URI службы OData, которой будет отправлен запрос.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-138">The `CustomerId` argument represents the customer who identifies which orders to return, and the `ServiceUri` argument represents the URI of the OData service to be queried.</span></span> <span data-ttu-id="a3c6d-139">Поскольку действие является производным от `AsyncCodeActivity<IEnumerable<Order>>` , имеется также выходной аргумент <xref:System.Activities.Activity%601.Result%2A> , который служит для возврата результатов запроса.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-139">Because the activity derives from `AsyncCodeActivity<IEnumerable<Order>>` there is also a <xref:System.Activities.Activity%601.Result%2A> output argument that is used to return the results of the query.</span></span> <span data-ttu-id="a3c6d-140">Переопределение <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> создает запрос LINQ, выбирающий все заказы указанного клиента.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-140">The <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override creates a LINQ query that selects all orders of the specified customer.</span></span> <span data-ttu-id="a3c6d-141">Запрос указывается как <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> переданного <xref:System.Activities.AsyncCodeActivityContext>, а затем вызывается метод запроса <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-141">This query is specified as the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> of the passed <xref:System.Activities.AsyncCodeActivityContext>, and then the query's <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> method is called.</span></span> <span data-ttu-id="a3c6d-142">Обратите внимание, что обратный вызов и состояние, передаваемые в <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> запроса, представляют собой обратный вызов и состояние, переданные методу действия <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-142">Note that the callback and state that are passed into the query's <xref:System.Data.Services.Client.DataServiceQuery%601.BeginExecute%2A> are the ones that are passed in to the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> method.</span></span> <span data-ttu-id="a3c6d-143">После завершения обработки запроса вызывается метод действия <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-143">When the query has finished executing, the activity's <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> method is invoked.</span></span> <span data-ttu-id="a3c6d-144">Запрос извлекается из <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, а затем вызывается метод запроса <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-144">The query is retrieved from the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, and then the query's <xref:System.Data.Services.Client.DataServiceQuery%601.EndExecute%2A> method is called.</span></span> <span data-ttu-id="a3c6d-145">Метод возвращает <xref:System.Collections.Generic.IEnumerable%601> указанного типа сущности, в данном случае - `Order`.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-145">This method returns an <xref:System.Collections.Generic.IEnumerable%601> of the specified entity type; in this case `Order`.</span></span> <span data-ttu-id="a3c6d-146">Поскольку `IEnumerable<Order>` является универсальным типом <xref:System.Activities.AsyncCodeActivity%601>, этот <xref:System.Collections.IEnumerable> задается как <xref:System.Activities.Activity%601.Result%2A> <xref:System.Activities.OutArgument%601> действия.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-146">Since `IEnumerable<Order>` is the generic type of the <xref:System.Activities.AsyncCodeActivity%601>, this <xref:System.Collections.IEnumerable> is set as the <xref:System.Activities.Activity%601.Result%2A> <xref:System.Activities.OutArgument%601> of the activity.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#100](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#100)]

<span data-ttu-id="a3c6d-147">В следующем примере действие `OrdersByCustomer` вызывает список заказов для указанного клиента, а затем действие <xref:System.Activities.Statements.ForEach%601> выполняет перечисление заказов в результате и отображает на консоли данные всех заказов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-147">In the following example, the `OrdersByCustomer` activity retrieves a list of orders for the specified customer, and then a <xref:System.Activities.Statements.ForEach%601> activity enumerates the returned orders and writes the date of each order to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#10](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#10)]

<span data-ttu-id="a3c6d-148">При вызове этого рабочего процесса на консоли отображаются следующие данные.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-148">When this workflow is invoked, the following data is written to the console:</span></span>

```console
Calling WCF Data Service...
8/25/1997
10/3/1997
10/13/1997
1/15/1998
3/16/1998
4/9/1998
```

> [!NOTE]
> <span data-ttu-id="a3c6d-149">Если не удалось установить соединение с сервером, то будет вызвано исключение, аналогичное следующему:</span><span class="sxs-lookup"><span data-stu-id="a3c6d-149">If a connection to the OData server cannot be established, you will get an exception similar to the following exception:</span></span>
>
> <span data-ttu-id="a3c6d-150">Необработанное исключение: System.InvalidOperationException: во время обработки запроса произошла ошибка.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-150">Unhandled Exception: System.InvalidOperationException: An error occurred while processing this request.</span></span> <span data-ttu-id="a3c6d-151">---> System.Net.WebException: не удалось подключиться к удаленному серверу ---> System.Net.Sockets.SocketException: сбой попытки подключения, так как через определенный период времени не был получен отклик от объекта, с которым выполняется попытка подключения, или сбой подключения, так как не удалось получить отклик от подключенного узла.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-151">---> System.Net.WebException: Unable to connect to the remote server ---> System.Net.Sockets.SocketException: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.</span></span>

<span data-ttu-id="a3c6d-152">Если требуется дополнительная обработка данных в результате запроса, то ее можно выполнить в переопределении действия <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-152">If any additional processing of the data returned by the query is required, it can be done in the activity's <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> override.</span></span> <span data-ttu-id="a3c6d-153">Методы <xref:System.Activities.AsyncCodeActivity%601.BeginExecute%2A> и <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> вызываются потоком рабочего процесса, при этом весь код в этих переопределениях не выполняется асинхронно.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-153">Both <xref:System.Activities.AsyncCodeActivity%601.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> are invoked by using the workflow thread, and any code in these overrides does not run asynchronously.</span></span> <span data-ttu-id="a3c6d-154">Если дополнительная обработка требует большого количества ресурсов, выполняется длительное время или результаты запроса отображаются с разбиением на страницы, то рекомендуется реализовать подход, описанный в предыдущем разделе, где для асинхронного выполнения запроса и дополнительной обработки используется делегат.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-154">If the additional processing is extensive or long-running, or the query results are paged, you should consider the approach discussed in the next section, which uses a delegate to execute the query and perform additional processing asynchronously.</span></span>

### <a name="using-a-delegate"></a><span data-ttu-id="a3c6d-155">Использование делегата</span><span class="sxs-lookup"><span data-stu-id="a3c6d-155">Using a delegate</span></span>

<span data-ttu-id="a3c6d-156">Помимо вызова асинхронного метода класса .NET Framework, действие на основе <xref:System.Activities.AsyncCodeActivity>может также определять асинхронную логику в одном из ее методов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-156">In addition to invoking the asynchronous method of a .NET Framework class, an <xref:System.Activities.AsyncCodeActivity>-based activity can also define the asynchronous logic in one of its methods.</span></span> <span data-ttu-id="a3c6d-157">Этот метод указывается с помощью делегата в переопределении действия <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-157">This method is specified by using a delegate in the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override.</span></span> <span data-ttu-id="a3c6d-158">Когда метод возвращает управление, среда выполнения вызывает переопределения действия <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-158">When the method returns, the runtime invokes the activity's <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> override.</span></span> <span data-ttu-id="a3c6d-159">При вызове службы OData из рабочего процесса этот метод можно использовать для запроса к службе и выполнения дополнительной обработки.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-159">When calling an OData service from a workflow, this method can be used to query the service and provide any additional processing.</span></span>

<span data-ttu-id="a3c6d-160">В следующем примере определяется действие `ListCustomers` .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-160">In the following example, a `ListCustomers` activity is defined.</span></span> <span data-ttu-id="a3c6d-161">Это действие отправляет запрос к образцу службы данных «Борей» и возвращает список `List<Customer>` , содержащий всех клиентов в базе данных «Борей».</span><span class="sxs-lookup"><span data-stu-id="a3c6d-161">This activity queries the sample Northwind data service and returns a `List<Customer>` that contains all of the customers in the Northwind database.</span></span> <span data-ttu-id="a3c6d-162">Асинхронные операции выполняются методом `GetCustomers` .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-162">The asynchronous work is performed by the `GetCustomers` method.</span></span> <span data-ttu-id="a3c6d-163">Этот метод отправляет запрос к службе для всех клиентов, а затем копирует их в `List<Customer>`.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-163">This method queries the service for all customers, and then copies them into a `List<Customer>`.</span></span> <span data-ttu-id="a3c6d-164">После этого выполняется проверка для подтверждения разбиения на страницы результатов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-164">It then checks to see if the results are paged.</span></span> <span data-ttu-id="a3c6d-165">Если результаты разбиты на страницы, то отправляется запрос к службе для получения следующей страницы результатов, они добавляются к списку и эти операции выполняются до получения всех данных клиентов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-165">If so, it queries the service for the next page of results, adds them to the list, and continues until all of the customer data has been retrieved.</span></span>

> [!NOTE]
> <span data-ttu-id="a3c6d-166">Дополнительные сведения о разбиении по страницам в WCF Data Services см. в разделе [как загружать выгруженные результаты (WCF Data Services)](../data/wcf/how-to-load-paged-results-wcf-data-services.md).</span><span class="sxs-lookup"><span data-stu-id="a3c6d-166">For more information about paging in WCF Data Services, see [How to: Load Paged Results (WCF Data Services)](../data/wcf/how-to-load-paged-results-wcf-data-services.md).</span></span>

<span data-ttu-id="a3c6d-167">После добавления всех клиентов возвращается список.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-167">Once all customers are added, the list is returned.</span></span> <span data-ttu-id="a3c6d-168">Метод `GetCustomers` указывается в переопределении действия <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-168">The `GetCustomers` method is specified in the activity's <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> override.</span></span> <span data-ttu-id="a3c6d-169">Поскольку у метода имеется возвращаемое значение, то для его указания создается `Func<string, List<Customer>>` .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-169">Since the method has a return value, a `Func<string, List<Customer>>` is created to specify the method.</span></span>

> [!NOTE]
> <span data-ttu-id="a3c6d-170">Если метод, выполняющий асинхронные операции, не имеет возвращаемого значения, то используется <xref:System.Action> вместо <xref:System.Func%601>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-170">If the method that performs the asynchronous work does not have a return value, an <xref:System.Action> is used instead of a <xref:System.Func%601>.</span></span> <span data-ttu-id="a3c6d-171">Примеры создания асинхронного примера с использованием обоих подходов см. в разделе [Создание асинхронных действий](creating-asynchronous-activities-in-wf.md).</span><span class="sxs-lookup"><span data-stu-id="a3c6d-171">For examples of creating an asynchronous example using both approaches, see [Creating Asynchronous Activities](creating-asynchronous-activities-in-wf.md).</span></span>

<span data-ttu-id="a3c6d-172">Этот <xref:System.Func%601> назначается <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, а затем вызывается `BeginInvoke`.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-172">This <xref:System.Func%601> is assigned to the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, and then `BeginInvoke` is called.</span></span> <span data-ttu-id="a3c6d-173">Поскольку у вызываемого метода отсутствует доступ к среде аргументов действия, значение аргумента `ServiceUri` передается в качестве первого параметра вместе с обратным вызовом и состоянием, переданными в <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-173">Since the method to be invoked does not have access to the activity's environment of arguments, the value of the `ServiceUri` argument is passed as the first parameter, together with the callback and state that were passed into <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span></span> <span data-ttu-id="a3c6d-174">Когда метод `GetCustomers` возвращает управление, среда выполнения вызывает <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-174">When `GetCustomers` returns, the runtime invokes <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="a3c6d-175">Код в <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> вызывает делегат из <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, вызывает `EndInvoke`и возвращает результат, который является списком клиентов, возвращаемым из метода `GetCustomers` .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-175">The code in <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> retrieves the delegate from the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A>, calls `EndInvoke`, and returns the result, which is the list of customers returned from the `GetCustomers` method.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#200](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#200)]

<span data-ttu-id="a3c6d-176">В следующем примере действие `ListCustomers` вызывает список клиентов, а затем действие <xref:System.Activities.Statements.ForEach%601> выполняет их перечисление и отображает на консоли название компании и имя контактного лица для всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-176">In the following example, the `ListCustomers` activity retrieves a list of customers, and then a <xref:System.Activities.Statements.ForEach%601> activity enumerates them and writes the company name and contact name of each customer to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#20](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#20)]

<span data-ttu-id="a3c6d-177">При вызове этого рабочего процесса на консоли отображаются следующие данные.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-177">When this workflow is invoked, the following data is written to the console.</span></span> <span data-ttu-id="a3c6d-178">Поскольку в результате этого запроса указывается несколько клиентов, ниже отображена только часть результатов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-178">Since this query returns many customers, only part of the output is displayed here.</span></span>

```console
Calling WCF Data Service...
Alfreds Futterkiste, Contact: Maria Anders
Ana Trujillo Emparedados y helados, Contact: Ana Trujillo
Antonio Moreno Taquería, Contact: Antonio Moreno
Around the Horn, Contact: Thomas Hardy
Berglunds snabbköp, Contact: Christina Berglund
...
```

## <a name="consuming-an-odata-feed-without-using-the-client-libraries"></a><span data-ttu-id="a3c6d-179">Использование веб-канала OData без использования клиентских библиотек</span><span class="sxs-lookup"><span data-stu-id="a3c6d-179">Consuming an OData feed without using the client libraries</span></span>

<span data-ttu-id="a3c6d-180">OData предоставляет доступ к данным в виде ресурсов, которые адресуются по URI.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-180">OData exposes data as resources that are addressable by URIs.</span></span> <span data-ttu-id="a3c6d-181">При использовании клиентских библиотек эти URI создаются автоматически, но при этом клиентские библиотеки использовать не обязательно.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-181">When you use the client libraries these URIs are created for you, but you do not have to use the client libraries.</span></span> <span data-ttu-id="a3c6d-182">При необходимости доступ к службам OData можно получить напрямую без использования клиентских библиотек.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-182">If desired, OData services can be accessed directly without using the client libraries.</span></span> <span data-ttu-id="a3c6d-183">Если клиентские библиотеки не используются, то местоположение службы и необходимые данные указываются в URI, а получение результатов производится через HTTP-запрос.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-183">When not using the client libraries the location of the service and the desired data are specified by the URI and the results are returned in the response to the HTTP request.</span></span> <span data-ttu-id="a3c6d-184">После этого необработанные данные можно обработать или использовать необходимым способом.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-184">This raw data can then be processed or manipulated in the desired manner.</span></span> <span data-ttu-id="a3c6d-185">Помимо других способов, результаты запроса OData можно вызвать с помощью класса <xref:System.Net.WebClient> .</span><span class="sxs-lookup"><span data-stu-id="a3c6d-185">One way to retrieve the results of an OData query is by using the <xref:System.Net.WebClient> class.</span></span> <span data-ttu-id="a3c6d-186">В данном примере извлекается имя контактного лица клиента, представленного ключом «ALFKI».</span><span class="sxs-lookup"><span data-stu-id="a3c6d-186">In this example, the contact name for the customer represented by the key ALFKI is retrieved.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#2](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#2)]

<span data-ttu-id="a3c6d-187">При выполнении этого кода на консоль выводятся следующие данные.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-187">When this code is run, the following output is displayed to the console:</span></span>

```console
Raw data returned:
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<ContactName xmlns="http://schemas.microsoft.com/ado/2007/08/dataservices">Maria Anders</ContactName>
```

<span data-ttu-id="a3c6d-188">В рабочем процессе код из этого примера может быть включен в переопределение <xref:System.Activities.CodeActivity.Execute%2A> настраиваемого действия на основе <xref:System.Activities.CodeActivity>, но той же функциональности также можно добиться и с помощью действия <xref:System.Activities.Expressions.InvokeMethod%601>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-188">In a workflow, the code from this example could be incorporated into the <xref:System.Activities.CodeActivity.Execute%2A> override of a <xref:System.Activities.CodeActivity>-based custom activity, but the same functionality can also be accomplished by using the <xref:System.Activities.Expressions.InvokeMethod%601> activity.</span></span> <span data-ttu-id="a3c6d-189">Действие <xref:System.Activities.Expressions.InvokeMethod%601> позволяет создателю рабочего процесса вызывать статические методы и методы экземпляра класса. Кроме того, поддерживается асинхронный вызов указанного метода.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-189">The <xref:System.Activities.Expressions.InvokeMethod%601> activity enables workflow authors to invoke static and instance methods of a class, and also has an option to invoke the specified method asynchronously.</span></span> <span data-ttu-id="a3c6d-190">В следующем примере действие <xref:System.Activities.Expressions.InvokeMethod%601> настраивается для вызова метода <xref:System.Net.WebClient.DownloadString%2A> класса <xref:System.Net.WebClient> и возвращает список клиентов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-190">In the following example, an <xref:System.Activities.Expressions.InvokeMethod%601> activity is configured to call the <xref:System.Net.WebClient.DownloadString%2A> method of the <xref:System.Net.WebClient> class and return a list of customers.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#3](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#3)]

<span data-ttu-id="a3c6d-191">Метод<xref:System.Activities.Expressions.InvokeMethod%601> может быть как статическим, так и методом экземпляра класса.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-191"><xref:System.Activities.Expressions.InvokeMethod%601> can call both static and instance methods of a class.</span></span> <span data-ttu-id="a3c6d-192">Поскольку <xref:System.Net.WebClient.DownloadString%2A> - метод экземпляра класса <xref:System.Net.WebClient> , определяется новый экземпляр класса <xref:System.Net.WebClient> для <xref:System.Activities.Expressions.InvokeMethod%601.TargetObject%2A>.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-192">Since <xref:System.Net.WebClient.DownloadString%2A> is an instance method of the <xref:System.Net.WebClient> class, a new instance of the <xref:System.Net.WebClient> class is specified for the <xref:System.Activities.Expressions.InvokeMethod%601.TargetObject%2A>.</span></span> <span data-ttu-id="a3c6d-193">`DownloadString` определяется как <xref:System.Activities.Expressions.InvokeMethod%601.MethodName%2A>, универсальный код ресурса (URI), содержащий запрос, определяется в коллекции <xref:System.Activities.Expressions.InvokeMethod%601.Parameters%2A> , и значению <xref:System.Activities.Activity%601.Result%2A> присваивается возвращаемое значение.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-193">`DownloadString` is specified as the <xref:System.Activities.Expressions.InvokeMethod%601.MethodName%2A>, the URI that contains the query is specified in the <xref:System.Activities.Expressions.InvokeMethod%601.Parameters%2A> collection, and the return value is assigned to the <xref:System.Activities.Activity%601.Result%2A> value.</span></span> <span data-ttu-id="a3c6d-194">Значение <xref:System.Activities.Expressions.InvokeMethod%601.RunAsynchronously%2A> задается равным `true`, и это указывает на асинхронный вызов метода относительно рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-194">The <xref:System.Activities.Expressions.InvokeMethod%601.RunAsynchronously%2A> value is set to `true`, which means that the method invocation will run asynchronously with regard to the workflow.</span></span> <span data-ttu-id="a3c6d-195">В следующем примере создается рабочий процесс, который с помощью действия <xref:System.Activities.Expressions.InvokeMethod%601> запрашивает у образца службы данных «Борей» список заказов указанного клиента, после чего полученные данные выводятся на консоль.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-195">In the following example, a workflow is constructed that uses the <xref:System.Activities.Expressions.InvokeMethod%601> activity to query the sample Northwind data service for a list of orders for a specific customer, and then the returned data is written to the console.</span></span>

[!code-csharp[CFX_WCFDataServicesActivityExample#1](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_WCFDataServicesActivityExample/cs/Program.cs#1)]

<span data-ttu-id="a3c6d-196">При вызове этого рабочего процесса на консоль выводятся следующие данные.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-196">When this workflow is invoked, the following output is displayed to the console.</span></span> <span data-ttu-id="a3c6d-197">Поскольку запрос возвращает несколько заказов, ниже показана только часть результатов.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-197">Since this query returns several orders, only part of the output is displayed here.</span></span>

```console
Calling WCF Data Service...
Raw data returned:

<?xml version="1.0" encoding="utf-8" standalone="yes"?>*
<feed
xml:base="http://services.odata.org/Northwind/Northwind.svc/"
xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices"
xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"
xmlns="http://www.w3.org/2005/Atom">
<title type="text">Orders\</title>
<id>http://services.odata.org/Northwind/Northwind.svc/Customers('ALFKI')/Orders\</id>
<updated>2010-05-19T19:37:07Z\</updated>
<link rel="self" title="Orders" href="Orders" />
<entry>
<id>http://services.odata.org/Northwind/Northwind.svc/Orders(10643)\</id>
<title type="text">\</title>
<updated>2010-05-19T19:37:07Z\</updated>
<author>
<name />
</author>
<link rel="edit" title="Order" href="Orders(10643)" />
<link rel="http://schemas.microsoft.com/ado/2007/08/dataservices/related/Customer" type="application/atom+xml;type=entry" title="Customer" href="Orders(10643)/Customer" />
...
```

<span data-ttu-id="a3c6d-198">В этом примере представлен один метод, который разработчики приложений рабочих процессов могут использовать для работы с необработанными данными, полученными от службы OData.</span><span class="sxs-lookup"><span data-stu-id="a3c6d-198">This example provides one method that workflow application authors can use to consume the raw data returned from an OData service.</span></span> <span data-ttu-id="a3c6d-199">Дополнительные сведения о доступе к WCF Data Services с помощью URI см. в разделе [доступ к ресурсам службы данных (WCF Data Services)](../data/wcf/accessing-data-service-resources-wcf-data-services.md) и [OData: соглашения об URI](https://www.odata.org/documentation/odata-version-2-0/uri-conventions/).</span><span class="sxs-lookup"><span data-stu-id="a3c6d-199">For more information about accessing WCF Data Services using URIs, see [Accessing Data Service Resources (WCF Data Services)](../data/wcf/accessing-data-service-resources-wcf-data-services.md) and [OData: URI Conventions](https://www.odata.org/documentation/odata-version-2-0/uri-conventions/).</span></span>
