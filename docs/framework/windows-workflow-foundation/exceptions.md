---
title: "Исключения"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 065205cc-52dd-4f30-9578-b17d8d113136
caps.latest.revision: "26"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: bf2c6e12dac2130a26aa01efc21b8f58f509294a
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2017
---
# <a name="exceptions"></a><span data-ttu-id="048b4-102">Исключения</span><span class="sxs-lookup"><span data-stu-id="048b4-102">Exceptions</span></span>
<span data-ttu-id="048b4-103">Рабочие процессы могут использовать действие <xref:System.Activities.Statements.TryCatch> для обработки исключений, возникающих в ходе выполнения рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="048b4-103">Workflows can use the <xref:System.Activities.Statements.TryCatch> activity to handle exceptions that are raised during the execution of a workflow.</span></span> <span data-ttu-id="048b4-104">Эти исключения обрабатываются либо вызываются повторно при помощи действия <xref:System.Activities.Statements.Rethrow>.</span><span class="sxs-lookup"><span data-stu-id="048b4-104">These exceptions can be handled or they can be re-thrown using the <xref:System.Activities.Statements.Rethrow> activity.</span></span> <span data-ttu-id="048b4-105">Действия в разделе <xref:System.Activities.Statements.TryCatch.Finally%2A> выполняются при завершении либо раздела <xref:System.Activities.Statements.TryCatch.Try%2A>, либо раздела <xref:System.Activities.Statements.TryCatch.Catches%2A>.</span><span class="sxs-lookup"><span data-stu-id="048b4-105">Activities in the <xref:System.Activities.Statements.TryCatch.Finally%2A> section are executed when either the <xref:System.Activities.Statements.TryCatch.Try%2A> section or the <xref:System.Activities.Statements.TryCatch.Catches%2A> section completes.</span></span> <span data-ttu-id="048b4-106">Рабочие процессы, размещаемые <xref:System.Activities.WorkflowApplication> экземпляра можно также использовать <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> обработчик событий для обработки исключений, которые не обрабатываются <xref:System.Activities.Statements.TryCatch> действия.</span><span class="sxs-lookup"><span data-stu-id="048b4-106">Workflows hosted by a <xref:System.Activities.WorkflowApplication> instance can also use the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> event handler to handle exceptions that are not handled by a <xref:System.Activities.Statements.TryCatch> activity.</span></span>  
  
## <a name="causes-of-exceptions"></a><span data-ttu-id="048b4-107">Причины исключений</span><span class="sxs-lookup"><span data-stu-id="048b4-107">Causes of Exceptions</span></span>  
 <span data-ttu-id="048b4-108">в рабочем процессе исключения могут создаваться следующим образом:</span><span class="sxs-lookup"><span data-stu-id="048b4-108">In a workflow, exceptions can be generated in the following ways:</span></span>  
  
-   <span data-ttu-id="048b4-109">Время ожидания транзакций в <xref:System.Activities.Statements.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="048b4-109">A time-out of transactions in <xref:System.Activities.Statements.TransactionScope>.</span></span>  
  
-   <span data-ttu-id="048b4-110">Явное исключение, вызываемое рабочим процессом с помощью действия <xref:System.Activities.Statements.Throw>.</span><span class="sxs-lookup"><span data-stu-id="048b4-110">An explicit exception thrown by the workflow using the <xref:System.Activities.Statements.Throw> activity.</span></span>  
  
-   <span data-ttu-id="048b4-111">Исключение [!INCLUDE[netfx_current_short](../../../includes/netfx-current-short-md.md)], возникшее из действия.</span><span class="sxs-lookup"><span data-stu-id="048b4-111">A [!INCLUDE[netfx_current_short](../../../includes/netfx-current-short-md.md)] exception thrown from an activity.</span></span>  
  
-   <span data-ttu-id="048b4-112">Исключение, возникающее из внешнего кода, например из библиотек, компонентов или служб, используемых в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="048b4-112">An exception thrown from external code, such as libraries, components, or services that are used in the workflow.</span></span>  
  
## <a name="handling-exceptions"></a><span data-ttu-id="048b4-113">Обработка исключений</span><span class="sxs-lookup"><span data-stu-id="048b4-113">Handling Exceptions</span></span>  
 <span data-ttu-id="048b4-114">Если исключение возникает из действия и не обрабатывается, поведение по умолчанию состоит в завершении экземпляра рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="048b4-114">If an exception is thrown by an activity and is unhandled, the default behavior is to terminate the workflow instance.</span></span> <span data-ttu-id="048b4-115">Если присутствует пользовательский обработчик <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>, он может переопределить поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="048b4-115">If a custom <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is present, it can override this default behavior.</span></span> <span data-ttu-id="048b4-116">Обработчик предоставляет автору узла рабочего процесса возможность выполнить соответствующую обработку, например пользовательское протоколирование, прерывание, отмену или прекращение рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="048b4-116">This handler gives the workflow host author an opportunity to provide the appropriate handling, such as custom logging, aborting the workflow, canceling the workflow, or terminating the workflow.</span></span>  <span data-ttu-id="048b4-117">Если рабочий процесс создает необрабатываемое исключение, вызывается обработчик <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>.</span><span class="sxs-lookup"><span data-stu-id="048b4-117">If a workflow raises an exception that is not handled, the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="048b4-118">Метод <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> может вернуть три действия, определяющие окончательный результат рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="048b4-118">There are three possible actions returned from <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> which determine the final outcome of the workflow.</span></span>  
  
-   <span data-ttu-id="048b4-119">**Отмена** -отменяется экземпляр рабочего процесса, являющийся результатом выполнения ветви.</span><span class="sxs-lookup"><span data-stu-id="048b4-119">**Cancel** - A cancelled workflow instance is a graceful exit of a branch execution.</span></span> <span data-ttu-id="048b4-120">Вы можете моделировать поведение отмены (например, с помощью действия CancellationScope).</span><span class="sxs-lookup"><span data-stu-id="048b4-120">You can model cancelation behavior (for example, by using a CancellationScope activity).</span></span> <span data-ttu-id="048b4-121">После завершения процесса отмены вызывается обработчик завершения (Completed).</span><span class="sxs-lookup"><span data-stu-id="048b4-121">The Completed handler is invoked when the cancellation process completes.</span></span> <span data-ttu-id="048b4-122">Отмененный рабочий процесс находится в состоянии Cancelled (Отменено).</span><span class="sxs-lookup"><span data-stu-id="048b4-122">A cancelled workflow is in the Cancelled state.</span></span>  
  
-   <span data-ttu-id="048b4-123">**Завершение** -завершенный экземпляр рабочего процесса нельзя возобновить или перезапустить.</span><span class="sxs-lookup"><span data-stu-id="048b4-123">**Terminate** - A terminated workflow instance cannot be resumed or restarted.</span></span>  <span data-ttu-id="048b4-124">Формируется событие Completed (Завершено), в котором вы можете указать исключение, являющееся причиной.</span><span class="sxs-lookup"><span data-stu-id="048b4-124">This triggers the Completed event in which you can provide an exception as the reason it was terminated.</span></span> <span data-ttu-id="048b4-125">После завершения процесса вызывается обработчик завершения (Terminated).</span><span class="sxs-lookup"><span data-stu-id="048b4-125">The Terminated handler is invoked when the termination process completes.</span></span> <span data-ttu-id="048b4-126">Завершенный рабочий процесс находится в состоянии ошибки (Faulted).</span><span class="sxs-lookup"><span data-stu-id="048b4-126">A terminated workflow is in the Faulted state.</span></span>  
  
-   <span data-ttu-id="048b4-127">**Прервать** -прерванные экземпляры рабочего процесса может быть возобновлена только в том случае, если он настроен как постоянную.</span><span class="sxs-lookup"><span data-stu-id="048b4-127">**Abort** - An aborted workflow instances can be resumed only if it has been configured to be persistent.</span></span>  <span data-ttu-id="048b4-128">Без сохраняемости рабочий процесс нельзя возобновить.</span><span class="sxs-lookup"><span data-stu-id="048b4-128">Without persistence, a workflow cannot be resumed.</span></span>  <span data-ttu-id="048b4-129">На этой стадии рабочий процесс прерывается, любые результаты работы (в памяти) с момента последнего сохранения будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="048b4-129">At the point a workflow is aborted, any work done (in memory) since the last persistence point will be lost.</span></span> <span data-ttu-id="048b4-130">Для прерванного рабочего процесса вызывается обработчик прерывания (Aborted) с использованием исключения как основания, когда процесс прерывания завершается.</span><span class="sxs-lookup"><span data-stu-id="048b4-130">For an aborted workflow, the Aborted handler is invoked using the exception as the reason when the abort process completes.</span></span> <span data-ttu-id="048b4-131">Однако в отличие от обработчиков Cancelled и Terminated обработчик Completed не вызывается.</span><span class="sxs-lookup"><span data-stu-id="048b4-131">However, unlike Cancelled and Terminated, the Completed handler is not invoked.</span></span> <span data-ttu-id="048b4-132">Прерванный рабочий процесс находится в состоянии Aborted (Прервано).</span><span class="sxs-lookup"><span data-stu-id="048b4-132">An aborted workflow is in an Aborted state.</span></span>  
  
 <span data-ttu-id="048b4-133">В следующем примере кода вызывается рабочий процесс, в котором создается исключение.</span><span class="sxs-lookup"><span data-stu-id="048b4-133">The following example invokes a workflow that throws an exception.</span></span> <span data-ttu-id="048b4-134">Исключение не обрабатывается рабочим процессом, и вызывается обработчик <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>.</span><span class="sxs-lookup"><span data-stu-id="048b4-134">The exception is unhandled by the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="048b4-135">Чтобы получить сведения об исключении, проверяются аргументы <xref:System.Activities.WorkflowApplicationUnhandledExceptionEventArgs>, и рабочий процесс завершается.</span><span class="sxs-lookup"><span data-stu-id="048b4-135">The <xref:System.Activities.WorkflowApplicationUnhandledExceptionEventArgs> are inspected to provide information about the exception, and the workflow is terminated.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#1](../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1)]  
  
### <a name="handling-exceptions-with-the-trycatch-activity"></a><span data-ttu-id="048b4-136">Обработка исключений при помощи действия TryCatch</span><span class="sxs-lookup"><span data-stu-id="048b4-136">Handling Exceptions with the TryCatch Activity</span></span>  
 <span data-ttu-id="048b4-137">Обработка исключений внутри рабочего процесса выполняется при помощи действия <xref:System.Activities.Statements.TryCatch>.</span><span class="sxs-lookup"><span data-stu-id="048b4-137">Handling exceptions inside a workflow is performed with the <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="048b4-138">Действие <xref:System.Activities.Statements.TryCatch> имеет коллекцию <xref:System.Activities.Statements.TryCatch.Catches%2A> действий <xref:System.Activities.Statements.Catch>, из которых каждое связано с определенным типом <xref:System.Exception>.</span><span class="sxs-lookup"><span data-stu-id="048b4-138">The <xref:System.Activities.Statements.TryCatch> activity has a <xref:System.Activities.Statements.TryCatch.Catches%2A> collection of <xref:System.Activities.Statements.Catch> activities that are each associated with a specific <xref:System.Exception> type.</span></span> <span data-ttu-id="048b4-139">Если исключение, возникшее из действия, содержащегося в разделе <xref:System.Activities.Statements.TryCatch.Try%2A> действия <xref:System.Activities.Statements.TryCatch>, совпадает с исключением действия <xref:System.Activities.Statements.Catch%601> в коллекции <xref:System.Activities.Statements.TryCatch.Catches%2A>, то исключение будет обработано.</span><span class="sxs-lookup"><span data-stu-id="048b4-139">If the exception thrown by an activity that is contained in the <xref:System.Activities.Statements.TryCatch.Try%2A> section of a <xref:System.Activities.Statements.TryCatch> activity matches the exception of a <xref:System.Activities.Statements.Catch%601> activity in the <xref:System.Activities.Statements.TryCatch.Catches%2A> collection, then the exception is handled.</span></span> <span data-ttu-id="048b4-140">Если исключение возникает повторно явным образом или если возникает новое исключение, то это исключение передается родительскому действию.</span><span class="sxs-lookup"><span data-stu-id="048b4-140">If the exception is explicitly re-thrown or a new exception is thrown then this exception passes up to the parent activity.</span></span> <span data-ttu-id="048b4-141">В следующем примере кода показано действие <xref:System.Activities.Statements.TryCatch>, которое обрабатывает исключение <xref:System.ApplicationException>, вызванное в разделе <xref:System.Activities.Statements.TryCatch.Try%2A> в результате действия <xref:System.Activities.Statements.Throw>.</span><span class="sxs-lookup"><span data-stu-id="048b4-141">The following code example shows a <xref:System.Activities.Statements.TryCatch> activity that handles an <xref:System.ApplicationException> that is thrown in the <xref:System.Activities.Statements.TryCatch.Try%2A> section by a <xref:System.Activities.Statements.Throw> activity.</span></span> <span data-ttu-id="048b4-142">Сообщение исключения записывается в консоль действием <xref:System.Activities.Statements.Catch%601>, после чего сообщение выводится на консоль в разделе <xref:System.Activities.Statements.TryCatch.Finally%2A>.</span><span class="sxs-lookup"><span data-stu-id="048b4-142">The exception's message is written to the console by the <xref:System.Activities.Statements.Catch%601> activity, and then a message is written to the console in the <xref:System.Activities.Statements.TryCatch.Finally%2A> section.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#33](../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#33)]  
  
 <span data-ttu-id="048b4-143">Действия в разделе <xref:System.Activities.Statements.TryCatch.Finally%2A> выполняются при успешном завершении либо раздела <xref:System.Activities.Statements.TryCatch.Try%2A>, либо раздела <xref:System.Activities.Statements.TryCatch.Catches%2A>.</span><span class="sxs-lookup"><span data-stu-id="048b4-143">The activities in the <xref:System.Activities.Statements.TryCatch.Finally%2A> section are executed when either the <xref:System.Activities.Statements.TryCatch.Try%2A> section or the <xref:System.Activities.Statements.TryCatch.Catches%2A> section successfully completes.</span></span> <span data-ttu-id="048b4-144">Раздел <xref:System.Activities.Statements.TryCatch.Try%2A> успешно завершается при отсутствии исключений из него, а раздел <xref:System.Activities.Statements.TryCatch.Catches%2A> успешно завершается, если не создаются собственные исключения и не вызываются из него повторно.</span><span class="sxs-lookup"><span data-stu-id="048b4-144">The <xref:System.Activities.Statements.TryCatch.Try%2A> section successfully completes if no exceptions are thrown from it, and the <xref:System.Activities.Statements.TryCatch.Catches%2A> section successfully completes if no exceptions are thrown or rethrown from it.</span></span> <span data-ttu-id="048b4-145">При возникновении исключения в разделе <xref:System.Activities.Statements.TryCatch.Try%2A> блока <xref:System.Activities.Statements.TryCatch>, которое либо не обрабатывается обработчиком <xref:System.Activities.Statements.Catch%601> в разделе <xref:System.Activities.Statements.TryCatch.Catches%2A>, либо повторно вызывается из <xref:System.Activities.Statements.TryCatch.Catches%2A>, действия из раздела <xref:System.Activities.Statements.TryCatch.Finally%2A> не будут выполнены, если только не возникнет одна из следующих ситуаций.</span><span class="sxs-lookup"><span data-stu-id="048b4-145">If an exception is thrown in the <xref:System.Activities.Statements.TryCatch.Try%2A> section of a <xref:System.Activities.Statements.TryCatch> and is either not handled by a <xref:System.Activities.Statements.Catch%601> in the <xref:System.Activities.Statements.TryCatch.Catches%2A> section, or is rethrown from the <xref:System.Activities.Statements.TryCatch.Catches%2A>, the activities in the <xref:System.Activities.Statements.TryCatch.Finally%2A> will not be executed unless the one of the following occurs.</span></span>  
  
-   <span data-ttu-id="048b4-146">Исключение перехватывается действием более высокого уровня <xref:System.Activities.Statements.TryCatch> в рабочем процессе независимо от того, вызывается ли повторно с более высокого уровня <xref:System.Activities.Statements.TryCatch>.</span><span class="sxs-lookup"><span data-stu-id="048b4-146">The exception is caught by a higher level <xref:System.Activities.Statements.TryCatch> activity in the workflow, regardless of whether it is rethrown from that higher level <xref:System.Activities.Statements.TryCatch>.</span></span>  
  
-   <span data-ttu-id="048b4-147">Исключение, не обработанное более высоким уровнем <xref:System.Activities.Statements.TryCatch>, покидает корневой элемент рабочего процесса, и рабочий процесс используется для отмены вместо завершения или прерывания транзакции.</span><span class="sxs-lookup"><span data-stu-id="048b4-147">The exception is not handled by a higher level <xref:System.Activities.Statements.TryCatch>, escapes the root of the workflow, and the workflow is configured to cancel instead of terminate or abort.</span></span> <span data-ttu-id="048b4-148">Рабочие процессы, размещенные с помощью <xref:System.Activities.WorkflowApplication>, могут настроить это путем обработки <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>, после чего будет возвращено значение <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span><span class="sxs-lookup"><span data-stu-id="048b4-148">Workflows hosted using <xref:System.Activities.WorkflowApplication> can configure this by handling <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> and returning <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="048b4-149">Пример обработки <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> приведен ранее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="048b4-149">An example of handling <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> is provided previously in this topic.</span></span> <span data-ttu-id="048b4-150">Службы Workflow Services можно настроить, используя <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> и задавая <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel>.</span><span class="sxs-lookup"><span data-stu-id="048b4-150">Workflow services can configure this by using <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> and specifying <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="048b4-151">Пример настройки <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior>, в разделе [расширяемость узла службы рабочего процесса](../../../docs/framework/wcf/feature-details/workflow-service-host-extensibility.md).</span><span class="sxs-lookup"><span data-stu-id="048b4-151">For an example of configuring <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior>, see [Workflow Service Host Extensibility](../../../docs/framework/wcf/feature-details/workflow-service-host-extensibility.md).</span></span>  
  
## <a name="exception-handling-versus-compensation"></a><span data-ttu-id="048b4-152">Обработка исключений и компенсация</span><span class="sxs-lookup"><span data-stu-id="048b4-152">Exception Handling versus Compensation</span></span>  
 <span data-ttu-id="048b4-153">Отличие между обработкой исключений и компенсацией заключается в том, что обработка исключений имеет место во время выполнения действия.</span><span class="sxs-lookup"><span data-stu-id="048b4-153">The difference between exception handling and compensation is that exception handling occurs during the execution of an activity.</span></span> <span data-ttu-id="048b4-154">Компенсация имеет место после успешного завершения действия.</span><span class="sxs-lookup"><span data-stu-id="048b4-154">Compensation occurs after an activity has successfully completed.</span></span> <span data-ttu-id="048b4-155">Обработка исключений предоставляет возможность выполнить очистку после того, как действие вызывает исключение, в то время как компенсация обеспечивает механизм, с помощью которого можно отменить успешно завершенную работу ранее завершенного действия.</span><span class="sxs-lookup"><span data-stu-id="048b4-155">Exception handling provides an opportunity to clean up after the activity raises the exception, whereas compensation provides a mechanism by which the successfully completed work of a previously completed activity can be undone.</span></span> [!INCLUDE[crdefault](../../../includes/crdefault-md.md)]<span data-ttu-id="048b4-156">[Компенсации](../../../docs/framework/windows-workflow-foundation/compensation.md).</span><span class="sxs-lookup"><span data-stu-id="048b4-156"> [Compensation](../../../docs/framework/windows-workflow-foundation/compensation.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="048b4-157">См. также</span><span class="sxs-lookup"><span data-stu-id="048b4-157">See Also</span></span>  
 <xref:System.Activities.Statements.TryCatch>  
 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>  
 <xref:System.Activities.Statements.CompensableActivity>
