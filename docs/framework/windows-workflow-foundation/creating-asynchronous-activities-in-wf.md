---
title: Создание асинхронных действий в WF
ms.date: 03/30/2017
ms.assetid: 497e81ed-5eef-460c-ba55-fae73c05824f
ms.openlocfilehash: 1b7fe1c5c998660f054d2ca060c108c758e36db7
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54650932"
---
# <a name="creating-asynchronous-activities-in-wf"></a><span data-ttu-id="314ba-102">Создание асинхронных действий в WF</span><span class="sxs-lookup"><span data-stu-id="314ba-102">Creating Asynchronous Activities in WF</span></span>
<span data-ttu-id="314ba-103">Класс <xref:System.Activities.AsyncCodeActivity> предоставляет авторам действий базовый класс, обеспечивающий реализацию логики асинхронного выполнения в производных от него действиях.</span><span class="sxs-lookup"><span data-stu-id="314ba-103"><xref:System.Activities.AsyncCodeActivity> provides activity authors a base class to use that enables derived activities to implement asynchronous execution logic.</span></span> <span data-ttu-id="314ba-104">Это особенно полезно для пользовательских действий, которые должны выполнять работу асинхронно, не останавливая поток расписания рабочих процессов и не блокируя другие действия, которые могут выполняться параллельно.</span><span class="sxs-lookup"><span data-stu-id="314ba-104">This is useful for custom activities that must perform asynchronous work without holding the workflow scheduler thread and blocking any activities that may be able to run in parallel.</span></span> <span data-ttu-id="314ba-105">В данном разделе приводятся общие сведения о процессе создания пользовательских асинхронных действий с использованием <xref:System.Activities.AsyncCodeActivity>.</span><span class="sxs-lookup"><span data-stu-id="314ba-105">This topic provides an overview of how to create custom asynchronous activities using <xref:System.Activities.AsyncCodeActivity>.</span></span>  
  
## <a name="using-asynccodeactivity"></a><span data-ttu-id="314ba-106">Использование AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="314ba-106">Using AsyncCodeActivity</span></span>  
 <span data-ttu-id="314ba-107"><xref:System.Activities?displayProperty=nameWithType> предоставляет авторам пользовательских действий различные базовые классы для различных требований, предъявляемых при создании действий.</span><span class="sxs-lookup"><span data-stu-id="314ba-107"><xref:System.Activities?displayProperty=nameWithType> provides custom activity authors with different base classes for different activity authoring requirements.</span></span> <span data-ttu-id="314ba-108">Каждый класс имеет определенную семантику и предоставляет автору рабочего процесса (и среде выполнения действия) соответствующий контракт.</span><span class="sxs-lookup"><span data-stu-id="314ba-108">Each one carries a particular semantic and provides a workflow author (and the activity runtime) a corresponding contract.</span></span> <span data-ttu-id="314ba-109">Действие, основанное на <xref:System.Activities.AsyncCodeActivity> - это действие, выполняющее работу асинхронно относительно потока планировщика, а логика выполнения такого действия выражена в управляемом коде.</span><span class="sxs-lookup"><span data-stu-id="314ba-109">An <xref:System.Activities.AsyncCodeActivity> based activity is an activity that performs work asynchronously relative to the scheduler thread and whose execution logic is expressed in managed code.</span></span> <span data-ttu-id="314ba-110">Вследствие асинхронности <xref:System.Activities.AsyncCodeActivity> может вызывать точку бездействия во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="314ba-110">As a result of going asynchronous, an <xref:System.Activities.AsyncCodeActivity> may induce an idle point during execution.</span></span> <span data-ttu-id="314ba-111">В силу изменчивого характера асинхронной работы <xref:System.Activities.AsyncCodeActivity> всегда создает несохраняемый блок на время выполнения действия.</span><span class="sxs-lookup"><span data-stu-id="314ba-111">Due to the volatile nature of asynchronous work, an <xref:System.Activities.AsyncCodeActivity> always creates a no persist block for the duration of the activity’s execution.</span></span> <span data-ttu-id="314ba-112">Это позволяет защитить среду выполнения рабочего процесса от сохранения экземпляра рабочего процесса во время выполнения асинхронной работы, а также предотвратить выгрузку экземпляра рабочего процесса во время выполнения асинхронного кода.</span><span class="sxs-lookup"><span data-stu-id="314ba-112">This prevents the workflow runtime from persisting the workflow instance in the middle of the asynchronous work, and also prevents the workflow instance from unloading while the asynchronous code is executing.</span></span>  
  
### <a name="asynccodeactivity-methods"></a><span data-ttu-id="314ba-113">Методы AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="314ba-113">AsyncCodeActivity Methods</span></span>  
 <span data-ttu-id="314ba-114">Действия, производные от <xref:System.Activities.AsyncCodeActivity>, могут создавать логику асинхронного выполнения перепрограммированием метода <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> и методов интерфейса <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span><span class="sxs-lookup"><span data-stu-id="314ba-114">Activities that derive from <xref:System.Activities.AsyncCodeActivity> can create asynchronous execution logic by overriding the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> methods with custom code.</span></span> <span data-ttu-id="314ba-115">При вызове средой выполнения эти методы передаются <xref:System.Activities.AsyncCodeActivityContext>.</span><span class="sxs-lookup"><span data-stu-id="314ba-115">When called by the runtime, these methods are passed an <xref:System.Activities.AsyncCodeActivityContext>.</span></span> <span data-ttu-id="314ba-116"><xref:System.Activities.AsyncCodeActivityContext> позволяет автору действия обеспечить общее состояние между <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> /  <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> в контексте <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> свойство.</span><span class="sxs-lookup"><span data-stu-id="314ba-116"><xref:System.Activities.AsyncCodeActivityContext> allows the activity author to provide shared state across <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>/ <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> in the context’s <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> property.</span></span> <span data-ttu-id="314ba-117">В следующем примере действие `GenerateRandom` асинхронно формирует случайное число.</span><span class="sxs-lookup"><span data-stu-id="314ba-117">In the following example, a `GenerateRandom` activity generates a random number asynchronously.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#8](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#8)]  
  
 <span data-ttu-id="314ba-118">Действие, описанное в предыдущем примере, является производным от <xref:System.Activities.AsyncCodeActivity%601>, имеет аргумент более высокого уровня `OutArgument<int>` с именем `Result`.</span><span class="sxs-lookup"><span data-stu-id="314ba-118">The previous example activity derives from <xref:System.Activities.AsyncCodeActivity%601>, and has an elevated `OutArgument<int>` named `Result`.</span></span> <span data-ttu-id="314ba-119">Значение, возвращаемое методом `GetRandom`, извлекается и возвращается путем переопределения <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A>, после чего это значение задается как значение `Result`.</span><span class="sxs-lookup"><span data-stu-id="314ba-119">The value returned by the `GetRandom` method is extracted and returned by the <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> override, and this value is set as the `Result` value.</span></span> <span data-ttu-id="314ba-120">Асинхронные действия, не возвращающие результат, должны наследоваться от <xref:System.Activities.AsyncCodeActivity>.</span><span class="sxs-lookup"><span data-stu-id="314ba-120">Asynchronous activities that do not return a result should derive from <xref:System.Activities.AsyncCodeActivity>.</span></span> <span data-ttu-id="314ba-121">В следующем примере, определяется действие `DisplayRandom`, являющееся производным от <xref:System.Activities.AsyncCodeActivity>.</span><span class="sxs-lookup"><span data-stu-id="314ba-121">In the following example, a `DisplayRandom` activity is defined which derives from <xref:System.Activities.AsyncCodeActivity>.</span></span> <span data-ttu-id="314ba-122">Это действие подобно действию `GetRandom`, однако вместо возвращения результата оно отображает сообщение на экране консоли.</span><span class="sxs-lookup"><span data-stu-id="314ba-122">This activity is like the `GetRandom` activity but instead of returning a result it displays a message to the console.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#11](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#11)]  
  
 <span data-ttu-id="314ba-123">Обратите внимание, что из-за отсутствия возвращаемого значения действие `DisplayRandom` использует класс <xref:System.Action> вместо <xref:System.Func%602> для вызова своего делегата, а делегат не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="314ba-123">Note that because there is no return value, `DisplayRandom` uses an <xref:System.Action> instead of a <xref:System.Func%602> to invoke its delegate, and the delegate returns no value.</span></span>  
  
 <span data-ttu-id="314ba-124"><xref:System.Activities.AsyncCodeActivity> также предоставляет переопределение <xref:System.Activities.AsyncCodeActivity.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="314ba-124"><xref:System.Activities.AsyncCodeActivity> also provides a <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override.</span></span> <span data-ttu-id="314ba-125">В то время как <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> и <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> являются обязательными переопределениями, <xref:System.Activities.AsyncCodeActivity.Cancel%2A> является необязательным и может быть переопределен, чтобы действие могло очистить необработанное асинхронное состояние в случае своей отмены или прерывания.</span><span class="sxs-lookup"><span data-stu-id="314ba-125">While <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> are required overrides, <xref:System.Activities.AsyncCodeActivity.Cancel%2A> is optional, and can be overridden so the activity can clean up its outstanding asynchronous state when it is being canceled or aborted.</span></span> <span data-ttu-id="314ba-126">Если очистка возможна и `AsyncCodeActivity.ExecutingActivityInstance.IsCancellationRequested` имеет значение `true`, то действие должно вызвать <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="314ba-126">If clean up is possible and `AsyncCodeActivity.ExecutingActivityInstance.IsCancellationRequested` is `true`, the activity should call <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span></span> <span data-ttu-id="314ba-127">Любые исключения, возникшие при выполнении данного метода, являются неустранимыми для экземпляра рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="314ba-127">Any exceptions thrown from this method are fatal to the workflow instance.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#10](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#10)]  
  
### <a name="invoking-asynchronous-methods-on-a-class"></a><span data-ttu-id="314ba-128">Вызов асинхронных методов в классе</span><span class="sxs-lookup"><span data-stu-id="314ba-128">Invoking Asynchronous Methods on a Class</span></span>  
 <span data-ttu-id="314ba-129">Многие классы в [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] обеспечивают асинхронное функционирование. Такой функциональностью можно асинхронно воспользоваться с помощью действий, основанных на <xref:System.Activities.AsyncCodeActivity>.</span><span class="sxs-lookup"><span data-stu-id="314ba-129">Many of the classes in the [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] provide asynchronous functionality, and this functionality can be asynchronously invoked by using an <xref:System.Activities.AsyncCodeActivity> based activity.</span></span> <span data-ttu-id="314ba-130">В следующем примере создается действие, асинхронно создает файл с помощью <xref:System.IO.FileStream> класса.</span><span class="sxs-lookup"><span data-stu-id="314ba-130">In the following example, an activity is created that asynchronously creates a file by using the <xref:System.IO.FileStream> class.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#12](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#12)]  
  
### <a name="sharing-state-between-the-beginexecute-and-endexecute-methods"></a><span data-ttu-id="314ba-131">Общее состояние между методами BeginExecute и EndExecute</span><span class="sxs-lookup"><span data-stu-id="314ba-131">Sharing State Between the BeginExecute and EndExecute Methods</span></span>  
 <span data-ttu-id="314ba-132">В предыдущем примере доступ к объекту <xref:System.IO.FileStream>, созданному в <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>, был выполнен в <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span><span class="sxs-lookup"><span data-stu-id="314ba-132">In the previous example, the <xref:System.IO.FileStream> object that was created in <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> was accessed in the <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="314ba-133">Это обусловлено тем, что переменная `file` была передана в свойстве <xref:System.Activities.AsyncCodeActivityContext.UserState%2A?displayProperty=nameWithType> методом <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span><span class="sxs-lookup"><span data-stu-id="314ba-133">This is possible because the `file` variable was passed in the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A?displayProperty=nameWithType> property in <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span></span> <span data-ttu-id="314ba-134">Это правильный метод для совместного использования состояния между <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> и <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span><span class="sxs-lookup"><span data-stu-id="314ba-134">This is the correct method for sharing state between <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="314ba-135">Использовать переменную-член в производном классе (в данном случае `FileWriter`) для совместного использования состояния между <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> и <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> неверно, так как на объект действия могут ссылаться несколько экземпляров действия.</span><span class="sxs-lookup"><span data-stu-id="314ba-135">It is incorrect to use a member variable in the derived class (`FileWriter` in this case) to share state between <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> because the activity object may be referenced by multiple activity instances.</span></span> <span data-ttu-id="314ba-136">Попытка использовать переменную-член для совместного использования состояния может привести к перезаписи значений из одного <xref:System.Activities.ActivityInstance> или потреблению значений из другого <xref:System.Activities.ActivityInstance>.</span><span class="sxs-lookup"><span data-stu-id="314ba-136">Attempting to use a member variable to share state can result in values from one <xref:System.Activities.ActivityInstance> overwriting or consuming values from another <xref:System.Activities.ActivityInstance>.</span></span>  
  
### <a name="accessing-argument-values"></a><span data-ttu-id="314ba-137">Доступ к значениям аргументов</span><span class="sxs-lookup"><span data-stu-id="314ba-137">Accessing Argument Values</span></span>  
 <span data-ttu-id="314ba-138">Среда <xref:System.Activities.AsyncCodeActivity> состоит из аргументов, определенных для действия.</span><span class="sxs-lookup"><span data-stu-id="314ba-138">The environment of an <xref:System.Activities.AsyncCodeActivity> consists of the arguments defined on the activity.</span></span> <span data-ttu-id="314ba-139">Эти аргументы можно получить доступ из <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> / <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> переопределяет с помощью <xref:System.Activities.AsyncCodeActivityContext> параметра.</span><span class="sxs-lookup"><span data-stu-id="314ba-139">These arguments can be accessed from the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>/<xref:System.Activities.AsyncCodeActivity.EndExecute%2A> overrides using the <xref:System.Activities.AsyncCodeActivityContext> parameter.</span></span> <span data-ttu-id="314ba-140">Получить доступ к аргументам в делегате невозможно, но значения аргументов или любые другие требуемые данные можно передать в делегат через его параметры.</span><span class="sxs-lookup"><span data-stu-id="314ba-140">The arguments cannot be accessed in the delegate, but the argument values or any other desired data can be passed in to the delegate using its parameters.</span></span> <span data-ttu-id="314ba-141">В следующем примере определяется действие создания случайного числа, которое получает инклюзивную верхнюю границу создаваемого числа в аргументе `Max`.</span><span class="sxs-lookup"><span data-stu-id="314ba-141">In the following example, a random number-generating activity is defined that obtains the inclusive upper bound from its `Max` argument.</span></span> <span data-ttu-id="314ba-142">При вызове делегата значение аргумента передается в асинхронный код.</span><span class="sxs-lookup"><span data-stu-id="314ba-142">The value of the argument is passed in to the asynchronous code when the delegate is invoked.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#9](../../../samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#9)]  
  
### <a name="scheduling-actions-or-child-activities-using-asynccodeactivity"></a><span data-ttu-id="314ba-143">Планирование действий или дочерних действий с помощью AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="314ba-143">Scheduling Actions or Child Activities Using AsyncCodeActivity</span></span>  
 <span data-ttu-id="314ba-144">Производные от <xref:System.Activities.AsyncCodeActivity> настраиваемых действий предоставляют метод для асинхронного выполнения работы в отношении к потоку рабочего процесса, но не предоставляют возможности планирования действий или дочерних действий.</span><span class="sxs-lookup"><span data-stu-id="314ba-144"><xref:System.Activities.AsyncCodeActivity> derived custom activities  provide a method for performing work asynchronously with regard to the workflow thread, but do not provide the ability to schedule child activities or actions.</span></span> <span data-ttu-id="314ba-145">Однако асинхронное поведение можно встроить в планирование дочерних действий посредством композиции.</span><span class="sxs-lookup"><span data-stu-id="314ba-145">However, asynchronous behavior can be incorporated with scheduling of child activities through composition.</span></span> <span data-ttu-id="314ba-146">Асинхронное действие можно создать, а затем сочетать с действием, производным от <xref:System.Activities.Activity> или <xref:System.Activities.NativeActivity>, предоставив асинхронное поведение и планирование действий или дочерних действий.</span><span class="sxs-lookup"><span data-stu-id="314ba-146">An asynchronous activity can be created, and then composed with an <xref:System.Activities.Activity> or <xref:System.Activities.NativeActivity> derived activity to provide asynchronous behavior and scheduling of child activities or actions.</span></span> <span data-ttu-id="314ba-147">Например, можно создать действие, производное от <xref:System.Activities.Activity>, у которого в качестве его реализации будет <xref:System.Activities.Statements.Sequence>, содержащий асинхронное действие, а также другие действия, реализующие логику этого действия.</span><span class="sxs-lookup"><span data-stu-id="314ba-147">For example, an activity could be created that derives from <xref:System.Activities.Activity>, and has as its implementation a <xref:System.Activities.Statements.Sequence> containing the asynchronous activity as well the other activities that implement the logic of the activity.</span></span> <span data-ttu-id="314ba-148">Дополнительные примеры составления действий с помощью <xref:System.Activities.Activity> и <xref:System.Activities.NativeActivity>, см. в разделе [как: Создание действия](../../../docs/framework/windows-workflow-foundation/how-to-create-an-activity.md) и [параметры разработки действий](../../../docs/framework/windows-workflow-foundation/activity-authoring-options-in-wf.md).</span><span class="sxs-lookup"><span data-stu-id="314ba-148">For more examples of composing activities using <xref:System.Activities.Activity> and <xref:System.Activities.NativeActivity>, see [How to: Create an Activity](../../../docs/framework/windows-workflow-foundation/how-to-create-an-activity.md) and [Activity Authoring Options](../../../docs/framework/windows-workflow-foundation/activity-authoring-options-in-wf.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="314ba-149">См. также</span><span class="sxs-lookup"><span data-stu-id="314ba-149">See also</span></span>

- <xref:System.Action>
- <xref:System.Func%602>
