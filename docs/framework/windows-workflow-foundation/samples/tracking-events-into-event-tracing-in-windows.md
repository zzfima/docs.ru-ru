---
title: Отслеживание событий в системе трассировки событий Windows
ms.date: 03/30/2017
ms.assetid: f812659b-0943-45ff-9430-4defa733182b
ms.openlocfilehash: fe50476eedef505258c2e6818e75a32c06ed6fa6
ms.sourcegitcommit: 5fb5b6520b06d7f5e6131ec2ad854da302a28f2e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74715931"
---
# <a name="tracking-events-into-event-tracing-in-windows"></a>Отслеживание событий в системе трассировки событий Windows

В этом примере показано, как включить отслеживание Windows Workflow Foundation (WF) в службе рабочего процесса и выдать события отслеживания в трассировке событий для Windows (ETW). Для создания записей отслеживания рабочих процессов в ETW в этом образце используется участник отслеживания трассировки событий Windows (<xref:System.Activities.Tracking.EtwTrackingParticipant>).

В образце рабочий процесс получает запрос, присваивает обратное значение входных данных входной переменной и возвращает обратное значение клиенту. Если входные данные равны 0, то возникнет необрабатываемое исключение деления на ноль, которое приводит к прерыванию рабочего процесса. При включенном отслеживании в трассировке событий Windows создается запись отслеживания ошибки, которая в дальнейшем может быть использована для исправления ошибки. Для подписки на записи отслеживания в участнике отслеживания трассировка событий Windows задается профиль отслеживания. Профиль отслеживания определяется в файле Web.config и предоставляется участнику отслеживания трассировки событий Windows как параметр конфигурации. Участник отслеживания трассировки событий Windows настраивается в файле Web.config службы рабочего процесса и применяется к службе как поведение службы. В этом образце события отслеживания просматриваются в журнале событий с помощью средства просмотра событий.

## <a name="workflow-tracking-details"></a>Подробные сведения об отслеживании рабочего процесса

Windows Workflow Foundation предоставляет инфраструктуру отслеживания для отслеживания выполнения экземпляра рабочего процесса. Среды выполнения отслеживания создает экземпляр рабочего процесса для создания событий, связанных с жизненным циклом рабочего процесса, событиями из действий рабочего процесса и пользовательскими событиями. В следующих сведениях о таблице подробно описаны основные компоненты инфраструктуры отслеживания.

|Компонент|Описание|
|---------------|-----------------|
|Среда выполнения отслеживания|Предоставляет инфраструктуру для передачи записей отслеживания.|
|Участники отслеживания|Открывает записи отслеживания. [!INCLUDE[netfx_current_short](../../../../includes/netfx-current-short-md.md)] поставляется с участником отслеживания, который записывает записи отслеживания в виде событий средства трассировки событий для Windows (ETW).|
|Профиль отслеживания|Механизм фильтрации, который позволяет участнику отслеживания подписаться на подмножество записей отслеживания, передаваемых из экземпляра рабочего процесса.|

Следующая таблица содержит подробные сведения о записях отслеживания, создаваемых средой выполнения рабочего процесса.

|Запись отслеживания|Описание|
|---------------------|-----------------|
|Записи отслеживания экземпляра рабочего процесса.|Описывает жизненный цикл экземпляра рабочего процесса. Например, запись экземпляра создается при запуске и завершении рабочего процесса.|
|Записи отслеживания состояний действия.|Подробные сведения о выполнении действия. Эти записи сообщают о состоянии действия рабочего процесса, например о планировании выполнения действия, о завершении действия или о возникновении ошибки.|
|Запись возобновления закладки.|Создается при возобновлении закладки в экземпляре рабочего процесса.|
|Пользовательские записи отслеживания.|Автор рабочего процесса может создавать настраиваемые записи отслеживания и выдавать их в рамках пользовательской операции.|
|<xref:System.Activities.Tracking.ActivityScheduledRecord>|Эта запись создается, когда действие планирует другое действие.|
|<xref:System.Activities.Tracking.FaultPropagationRecord>|Эта запись создается, когда от действия передается ошибка.|
|<xref:System.Activities.Tracking.CancelRequestedRecord>|Эта запись создается, когда действие отменяется другим действием.|

Участник отслеживания подписывается на часть создаваемых записей отслеживания с помощью профилей отслеживания. Профиль отслеживания содержит запросы отслеживания, которые позволяют подписываться на определенный тип записей отслеживания. Профили отслеживания можно указывать в коде или в конфигурации.

#### <a name="to-use-this-sample"></a>Использование этого образца

1. С помощью Visual Studio 2010 откройте файл решения ЕтвтраккингпартиЦипантсампле. sln.

2. Для построения решения нажмите CTRL+SHIFT+B.

3. Чтобы запустить решение, нажмите клавишу F5.

    По умолчанию служба прослушивает порт 53797 (http://localhost:53797/SampleWorkflowService.xamlx).

4. В проводнике откройте тестовый клиент WCF.

    Тестовый клиент WCF (клиент WcfTestClient. exe) находится в папке \<установки Visual Studio 2010 > папке \Common7\IDE\.

    Папка установки Visual Studio 2010 по умолчанию — C:\Program Files\Microsoft Visual Studio 10,0.

5. В тестовом клиенте WCF выберите **Добавить службу** в меню **файл** .

    Добавьте адрес конечной точки в поле ввода. Значение по умолчанию: `http://localhost:53797/SampleWorkflowService.xamlx`.

6. Откройте приложение просмотра событий.

    Перед вызовом службы запустите Просмотр событий из меню **Пуск** , выберите **выполнить** и введите в `eventvwr.exe`. Убедитесь, что журнал событий прослушивает события отслеживания, создаваемые службой рабочего процесса.

7. В древовидном представлении Просмотр событий перейдите к **Просмотр событий**, **журналы приложений и служб**и **Майкрософт**. Щелкните правой кнопкой мыши **Майкрософт** и выберите пункт **Просмотр** , а затем **Показать журналы аналитики и отладки** , чтобы включить журналы аналитики и отладки.

    Убедитесь, что установлен флажок **отображать журналы аналитики и отладки** .

8. В древовидном представлении в Просмотр событий перейдите к **Просмотр событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, **сервер приложений — приложения**. Щелкните правой кнопкой мыши **аналитика** и выберите **Включить журнал** , чтобы включить **аналитический** журнал.

9. Проверьте службу с помощью тестового клиента WCF, дважды щелкнув `GetData`.

    Откроется метод `GetData`. Запрос принимает один параметр и проверяет, равно ли значение 0 (значение по умолчанию).

     Нажмите кнопку **вызвать**.

10. Просмотрите события, переданные из рабочего процесса.

    Вернитесь к Просмотр событий и перейдите в раздел **Просмотр событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, **сервер приложений — приложения**. Щелкните правой кнопкой мыши **аналитика** и выберите **Обновить**.

    События рабочего процесса отображаются в средстве просмотра событий. Обратите внимание, что отображаются события выполнения рабочего процесса и одно из них является необработанным исключением, соответствующим ошибке в рабочем процессе. Кроме того, действие рабочего процесса создает событие предупреждения, указывающее, какое действие выдало ошибку.

11. Повторите шаги 9 и 10, введя данные, отличные от 0, чтобы ошибка не появлялась.

Профили отслеживания позволяют подписаться на события, создаваемые средой выполнения при изменении состояния экземпляра рабочего процесса. Исходя из потребностей, можно создать профиль с низкой детализацией, который будет подписан на небольшой набор изменений состояния высокого уровня в рабочем процессе. В то же время можно создать очень точный профиль, выходные данные которого будут достаточно полными для последующей реконструкции выполнения. Образец демонстрирует события, создаваемые средой выполнения рабочего процесса для трассировки событий Windows с помощью `HealthMonitoring Tracking Profile`, создающего небольшой набор событий. В файле Web.config имеется другой профиль, создающий больше событий отслеживания, он называется `Troubleshooting Tracking Profile`. При установке [!INCLUDE[netfx_current_short](../../../../includes/netfx-current-short-md.md)] в файле Machine.config настраивается профиль по умолчанию с пустым именем. Этот профиль используется конфигурацией поведения отслеживания ETW при отсутствии имени профиля или при задании пустого имени.

Профиль отслеживания мониторинга работоспособности создает записи экземпляра рабочего процесса и записи распространения ошибок действий. Этот профиль создается путем добавления следующего профиля отслеживания в файл конфигурации Web.config.

```xml
<tracking>
  <profiles>
    <trackingProfile name="HealthMonitoring Tracking Profile">
      <workflow activityDefinitionId="*">
        <workflowInstanceQueries>
          <workflowInstanceQuery>
            <states>
              <state name="Started"/>
              <state name="Completed"/>
              <state name="Aborted"/>
              <state name="UnhandledException"/>
            </states>
          </workflowInstanceQuery>
        </workflowInstanceQueries>
        <faultPropagationQueries>
          <faultPropagationQuery faultSourceActivityName ="*" faultHandlerActivityName="*"/>
        </faultPropagationQueries>
      </workflow>
    </trackingProfile>
  </profiles>
</tracking>
```

 Профиль может быть изменен путем изменения конфигурации `EtwTrackingParticipant` на следующую.

```xml
<behaviors>
  <serviceBehaviors>
    <behavior>
      <etwTracking profileName="HealthMonitoring Tracking Profile"/>
    </behavior>
  </serviceBehaviors>
</behaviors>
```

#### <a name="to-clean-up-optional"></a>Очистка (необязательно)

1. Откройте окно Просмотр событий.

2. Перейдите в раздел **Просмотр событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, **сервер приложений — приложения**. Щелкните правой кнопкой мыши **аналитика** и выберите **Отключить журнал**.

3. Перейдите в раздел **Просмотр событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, **сервер приложений — приложения**. Щелкните правой кнопкой мыши **аналитика** и выберите **Очистить журнал**.

4. Выберите параметр **clear (очистить** ), чтобы очистить события.

## <a name="known-issue"></a>Известная проблема

> [!NOTE]
> В Средстве просмотра событий есть известная проблема, связанная с ошибкой декодирования событий трассировки событий Windows. Может выводиться следующее сообщение об ошибке.
>
> Описание события с ИДЕНТИФИКАТОРом \<идентификатор > из источника Microsoft-Windows-Application Server-приложения не найдены. Возможно, компонент, вызывающий это событие, не установлен на локальном компьютере, либо установка повреждена. Компонент может быть установлен или восстановлен на локальном компьютере.
>
> При появлении этой ошибки нажмите кнопку «Обновить» в области действий. Теперь декодирование события должно выполняться правильно.

> [!IMPORTANT]
> Образцы уже могут быть установлены на компьютере. Перед продолжением проверьте следующий каталог (по умолчанию).
>
> `<InstallDrive>:\WF_WCF_Samples`
>
> Если этот каталог не существует, перейдите к [примерам Windows Communication Foundation (WCF) и Windows Workflow Foundation (WF) для .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) , чтобы скачать все Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] Samples. Этот образец расположен в следующем каталоге.
>
> `<InstallDrive>:\WF_WCF_Samples\WF\Basic\Tracking\EtwTracking`

## <a name="see-also"></a>См. также:

- [Примеры мониторинга AppFabric](https://go.microsoft.com/fwlink/?LinkId=193959)
