---
title: Пошаговое руководство. Выпуск кода в сценариях частичного доверия
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: fd420c9754494b95c55df403edec87743572db03
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73129996"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="0a332-102">Пошаговое руководство. Выпуск кода в сценариях частичного доверия</span><span class="sxs-lookup"><span data-stu-id="0a332-102">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="0a332-103">При порождении отражения для полного или частичного доверия используется одинаковый набор интерфейсов API, но для некоторых функциональных возможностей требуются особые разрешения в коде с частичным доверием.</span><span class="sxs-lookup"><span data-stu-id="0a332-103">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="0a332-104">Кроме того, в порождении отражения имеется функциональная возможность, анонимно размещенные динамические методы, которые предназначены для использования при частичном доверии и в прозрачных с точки зрения безопасности сборках.</span><span class="sxs-lookup"><span data-stu-id="0a332-104">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="0a332-105">В версиях, предшествовавших .NET Framework 3.5, для порождения кода требовалось разрешение <xref:System.Security.Permissions.ReflectionPermission> с флагом <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0a332-105">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="0a332-106">Это разрешение включено по умолчанию в именованные наборы разрешений `FullTrust` и `Intranet`, но отсутствует в наборе разрешений `Internet`.</span><span class="sxs-lookup"><span data-stu-id="0a332-106">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="0a332-107">Поэтому библиотека может использоваться при частичном доверии, только если у нее был атрибут <xref:System.Security.SecurityCriticalAttribute> и она выполнила метод <xref:System.Security.PermissionSet.Assert%2A> для <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span><span class="sxs-lookup"><span data-stu-id="0a332-107">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="0a332-108">Такие библиотеки требуют тщательной проверки безопасности, так как ошибки в коде могут стать причиной уязвимости.</span><span class="sxs-lookup"><span data-stu-id="0a332-108">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="0a332-109">Платформа .NET Framework 3.5 позволяет создавать код в сценариях частичного доверия без предъявления каких-либо требований к безопасности, так как создание кода по сути не является привилегированной операцией.</span><span class="sxs-lookup"><span data-stu-id="0a332-109">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="0a332-110">То есть созданный код имеет не больше разрешений, чем породившая его сборка.</span><span class="sxs-lookup"><span data-stu-id="0a332-110">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="0a332-111">Это позволяет библиотекам порождать код, прозрачный с точки зрения безопасности, и устраняет необходимость в подтверждении <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, что упрощает задачу написания безопасной библиотеки, так как тщательная проверка безопасности не нужна.</span><span class="sxs-lookup"><span data-stu-id="0a332-111">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="0a332-112">В данном пошаговом руководстве рассмотрены следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="0a332-112">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="0a332-113">[Настройка простой песочницы для проверки кода с частичным доверием](#Setting_up).</span><span class="sxs-lookup"><span data-stu-id="0a332-113">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="0a332-114">Это простой способ поэкспериментировать с кодом с частичным доверием.</span><span class="sxs-lookup"><span data-stu-id="0a332-114">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="0a332-115">Сведения о выполнении кода, поступившего из ненадежных расположений, см. в разделе [Практическое руководство. Выполнение не вполне безопасного кода в изолированной среде](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="0a332-115">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="0a332-116">[Выполнение кода в доменах приложений с частичным доверием](#Running_code).</span><span class="sxs-lookup"><span data-stu-id="0a332-116">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="0a332-117">[Использование анонимно размещенных динамических методов для порождения и выполнения кода при частичном доверии](#Using_methods).</span><span class="sxs-lookup"><span data-stu-id="0a332-117">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="0a332-118">Дополнительные сведения о порождении кода в сценариях с частичным доверием см. в разделе [Вопросы безопасности в порождаемом отражении](security-issues-in-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="0a332-118">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="0a332-119">Полный код, показанный в данных процедурах, см. в разделе [Пример](#Example) в конце этого руководства.</span><span class="sxs-lookup"><span data-stu-id="0a332-119">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="0a332-120">Настройка расположений с частичным доверием</span><span class="sxs-lookup"><span data-stu-id="0a332-120">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="0a332-121">В следующих двух процедурах показано, как настроить расположения, из которых можно протестировать код с частичным доверием.</span><span class="sxs-lookup"><span data-stu-id="0a332-121">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="0a332-122">В первой процедуре показано, как создать домен изолированного приложения, в котором код выполняется с интернет-доверием.</span><span class="sxs-lookup"><span data-stu-id="0a332-122">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="0a332-123">Во второй процедуре показано, как добавить <xref:System.Security.Permissions.ReflectionPermission> с флагом <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> в домен приложения с частичным доверием для разрешения доступа к конфиденциальным данным в сборках с тем же или меньшим доверием.</span><span class="sxs-lookup"><span data-stu-id="0a332-123">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="0a332-124">Создание доменов изолированных приложений</span><span class="sxs-lookup"><span data-stu-id="0a332-124">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="0a332-125">Чтобы создать домен приложения, в котором сборки будут выполняться при частичном доверии, необходимо указать набор разрешений, которые должны быть предоставлены сборкам, используя перегрузку метода <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> для создания домена приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-125">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="0a332-126">Самым простым способом указания набора разрешений является получение именованного набора разрешений из политики безопасности.</span><span class="sxs-lookup"><span data-stu-id="0a332-126">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="0a332-127">В следующей процедуре создается домен изолированного приложения, в котором код будет выполняться при частичном доверии, для проверки сценариев, в которых порожденный код имеет доступ только к открытым членам открытых типов.</span><span class="sxs-lookup"><span data-stu-id="0a332-127">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="0a332-128">В следующей процедуре показано, как добавить <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> для проверки сценариев, в которых порожденный код имеет доступ к закрытым типам и членам в сборках, которым предоставлены равнозначные или меньшие разрешения.</span><span class="sxs-lookup"><span data-stu-id="0a332-128">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="0a332-129">Создание домена приложения с частичным доверием</span><span class="sxs-lookup"><span data-stu-id="0a332-129">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="0a332-130">Создайте набор разрешений, которые следует предоставить сборкам в домене изолированного приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-130">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="0a332-131">В этом случае используется набор разрешений зоны Интернета.</span><span class="sxs-lookup"><span data-stu-id="0a332-131">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="0a332-132">Создайте объект <xref:System.AppDomainSetup> для инициализации домена приложения с помощью пути к приложению.</span><span class="sxs-lookup"><span data-stu-id="0a332-132">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="0a332-133">Для простоты в этом примере кода используется текущая папка.</span><span class="sxs-lookup"><span data-stu-id="0a332-133">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="0a332-134">Для выполнения кода, поступившего из Интернета, используйте отдельную папку для ненадежного кода, как описано в разделе [Практическое руководство. Выполнение не вполне безопасного кода в изолированной среде](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="0a332-134">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="0a332-135">Создайте домен приложения, указав сведения о настройке домена приложения и набор правил для всех сборок, выполняющихся в домене приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-135">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="0a332-136">С помощью последнего параметра перегрузки метода <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> можно указать набор сборок, которым будет предоставлено полное доверие, вместо набора правил для домена приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-136">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="0a332-137">Вам не нужно указывать сборки .NET Framework, используемые приложением, так как они находятся в глобальном кэше сборок.</span><span class="sxs-lookup"><span data-stu-id="0a332-137">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="0a332-138">Сборки, находящиеся в глобальном кэше сборок, всегда имеют полное доверие.</span><span class="sxs-lookup"><span data-stu-id="0a332-138">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="0a332-139">Этот параметр можно использовать для указания сборок со строгими именами, которые не находятся в глобальном кэше сборок.</span><span class="sxs-lookup"><span data-stu-id="0a332-139">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="0a332-140">Добавление RestrictedMemberAccess к изолированным доменам</span><span class="sxs-lookup"><span data-stu-id="0a332-140">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="0a332-141">Ведущие приложения могут разрешать доступ анонимно размещенных динамических методов к конфиденциальным данным в сборках, уровень доверия которых не превышает уровень доверия сборки, порождающей код.</span><span class="sxs-lookup"><span data-stu-id="0a332-141">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="0a332-142">Чтобы разрешить эту ограниченную возможность пропуска проверок видимости, выполняемых JIT-компилятором, ведущее приложение добавляет объект <xref:System.Security.Permissions.ReflectionPermission> с флагом <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) в набор правил.</span><span class="sxs-lookup"><span data-stu-id="0a332-142">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="0a332-143">Например, ведущее приложение может предоставить интернет-приложениям интернет-разрешения и RMA, так что интернет-приложение может породить код, который обращается к конфиденциальным данным в собственных сборках.</span><span class="sxs-lookup"><span data-stu-id="0a332-143">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="0a332-144">Так как доступ ограничен сборками с таким же или меньшим доверием, веб-приложение не может обращаться к членам полностью доверенных сборок, например сборок .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="0a332-144">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="0a332-145">Чтобы предотвратить повышение привилегий, при создании анонимно размещенных динамических методов включаются также сведения стека для порождающей сборки.</span><span class="sxs-lookup"><span data-stu-id="0a332-145">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="0a332-146">При вызове метода проверяются сведения стека.</span><span class="sxs-lookup"><span data-stu-id="0a332-146">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="0a332-147">Поэтому вызванный из полностью доверенного кода анонимно размещенный динамический метод все так же ограничен уровнем доверия порождающей сборки.</span><span class="sxs-lookup"><span data-stu-id="0a332-147">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="0a332-148">Создание домена приложения с частичным доверием и RMA</span><span class="sxs-lookup"><span data-stu-id="0a332-148">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="0a332-149">Создайте объект <xref:System.Security.Permissions.ReflectionPermission> с флагом <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) и используйте метод <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> для добавления разрешения в набор правил.</span><span class="sxs-lookup"><span data-stu-id="0a332-149">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="0a332-150">Метод <xref:System.Security.PermissionSet.AddPermission%2A> добавляет это разрешение в набор правил, если его там еще нет.</span><span class="sxs-lookup"><span data-stu-id="0a332-150">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="0a332-151">Если разрешение уже включено в набор правил, указанные флаги добавляются к существующим разрешениям.</span><span class="sxs-lookup"><span data-stu-id="0a332-151">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0a332-152">RMA — это функциональная возможность анонимно размещенных динамических методов.</span><span class="sxs-lookup"><span data-stu-id="0a332-152">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="0a332-153">Если обычные динамические методы пропускают проверки видимости, выполняемые JIT-компилятором, порождаемый код требует полного доверия.</span><span class="sxs-lookup"><span data-stu-id="0a332-153">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="0a332-154">Создайте домен приложения, указав сведения о настройке домена приложения и набор правил.</span><span class="sxs-lookup"><span data-stu-id="0a332-154">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="0a332-155">Выполнение кода в доменах изолированных приложений</span><span class="sxs-lookup"><span data-stu-id="0a332-155">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="0a332-156">В следующей процедуре объясняется, как определить класс с помощью методов, которые могут быть выполнены в домене приложения, как создать экземпляр класса в домене и как выполнить его методы.</span><span class="sxs-lookup"><span data-stu-id="0a332-156">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="0a332-157">Определение и выполнение метода в домене приложения</span><span class="sxs-lookup"><span data-stu-id="0a332-157">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="0a332-158">Определите класс, производный от класса <xref:System.MarshalByRefObject>.</span><span class="sxs-lookup"><span data-stu-id="0a332-158">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="0a332-159">Это позволит создавать экземпляры класса в других доменах приложений, а также вызывать методы за пределами домена приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-159">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="0a332-160">Класс в этом примере назван `Worker`.</span><span class="sxs-lookup"><span data-stu-id="0a332-160">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="0a332-161">Определите открытый метод, содержащий код, который следует выполнить.</span><span class="sxs-lookup"><span data-stu-id="0a332-161">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="0a332-162">В этом примере в коде порождается простой динамический метод, создается делегат для выполнения этого метода и вызывается делегат.</span><span class="sxs-lookup"><span data-stu-id="0a332-162">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="0a332-163">В основной программе получите отображаемое имя сборки.</span><span class="sxs-lookup"><span data-stu-id="0a332-163">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="0a332-164">Это имя используется при создании экземпляров класса `Worker` в домене изолированного приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-164">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="0a332-165">В основной программе создайте домен изолированного приложения, как описано в [первой процедуре](#Setting_up) этого пошагового руководства.</span><span class="sxs-lookup"><span data-stu-id="0a332-165">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="0a332-166">Добавлять какие-либо разрешения в набор разрешений `Internet` не нужно, так как метод `SimpleEmitDemo` использует только открытые методы.</span><span class="sxs-lookup"><span data-stu-id="0a332-166">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="0a332-167">В основной программе создайте экземпляр класса `Worker` в домене изолированного приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-167">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="0a332-168">Метод <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> создает объект в целевом домене приложения и возвращает прокси, который может использоваться для вызова свойств и методов объекта.</span><span class="sxs-lookup"><span data-stu-id="0a332-168">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0a332-169">При использовании этого кода в Visual Studio необходимо изменить имя класса для включения пространства имен.</span><span class="sxs-lookup"><span data-stu-id="0a332-169">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="0a332-170">По умолчанию пространство имен носит имя проекта.</span><span class="sxs-lookup"><span data-stu-id="0a332-170">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="0a332-171">Например, если проект называется PartialTrust, имя класса должно быть PartialTrust.Worker.</span><span class="sxs-lookup"><span data-stu-id="0a332-171">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="0a332-172">Добавьте код для вызова метода `SimpleEmitDemo`.</span><span class="sxs-lookup"><span data-stu-id="0a332-172">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="0a332-173">Вызов маршалируется за пределы домена приложения, а код выполняется в изолированном домене приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-173">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="0a332-174">Использование анонимно размещенных динамических методов</span><span class="sxs-lookup"><span data-stu-id="0a332-174">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="0a332-175">Анонимно размещенные динамические методы связаны с прозрачной сборкой, предоставленной системой.</span><span class="sxs-lookup"><span data-stu-id="0a332-175">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="0a332-176">Поэтому содержащийся в них код является прозрачным.</span><span class="sxs-lookup"><span data-stu-id="0a332-176">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="0a332-177">С другой стороны, обычные динамические методы должны быть связаны с существующим модулем (указанным непосредственно или выведенным из связанного типа) и принимать от него уровень безопасности.</span><span class="sxs-lookup"><span data-stu-id="0a332-177">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="0a332-178">Единственный способ сопоставления динамического метода со сборкой, предоставляющей анонимное размещение, — это использование конструкторов, описанных в следующей процедуре.</span><span class="sxs-lookup"><span data-stu-id="0a332-178">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="0a332-179">Невозможно явно указать модуль в анонимно размещающей сборке.</span><span class="sxs-lookup"><span data-stu-id="0a332-179">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="0a332-180">Обычные динамические методы имеют доступ к внутренним членам модуля, с которым они связаны, или к закрытым членам типа, с которым они связаны.</span><span class="sxs-lookup"><span data-stu-id="0a332-180">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="0a332-181">Так как анонимно размещенные динамические методы изолированы от другого кода, они не имеют доступа к конфиденциальным данным.</span><span class="sxs-lookup"><span data-stu-id="0a332-181">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="0a332-182">Но у них есть ограниченная возможность пропускать проверки видимости, выполняемые JIT-компилятором, для получения доступа к конфиденциальным данным.</span><span class="sxs-lookup"><span data-stu-id="0a332-182">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="0a332-183">Эта возможность ограничивается сборками, уровень доверия которых не превышает уровень доверия сборки, породившей этот код.</span><span class="sxs-lookup"><span data-stu-id="0a332-183">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="0a332-184">Чтобы предотвратить повышение привилегий, при создании анонимно размещенных динамических методов включаются также сведения стека для порождающей сборки.</span><span class="sxs-lookup"><span data-stu-id="0a332-184">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="0a332-185">При вызове метода проверяются сведения стека.</span><span class="sxs-lookup"><span data-stu-id="0a332-185">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="0a332-186">Вызванный из полностью доверенного кода анонимно размещенный динамический метод все так же ограничен уровнем доверия породившей его сборки.</span><span class="sxs-lookup"><span data-stu-id="0a332-186">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="0a332-187">Использование анонимно размещенных динамических методов</span><span class="sxs-lookup"><span data-stu-id="0a332-187">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="0a332-188">Создайте анонимно размещенный динамический метод с помощью конструктора, который не задает связанный модуль или тип.</span><span class="sxs-lookup"><span data-stu-id="0a332-188">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="0a332-189">Если анонимно размещенный динамический метод использует только открытые типы и методы, ему не требуется ограниченный доступ к членам и он может не пропускать проверки видимости, выполняемые JIT-компилятором.</span><span class="sxs-lookup"><span data-stu-id="0a332-189">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="0a332-190">Специальных разрешений для порождения динамического метода не требуется, но порождаемый код нуждается в разрешениях, которые требуются для используемых в этом коде типов и методов.</span><span class="sxs-lookup"><span data-stu-id="0a332-190">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="0a332-191">Например, если порожденный код вызывает метод, который получает доступ к файлу, необходимо разрешение <xref:System.Security.Permissions.FileIOPermission>.</span><span class="sxs-lookup"><span data-stu-id="0a332-191">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="0a332-192">Если уровень доверия не включает это разрешение, при выполнении порожденного кода создается исключение безопасности.</span><span class="sxs-lookup"><span data-stu-id="0a332-192">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="0a332-193">Приведенный здесь код порождает динамический метод, который использует только метод <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0a332-193">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="0a332-194">Поэтому код может быть выполнен в расположениях с частичным доверием.</span><span class="sxs-lookup"><span data-stu-id="0a332-194">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="0a332-195">Кроме того, вы можете создать анонимно размещенный динамический метод с ограниченной возможностью пропуска проверок видимости, выполняемых JIT-компилятором, путем использования конструктора <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> и указания значения `true` для параметра `restrictedSkipVisibility`.</span><span class="sxs-lookup"><span data-stu-id="0a332-195">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="0a332-196">Ограничение заключается в том, что анонимно размещенный динамический метод может получать доступ к конфиденциальным данным только в сборках, уровень доверия которых не превышает уровень доверия порождающей сборки.</span><span class="sxs-lookup"><span data-stu-id="0a332-196">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="0a332-197">Например, если динамический метод выполняется с доверием Интернету, он может получить доступ к конфиденциальным данным в других сборках, которые также работают с доверием Интернету, но не может получить доступ к конфиденциальным данным сборок .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="0a332-197">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="0a332-198">Сборки .NET framework устанавливаются в глобальном кэше сборок и всегда имеют полное доверие.</span><span class="sxs-lookup"><span data-stu-id="0a332-198">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="0a332-199">Анонимно размещенные динамические методы могут использовать эту ограниченную возможность пропуска проверок видимости, выполняемых JIT-компилятором, только в том случае, если ведущее приложение предоставляет разрешение <xref:System.Security.Permissions.ReflectionPermission> с флагом <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0a332-199">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="0a332-200">Это разрешение требуется при вызове метода.</span><span class="sxs-lookup"><span data-stu-id="0a332-200">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="0a332-201">Сведения стека вызовов для порождающей сборки включаются при создании динамического метода.</span><span class="sxs-lookup"><span data-stu-id="0a332-201">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="0a332-202">Поэтому запрос делается в отношении разрешений порождающей сборки, а не сборки, вызывающей метод.</span><span class="sxs-lookup"><span data-stu-id="0a332-202">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="0a332-203">Это препятствует выполнению порожденного кода с повышенным уровнем разрешений.</span><span class="sxs-lookup"><span data-stu-id="0a332-203">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="0a332-204">[Полный пример кода](#Example) в конце этого пошагового руководства служит для демонстрации использования ограниченного доступа к членам.</span><span class="sxs-lookup"><span data-stu-id="0a332-204">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="0a332-205">Класс `Worker` содержит метод, который может создавать анонимно размещенные динамические методы с ограниченной возможностью пропускать проверки видимости или без нее, а в примере показан результат выполнения этого метода в доменах приложений с другими уровнями доверия.</span><span class="sxs-lookup"><span data-stu-id="0a332-205">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="0a332-206">Ограниченная возможность пропускать проверки видимости — это функциональная возможность анонимно размещенных динамических методов.</span><span class="sxs-lookup"><span data-stu-id="0a332-206">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="0a332-207">Если обычные динамические методы пропускают проверки видимости, выполняемые JIT-компилятором, им следует предоставить полное доверие.</span><span class="sxs-lookup"><span data-stu-id="0a332-207">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="0a332-208">Пример</span><span class="sxs-lookup"><span data-stu-id="0a332-208">Example</span></span>

### <a name="description"></a><span data-ttu-id="0a332-209">Описание</span><span class="sxs-lookup"><span data-stu-id="0a332-209">Description</span></span>

<span data-ttu-id="0a332-210">В следующем примере кода демонстрируется использование флага <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> для разрешения пропуска проверок видимости, выполняемых JIT-компилятором, анонимно размещенными динамическими методами, но только в тех случаях, когда уровень доверия целевого члена не превышает уровень доверия сборки, порождающей код.</span><span class="sxs-lookup"><span data-stu-id="0a332-210">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="0a332-211">В примере определяется класс `Worker`, который может маршалироваться через границы домена приложения.</span><span class="sxs-lookup"><span data-stu-id="0a332-211">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="0a332-212">Этот класс содержит две перегрузки метода `AccessPrivateMethod`, которые порождают и выполняют динамические методы.</span><span class="sxs-lookup"><span data-stu-id="0a332-212">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="0a332-213">Первая перегрузка порождает динамический метод, который вызывает закрытый метод `PrivateMethod` класса `Worker`. Она может порождать динамический метод с проверкой видимости с помощью JIT-компилятора или без нее.</span><span class="sxs-lookup"><span data-stu-id="0a332-213">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="0a332-214">Вторая перегрузка порождает динамический метод, который получает доступ к свойству `internal` (свойство `Friend` в Visual Basic) класса <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="0a332-214">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="0a332-215">В примере используется вспомогательный метод для создания набора правил, ограниченного разрешениями `Internet`, а затем создается домен приложения с помощью перегрузки метода <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> для указания необходимости использовать этот набор правил для всего кода, выполняемого в домене.</span><span class="sxs-lookup"><span data-stu-id="0a332-215">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="0a332-216">В примере создается экземпляр класса `Worker` в домене приложения, а затем дважды выполняется метод `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="0a332-216">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="0a332-217">При первом выполнении метода `AccessPrivateMethod` принудительно выполняются проверки видимости с помощью JIT-компилятора.</span><span class="sxs-lookup"><span data-stu-id="0a332-217">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="0a332-218">Динамический метод завершается сбоем после вызова, так как проверки видимости с помощью JIT-компилятора не дают ему получить доступ к закрытому методу.</span><span class="sxs-lookup"><span data-stu-id="0a332-218">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="0a332-219">При втором выполнении метода `AccessPrivateMethod` проверки видимости с помощью JIT-компилятора пропускаются.</span><span class="sxs-lookup"><span data-stu-id="0a332-219">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="0a332-220">Компиляция динамического метода завершается сбоем, так как набор правил `Internet` не предоставляет достаточных разрешений для пропуска проверок видимости.</span><span class="sxs-lookup"><span data-stu-id="0a332-220">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="0a332-221">В примере в набор правил добавляется <xref:System.Security.Permissions.ReflectionPermission> с <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0a332-221">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="0a332-222">Затем в примере создается второй домен и указывается, что весь код, выполняемый в домене, получает разрешения из нового набора правил.</span><span class="sxs-lookup"><span data-stu-id="0a332-222">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="0a332-223">В примере создается экземпляр класса `Worker` в новом домене приложения, а затем выполняются обе перегрузки метода `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="0a332-223">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="0a332-224">Выполняется первая перегрузка метода `AccessPrivateMethod`, и проверки видимости с помощью JIT-компилятора пропускаются.</span><span class="sxs-lookup"><span data-stu-id="0a332-224">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="0a332-225">Динамический метод успешно компилируется и выполняется, так как сборка, породившая код, является такой же, как сборка, содержащая закрытый метод.</span><span class="sxs-lookup"><span data-stu-id="0a332-225">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="0a332-226">Поэтому уровни доверия одинаковы.</span><span class="sxs-lookup"><span data-stu-id="0a332-226">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="0a332-227">Если приложение, содержащее класс `Worker`, содержало бы несколько сборок, этот же процесс прошел бы успешно для любой из них, так как они все имели бы один и тот же уровень доверия.</span><span class="sxs-lookup"><span data-stu-id="0a332-227">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="0a332-228">Выполняется вторая перегрузка метода `AccessPrivateMethod`, и проверки видимости с помощью JIT-компилятора снова пропускаются.</span><span class="sxs-lookup"><span data-stu-id="0a332-228">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="0a332-229">На этот раз компиляция динамического метода завершается сбоем, потому что происходит попытка получить доступ к свойству `internal` `FirstChar` класса <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="0a332-229">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="0a332-230">Сборка, содержащая класс <xref:System.String>, имеет полное доверие.</span><span class="sxs-lookup"><span data-stu-id="0a332-230">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="0a332-231">Поэтому уровень доверия выше, чем у сборки, порождающей код.</span><span class="sxs-lookup"><span data-stu-id="0a332-231">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="0a332-232">В этом сравнении показано, как <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> позволяет пропускать в частично доверенном коде проверки видимости, предназначенные для другого частично доверенного кода, без нарушения безопасности доверенного кода.</span><span class="sxs-lookup"><span data-stu-id="0a332-232">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="0a332-233">Код</span><span class="sxs-lookup"><span data-stu-id="0a332-233">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="0a332-234">Компиляция кода</span><span class="sxs-lookup"><span data-stu-id="0a332-234">Compiling the Code</span></span>

- <span data-ttu-id="0a332-235">При сборке этого примера кода в Visual Studio необходимо изменить имя класса при передаче его в метод <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>, включив в него пространство имен.</span><span class="sxs-lookup"><span data-stu-id="0a332-235">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="0a332-236">По умолчанию пространство имен носит имя проекта.</span><span class="sxs-lookup"><span data-stu-id="0a332-236">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="0a332-237">Например, если проект называется PartialTrust, имя класса должно быть PartialTrust.Worker.</span><span class="sxs-lookup"><span data-stu-id="0a332-237">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="0a332-238">См. также</span><span class="sxs-lookup"><span data-stu-id="0a332-238">See also</span></span>

- [<span data-ttu-id="0a332-239">Вопросы безопасности в порождении отражения</span><span class="sxs-lookup"><span data-stu-id="0a332-239">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="0a332-240">Практическое руководство. Выполнение не вполне безопасного кода в изолированной среде</span><span class="sxs-lookup"><span data-stu-id="0a332-240">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
