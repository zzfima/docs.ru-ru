---
title: Практическое руководство. Включение обнаружения воспроизведения маркеров
ms.date: 03/30/2017
ms.assetid: 5a9f5771-f5f6-4100-8501-406aa20d731a
author: BrucePerlerMS
manager: mbaldwin
ms.openlocfilehash: dd5adf39c37fce92d4caf1d85e2a6a12e9e6b59b
ms.sourcegitcommit: 2eceb05f1a5bb261291a1f6a91c5153727ac1c19
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/04/2018
ms.locfileid: "43504357"
---
# <a name="how-to-enable-token-replay-detection"></a>Практическое руководство. Включение обнаружения воспроизведения маркеров
## <a name="applies-to"></a>Применение  
  
-   Microsoft® Windows® Identity Foundation (WIF)  
  
-   Веб-формы ASP.NET®  
  
## <a name="summary"></a>Сводка  
 Это практическое руководство содержит подробные пошаговые инструкции по включению обнаружения воспроизведения маркеров в приложении ASP.NET, использующем платформу WIF. Также здесь приводятся инструкции по проверке приложения на наличие включенной функции обнаружения воспроизведения маркеров. В этом практическом руководстве нет подробных инструкций по созданию службы токенов безопасности (STS); вместо этого используется служба Development STS, входящая в состав средства Identity and Access Tool. Служба Development STS не выполняет фактическую аутентификацию и предназначена только для тестирования. Для выполнения этого практического руководства необходимо установить средство Identity and Access Tool. Его можно скачать на следующей странице: [Средство Identity and Access Tool](https://go.microsoft.com/fwlink/?LinkID=245849)  
  
## <a name="contents"></a>Описание  
  
-   Цели  
  
-   Обзор  
  
-   Сводка действий  
  
-   Шаг 1. Создание простого приложения веб-форм ASP.NET и включение обнаружения воспроизведения  
  
-   Шаг 2. Тестирование решения  
  
## <a name="objectives"></a>Цели  
  
-   Создание простого приложения ASP.NET, которое использует WIF и службу Development STS в составе средства Identity and Access Tool  
  
-   Включение обнаружения воспроизведения маркеров и проверка работоспособности этой функции  
  
## <a name="overview"></a>Обзор  
 Атаки с повторением пакетов возникают в тех случаях, когда клиент пытается проверить подлинность проверяющей стороны с помощью маркера службы маркеров безопасности, который уже был использован этим клиентом. Чтобы предотвратить атаки такого рода, на платформе WIF применяется кэш обнаружения воспроизведения ранее использованных маркеров службы маркеров безопасности. Если обнаружение воспроизведения включено, эта функция проверяет маркер безопасности входящего запроса и определяет, был ли он использован ранее. Если этот маркер уже использовался, запрос отклоняется и возникает исключение <xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException>.  
  
 Далее демонстрируются изменения конфигурации, которые необходимы для включения обнаружения воспроизведения.  
  
## <a name="summary-of-steps"></a>Сводка действий  
  
-   Шаг 1. Создание простого приложения веб-форм ASP.NET и включение обнаружения воспроизведения  
  
-   Шаг 2. Тестирование решения  
  
## <a name="step-1--create-a-simple-aspnet-web-forms-application-and-enable-replay-detection"></a>Шаг 1. Создание простого приложения веб-форм ASP.NET и включение обнаружения воспроизведения  
 На этом шаге вы создадите приложение веб-форм ASP.NET и включите обнаружение воспроизведения, изменив файл *Web.config*.  
  
#### <a name="to-create-a-simple-aspnet-application"></a>Создание простого приложения ASP.NET  
  
1.  Запустите Visual Studio и выберите **Файл**, **Создать** и затем **Проект**.  
  
2.  В окне **Новый проект** выберите **Приложение веб-форм ASP.NET**.  
  
3.  В поле **Имя** введите `TestApp` и нажмите кнопку **ОК**.  
  
4.  В **обозревателе решений** щелкните правой кнопкой мыши проект **TestApp**, а затем выберите **Идентификация и доступ**.  
  
5.  Откроется окно **Идентификация и доступ**. В поле **Поставщики** выберите **Протестировать приложение с помощью локальной службы Development STS** и нажмите кнопку **Применить**.  
  
6.  Добавьте следующий элемент **\<tokenReplayDetection>** в файл конфигурации *Web.config* непосредственно после элементов **\<system.identityModel>** и **\<identityConfiguration>**, как показано ниже:  
  
    ```xml  
    <system.identityModel>  
        <identityConfiguration>  
            <tokenReplayDetection enabled="true"/>  
    ```  
  
## <a name="step-2--test-your-solution"></a>Шаг 2. Тестирование решения  
 На этом шаге вы проверите, включено ли обнаружение воспроизведения в приложении ASP.NET с поддержкой WIF.  
  
#### <a name="to-test-your-wif-enabled-aspnet-application-for-replay-detection"></a>Проверка обнаружения воспроизведения в приложении ASP.NET с поддержкой WIF  
  
1.  Запустите решение, нажав клавишу **F5**. Откроется домашняя страница ASP.NET по умолчанию, и будет выполнен автоматический вход в систему с именем пользователя *Terry*. Это пользователь по умолчанию для службы Development STS.  
  
2.  Нажмите кнопку **Назад** в браузере. Появится страница **Ошибка сервера в приложении "/"** со следующим описанием: *ID1062: обнаружено повторение: Token: "System.IdentityModel.Tokens.SamlSecurityToken"*, *AssertionId*, *Issuer*.  
  
     Эта страница появляется в том случае, если было обнаружено воспроизведение маркера безопасности и возникло исключение <xref:System.IdentityModel.Tokens.SecurityTokenReplayDetectedException>. Эта ошибка происходит при попытке повторно отправить первоначальный запрос POST, для которого сначала был предоставлен маркер безопасности. Такое поведение не наблюдается при нажатии кнопки **Назад** для последующих запросов к серверу.
