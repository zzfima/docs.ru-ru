---
title: Образец безопасности при обнаружении
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: cfee226f52bc5f001b2952b76b40ce0eb8aebceb
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76728850"
---
# <a name="discovery-security-sample"></a>Образец безопасности при обнаружении

В спецификации Discovery не требуется защищенность конечных точек, участвующих в процессе обнаружения. Включение функций безопасности для сообщений обнаружения обеспечивает защиту от атак различного типа (изменение сообщений, отказ в обслуживании, воспроизведение, подделка пакетов). В этом образце реализованы пользовательские каналы, которые вычисляют и проверяют сигнатуры сообщений в компактном формате (описан в разделе 8.2 спецификации WS-Discovery). Пример поддерживает [спецификацию обнаружения 2005](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) и [версию 1,1](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).  
  
 Пользовательские каналы применяются после существующего стека каналов для конечных точек обнаружения и объявления. Таким образом, заголовок сигнатуры применяется к каждому отправляемому сообщению. В получаемых сообщениях проверяется сигнатура, и сообщения, где сигнатура не совпадает или отсутствует, отбрасываются. Для подписания и проверки сообщений в образце применяются сертификаты.  
  
## <a name="discussion"></a>Обсуждение  
 Платформа WCF дает большие возможности для расширения и позволяет пользователям настраивать каналы нужным образом. В образце реализуется элемент защищенной привязки обнаружения, который создает защищенные каналы. В защищенных каналах проверяются сигнатуры сообщений, которые добавляются поверх текущего стека.  
  
 Элемент защищенной привязки создает защищенные фабрики каналов и прослушиватели каналов.  
  
## <a name="secure-channel-factory"></a>Защищенная фабрика каналов  
 Защищенная фабрика каналов создает выходные или дуплексные каналы, которые добавляют в заголовки сообщений компактную сигнатуру. Компактный формат сигнатуры применяется, чтобы сохранить минимальный размер сообщения. В следующем примере показана структура компактной сигнатуры.  
  
```xml  
<d:Security ... >   
  [<d:Sig Scheme="xs:anyURI"   
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"   
          Sig="xs:base64Binary"   
          ... />]?  
  ...   
</d:Security>  
```  
  
> [!NOTE]
> Элемент `PrefixList` добавлен в версии 2008 протокола Discovery.  
  
 Для вычисления сигнатуры в образце определяются развернутые элементы сигнатуры. Создается XML-сигнатура (`SignedInfo`) с использованием префикса пространства имен `ds` согласно спецификации WS-Discovery. В сигнатуре содержатся ссылки на текст и все заголовки в пространствах имен обнаружения и адресации. Это исключает незаконное изменение заголовков и текста. Каждый элемент, на который указывает ссылка, преобразуется с помощью монопольной канонизации (http://www.w3.org/2001/10/xml-exc-c14n# ), а затем вычисляются значения дайджеста SHA-1 (http://www.w3.org/2000/09/xmldsig#sha1 ). На основе всех элементов, на которые имеются ссылки, и их значений дайджеста значение сигнатуры вычисляются с помощью алгоритма RSA (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).  
  
 Сообщения подписываются сертификатом, указанным клиентом. Место хранения, имя и имя темы сертификата должны указываться при создании элемента привязки. Элемент `KeyId` в компактной сигнатуре представляет идентификатор ключа маркера подписания и служит идентификатором ключа субъекта (SKI) для маркера подписания либо (если SKI не существует) хэшем SHA-1 для открытого ключа маркера подписания.  
  
## <a name="secure-channel-listener"></a>Прослушиватель защищенного канала  
 Прослушиватель защищенного канала создает входные или дуплексные каналы, которые проверяют компактную сигнатуру в полученных сообщениях. В ходе проверки сигнатуры элемент `KeyId`, указанный в компактной сигнатуре, присоединенной к сообщению, используется для выбора сертификата из указанного хранилища. Если в сообщении отсутствует сигнатура или сигнатура не проходит проверку, то сообщение удаляется. Для использования защищенной привязки в образце определяется фабрика, которая создает пользовательские конечные точки <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> и <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> с добавленным элементом защищенной привязки обнаружения. Такие защищенные конечные точки можно использовать в прослушивателях объявлений об обнаружении и службах, поддерживающих обнаружение.  
  
## <a name="sample-details"></a>Подробные сведения об образце  
 В образец входит библиотека и 4 консольных приложения.  
  
- **Дисковерисекуритичаннелс**: Библиотека, предоставляющая безопасную привязку. Библиотека вычисляет и проверяет компактную сигнатуру для исходящих и входящих сообщений.  
  
- **Служба**: служба, предоставляя контракт ICalculatorService, который размещается самостоятельно. Служба помечена как доступная для обнаружения. Пользователь указывает данные сертификата, используемого для подписания сообщения, указывая место хранения, имя и имя темы или другой уникальный идентификатор сертификата, а также хранилище, где находятся сертификаты клиента (сертификаты, используемые для проверки сигнатуры входящих сообщений). С учетом этих данных создается и используется точка UdpDiscoveryEndpoint с функциями безопасности.  
  
- **Клиент**: Этот класс пытается обнаружить ICalculatorService и вызвать методы в службе. Здесь также создается точка <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> с функциями безопасности,которая используется для подписания и проверки сообщений.  
  
- **Аннаунцементлистенер**: автономная служба, которая прослушивает объявления в сети и в автономном режиме и использует конечную точку безопасного объявления.  
  
> [!NOTE]
> Если файл Setup.bat запускается несколько раз, то диспетчер сертификатов предлагает выбрать сертификат для использования, поскольку обнаруживается несколько сертификатов. В этом случае следует прервать работу Setup.bat и запустить файл Cleanup.bat, поскольку уже созданы повторяющиеся сертификаты. Cleanup.bat также предлагает выбрать сертификат для удаления. Выберите сертификат из списка и продолжайте выполнение Cleanup.bat, пока не останется ни одного сертификата.  
  
#### <a name="to-use-this-sample"></a>Использование этого образца  
  
1. Выполните сценарий Setup. bat из Командная строка разработчика для Visual Studio. Для подписания и проверки сообщений в образце применяются сертификаты. Скрипт создает сертификаты, запуская программу Makecert.exe, а затем устанавливает их, запуская программу Certmgr.exe. Скрипт необходимо запускать с правами администратора.  
  
2. Чтобы собрать и запустить пример, откройте файл Security. sln в Visual Studio и выберите **перестроить все**. Обновите свойства решения, чтобы запустить несколько проектов: выберите **Запуск** для всех проектов, кроме дисковерисекуречаннелс. Запустите решение обычным образом.  
  
3. После завершения работы образца выполните скрипт Cleanup.bat, который удаляет сертификаты, созданные для этого образца.  
  
> [!IMPORTANT]
> Образцы уже могут быть установлены на компьютере. Перед продолжением проверьте следующий каталог (по умолчанию).  
>   
> `<InstallDrive>:\WF_WCF_Samples`  
>   
> Если этот каталог не существует, перейдите к [примерам Windows Communication Foundation (WCF) и Windows Workflow Foundation (WF) для .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) , чтобы скачать все Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] Samples. Этот образец расположен в следующем каталоге.  
>   
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
