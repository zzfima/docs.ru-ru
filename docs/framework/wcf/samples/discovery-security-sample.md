---
title: Образец безопасности при обнаружении
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 8469b69baabcd2ba9185956c276554b4bb929d85
ms.sourcegitcommit: 5fb5b6520b06d7f5e6131ec2ad854da302a28f2e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74712059"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="e1885-102">Образец безопасности при обнаружении</span><span class="sxs-lookup"><span data-stu-id="e1885-102">Discovery Security Sample</span></span>
<span data-ttu-id="e1885-103">В спецификации Discovery не требуется защищенность конечных точек, участвующих в процессе обнаружения.</span><span class="sxs-lookup"><span data-stu-id="e1885-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="e1885-104">Включение функций безопасности для сообщений обнаружения обеспечивает защиту от атак различного типа (изменение сообщений, отказ в обслуживании, воспроизведение, подделка пакетов).</span><span class="sxs-lookup"><span data-stu-id="e1885-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="e1885-105">В этом образце реализованы пользовательские каналы, которые вычисляют и проверяют сигнатуры сообщений в компактном формате (описан в разделе 8.2 спецификации WS-Discovery).</span><span class="sxs-lookup"><span data-stu-id="e1885-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="e1885-106">Пример поддерживает [спецификацию обнаружения 2005](https://go.microsoft.com/fwlink/?LinkId=177912) и [версию 1,1](https://go.microsoft.com/fwlink/?LinkId=179677).</span><span class="sxs-lookup"><span data-stu-id="e1885-106">The sample supports both the [2005 Discovery specification](https://go.microsoft.com/fwlink/?LinkId=177912) and the [1.1 version](https://go.microsoft.com/fwlink/?LinkId=179677).</span></span>  
  
 <span data-ttu-id="e1885-107">Пользовательские каналы применяются после существующего стека каналов для конечных точек обнаружения и объявления.</span><span class="sxs-lookup"><span data-stu-id="e1885-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="e1885-108">Таким образом, заголовок сигнатуры применяется к каждому отправляемому сообщению.</span><span class="sxs-lookup"><span data-stu-id="e1885-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="e1885-109">В получаемых сообщениях проверяется сигнатура, и сообщения, где сигнатура не совпадает или отсутствует, отбрасываются.</span><span class="sxs-lookup"><span data-stu-id="e1885-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="e1885-110">Для подписания и проверки сообщений в образце применяются сертификаты.</span><span class="sxs-lookup"><span data-stu-id="e1885-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="e1885-111">Обсуждение</span><span class="sxs-lookup"><span data-stu-id="e1885-111">Discussion</span></span>  
 <span data-ttu-id="e1885-112">Платформа WCF дает большие возможности для расширения и позволяет пользователям настраивать каналы нужным образом.</span><span class="sxs-lookup"><span data-stu-id="e1885-112">WCF is very extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="e1885-113">В образце реализуется элемент защищенной привязки обнаружения, который создает защищенные каналы.</span><span class="sxs-lookup"><span data-stu-id="e1885-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="e1885-114">В защищенных каналах проверяются сигнатуры сообщений, которые добавляются поверх текущего стека.</span><span class="sxs-lookup"><span data-stu-id="e1885-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="e1885-115">Элемент защищенной привязки создает защищенные фабрики каналов и прослушиватели каналов.</span><span class="sxs-lookup"><span data-stu-id="e1885-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="e1885-116">Защищенная фабрика каналов</span><span class="sxs-lookup"><span data-stu-id="e1885-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="e1885-117">Защищенная фабрика каналов создает выходные или дуплексные каналы, которые добавляют в заголовки сообщений компактную сигнатуру.</span><span class="sxs-lookup"><span data-stu-id="e1885-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="e1885-118">Компактный формат сигнатуры применяется, чтобы сохранить минимальный размер сообщения.</span><span class="sxs-lookup"><span data-stu-id="e1885-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="e1885-119">В следующем примере показана структура компактной сигнатуры.</span><span class="sxs-lookup"><span data-stu-id="e1885-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >   
  [<d:Sig Scheme="xs:anyURI"   
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"   
          Sig="xs:base64Binary"   
          ... />]?  
  ...   
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="e1885-120">Элемент `PrefixList` добавлен в версии 2008 протокола Discovery.</span><span class="sxs-lookup"><span data-stu-id="e1885-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="e1885-121">Для вычисления сигнатуры в образце определяются развернутые элементы сигнатуры.</span><span class="sxs-lookup"><span data-stu-id="e1885-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="e1885-122">Создается XML-сигнатура (`SignedInfo`) с использованием префикса пространства имен `ds` согласно спецификации WS-Discovery.</span><span class="sxs-lookup"><span data-stu-id="e1885-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="e1885-123">В сигнатуре содержатся ссылки на текст и все заголовки в пространствах имен обнаружения и адресации. Это исключает незаконное изменение заголовков и текста.</span><span class="sxs-lookup"><span data-stu-id="e1885-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="e1885-124">Каждый элемент, на который указывает ссылка, преобразуется с помощью монопольной канонизации (http://www.w3.org/2001/10/xml-exc-c14n# ), а затем вычисляются значения дайджеста SHA-1 (http://www.w3.org/2000/09/xmldsig#sha1 ).</span><span class="sxs-lookup"><span data-stu-id="e1885-124">Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).</span></span> <span data-ttu-id="e1885-125">На основе всех элементов, на которые имеются ссылки, и их значений дайджеста значение сигнатуры вычисляются с помощью алгоритма RSA (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span><span class="sxs-lookup"><span data-stu-id="e1885-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span></span>  
  
 <span data-ttu-id="e1885-126">Сообщения подписываются сертификатом, указанным клиентом.</span><span class="sxs-lookup"><span data-stu-id="e1885-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="e1885-127">Место хранения, имя и имя темы сертификата должны указываться при создании элемента привязки.</span><span class="sxs-lookup"><span data-stu-id="e1885-127">The store location, name and the certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="e1885-128">Элемент `KeyId` в компактной сигнатуре представляет идентификатор ключа маркера подписания и служит идентификатором ключа субъекта (SKI) для маркера подписания либо (если SKI не существует) хэшем SHA-1 для открытого ключа маркера подписания.</span><span class="sxs-lookup"><span data-stu-id="e1885-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="e1885-129">Прослушиватель защищенного канала</span><span class="sxs-lookup"><span data-stu-id="e1885-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="e1885-130">Прослушиватель защищенного канала создает входные или дуплексные каналы, которые проверяют компактную сигнатуру в полученных сообщениях.</span><span class="sxs-lookup"><span data-stu-id="e1885-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="e1885-131">В ходе проверки сигнатуры элемент `KeyId`, указанный в компактной сигнатуре, присоединенной к сообщению, используется для выбора сертификата из указанного хранилища.</span><span class="sxs-lookup"><span data-stu-id="e1885-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="e1885-132">Если в сообщении отсутствует сигнатура или сигнатура не проходит проверку, то сообщение удаляется.</span><span class="sxs-lookup"><span data-stu-id="e1885-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="e1885-133">Для использования защищенной привязки в образце определяется фабрика, которая создает пользовательские конечные точки <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> и <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> с добавленным элементом защищенной привязки обнаружения.</span><span class="sxs-lookup"><span data-stu-id="e1885-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="e1885-134">Такие защищенные конечные точки можно использовать в прослушивателях объявлений об обнаружении и службах, поддерживающих обнаружение.</span><span class="sxs-lookup"><span data-stu-id="e1885-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="e1885-135">Подробные сведения об образце</span><span class="sxs-lookup"><span data-stu-id="e1885-135">Sample Details</span></span>  
 <span data-ttu-id="e1885-136">В образец входит библиотека и 4 консольных приложения.</span><span class="sxs-lookup"><span data-stu-id="e1885-136">The sample includes a library and 4 console applications:</span></span>  
  
- <span data-ttu-id="e1885-137">**Дисковерисекуритичаннелс**: Библиотека, предоставляющая безопасную привязку.</span><span class="sxs-lookup"><span data-stu-id="e1885-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="e1885-138">Библиотека вычисляет и проверяет компактную сигнатуру для исходящих и входящих сообщений.</span><span class="sxs-lookup"><span data-stu-id="e1885-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="e1885-139">**Служба**: служба, предоставляя контракт ICalculatorService, который размещается самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="e1885-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="e1885-140">Служба помечена как доступная для обнаружения.</span><span class="sxs-lookup"><span data-stu-id="e1885-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="e1885-141">Пользователь указывает данные сертификата, используемого для подписания сообщения, указывая место хранения, имя и имя темы или другой уникальный идентификатор сертификата, а также хранилище, где находятся сертификаты клиента (сертификаты, используемые для проверки сигнатуры входящих сообщений).</span><span class="sxs-lookup"><span data-stu-id="e1885-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="e1885-142">С учетом этих данных создается и используется точка UdpDiscoveryEndpoint с функциями безопасности.</span><span class="sxs-lookup"><span data-stu-id="e1885-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="e1885-143">**Клиент**: Этот класс пытается обнаружить ICalculatorService и вызвать методы в службе.</span><span class="sxs-lookup"><span data-stu-id="e1885-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="e1885-144">Здесь также создается точка <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> с функциями безопасности,которая используется для подписания и проверки сообщений.</span><span class="sxs-lookup"><span data-stu-id="e1885-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="e1885-145">**Аннаунцементлистенер**: автономная служба, которая прослушивает объявления в сети и в автономном режиме и использует конечную точку безопасного объявления.</span><span class="sxs-lookup"><span data-stu-id="e1885-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e1885-146">Если файл Setup.bat запускается несколько раз, то диспетчер сертификатов предлагает выбрать сертификат для использования, поскольку обнаруживается несколько сертификатов.</span><span class="sxs-lookup"><span data-stu-id="e1885-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="e1885-147">В этом случае следует прервать работу Setup.bat и запустить файл Cleanup.bat, поскольку уже созданы повторяющиеся сертификаты.</span><span class="sxs-lookup"><span data-stu-id="e1885-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="e1885-148">Cleanup.bat также предлагает выбрать сертификат для удаления.</span><span class="sxs-lookup"><span data-stu-id="e1885-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="e1885-149">Выберите сертификат из списка и продолжайте выполнение Cleanup.bat, пока не останется ни одного сертификата.</span><span class="sxs-lookup"><span data-stu-id="e1885-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="e1885-150">Использование этого образца</span><span class="sxs-lookup"><span data-stu-id="e1885-150">To use this sample</span></span>  
  
1. <span data-ttu-id="e1885-151">Выполните сценарий Setup. bat из Командная строка разработчика для Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="e1885-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="e1885-152">Для подписания и проверки сообщений в образце применяются сертификаты.</span><span class="sxs-lookup"><span data-stu-id="e1885-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="e1885-153">Скрипт создает сертификаты, запуская программу Makecert.exe, а затем устанавливает их, запуская программу Certmgr.exe.</span><span class="sxs-lookup"><span data-stu-id="e1885-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="e1885-154">Скрипт необходимо запускать с правами администратора.</span><span class="sxs-lookup"><span data-stu-id="e1885-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="e1885-155">Чтобы собрать и запустить пример, откройте файл Security. sln в Visual Studio и выберите **перестроить все**.</span><span class="sxs-lookup"><span data-stu-id="e1885-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="e1885-156">Обновите свойства решения, чтобы запустить несколько проектов: выберите **Запуск** для всех проектов, кроме дисковерисекуречаннелс.</span><span class="sxs-lookup"><span data-stu-id="e1885-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="e1885-157">Запустите решение обычным образом.</span><span class="sxs-lookup"><span data-stu-id="e1885-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="e1885-158">После завершения работы образца выполните скрипт Cleanup.bat, который удаляет сертификаты, созданные для этого образца.</span><span class="sxs-lookup"><span data-stu-id="e1885-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="e1885-159">Образцы уже могут быть установлены на компьютере.</span><span class="sxs-lookup"><span data-stu-id="e1885-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="e1885-160">Перед продолжением проверьте следующий каталог (по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="e1885-160">Check for the following (default) directory before continuing.</span></span>  
>   
> `<InstallDrive>:\WF_WCF_Samples`  
>   
> <span data-ttu-id="e1885-161">Если этот каталог не существует, перейдите к [примерам Windows Communication Foundation (WCF) и Windows Workflow Foundation (WF) для .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) , чтобы скачать все Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] Samples.</span><span class="sxs-lookup"><span data-stu-id="e1885-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="e1885-162">Этот образец расположен в следующем каталоге.</span><span class="sxs-lookup"><span data-stu-id="e1885-162">This sample is located in the following directory.</span></span>  
>   
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
