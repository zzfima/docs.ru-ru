---
title: Общие сведения о потоках сообщений
ms.date: 03/30/2017
ms.assetid: fb0899e1-84cc-4d90-b45b-dc5a50063943
ms.openlocfilehash: 54ffd8ec2349b2dd54ca61615b2fb1b997d02932
ms.sourcegitcommit: e42d09e5966dd9fd02847d3e7eeb4ec0877069f8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/17/2018
ms.locfileid: "49372789"
---
# <a name="message-flow-overview"></a><span data-ttu-id="46686-102">Общие сведения о потоках сообщений</span><span class="sxs-lookup"><span data-stu-id="46686-102">Message Flow Overview</span></span>
<span data-ttu-id="46686-103">В распределенной системе со связанными между собой службами необходимо определять причинные взаимоотношения между службами.</span><span class="sxs-lookup"><span data-stu-id="46686-103">In a distributed system containing interconnected services, it is necessary to determine causal relationships between the services.</span></span> <span data-ttu-id="46686-104">Понимать, какие из различных компонентов входили в путь потока запроса, необходимо для решения таких важнейших задач, как наблюдения за работоспособностью, устранение неполадок и анализ первопричин.</span><span class="sxs-lookup"><span data-stu-id="46686-104">It is important to understand the various components that were part of a request flow to support critical scenarios such as health monitoring, troubleshooting, and root cause analysis.</span></span> <span data-ttu-id="46686-105">Для поддержки трассировки в различных службах в .NET Framework 4 была добавлена поддержка следующих функций.</span><span class="sxs-lookup"><span data-stu-id="46686-105">To enable the correlation of traces between various services, in the .NET Framework 4 we added support through the following features:</span></span>

-   <span data-ttu-id="46686-106">Аналитическая трассировка: высокопроизводительная функция трассировки с низкой детализацией, использующая средство отслеживания событий для Windows (ETW).</span><span class="sxs-lookup"><span data-stu-id="46686-106">Analytic tracing: A high performance and low verbosity tracing feature using Event Tracing for Windows (ETW).</span></span>

-   <span data-ttu-id="46686-107">Сквозная модель действий для служб WCF/WF: эта функция поддерживает корреляцию трассировок, создаваемых пространствами имен <xref:System.ServiceModel> и <xref:System.Workflow.ComponentModel>.</span><span class="sxs-lookup"><span data-stu-id="46686-107">End-to-end activity model for WCF/WF services: This feature supports correlation of traces generated by the <xref:System.ServiceModel> and <xref:System.Workflow.ComponentModel> namespaces.</span></span>

-   <span data-ttu-id="46686-108">Трассировка событий Windows для WF: эта функция использует записи трассировки, создаваемые службами WF, для обеспечения видимости текущего состояния и хода выполнения рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="46686-108">ETW tracking for WF: This feature uses tracking records generated by WF services to provide visibility into the workflow’s current state and progress.</span></span>

 <span data-ttu-id="46686-109">Ошибки, зарегистрированные в сеансе отслеживания или трассировки, позволяют находить дефекты кода или неверно сформированные сообщения.</span><span class="sxs-lookup"><span data-stu-id="46686-109">Errors logged in a tracking or tracing record can be used to find code defects or incorrectly formed messages.</span></span> <span data-ttu-id="46686-110">Свойство ActivityId узла Correlation в заголовке сообщения события может использоваться для нахождения сбойного действия.</span><span class="sxs-lookup"><span data-stu-id="46686-110">The ActivityId property of the Correlation node in the event’s message header can be used to determine the faulting activity.</span></span> <span data-ttu-id="46686-111">Чтобы включить трассировку потока сообщений по Идентификатору действия, см. в разделе [Configuring Message Flow Tracing](../../../../docs/framework/wcf/diagnostics/etw/configuring-message-flow-tracing.md).</span><span class="sxs-lookup"><span data-stu-id="46686-111">To enable message flow tracing by activity ID, see [Configuring Message Flow Tracing](../../../../docs/framework/wcf/diagnostics/etw/configuring-message-flow-tracing.md).</span></span> <span data-ttu-id="46686-112">В этом разделе описывается включение трассировки потока сообщений в проекте, который был создан в учебнике «Приступая к работе».</span><span class="sxs-lookup"><span data-stu-id="46686-112">This topic demonstrates how to enable message flow tracing in the project created in the Getting Started tutorial.</span></span>

### <a name="to-enable-message-flow-tracing-in-the-getting-started-tutorial"></a><span data-ttu-id="46686-113">Включение трассировки потока сообщений в проекте, который был создан в учебнике «Приступая к работе»</span><span class="sxs-lookup"><span data-stu-id="46686-113">To enable message flow tracing in the Getting Started tutorial</span></span>

1.  <span data-ttu-id="46686-114">Откройте средство просмотра событий, щелкнув **запустить**, **запуска**и введя `eventvwr.exe`.</span><span class="sxs-lookup"><span data-stu-id="46686-114">Open Event Viewer by clicking **Start**, **Run**, and entering `eventvwr.exe`.</span></span>

2.  <span data-ttu-id="46686-115">Если вы еще не включено аналитическое отслеживание, разверните **журналы приложений и служб**, **Microsoft**, **Windows**, **сервер приложений-приложения** .</span><span class="sxs-lookup"><span data-stu-id="46686-115">If you haven’t enabled analytic tracing, expand **Applications and Services Logs**, **Microsoft**, **Windows**, **Application Server-Applications**.</span></span> <span data-ttu-id="46686-116">Выберите **представление**, **Отобразить аналитический и отладочный журналы**.</span><span class="sxs-lookup"><span data-stu-id="46686-116">Select **View**, **Show Analytic and Debug Logs**.</span></span> <span data-ttu-id="46686-117">Щелкните правой кнопкой мыши **аналитический** и выберите **включить журнал**.</span><span class="sxs-lookup"><span data-stu-id="46686-117">Right-click **Analytic** and select **Enable Log**.</span></span> <span data-ttu-id="46686-118">Оставьте средство просмотра событий открытым, чтобы можно было просматривать трассировки.</span><span class="sxs-lookup"><span data-stu-id="46686-118">Leave Event Viewer open so that traces can be viewed.</span></span>

3.  <span data-ttu-id="46686-119">Откройте образец, созданный в [Приступая к работе](../../../../docs/framework/wcf/getting-started-tutorial.md) в Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="46686-119">Open the sample created in the [Getting Started Tutorial](../../../../docs/framework/wcf/getting-started-tutorial.md) in Visual Studio 2012.</span></span> <span data-ttu-id="46686-120">Обратите внимание на то, что Visual Studio 2012 следует запустить с правами администратора для создания службы.</span><span class="sxs-lookup"><span data-stu-id="46686-120">Note that you must run Visual Studio 2012 as an administrator so that the service can be created.</span></span> <span data-ttu-id="46686-121">Если у вас есть установить образцы WCF, можно открыть [Приступая к работе](../../../../docs/framework/wcf/samples/getting-started-sample.md), который содержит выполненный проект, созданный в этом руководстве.</span><span class="sxs-lookup"><span data-stu-id="46686-121">If you have the WCF samples installed, you can open the [Getting Started](../../../../docs/framework/wcf/samples/getting-started-sample.md), which contains the completed project created in the tutorial.</span></span>

4.  <span data-ttu-id="46686-122">Щелкните правой кнопкой мыши **службы** проекта и выберите **добавить**, **новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="46686-122">Right-click the **Service** project and select **Add**, **New Item**.</span></span> <span data-ttu-id="46686-123">Выберите **файла конфигурации приложения** и нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="46686-123">Select **Application Configuration File** and click **OK**.</span></span>

5.  <span data-ttu-id="46686-124">Добавьте следующий код в файл App.Config, созданный в предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="46686-124">Add the following code to the App.Config file created in the previous step.</span></span>

    ```xml
    <system.serviceModel>
      <diagnostics>
        <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
      </diagnostics>
    </system.serviceModel>
    ```

6.  <span data-ttu-id="46686-125">Выполните серверное приложение без отладки, нажав CTRL+F5.</span><span class="sxs-lookup"><span data-stu-id="46686-125">Execute the server application without debugging by pressing CTRL+F5.</span></span> <span data-ttu-id="46686-126">Выполнить проект клиента, щелкните правой кнопкой мыши **клиента** проекта и выбрав **Отладка**, **запустить новый экземпляр**.</span><span class="sxs-lookup"><span data-stu-id="46686-126">Execute the client project by right-clicking the **Client** project and selecting **Debug**, **Start New Instance**.</span></span>

7.  <span data-ttu-id="46686-127">Для трассировки событий от клиента на сервер добавьте в файл конфигурации приложения в проекте Client следующее.</span><span class="sxs-lookup"><span data-stu-id="46686-127">To trace the events from the client to the server, add the following to the application configuration file in the Client project.</span></span>

    ```xml
    <diagnostics>
      <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
    </diagnostics>
    ```

8.  <span data-ttu-id="46686-128">В файле Program.cs в клиенте добавьте следующий оператор Using.</span><span class="sxs-lookup"><span data-stu-id="46686-128">In Program.cs in the client, add the following Using statement.</span></span>

    ```csharp
    using System.Diagnostics;
    ```

9. <span data-ttu-id="46686-129">В методе Main файла program.cs клиентского проекта задайте распространение идентификатора GUID трассировки в журнале событий.</span><span class="sxs-lookup"><span data-stu-id="46686-129">In the Main method in the program.cs file in the client project, set the Trace GUID to be propagated in the event log.</span></span>

    ```csharp
    Guid guid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = guid;
    ```

10. <span data-ttu-id="46686-130">Обновите и просмотрите **аналитический** журнала.</span><span class="sxs-lookup"><span data-stu-id="46686-130">Refresh and examine the **Analytic**  log.</span></span>  <span data-ttu-id="46686-131">Найдите событие с идентификатором 220.</span><span class="sxs-lookup"><span data-stu-id="46686-131">Look for an event with Event ID 220.</span></span>  <span data-ttu-id="46686-132">Выберите событие и нажмите кнопку **сведения** вкладку на панели предварительного просмотра.</span><span class="sxs-lookup"><span data-stu-id="46686-132">Select the event, and click the **Details** tab in the preview pane.</span></span> <span data-ttu-id="46686-133">Это событие будет содержать идентификатор корреляции для вызывающего действия.</span><span class="sxs-lookup"><span data-stu-id="46686-133">This event will contain the correlation ID for the calling activity.</span></span>

    ```xml
    <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" />
    ```

    > [!NOTE]
    >  <span data-ttu-id="46686-134">Все события с одним и тем же идентификатором GUID в поле ActivityID (идентификатора действия) относятся к одному запросу.</span><span class="sxs-lookup"><span data-stu-id="46686-134">All events with the same GUID in the ActivityID are related to one request.</span></span> <span data-ttu-id="46686-135">Это позволяет сопоставлять сообщения от конкретного клиента определенной службе.</span><span class="sxs-lookup"><span data-stu-id="46686-135">This can be used to correlate messages from a specific client to a specific service.</span></span> <span data-ttu-id="46686-136">Если один клиент вызывает другую службу, то этого клиента можно определить по ActivityID.</span><span class="sxs-lookup"><span data-stu-id="46686-136">If the client called another service, then the same client could be identified by ActivityID.</span></span>

11. <span data-ttu-id="46686-137">В некоторых случаях ActivityID может изменяться с исходного идентификатора GUID на новый ActivityID.</span><span class="sxs-lookup"><span data-stu-id="46686-137">In some cases, the ActivityID can change from the original GUID to a new ActivityID.</span></span> <span data-ttu-id="46686-138">В этом случае возникает событие передачи.</span><span class="sxs-lookup"><span data-stu-id="46686-138">In that case, a transfer event is emitted.</span></span> <span data-ttu-id="46686-139">У этого события будет идентификатор 499, а в заголовке события будут содержаться следующие данные.</span><span class="sxs-lookup"><span data-stu-id="46686-139">This event ID is 499, and the event will contain the following data in the header.</span></span>

    ```xml
    <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
        <System>
            <Provider Name="Microsoft-Windows-Application Server-Applications" Guid="{c651f5f6-1c0d-492e-8ae1-b4efd7c9d503}" />
            <EventID>499</EventID>
            ...
            <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" RelatedActivityID="{85FC0930-9C49-42DA-804B-A7368104BD1B}" />
            ...
       </System>
    </Event>
    ```

    > [!NOTE]
    >  <span data-ttu-id="46686-140">Событие передачи фиксирует изменение активного ActivityID с GUID, указанного в качестве ActivityID, на GUID, указанный в качестве RelatedActivityID.</span><span class="sxs-lookup"><span data-stu-id="46686-140">The transfer event records the change of the active ActivityID from the GUID specified as the ActivityID to the GUID specified as RelatedActivityID.</span></span> <span data-ttu-id="46686-141">После выдачи события передачи все последующие события будут содержать новый GUID в качестве ActivityID.</span><span class="sxs-lookup"><span data-stu-id="46686-141">After the transfer event is emitted, all events will contain the new GUID as the ActivityID.</span></span>
