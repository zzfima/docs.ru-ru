---
title: Расширяемость узла службы рабочих процессов
ms.date: 03/30/2017
ms.assetid: c0e8f7bb-cb13-49ec-852f-b85d7c23972f
ms.openlocfilehash: 776fc78cd3f5b012dd40576fe56f71835e949708
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79184160"
---
# <a name="workflow-service-host-extensibility"></a><span data-ttu-id="c5ca1-102">Расширяемость узла службы рабочих процессов</span><span class="sxs-lookup"><span data-stu-id="c5ca1-102">Workflow Service Host Extensibility</span></span>
<span data-ttu-id="c5ca1-103">Платформа [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] содержит класс <xref:System.ServiceModel.Activities.WorkflowServiceHost> для размещения служб рабочих процессов.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-103">[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] provides the <xref:System.ServiceModel.Activities.WorkflowServiceHost> class for hosting workflow services.</span></span> <span data-ttu-id="c5ca1-104">Этот класс используется при размещении служб рабочих процессов в управляемом приложении или службе Windows.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-104">This class is used when you are self-hosting a workflow service in a managed application or a Windows service.</span></span> <span data-ttu-id="c5ca1-105">Этот класс также используется при размещении службы рабочего процесса в службах IIS или службе активации Windows (WAS).</span><span class="sxs-lookup"><span data-stu-id="c5ca1-105">This class is also used when hosting a workflow service with Internet Information Services (IIS) or Windows Process Activation Service (WAS).</span></span> <span data-ttu-id="c5ca1-106">Класс <xref:System.ServiceModel.Activities.WorkflowServiceHost> обеспечивает точки расширения, которые дают возможность добавлять пользовательские расширения, изменять неактивное поведение и размещать рабочие процессы, не относящиеся к службе (то есть те, которые не используют обмен сообщениями).</span><span class="sxs-lookup"><span data-stu-id="c5ca1-106">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities).</span></span>  
  
## <a name="workflow-service-host-extensions"></a><span data-ttu-id="c5ca1-107">Расширения размещения службы рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="c5ca1-107">Workflow Service Host Extensions</span></span>  
 <span data-ttu-id="c5ca1-108">Класс <xref:System.ServiceModel.Activities.WorkflowServiceHost> содержит свойство <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> типа <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager>, методы которого позволяют добавлять расширения к <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-108">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> contains a <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> property of type <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> that provides methods to add extensions to the <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span></span> <span data-ttu-id="c5ca1-109">Метод <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> используется для добавления расширения в каждый из экземпляров.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-109">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service instance.</span></span> <span data-ttu-id="c5ca1-110">Указанный делегат вызывается для создания нового расширения при создании экземпляра службы рабочего процесса или его загрузке из хранилища сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-110">The delegate specified is called to create a new extension when a workflow service instance is created or loaded from a persistence store.</span></span> <span data-ttu-id="c5ca1-111">Метод <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> используется для добавления расширения для каждого узла службы рабочего процесса, один экземпляр расширения совместно используется всеми экземплярами службы рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-111">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances.</span></span>  
  
## <a name="react-to-unhandled-exceptions"></a><span data-ttu-id="c5ca1-112">Реакция на необработанные исключения</span><span class="sxs-lookup"><span data-stu-id="c5ca1-112">React to Unhandled Exceptions</span></span>  
 <span data-ttu-id="c5ca1-113">Поведение <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> позволяет задать действие, которое должно быть выполнено в случае, если в службе рабочего процесса появляется необработанное исключение.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-113">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> enables you to specify the action to take if an unhandled exception occurs within a workflow service.</span></span> <span data-ttu-id="c5ca1-114">Свойство <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> определяет одно из следующих значений <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-114">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> property specifies one of the <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> values:</span></span>  
  
- <span data-ttu-id="c5ca1-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> - аварийно завершает работу экземпляра службы рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – Aborts the workflow service instance.</span></span>  
  
- <span data-ttu-id="c5ca1-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> - выполняет откат до последнего сохраненного состояния и приостанавливает экземпляр службы рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – Rolls back to the last persisted state and suspends the workflow service instance.</span></span> <span data-ttu-id="c5ca1-117">Это происходит только в случае, если рабочий процесс уже хотя бы раз был сохранен.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-117">This only occurs if the workflow has already been persisted at least once.</span></span> <span data-ttu-id="c5ca1-118">В противном случае экземпляр рабочего процесса аварийно завершается.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-118">If not the workflow instance is aborted.</span></span>  
  
- <span data-ttu-id="c5ca1-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> - отменяет экземпляр.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – Cancels the instance.</span></span>  
  
- <span data-ttu-id="c5ca1-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> - завершает работу экземпляра.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – Terminates the instance.</span></span>  
  
 <span data-ttu-id="c5ca1-121">Это поведение может быть настроено в коде, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-121">This behavior can be configured in code as shown in the following example.</span></span>  
  
```csharp  
host.Description.Behaviors.Add(new WorkflowUnhandledExceptionBehavior { Action = WorkflowUnhandledExceptionAction.Abandon });  
```  
  
 <span data-ttu-id="c5ca1-122">Кроме того, его можно настроить в файле конфигурации, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-122">It can also be configured in a configuration file as shown in the following example.</span></span>  
  
```xml
<behaviors>  
      <serviceBehaviors>  
        <behavior>  
          <serviceMetadata httpGetEnabled="True"/>  
          <serviceDebug includeExceptionDetailInFaults="False" />  
          <workflowUnhandledExceptionBehavior action="Abandon" />
        </behavior>  
      </serviceBehaviors>  
```  
  
## <a name="hosting-non-service-workflows"></a><span data-ttu-id="c5ca1-123">Размещение рабочих процессов, не относящихся к службе</span><span class="sxs-lookup"><span data-stu-id="c5ca1-123">Hosting Non-Service Workflows</span></span>  
 <span data-ttu-id="c5ca1-124">Объект <xref:System.ServiceModel.Activities.WorkflowServiceHost> может быть использован для размещения рабочих процессов, не относящихся к службе, а также рабочих процессов, которые либо не начинают работу с действия <xref:System.ServiceModel.Activities.Receive>, либо не используют обмен сообщениями.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> can be used to host non-service workflows, or workflows that either do not begin with a <xref:System.ServiceModel.Activities.Receive> activity or workflows that do not use the messaging activities.</span></span> <span data-ttu-id="c5ca1-125">Службы рабочих процессов, как правило, начинают работу с действия <xref:System.ServiceModel.Activities.Receive>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-125">Workflow services normally begin with a <xref:System.ServiceModel.Activities.Receive> activity.</span></span> <span data-ttu-id="c5ca1-126">Когда <xref:System.ServiceModel.Activities.WorkflowServiceHost> получает сообщение для службы рабочего процесса, создается новый экземпляр службы рабочего процесса (если он не работает и не сохранен).</span><span class="sxs-lookup"><span data-stu-id="c5ca1-126">When the <xref:System.ServiceModel.Activities.WorkflowServiceHost> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created.</span></span> <span data-ttu-id="c5ca1-127">Если рабочий процесс не начал работу с действия Receive, он не не может быть запущен отправкой сообщения, поскольку отсутствует действие, которое может принять это сообщение.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-127">If a workflow does not begin with a Receive activity, it cannot be started by sending a message because there is no activity to receive the message.</span></span> <span data-ttu-id="c5ca1-128">Чтобы разместить рабочий процесс, не являющийся службой, создайте класс, наследующий <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>, и переопределите в нем методы <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> и <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-128">To host a non-service workflow, derive a class from <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> and override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>, and <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>.</span></span> <span data-ttu-id="c5ca1-129">Переопределите метод <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, если необходимо задать определенный идентификатор экземпляра.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-129">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> if you want to provide a preferred instance ID.</span></span> <span data-ttu-id="c5ca1-130">Переопределите метод <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> для создания контекста создания рабочего процесса или заполните экземпляр из существующего <xref:System.ServiceModel.Activities.WorkflowCreationContext>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-130">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> to create a custom workflow creation context or populate an instance of the existing <xref:System.ServiceModel.Activities.WorkflowCreationContext>.</span></span> <span data-ttu-id="c5ca1-131">Переопределите метод <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>, если необходимо вручную извлекать закладку из входящего сообщения.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-131">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> to manually extract the bookmark from the incoming message.</span></span> <span data-ttu-id="c5ca1-132">При переопределении этого метода в его тексте необходимо вызвать метод <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A>, чтобы ответить на сообщение, отправленное конечной точкой WorkflowHostingEndpoint.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-132">If you override this method, you must invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> in its body so as to respond to the message sent to the WorkflowHostingEndpoint.</span></span> <span data-ttu-id="c5ca1-133">Если этого не сделать, предел <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> может быть превышен.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-133">If you do not do so, a <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> limit may be eventually exceeded.</span></span> <span data-ttu-id="c5ca1-134">В двусторонних контрактах пользователь может столкнуться с ошибкой при вызове метода <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A>, связанной с тем, что клиент не получил ответ.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-134">In two-way contracts, you may be able to detect your   failure to invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> because of the client’s failure to receive a response.</span></span> <span data-ttu-id="c5ca1-135">В односторонних контрактах может возникнуть ситуация, когда ошибка, связанная с тем, что метод <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> не вызван, будет обнаружена только после превышения предела <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A>, когда уже слишком поздно.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-135">In one-way contracts, you may not recognize the mistake of failing to call <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> until it’s too late, after the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> throttle limit is exceeded.</span></span> <span data-ttu-id="c5ca1-136">Для получения дополнительной информации, пожалуйста, смотрите [Закладку WorkflowHostingEndpoint Resume](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)Для создания нового экземпляра рабочего процесса, не связанного с обслуживанием, объявить контракт службы, определяющий операцию, создающая новый экземпляр.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-136">For more information, please see the [WorkflowHostingEndpoint Resume Bookmark](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance.</span></span> <span data-ttu-id="c5ca1-137">Операция создания должна принимать строку IDictionary,\<объект> для передачи любых необходимых параметров рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-137">The creation operation should take an IDictionary\<string, object> to pass any required workflow parameters.</span></span> <span data-ttu-id="c5ca1-138">Этот контракт неявным образом реализуется классом, производным от <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-138">This contract is implicitly implemented by the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class.</span></span> <span data-ttu-id="c5ca1-139">При размещении рабочего процесса добавьте к узлу экземпляр класса, производного от <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>, вызвав метод <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A>, а затем вызовите метод <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-139">When hosting the workflow, add an instance of the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class to the host by calling <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> and call <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>.</span></span> <span data-ttu-id="c5ca1-140">Чтобы создать экземпляр рабочего процесса, создайте фабрику <xref:System.ServiceModel.ChannelFactory%601> для типа контракта службы и вызовите метод <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-140">To create an instance of the workflow, create a <xref:System.ServiceModel.ChannelFactory%601> of your service contract type and call <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>.</span></span> <span data-ttu-id="c5ca1-141">Затем можно вызвать операцию создания, определенную в контракте службы.</span><span class="sxs-lookup"><span data-stu-id="c5ca1-141">You can then call the create operation defined in your service contract.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c5ca1-142">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="c5ca1-142">See also</span></span>

- [<span data-ttu-id="c5ca1-143">Службы рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="c5ca1-143">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)
- [<span data-ttu-id="c5ca1-144">Действия обмена сообщениями</span><span class="sxs-lookup"><span data-stu-id="c5ca1-144">Messaging Activities</span></span>](../../../../docs/framework/wcf/feature-details/messaging-activities.md)
