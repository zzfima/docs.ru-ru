---
title: Очереди в WCF
ms.date: 03/30/2017
ms.assetid: e98d76ba-1acf-42cd-b137-0f8214661112
ms.openlocfilehash: 7f0a6700dba8eb844cc471704095b29c2a2c7937
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
ms.locfileid: "33496488"
---
# <a name="queuing-in-wcf"></a>Очереди в WCF
В этом разделе описывается использование очередей в Windows Communication Foundation (WCF).  
  
## <a name="queues-as-a-wcf-transport-binding"></a>Очереди в качестве привязки транспорта WCF  
 В WCF Контракты определяют, что обмен. Контракты представляют собой обмен сообщениями, связанными с бизнес-требованиями или конкретными приложениями. Механизм, с помощью которого осуществляется обмен сообщениями, задается в привязках. Привязки в WCF инкапсулируют сведения об обмене сообщениями. Они предоставляют доступ к элементам конфигурации, с помощью которых пользователи могут управлять различными аспектами транспорта или протокола, которые представляются привязками. Очереди в WCF обрабатывается как любые другие привязки транспорта, что является большим преимуществом для многих приложений, использующих очереди. В наше время многие приложения с использованием очередей разрабатываются не так, как другие распределенные приложения на базе удаленного вызова процедур, что затрудняет их понимание и обслуживание. С помощью WCF стиль разработки распределенных приложений является так же, что упрощает понимание и обслуживание. Более того, отделение механизма обмена данными от бизнес-логики упрощает настройку транспорта или внесение изменений в него, не затрагивая код, относящийся к предметной области. На следующем рисунке показана структура службы и клиента WCF, которые используют MSMQ в качестве транспорта.  
  
 ![Диаграмма приложения в очереди](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg "распределенных очереди фигуры")  
  
 Как видно из этого рисунка, клиент и служба должны определять только семантику приложения, т. е. контракт и реализацию. Служба настраивает поддерживающую очереди привязку с использованием нужных параметров. Клиент использует [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) для создания клиента WCF для службы и создать файл конфигурации, описывающий привязок, чтобы использовать для отправки сообщений в службе. Таким образом Чтобы отправить сообщение из очереди, клиент создает экземпляр клиента WCF и вызывает операцию над ним. В результате сообщение отправляется в очередь передачи, а затем передается в целевую очередь. Все сложные механизмы взаимодействия с использованием очередей оказываются скрытыми от приложения, которое отправляет и получает сообщения.  
  
 Включить предупреждения о привязке с очередью в WCF:  
  
-   Все службы, которую операции должны быть односторонними, поскольку в очередь по умолчанию привязка WCF не поддерживает дуплексное взаимодействие с использованием очередей. Образец двусторонний обмен данными ([двусторонней связи](../../../../docs/framework/wcf/samples/two-way-communication.md)) показано, как использовать два односторонних контрактов для реализации дуплексного обмена данными с использованием очередей.  
  
-   Для создания WCF клиента с использованием обмена метаданными требуется дополнительная конечная точка HTTP на стороне службы, чтобы его можно запрашивать непосредственно для создания клиента WCF и получить сведения о привязке для правильной настройки взаимодействия с использованием очередей.  
  
-   На основании привязке с очередью, дополнительная настройка за пределами WCF не требуется. Например <xref:System.ServiceModel.NetMsmqBinding> класс, входящий в состав WCF необходимо настроить привязки, а также минимальной настройки очереди сообщений (MSMQ).  
  
 В следующих разделах описаны конкретные поддерживающие очереди привязки в состав WCF, основанные на MSMQ.  
  
### <a name="msmq"></a>MSMQ  
 MSMQ использует транспорт очереди в WCF для взаимодействия с использованием очередей.  
  
 MSMQ поставляется как дополнительный компонент Windows и выполняется как служба NT. MSMQ помещает передаваемые сообщения в очередь передачи и доставляет их в целевую очередь. Диспетчеры очередей MSMQ реализуют надежный протокол передачи сообщений, благодаря которому сообщения не могут быть потеряны при передаче. Этот протокол может быть собственным или основанным на SOAP, например как протокол SRMP.  
  
 В MSMQ, очереди могут быть транзакционными и нетранзакционными. Транзакционная очередь позволяет перехватывать и доставлять сообщение в транзакции, а затем продолжительное время хранить его в очереди. Сообщения, отправляемые в транзакционную очередь, передаются только один раз в заданном порядке. С помощью нетранзакционных очередей можно передавать, как неустойчивые, так и устойчивые сообщения. Сообщение, переданное в нетранзакционную очередь, не содержит каких-либо механизмов подтверждения надежной передачи, поэтому такое сообщение может быть потеряно.  
  
 Кроме того, очереди MSMQ можно защищать с помощью удостоверений Windows, зарегистрированных в службе каталогов Active Directory. При установке MSMQ можно установить интеграцию с Active Directory, для чего компьютер должен входить в домен Windows.  
  
 Дополнительные сведения о MSMQ см. в разделе [Установка Message Queuing (MSMQ)](../../../../docs/framework/wcf/samples/installing-message-queuing-msmq.md).  
  
### <a name="netmsmqbinding"></a>NetMsmqBinding  
 [ \<NetMsmqBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/netmsmqbinding.md) является привязке с очередью WCF предоставляет две конечные точки WCF для взаимодействия с помощью MSMQ. Поэтому привязка предоставляет свойства, имеющие отношение к MSMQ. Тем не менее в `NetMsmqBinding` доступны не все функции и свойства MSMQ. Компактная привязка `NetMsmqBinding` содержит оптимальный набор функций, которого должно быть достаточно для большинства пользователей.  
  
 В `NetMsmqBinding` в виде свойств привязок объявлены базовые принципы работы с очередями, рассмотренные выше. Эти свойства, в свою очередь, определяют, каким образом сообщения должны передаваться и отправляться с использованием MSMQ. Описание категорий свойств содержится в приведенных ниже разделах. Дополнительные сведения см. в разделе Основные разделы, более полно описывающие конкретные свойства.  
  
#### <a name="exactlyonce-and-durable-properties"></a>Свойства ExactlyOnce и Durable  
 От значений свойств `ExactlyOnce` и `Durable` зависит то, каким образом сообщения передаются между очередями.  
  
-   `ExactlyOnce`: если имеет значение `true` (по умолчанию), канал очереди следит за тем, чтобы сообщение доставлялось только один раз. Кроме того, он контролирует, чтобы сообщение не было потеряно. Если доставить сообщение не удается или срок жизни сообщения истекает до его доставки, это сообщение, а также причина сбоя при его доставке записываются в очередь недоставленных сообщений. Если свойство имеет значение `false`, канал очереди пытается передать сообщение. В этом случае можно (необязательно) выбрать очередь недоставленных сообщений.  
  
-   `Durable:` если имеет значение `true` (по умолчанию), канал очереди проверяет, что MSMQ сохраняет сообщение на диск на продолжительное время. Таким образом, если службу MSMQ необходимо остановить и перезапустить, сообщения на диске передаются в целевую очередь или в службу. Если свойство имеет значение `false`, сообщения сохраняются во временном хранилище и теряются в случае остановки и перезапуска службы MSMQ.  
  
 Для реализации надежной передачи в режиме `ExactlyOnce` служба MSMQ требует, чтобы очередь была транзакционной. Кроме того, служба MSMQ требует чтения транзакции из транзакционной очереди. Поэтому при использовании привязки `NetMsmqBinding` следует помнить, что для отправки и получения сообщения требуется транзакция, если свойство `ExactlyOnce` имеет значение `true`. Аналогично служба MSMQ требует, чтобы очередь была нетранзакционной с гарантией наилучшего из возможного, как например в случаях, когда свойство `ExactlyOnce` равняется `false` или при обмене временными сообщениями. Таким образом, если свойство `ExactlyOnce` имеет значение `false` или свойство Durable имеет значение `false`, невозможно осуществлять отправку или получение с использованием транзакций.  
  
> [!NOTE]
>  Следите за тем, чтобы создавалась правильная очередь (транзакционная или нетранзакционная) в зависимости от параметров привязок. Если свойство `ExactlyOnce` имеет значение `true`, используется транзакционную очередь; в противном случае используется нетранзакционная очередь.  
  
#### <a name="dead-letter-queue-properties"></a>Свойства очереди недоставленных сообщений  
 Очередь недоставленных сообщений служит для хранения сообщений, которые не удалось доставить. Пользователь может написать дополнительные операции по чтению сообщений из очереди недоставленных сообщений.  
  
 Многие системы организации очереди реализуют общесистемную очередь недоставленных сообщений. Служба MSMQ имеет две общесистемные очереди недоставленных сообщений: общесистемную очередь недоставленных нетранзакционных сообщений, которые не удалось доставить в нетранзакционные очереди, и общесистемную очередь недоставленных транзакционных сообщений, которые не удалось доставить в транзакционные очереди.  
  
 Если несколько клиентов отправляют сообщения в различные целевые очереди с использованием одной службы MSMQ, все отправляемые клиентами сообщения попадают в одну и ту же очередь недоставленных сообщений. Это не всегда желательно. Для лучшей изоляции WCF и MSMQ в [!INCLUDE[wv](../../../../includes/wv-md.md)] предоставляют пользовательскую очередь недоставленных сообщений (или очереди недоставленных сообщений конкретного приложения), пользователь может указать для хранения сообщений, которые не удалось доставить. В результате различные клиенты не будут использовать одну и ту же очередь недоставленных сообщений.  
  
 У привязок имеются следующие важные свойства.  
  
-   `DeadLetterQueue`. Это свойство является перечислением, которое указывает, запрошена ли очередь недоставленных сообщений. Кроме того, в перечислении содержится тип очереди недоставленных сообщений, если она запрошена. Значениями являются `None`, `System` и `Custom`. Дополнительные сведения об интерпретации этих свойств см. в разделе [с использованием очередей недоставленных сообщений для обработки ошибок передачи сообщений](../../../../docs/framework/wcf/feature-details/using-dead-letter-queues-to-handle-message-transfer-failures.md)  
  
-   `CustomDeadLetterQueue`. Это свойство представляет собой универсальный код ресурса (URI) очереди недоставленных сообщений конкретного приложения. Требуется, если `DeadLetterQueue`.`Custom` выбирается.  
  
#### <a name="poison-message-handling-properties"></a>Свойства обработки подозрительных сообщений  
 Когда служба получает сообщение из целевой очереди в рамках транзакции, служба может по какой-либо причине не обработать это сообщение. В этом случае сообщение возвращается в очередь, чтобы быть считанными снова. Для обработки сообщений, которые часто вызывают сбои, в привязке можно настроить набор свойств обработки подозрительных сообщений. Есть четыре свойства: `ReceiveRetryCount`, `MaxRetryCycles`, `RetryCycleDelay` и `ReceiveErrorHandling`. Дополнительные сведения об этих свойствах см. в разделе [обработка подозрительных сообщений](../../../../docs/framework/wcf/feature-details/poison-message-handling.md).  
  
#### <a name="security-properties"></a>Свойства безопасности  
 Служба MSMQ реализует собственную модель безопасности, например списки управления доступом в очереди или отправку прошедших проверку подлинности сообщений. В привязке `NetMsmqBinding` эти свойства безопасности реализованы как часть параметров безопасности транспорта. В привязке имеется два свойства для обеспечения безопасности транспорта: `MsmqAuthenticationMode` и `MsmqProtectionLevel`. Значения этих свойств зависят от настройки MSMQ. Дополнительные сведения см. в разделе [защита безопасность транспорта с помощью сообщений](../../../../docs/framework/wcf/feature-details/securing-messages-using-transport-security.md).  
  
 Помимо безопасности транспорта само сообщение SOAP можно также защитить с помощью механизмов защиты сообщений. Дополнительные сведения см. в разделе [защита безопасность сообщений с помощью сообщений](../../../../docs/framework/wcf/feature-details/securing-messages-using-message-security.md).  
  
 `MsmqTransportSecurity` также реализует два свойства: `MsmqEncryptionAlgorithm` и `MsmqHashAlgorithm`. Это перечисления различных алгоритмов, позволяющее задать шифрование при передаче сообщений между очередями и хэширование сигнатур.  
  
#### <a name="other-properties"></a>Другие свойства  
 Помимо описанных выше свойства предоставляемые привязкой свойства MSMQ включают:  
  
-   `UseSourceJournal`: свойство, указывающее, что включено ведение журнала источника. Ведение журнала является функцией MSMQ, отслеживающей сообщения, которые были успешно переданы из очереди передачи;  
  
-   `UseMsmqTracing`: свойство, указывающее, что включена трассировка MSMQ. Функция трассировки MSMQ отправляет сообщение с отчетом в очередь отчетов всякий раз, когда сообщение покидает компьютер с диспетчером очереди MSMQ или приходит на него;  
  
-   `QueueTransferProtocol`: перечисление протокола, используемого для обмена сообщениями между очередями. Служба MSMQ реализует собственный протокол передачи сообщений между очередями, а также протокол на базе SOAP (SRMP). Протокол SRMP используется при передаче сообщений между очередями с помощью протокола HTTP. Если сообщения между очередями передаются с помощью протокола HTTPS, используется протокол SRMP;  
  
-   `UseActiveDirectory`: логическое значение, указывающее, следует ли использовать для разрешения адресов очередей службу каталогов Active Directory. По умолчанию этот режим отключен. Дополнительные сведения см. в разделе [конечные точки служб и адресация очереди](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).  
  
### <a name="msmqintegrationbinding"></a>MsmqIntegrationBinding  
 `MsmqIntegrationBinding` Используется, если конечной точки WCF для взаимодействия с существующие приложения MSMQ, написанного на C, C++, COM или интерфейсов API System.Messaging.  
  
 Привязка имеет те же свойства, что и `NetMsmqBinding`. Однако имеются следующие различия:  
  
-   контракт операции `MsmqIntegrationBinding` может принимать только один параметр типа <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>, где параметр типа является типом тела;  
  
-   большинство свойств собственных сообщений MSMQ доступно в <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>;  
  
-   для сериализации и десериализации тела сообщения предоставляются сериализаторы, например XML и ActiveX.  
  
### <a name="sample-code"></a>Пример кода  
 Пошаговые инструкции по созданию служб WCF, использующих MSMQ, см. в следующих разделах.  
  
-   [Практическое руководство. Обмен сообщениями с конечными точками WCF и приложениями очереди сообщений](../../../../docs/framework/wcf/feature-details/how-to-exchange-messages-with-wcf-endpoints-and-message-queuing-applications.md)  
  
-   [Практическое руководство. Обмен сообщениями в очереди с конечными точками WCF](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md)  
  
 Полный образец кода, демонстрирующий использование MSMQ в WCF, см. в следующих разделах.  
  
-   [Привязка MSMQ с поддержкой транзакций](../../../../docs/framework/wcf/samples/transacted-msmq-binding.md)  
  
-   [Неустойчивое взаимодействие с использованием очереди](../../../../docs/framework/wcf/samples/volatile-queued-communication.md)  
  
-   [Очереди недоставленных сообщений](../../../../docs/framework/wcf/samples/dead-letter-queues.md)  
  
-   [Сеансы и очереди](../../../../docs/framework/wcf/samples/sessions-and-queues.md)  
  
-   [Двусторонний обмен данными](../../../../docs/framework/wcf/samples/two-way-communication.md)  
  
-   [Пакетирование с поддержкой транзакций](../../../../docs/framework/wcf/samples/transacted-batching.md)  
  
-   [SRMP](../../../../docs/framework/wcf/samples/srmp.md)  
  
-   [Безопасность сообщений при использовании очереди сообщений](../../../../docs/framework/wcf/samples/message-security-over-message-queuing.md)  
  
## <a name="see-also"></a>См. также  
 [Конечные точки служб и адресация очереди](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md)  
 [Размещение веб-узлов в приложении, использующем очереди](../../../../docs/framework/wcf/feature-details/web-hosting-a-queued-application.md)
