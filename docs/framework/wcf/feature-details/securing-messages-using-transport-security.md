---
title: Защита сообщений с использованием средств обеспечения безопасности транспорта
ms.date: 03/30/2017
ms.assetid: 9029771a-097e-448a-a13a-55d2878330b8
author: BrucePerlerMS
manager: mbaldwin
ms.openlocfilehash: 0ab04326404a4b90e30036594a7152e6118c2138
ms.sourcegitcommit: 64f4baed249341e5bf64d1385bf48e3f2e1a0211
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/07/2018
ms.locfileid: "44129145"
---
# <a name="securing-messages-using-transport-security"></a>Защита сообщений с использованием средств обеспечения безопасности транспорта
В этом разделе рассматривается механизм безопасности транспорта очереди сообщений MSMQ, который может быть использован для защиты сообщений, отправленных в очередь.  
  
> [!NOTE]
>  Перед прочтением этого раздела, рекомендуется ознакомиться с [основные понятия безопасности](../../../../docs/framework/wcf/feature-details/security-concepts.md).  
  
 На рисунке ниже представлен концептуальную модель взаимодействия с использованием очередей с помощью Windows Communication Foundation (WCF). Для объяснения принципов безопасности транспорта используется следующая терминология и рисунки.  
  
 ![В очереди схемы приложения](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg "распределенных очереди Значной")  
  
 При отправке сообщений из очереди с помощью WCF с <xref:System.ServiceModel.NetMsmqBinding>, сообщение WCF прикрепляется к телу сообщения MSMQ. Механизм безопасности транспорта защищает целиком сообщение MSMQ (заголовок или свойства и тело сообщения MSMQ). Так как это тело сообщения MSMQ с использованием безопасности транспорта также обеспечивает защиту сообщения WCF.  
  
 Ключевое понятие в основе безопасности транспорта заключается в том, что клиент обязан удовлетворять требованиям безопасности, чтобы получить сообщение в целевую очередь. В этом заключается отличие от безопасности сообщения, в котором сообщение защищается для приложения, которое получает сообщение.  
  
 Безопасность транспорта с использованием <xref:System.ServiceModel.NetMsmqBinding> и <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>влияет на то, как защищаются сообщения MSMQ во время передачи между очередью передачи и целевой очередью, которые подразумеваются безопасными.  
  
-   Подписывание сообщения обеспечивает защиту от подделки.  
  
-   Шифрование сообщения обеспечивает защиту от просмотра или подделки. Это рекомендуется, но не является обязательным.  
  
-   Диспетчер целевой очереди определяет отправителя сообщения для предотвращения подделки.  
  
 В MSMQ, независимо от проверки подлинности, целевая очередь содержит список управления доступом (ACL) для проверки, имеет ли клиент разрешение посылать сообщение в целевую очередь. У принимающего приложения также проверяется право принимать сообщения от целевой очереди.  
  
## <a name="wcf-msmq-transport-security-properties"></a>Свойства безопасности транспорта WCF MSMQ.  
 MSMQ использует безопасность Windows для проверки подлинности. Используются идентификатор безопасности Windows (SID) для идентификации клиента и служба каталогов Active Directory в качестве центра сертификации при проверке подлинности клиента. Требуется установить MSMQ с интеграцией Active Directory. Поскольку для идентификации клиента используется идентификатор безопасности домена Windows SID, этот вариант обеспечения безопасности имеет смысл, если клиент и служба являются частью одного домена Windows.  
  
 MSMQ также предоставляет возможность прикрепить сертификат к сообщению, даже если он не зарегистрирован в Active Directory. В этом случае он обеспечивает проверку подписи сообщения с использованием прикрепленного сертификата.  
  
 WCF предоставляет оба этих параметра, как часть безопасность транспорта MSMQ и являются ключевой основой механизма безопасности транспорта.  
  
 По умолчанию безопасность транспорта включена.  
  
 С учетом этих основ, следующие разделы дают представление о свойствах безопасности транспорта совместно с <xref:System.ServiceModel.NetMsmqBinding> и <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.  
  
#### <a name="msmq-authentication-mode"></a>Режим проверки подлинности MSMQ  
 Режим <xref:System.ServiceModel.MsmqTransportSecurity.MsmqAuthenticationMode%2A> определяет, следует ли использовать безопасность домена Windows или внешнюю безопасность на основе сертификатов для защиты сообщения. В обоих режимах проверки подлинности использует WCF транспортным каналом очереди `CertificateValidationMode` указанный в конфигурации службы. Режим проверки сертификата задает механизм, используемый для проверки допустимости сертификата.  
  
 Если безопасность транспорта включена, значение по умолчанию - <xref:System.ServiceModel.MsmqAuthenticationMode.WindowsDomain>.  
  
#### <a name="windows-domain-authentication-mode"></a>Режим проверки подлинности домена Windows  
 Вариант с использованием безопасности Windows требует интеграции с Active Directory. Режим безопасности, используемый по умолчанию, - <xref:System.ServiceModel.MsmqAuthenticationMode.WindowsDomain>. Если этот параметр установлен, канал WCF прикрепляет Windows SID к сообщению MSMQ и использует свой внутренний сертификат, полученный от Active Directory. MSMQ использует этот внутренний сертификат для защиты сообщения. Диспетчер принимающей очереди использует Active Directory для поиска и нахождения соответствующего сертификата для проверки подлинности клиента, а также проверки соответствия SID клиенту. Если сертификат прикреплен к сообщению, выполняется этап проверки подлинности, даже если целевая очередь не отмечена как требующая проверки подлинности. В режиме проверки подлинности `WindowsDomain` происходит внутреннее создание сертификата, в режиме проверки подлинности `Certificate` происходит внешнее создание сертификата.  
  
> [!NOTE]
>  При создании очереди можно указать, что очередь является очередью с проверкой подлинности и требует проверки подлинности клиента, посылающего сообщения в очередь. Это запрещает прием очередью сообщений, не прошедших проверку подлинности.  
  
 Прикрепленный к сообщению идентификатор SID также используется для проверки списка ACL целевой очереди, чтобы убедиться в полномочиях клиента отправлять сообщения в очередь.  
  
#### <a name="certificate-authentication-mode"></a>Режим проверки подлинности сертификата  
 При выборе режима проверки подлинности сертификата не требуется интеграция с Active Directory. В некоторых случаях, например, когда MSMQ установлена в режиме рабочей группы (без интеграции с Active Directory) или при использовании протокола надежного обмена сообщениями SOAP (SRMP) для передачи сообщений в очередь, работает только <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>.  
  
 При отправке сообщения WCF с <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>, канал WCF не присоединяется Windows SID к сообщению MSMQ. Таким образом, список ACL целевой очереди должен предоставить пользователю `Anonymous` доступ для передачи в очередь. Диспетчер принимающей очереди проверяет, было ли подписано сообщение MSMQ сертификатом, но не проверяет его подлинность.  
  
 Сертификат с его утверждениями и удостоверяющими сведениями заполняется в <xref:System.ServiceModel.ServiceSecurityContext> каналом использующий очереди транспорт WCF. Служба может использовать эту информацию для выполнения собственной проверки подлинности отправителя.  
  
### <a name="msmq-protection-level"></a>Уровень защиты MSMQ  
 Уровень защиты определяет, как защищать сообщение MSMQ для предотвращения его подделки. Это задается в свойстве <xref:System.ServiceModel.MsmqTransportSecurity.MsmqProtectionLevel%2A>. Значение по умолчанию — <xref:System.Net.Security.ProtectionLevel.Sign>.  
  
#### <a name="sign-protection-level"></a>Уровень защиты "Подписать"  
 Сообщение MSMQ подписывается с использованием созданного внутреннего сертификата, если используется режим проверки подлинности `WindowsDomain`, или с использованием внешнего созданного сертификата, если используется режим проверки подлинности `Certificate`.  
  
#### <a name="sign-and-encrypt-protection-level"></a>Уровень защиты "Подписать и зашифровать"  
 Сообщение MSMQ подписывается с использованием созданного внутреннего сертификата, если используется режим проверки подлинности `WindowsDomain`, или с использованием внешнего созданного сертификата, если используется режим проверки подлинности `Certificate`.  
  
 Кроме подписывания сообщения, сообщение MSMQ зашифровывается с использованием открытого ключа сертификата, получаемого из Active Directory, который принадлежит диспетчеру принимающей очереди, на котором размещена целевая очередь. Диспетчер передающей очереди гарантирует, что сообщение MSMQ является зашифрованным при передаче. Диспетчер принимающей очереди расшифровывает сообщение MSMQ с использованием закрытого ключа своего внутреннего сертификата и сохраняет сообщение в очереди открытым текстом (если прошел проверку подлинности и авторизацию).  
  
> [!NOTE]
>  Чтобы зашифровать сообщение, требуется доступ к Active Directory (свойству `UseActiveDirectory` класса <xref:System.ServiceModel.NetMsmqBinding> должно быть присвоено логическое значение `true`), и может использоваться как с <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>, так и <xref:System.ServiceModel.MsmqAuthenticationMode.WindowsDomain>.  
  
#### <a name="none-protection-level"></a>Уровень защиты "Отсутствует"  
 Это используется, когда свойству <xref:System.ServiceModel.MsmqTransportSecurity.MsmqProtectionLevel%2A> присвоено <xref:System.Net.Security.ProtectionLevel.None>. Это не является допустимым значением для любых других режимов проверки подлинности.  
  
> [!NOTE]
>  Если сообщение MSMQ подписано, MSMQ проверяет, подписано ли сообщение прикрепленным сертификатом (внутренним или внешним) независимо от состояния очереди (то есть, является очередь очередью с проверкой подлинности или нет).  
  
### <a name="msmq-encryption-algorithm"></a>Алгоритм шифрования MSMQ  
 Алгоритм шифрования задает алгоритм, используемый в сети для шифрования сообщения MSMQ. Это свойство используется только в случае, если для свойства <xref:System.ServiceModel.MsmqTransportSecurity.MsmqProtectionLevel%2A> установлено значение <xref:System.Net.Security.ProtectionLevel.EncryptAndSign>.  
  
 Поддерживаемые алгоритмы: `RC4Stream` и `AES`. Значение по умолчанию - `RC4Stream`.  
  
 Алгоритм `AES` можно использовать, только если отправитель установил MSMQ 4.0. Кроме того, целевая очередь также должна быть размещена на MSMQ 4.0.  
  
### <a name="msmq-hash-algorithm"></a>Алгоритм хэширования MSMQ  
 Алгоритм хэширования задает алгоритм, который используется для создания цифровой подписи сообщения MSMQ. Диспетчер принимающей очереди использует тот же алгоритм для проверки подлинности сообщения MSMQ. Это свойство используется, только если для свойства <xref:System.ServiceModel.MsmqTransportSecurity.MsmqProtectionLevel%2A> установлено значение <xref:System.Net.Security.ProtectionLevel.Sign> или <xref:System.Net.Security.ProtectionLevel.EncryptAndSign>.  
  
 Поддерживаются алгоритмы: `MD5`, `SHA1`, `SHA256` и `SHA512`. Значение по умолчанию — `SHA1`.  
  
## <a name="see-also"></a>См. также  
 [Очереди сообщений](https://msdn.microsoft.com/library/ff917e87-05d5-478f-9430-0f560675ece1)  
 [Основные понятия безопасности](../../../../docs/framework/wcf/feature-details/security-concepts.md)  
 [Защита служб и клиентов](../../../../docs/framework/wcf/feature-details/securing-services-and-clients.md)
