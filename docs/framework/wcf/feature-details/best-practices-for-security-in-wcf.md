---
title: Рекомендации по безопасности при использовании WCF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- best practices [WCF], security
ms.assetid: 3639de41-1fa7-4875-a1d7-f393e4c8bd69
ms.openlocfilehash: c8c0c084ac3b1cf06fc5f2b3df85fa979744e17b
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79185422"
---
# <a name="best-practices-for-security-in-wcf"></a><span data-ttu-id="c3a5b-102">Рекомендации по безопасности при использовании WCF</span><span class="sxs-lookup"><span data-stu-id="c3a5b-102">Best Practices for Security in WCF</span></span>
<span data-ttu-id="c3a5b-103">В следующих разделах приводятся рекомендации по созданию надежных приложений с помощью Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="c3a5b-103">The following sections list the best practices to consider when creating secure applications using Windows Communication Foundation (WCF).</span></span> <span data-ttu-id="c3a5b-104">Дополнительные сведения о безопасности см. в разделах [Вопросы безопасности](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md), [Вопросы безопасности для данных](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md) и [Вопросы безопасности при использовании метаданных](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md).</span><span class="sxs-lookup"><span data-stu-id="c3a5b-104">For more information about security, see [Security Considerations](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md), [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md), and [Security Considerations with Metadata](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md).</span></span>  
  
## <a name="identify-services-performing-windows-authentication-with-spns"></a><span data-ttu-id="c3a5b-105">Идентифицируйте службы, проходящие проверку подлинности Windows, с помощью различных SPN.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-105">Identify Services Performing Windows Authentication with SPNs</span></span>  
 <span data-ttu-id="c3a5b-106">Службы могут идентифицироваться с помощью имен участника-пользователя (UPN) или имен субъекта-службы (SPN).</span><span class="sxs-lookup"><span data-stu-id="c3a5b-106">Services can be identified with either user principal names (UPNs) or service principal names (SPNs).</span></span> <span data-ttu-id="c3a5b-107">Службы, выполняемые от имени учетных записей компьютера (например, сетевые службы), имеют идентификатор SPN, который совпадает с идентификатором компьютера, на котором они выполняются.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-107">Services running under machine accounts such as network service have an SPN identity corresponding to the machine they're running.</span></span> <span data-ttu-id="c3a5b-108">Службы, выполняемые от имени учетных записей пользователя, имеют идентификатор UPN, совпадающий с идентификатором пользователя, от имени которого они выполняются, при этом средство `setspn` может использоваться для назначения SPN учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-108">Services running under user accounts have a UPN identity corresponding to the user they're running as, although the `setspn` tool can be used to assign an SPN to the user account.</span></span> <span data-ttu-id="c3a5b-109">Настройка службы, делающая возможной идентификацию службы через SPN, и настройка подключающихся к службе клиентов на использование этого SPN, затрудняют определенные атаки.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-109">Configuring a service so it can be identified via SPN and configuring the clients connecting to the service to use that SPN can make certain attacks more difficult.</span></span> <span data-ttu-id="c3a5b-110">Это правило действует для привязок, использующих согласование Kerberos или SSPI.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-110">This guidance applies to bindings using Kerberos or SSPI negotiation.</span></span>  <span data-ttu-id="c3a5b-111">Несмотря на это, клиенты должны указывать SPN в случае, если SSPI возвращается к NTLM.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-111">Clients should still specify an SPN in the case where SSPI falls back to NTLM.</span></span>  
  
## <a name="verify-service-identities-in-wsdl"></a><span data-ttu-id="c3a5b-112">Проверяйте удостоверения службы в WSDL</span><span class="sxs-lookup"><span data-stu-id="c3a5b-112">Verify Service Identities in WSDL</span></span>  
 <span data-ttu-id="c3a5b-113">WS-SecurityPolicy позволяет службам публиковать информацию о своих удостоверениях в метаданных.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-113">WS-SecurityPolicy allows services to publish information about their own identities in metadata.</span></span> <span data-ttu-id="c3a5b-114">Когда идентификационные данные извлекаются через `svcutil` или с помощью других методов, таких как <xref:System.ServiceModel.Description.WsdlImporter>, эти данные преобразуются в параметры удостоверения для адресов конечных точек служб WCF.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-114">When retrieved via `svcutil` or other methods such as <xref:System.ServiceModel.Description.WsdlImporter>, this identity information is translated to the identity properties of the WCF service endpoint addresses.</span></span> <span data-ttu-id="c3a5b-115">Клиенты, которые не подтверждают правильность и допустимость данных удостоверений службы, эффективно выполняют обход проверки подлинности службы.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-115">Clients which do not verify that these service identities are correct and valid effectively bypass service authentication.</span></span> <span data-ttu-id="c3a5b-116">Вредоносная служба может использовать такие клиенты для перенаправления учетных данных и реализации других атак типа "злоумышленник в середине", изменяя заявленное в WSDL удостоверение.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-116">A malicious service can exploit such clients to execute credential forwarding and other "man in the middle" attacks by changing the identity claimed in its WSDL.</span></span>  
  
## <a name="use-x509-certificates-instead-of-ntlm"></a><span data-ttu-id="c3a5b-117">Используйте сертификаты X509 вместо протокола NTLM</span><span class="sxs-lookup"><span data-stu-id="c3a5b-117">Use X509 Certificates Instead of NTLM</span></span>  
 <span data-ttu-id="c3a5b-118">WCF предоставляет два механизма проверки подлинности одноранговых элементов: сертификаты X509 (используемые одноранговым каналом) и проверку подлинности Windows, при которой согласование SSPI понижается с протокола Kerberos до протокола NTLM.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-118">WCF offers two mechanisms for peer-to-peer authentication: X509 certificates (used by peer channel) and Windows authentication where an SSPI negotiation downgrades from Kerberos to NTLM.</span></span>  <span data-ttu-id="c3a5b-119">Проверка подлинности на основании сертификатов с использованием размеров ключа от 1024 битов имеет преимущества по сравнению с проверкой подлинности по протоколу NTLM по следующим причинам:</span><span class="sxs-lookup"><span data-stu-id="c3a5b-119">Certificate-based authentication using key sizes of 1024 bits or more is preferred to NTLM for several reasons:</span></span>  
  
- <span data-ttu-id="c3a5b-120">возможность взаимной проверки подлинности,</span><span class="sxs-lookup"><span data-stu-id="c3a5b-120">the availability of mutual authentication,</span></span>  
  
- <span data-ttu-id="c3a5b-121">использование усиленных алгоритмов шифрования и</span><span class="sxs-lookup"><span data-stu-id="c3a5b-121">the use of stronger cryptographic algorithms, and</span></span>  
  
- <span data-ttu-id="c3a5b-122">затруднение использования перенаправленных учетных данных сертификата X509.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-122">the greater difficulty of utilizing forwarded X509 credentials.</span></span>  

## <a name="always-revert-after-impersonation"></a><span data-ttu-id="c3a5b-123">Всегда отменяйте изменения после олицетворения</span><span class="sxs-lookup"><span data-stu-id="c3a5b-123">Always Revert After Impersonation</span></span>  
 <span data-ttu-id="c3a5b-124">При использовании интерфейсов API, которые разрешают олицетворение клиента, не забудьте вернуться к исходной идентификации.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-124">When using APIs that enable impersonation of a client, be sure to revert to the original identity.</span></span> <span data-ttu-id="c3a5b-125">Например, при работе с <xref:System.Security.Principal.WindowsIdentity> и <xref:System.Security.Principal.WindowsImpersonationContext> воспользуйтесь оператором C# `using` или оператором Visual Basic `Using`, как показано в следующем примере кода.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-125">For example, when using the <xref:System.Security.Principal.WindowsIdentity> and <xref:System.Security.Principal.WindowsImpersonationContext>, use the C# `using` statement or the Visual Basic`Using` statement, as shown in the following code.</span></span> <span data-ttu-id="c3a5b-126">Класс <xref:System.Security.Principal.WindowsImpersonationContext> реализует интерфейс <xref:System.IDisposable>, следовательно, среда CLR автоматически возвращается к исходной идентификации после того, как код выводится из блока `using`.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-126">The <xref:System.Security.Principal.WindowsImpersonationContext> class implements the <xref:System.IDisposable> interface, and therefore the common language runtime (CLR) automatically reverts to the original identity once the code leaves the `using` block.</span></span>  
  
 [!code-csharp[c_SecurityBestPractices#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_securitybestpractices/cs/source.cs#1)]
 [!code-vb[c_SecurityBestPractices#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_securitybestpractices/vb/source.vb#1)]  
  
## <a name="impersonate-only-as-needed"></a><span data-ttu-id="c3a5b-127">Используйте олицетворение только при необходимости</span><span class="sxs-lookup"><span data-stu-id="c3a5b-127">Impersonate Only as Needed</span></span>  
 <span data-ttu-id="c3a5b-128">Метод <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> класса <xref:System.Security.Principal.WindowsIdentity> позволяет осуществлять строгий контроль над использованием олицетворения.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-128">Using the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method of the <xref:System.Security.Principal.WindowsIdentity> class, it is possible to use impersonation in a very controlled scope.</span></span> <span data-ttu-id="c3a5b-129">В этом заключается отличие от использования свойства <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A><xref:System.ServiceModel.OperationBehaviorAttribute>, которое позволяет использовать олицетворение в рамках всей операции.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-129">This is in contrast to using the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property of the <xref:System.ServiceModel.OperationBehaviorAttribute>, which allows impersonation for the scope of the entire operation.</span></span> <span data-ttu-id="c3a5b-130">По возможности контролируйте область применения олицетворения с помощью более точного метода <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A>.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-130">Whenever possible, control the scope of impersonation by using the more precise <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method.</span></span>  
  
## <a name="obtain-metadata-from-trusted-sources"></a><span data-ttu-id="c3a5b-131">Получайте метаданные из надежных источников</span><span class="sxs-lookup"><span data-stu-id="c3a5b-131">Obtain Metadata from Trusted Sources</span></span>  
 <span data-ttu-id="c3a5b-132">Убедитесь в надежности источника метаданных и в том, что метаданные не были злонамеренно искажены.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-132">Be sure you trust the source of your metadata and make sure that no one has tampered with the metadata.</span></span> <span data-ttu-id="c3a5b-133">Метаданные, полученные по протоколу HTTP, передаются открытым текстом и могут быть подделаны.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-133">Metadata retrieved using the HTTP protocol is sent in clear text and can be tampered with.</span></span> <span data-ttu-id="c3a5b-134">Если в службе используются свойства <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> и <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A>, для загрузки данных по протоколу HTTPS используйте URL-адрес, предоставленный разработчиком службы.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-134">If the service uses the <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetEnabled%2A> and <xref:System.ServiceModel.Description.ServiceMetadataBehavior.HttpsGetUrl%2A> properties, use the URL supplied by the service creator to download the data using the HTTPS protocol.</span></span>  
  
## <a name="publish-metadata-using-security"></a><span data-ttu-id="c3a5b-135">Публикуйте метаданные с использованием безопасности</span><span class="sxs-lookup"><span data-stu-id="c3a5b-135">Publish Metadata Using Security</span></span>  
 <span data-ttu-id="c3a5b-136">Для предотвращения злонамеренного искажения метаданных, опубликованных службой, обеспечьте защиту конечной точки обмена метаданными с помощью безопасности на уровне транспорта или сообщений.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-136">To prevent tampering with a service's published metadata, secure the metadata exchange endpoint with transport or message-level security.</span></span> <span data-ttu-id="c3a5b-137">Дополнительные сведения см. в разделе [Публикация конечных точек метаданных](../../../../docs/framework/wcf/publishing-metadata-endpoints.md) и [Практическое руководство. Публикация метаданных для службы с использованием кода](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md).</span><span class="sxs-lookup"><span data-stu-id="c3a5b-137">For more information, see [Publishing Metadata Endpoints](../../../../docs/framework/wcf/publishing-metadata-endpoints.md) and [How to: Publish Metadata for a Service Using Code](../../../../docs/framework/wcf/feature-details/how-to-publish-metadata-for-a-service-using-code.md).</span></span>  
  
## <a name="ensure-use-of-local-issuer"></a><span data-ttu-id="c3a5b-138">Разрешите использование локального издателя</span><span class="sxs-lookup"><span data-stu-id="c3a5b-138">Ensure Use of Local Issuer</span></span>  
 <span data-ttu-id="c3a5b-139">Если для данной привязки указаны адрес издателя и привязка, локальный издатель не применяется в конечных точках, использующих эту привязку.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-139">If an issuer address and binding are specified for a given binding, the local issuer is not used for endpoints that use that binding.</span></span> <span data-ttu-id="c3a5b-140">Клиенты, которые предполагают всегда использовать локальный издатель, должны убедиться, что они не используют такую привязку или что привязка изменена таким образом, что адрес издателя пуст.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-140">Clients who expect to always use the local issuer should ensure that they do not use such a binding or that they modify the binding such that the issuer address is null.</span></span>  
  
## <a name="saml-token-size-quotas"></a><span data-ttu-id="c3a5b-141">Квоты на размер маркеров SAML</span><span class="sxs-lookup"><span data-stu-id="c3a5b-141">SAML Token Size Quotas</span></span>  
 <span data-ttu-id="c3a5b-142">Когда маркеры Security Assertion Markup Language (SAML) сериализуются в сообщениях, то, независимо от того, выдаются ли они службой маркеров безопасности (STS) или предоставляются клиентами для служб как часть проверки подлинности, квота на максимальный размер сообщения должна быть достаточно большой, чтобы вместить маркер SAML и другие части сообщения.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-142">When Security Assertions Markup Language (SAML) tokens are serialized in messages, either when they are issued by a Security Token Service (STS) or when clients present them to services as part of authentication, the maximum message size quota must be sufficiently large to accommodate the SAML token and the other message parts.</span></span> <span data-ttu-id="c3a5b-143">Как правило, по умолчанию квоты на размер сообщения являются достаточными.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-143">In normal cases, the default message size quotas are sufficient.</span></span> <span data-ttu-id="c3a5b-144">Впрочем, если большой размер токена SAML объясняется содержанием в нем сотни утверждений, может потребоваться увеличение квот для выделения места сериализованному токену.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-144">However, in cases where a SAML token is large because it contains hundreds of claims, the quotas should be increased to accommodate the serialized token.</span></span> <span data-ttu-id="c3a5b-145">Дополнительные сведения о квотах см. в разделе [Вопросы безопасности для данных](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md).</span><span class="sxs-lookup"><span data-stu-id="c3a5b-145">For more information about quotas, see [Security Considerations for Data](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md).</span></span>  
  
## <a name="set-securitybindingelementincludetimestamp-to-true-on-custom-bindings"></a><span data-ttu-id="c3a5b-146">Задайте параметру SecurityBindingElement.IncludeTimestamp значение True в пользовательских привязках</span><span class="sxs-lookup"><span data-stu-id="c3a5b-146">Set SecurityBindingElement.IncludeTimestamp to True on Custom Bindings</span></span>  
 <span data-ttu-id="c3a5b-147">При создании пользовательской привязки следует задать параметру <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> значение `true`.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-147">When you create a custom binding, you must set <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> to `true`.</span></span> <span data-ttu-id="c3a5b-148">В противном случае, если параметр <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> имеет значение `false`, а клиент использует асимметричный маркер на основе ключа, например, сертификат Х509, сообщение не будет подписано.</span><span class="sxs-lookup"><span data-stu-id="c3a5b-148">Otherwise, if <xref:System.ServiceModel.Channels.SecurityBindingElement.IncludeTimestamp%2A> is set to `false`, and the client is using an asymmetric key-based token such as an X509 certificate, the message will not be signed.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c3a5b-149">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="c3a5b-149">See also</span></span>

- [<span data-ttu-id="c3a5b-150">Соображения безопасности</span><span class="sxs-lookup"><span data-stu-id="c3a5b-150">Security Considerations</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-in-wcf.md)
- [<span data-ttu-id="c3a5b-151">Соображения безопасности для данных</span><span class="sxs-lookup"><span data-stu-id="c3a5b-151">Security Considerations for Data</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-for-data.md)
- [<span data-ttu-id="c3a5b-152">Вопросы безопасности при использовании метаданных</span><span class="sxs-lookup"><span data-stu-id="c3a5b-152">Security Considerations with Metadata</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)
