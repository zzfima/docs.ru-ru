---
title: Ограничение распространения сообщений
ms.date: 03/30/2017
ms.assetid: 8b5ec4b8-1ce9-45ef-bb90-2c840456bcc1
ms.openlocfilehash: 36d9d43760e68f6bcf0099ac17dec5a8278d0e49
ms.sourcegitcommit: 09b4090b78f52fd09b0e430cd4b26576f1fdf96e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2020
ms.locfileid: "76211898"
---
# <a name="limiting-message-distribution"></a><span data-ttu-id="d6e14-102">Ограничение распространения сообщений</span><span class="sxs-lookup"><span data-stu-id="d6e14-102">Limiting Message Distribution</span></span>

<span data-ttu-id="d6e14-103">Одноранговый канал представляет собой широковещательную сетку.</span><span class="sxs-lookup"><span data-stu-id="d6e14-103">Peer Channel is by design a broadcast mesh.</span></span> <span data-ttu-id="d6e14-104">Его базовая модель рассылки заключается в том, что каждое сообщение, отправленное любым участником сетки, доставляется всем остальным участникам этой сетки.</span><span class="sxs-lookup"><span data-stu-id="d6e14-104">Its basic flooding model involves distributing each message sent by any member of a mesh to all other members of that mesh.</span></span> <span data-ttu-id="d6e14-105">Этот принцип идеально подходит для ситуаций, когда каждое сообщение, созданное участником сетки, представляет ценность для всех остальных участников (например, участников чата).</span><span class="sxs-lookup"><span data-stu-id="d6e14-105">This is ideal in situations where every message generated by a member is relevant and useful to all other members (for example, a chat room).</span></span> <span data-ttu-id="d6e14-106">Впрочем, для многих приложений иногда требуется ограничить распределение сообщений.</span><span class="sxs-lookup"><span data-stu-id="d6e14-106">However, many applications have an occasional need for limiting message distribution.</span></span> <span data-ttu-id="d6e14-107">Например, если к сетке присоединяется новый участник, которому требуется извлечь последнее из сообщений, отправленных через сетку, этот запрос не требуется рассылать всем участникам сетки.</span><span class="sxs-lookup"><span data-stu-id="d6e14-107">For example, if a new member joins a mesh and wants to retrieve the last message sent through the mesh, this request does not need to be flooded to every member of the mesh.</span></span> <span data-ttu-id="d6e14-108">Запрос может быть ограничен ближайшими соседями, или сообщения, созданные локально, могут быть отфильтрованы. Сообщения также могут отправляться на отдельный узел в сети.</span><span class="sxs-lookup"><span data-stu-id="d6e14-108">The request could be limited to near neighbors, or locally generated messages can be filtered out. Messages can also be sent to an individual node on the mesh.</span></span> <span data-ttu-id="d6e14-109">В этом разделе рассматривается управление пересылкой сообщений через сетку с помощью счетчика числа прыжков, фильтра распространения сообщений, локального фильтра или прямого подключения и приводятся общие рекомендации по выбору подхода.</span><span class="sxs-lookup"><span data-stu-id="d6e14-109">This topic discusses using Hop Count, a Message Propagation Filter, a local filter, or a direct connection to control how messages are forwarded throughout the mesh, and provides general guidelines for choosing an approach.</span></span>

## <a name="hop-counts"></a><span data-ttu-id="d6e14-110">Число прыжков</span><span class="sxs-lookup"><span data-stu-id="d6e14-110">Hop Counts</span></span>

<span data-ttu-id="d6e14-111">Понятие `PeerHopCount` аналогично понятию "срок жизни", используемому в протоколе IP.</span><span class="sxs-lookup"><span data-stu-id="d6e14-111">The concept of `PeerHopCount` is similar to TTL (Time-To-Live) used in IP protocol.</span></span> <span data-ttu-id="d6e14-112">Значение `PeerHopCount` привязывается к экземпляру сообщения. Оно указывает, сколько раз следует перенаправить сообщение, прежде чем отбросить его.</span><span class="sxs-lookup"><span data-stu-id="d6e14-112">The value of `PeerHopCount` is tied to a message instance, and it specifies how many times a message should be forwarded before being dropped.</span></span> <span data-ttu-id="d6e14-113">Каждый раз, когда клиент однорангового канала получает сообщение, он проверяет, указано ли значение `PeerHopCount` для этого сообщения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-113">Each time a message is received by a Peer Channel client, the client examines the message to see if `PeerHopCount` is specified.</span></span> <span data-ttu-id="d6e14-114">Если оно указано, клиент уменьшает значение числа прыжков на единицу, прежде чем перенаправить сообщение на соседние узлы.</span><span class="sxs-lookup"><span data-stu-id="d6e14-114">If it is specified, then the client decrements the hop count value by one before forwarding the message to neighboring nodes.</span></span> <span data-ttu-id="d6e14-115">Если клиент получает сообщение с нулевым числом прыжков, он обрабатывает сообщение, но не перенаправляет его соседям.</span><span class="sxs-lookup"><span data-stu-id="d6e14-115">When a client receives a message with a hop count value of zero, the client processes the message, but does not forward the message to neighbors.</span></span>

<span data-ttu-id="d6e14-116">Сообщению можно задать количество прыжков, добавив `PeerHopCount` в качестве атрибута применимого свойства или поля при реализации класса сообщения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-116">Hop count may be added to a message by adding `PeerHopCount` as an attribute to the applicable property or field in the implementation of the message class.</span></span> <span data-ttu-id="d6e14-117">Можно задать определенное значение числа прыжков перед отправкой сообщения в сетку.</span><span class="sxs-lookup"><span data-stu-id="d6e14-117">You can set this to a specific value before sending the message to the mesh.</span></span> <span data-ttu-id="d6e14-118">Таким образом, при необходимости можно ограничить распределение сообщений по сетке с помощью числа прыжков, потенциально избежав ненужного дублирования сообщения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-118">In this manner, you can use hop count to limit distribution of messages throughout the mesh when necessary, potentially avoiding unnecessary message duplication.</span></span> <span data-ttu-id="d6e14-119">Эта функция полезна в случаях, когда сетка содержит большое количество избыточных данных, а также при отправке сообщений соседям, находящихся на ближайших узлах или в пределах нескольких прыжков.</span><span class="sxs-lookup"><span data-stu-id="d6e14-119">This is useful in cases where the mesh contains a high amount of redundant data, or for sending a message to immediate neighbors, or neighbors within a few hops.</span></span>

- <span data-ttu-id="d6e14-120">Фрагменты кода и связанные сведения см. в описании [атрибута пирхопкаунт: управление сообщением о распространении сообщений](https://docs.microsoft.com/archive/blogs/peerchan/the-peerhopcount-attribute-controlling-message-distribution) в блоге однорангового канала.</span><span class="sxs-lookup"><span data-stu-id="d6e14-120">For code snippets and related information, see the [The PeerHopCount Attribute: Controlling Message Distribution](https://docs.microsoft.com/archive/blogs/peerchan/the-peerhopcount-attribute-controlling-message-distribution) post on the Peer Channel blog.</span></span>

## <a name="message-propagation-filter"></a><span data-ttu-id="d6e14-121">Фильтр распространения сообщений</span><span class="sxs-lookup"><span data-stu-id="d6e14-121">Message Propagation Filter</span></span>

<span data-ttu-id="d6e14-122">Фильтр `MessagePropagationFilter` можно использовать для настраиваемого управления рассылкой сообщений, особенно если распространение определяется содержанием сообщения или другими конкретными сценариями.</span><span class="sxs-lookup"><span data-stu-id="d6e14-122">`MessagePropagationFilter` can be used for customized control of message flooding, especially when the content of the message or other specific scenarios determine propagation.</span></span> <span data-ttu-id="d6e14-123">Для каждого сообщения, проходящего через узел, фильтр принимает решение о его дальнейшем распространении.</span><span class="sxs-lookup"><span data-stu-id="d6e14-123">The filter makes propagation decisions for every message that passes through the node.</span></span> <span data-ttu-id="d6e14-124">Это относится к сообщениям, получаемым от других узлов сетки, а также к создаваемым с помощью приложения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-124">This is true for messages that originated elsewhere in the mesh that your node has received as well as messages created by your application.</span></span> <span data-ttu-id="d6e14-125">Фильтр имеет доступ к самому сообщению и к информации о его источнике, а потому решения о перенаправлении или удалении этого сообщения можно основывать на информации, доступной во всей полноте.</span><span class="sxs-lookup"><span data-stu-id="d6e14-125">The filter has access to both the message and its origination, so decisions about forwarding or dropping the message can be based on the full information available.</span></span>

<span data-ttu-id="d6e14-126"><xref:System.ServiceModel.PeerMessagePropagationFilter> - базовый абстрактный класс с единственной функцией <xref:System.ServiceModel.PeerMessagePropagationFilter.ShouldMessagePropagate%2A>.</span><span class="sxs-lookup"><span data-stu-id="d6e14-126"><xref:System.ServiceModel.PeerMessagePropagationFilter> is a base abstract class with a single function, <xref:System.ServiceModel.PeerMessagePropagationFilter.ShouldMessagePropagate%2A>.</span></span> <span data-ttu-id="d6e14-127">Первый аргумент при вызове метода передает полную копию сообщения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-127">The first argument of the method call passes in a full copy of the message.</span></span> <span data-ttu-id="d6e14-128">Никакие изменения, внесенные в сообщение, не влияют на фактическое сообщение.</span><span class="sxs-lookup"><span data-stu-id="d6e14-128">Any changes made to the message do not affect the actual message.</span></span> <span data-ttu-id="d6e14-129">Последний аргумент при вызове метода указывает источник сообщения (`PeerMessageOrigination.Local` или `PeerMessageOrigination.Remote`).</span><span class="sxs-lookup"><span data-stu-id="d6e14-129">The last argument of the method call identifies the origin of the message (`PeerMessageOrigination.Local` or `PeerMessageOrigination.Remote`).</span></span> <span data-ttu-id="d6e14-130">Конкретные реализации этого метода должны возвращать константу из перечисления <xref:System.ServiceModel.PeerMessagePropagation>, указывающую, что сообщение необходимо перенаправить локальному приложению (`Local`), удаленным клиентам (`Remote`), и тому и другим (`LocalAndRemote`) или ни тому ни другим (`None`).</span><span class="sxs-lookup"><span data-stu-id="d6e14-130">Concrete implementations of this method must return a constant from the <xref:System.ServiceModel.PeerMessagePropagation> enumeration indicating that the message is to be forwarded to the local application (`Local`), forwarded to remote clients (`Remote`), both (`LocalAndRemote`), or neither (`None`).</span></span> <span data-ttu-id="d6e14-131">Этот фильтр можно применить, обратившись к соответствующему объекту `PeerNode` и указав экземпляр производного класса фильтра распространения в свойстве `PeerNode.MessagePropagationFilter`.</span><span class="sxs-lookup"><span data-stu-id="d6e14-131">This filter can be applied by accessing the corresponding `PeerNode` object and specifying an instance of the derived propagation filter class in the `PeerNode.MessagePropagationFilter` property.</span></span> <span data-ttu-id="d6e14-132">Прежде чем открыть одноранговый канал, убедитесь, что фильтр подключен.</span><span class="sxs-lookup"><span data-stu-id="d6e14-132">Ensure that the propagation filter is attached before opening the Peer Channel.</span></span>

- <span data-ttu-id="d6e14-133">Фрагменты кода и связанные сведения см. в разделе [одноранговый канал и мессажепропагатионфилтер](https://docs.microsoft.com/archive/blogs/peerchan/peer-channel-and-messagepropagationfilter) POST в блоге однорангового канала.</span><span class="sxs-lookup"><span data-stu-id="d6e14-133">For code snippets and related information, see the [Peer Channel and MessagePropagationFilter](https://docs.microsoft.com/archive/blogs/peerchan/peer-channel-and-messagepropagationfilter) post on the Peer Channel blog.</span></span>

## <a name="contacting-an-individual-node-in-the-mesh"></a><span data-ttu-id="d6e14-134">Обращение к одному из узлов сетки</span><span class="sxs-lookup"><span data-stu-id="d6e14-134">Contacting an Individual Node in the Mesh</span></span>

<span data-ttu-id="d6e14-135">Можно обратиться к одному из узлов сетки, настроив локальный фильтр или прямое подключение.</span><span class="sxs-lookup"><span data-stu-id="d6e14-135">An individual node in a mesh can be contacted by setting up a local filter, or by setting up a direct connection.</span></span>

<span data-ttu-id="d6e14-136">Если каждый узел сетки имеет отдельный идентификатор, можно указать идентификатор целевого узла при реализации сообщения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-136">If the nodes in a mesh each have an individual ID, a destination ID can be specified in the implementation of your message.</span></span> <span data-ttu-id="d6e14-137">Можно настроить локальный фильтр, реализовав в контракте сообщения функцию, выдающую сообщение текущему узлу только в том случае, если его идентификатор соответствует заданному в качестве целевого.</span><span class="sxs-lookup"><span data-stu-id="d6e14-137">A local filter can be set up by writing a function in your message contract that will only display the message to the current node if its ID matches the destination ID you specified.</span></span> <span data-ttu-id="d6e14-138">Сообщение передается по сетке, что избавляет от излишней нагрузке по настройке нового подключения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-138">The mesh transports the message, so the overhead of setting up a new connection does not have to be incurred.</span></span> <span data-ttu-id="d6e14-139">Впрочем, теряется эффективность, поскольку сообщение передается по сетке множество раз.</span><span class="sxs-lookup"><span data-stu-id="d6e14-139">However, there is a loss of efficiency since the message is sent many times throughout the mesh.</span></span> <span data-ttu-id="d6e14-140">Этот способ достаточно эффективен для отправки сообщений отдельным участникам сетки, если объем этих сообщений не слишком велик и частота их отправки умерена.</span><span class="sxs-lookup"><span data-stu-id="d6e14-140">This works well for sending messages to individual members of a mesh as long as the messages are neither too big nor too frequent.</span></span>

<span data-ttu-id="d6e14-141">Для длительных передач больших объемов данных предпочтительно использовать прямые подключения.</span><span class="sxs-lookup"><span data-stu-id="d6e14-141">For long-lasting, high-bandwidth connections, direct connections are preferable.</span></span> <span data-ttu-id="d6e14-142">Можно отправить по сетке информацию о подключении, а затем настроить прямое подключение для отправки и приема сообщений.</span><span class="sxs-lookup"><span data-stu-id="d6e14-142">You can send connection information over the mesh, and then set up a direct connection of your choosing to send/receive messages.</span></span>

## <a name="choosing-an-approach-for-limiting-message-distribution"></a><span data-ttu-id="d6e14-143">Выбор способа ограничения распределения сообщений</span><span class="sxs-lookup"><span data-stu-id="d6e14-143">Choosing an Approach for Limiting Message Distribution</span></span>

<span data-ttu-id="d6e14-144">Если необходимо ограничить распределение сообщений, следует продумать следующие вопросы:</span><span class="sxs-lookup"><span data-stu-id="d6e14-144">When you discover a scenario in which you need to limit message distribution, ask yourself the following questions:</span></span>

- <span data-ttu-id="d6e14-145">**Кому** нужно получить сообщение?</span><span class="sxs-lookup"><span data-stu-id="d6e14-145">**Who** needs to receive the message?</span></span> <span data-ttu-id="d6e14-146">Только на соседний узел?</span><span class="sxs-lookup"><span data-stu-id="d6e14-146">Just one neighbor node?</span></span> <span data-ttu-id="d6e14-147">На узел в другой части сетки?</span><span class="sxs-lookup"><span data-stu-id="d6e14-147">A node somewhere else in the mesh?</span></span> <span data-ttu-id="d6e14-148">На половину узлов сетки?</span><span class="sxs-lookup"><span data-stu-id="d6e14-148">Half the mesh?</span></span>

- <span data-ttu-id="d6e14-149">**Как часто** будет отправляться это сообщение?</span><span class="sxs-lookup"><span data-stu-id="d6e14-149">**How often** will this message be sent?</span></span>

- <span data-ttu-id="d6e14-150">Какой тип **пропускной способности** будет использоваться этим сообщением?</span><span class="sxs-lookup"><span data-stu-id="d6e14-150">What kind of **bandwidth** will this message use?</span></span>

<span data-ttu-id="d6e14-151">Ответы на эти вопросы помогут определить, какой подход следует использовать: счетчик числа прыжков, фильтр распространения сообщений, локальный фильтр или прямое подключение.</span><span class="sxs-lookup"><span data-stu-id="d6e14-151">The answers to these questions can help you determine whether to use Hop Count, a Message Propagation Filter, a local filter, or a direct connection.</span></span> <span data-ttu-id="d6e14-152">Ниже приведены рекомендации общего характера.</span><span class="sxs-lookup"><span data-stu-id="d6e14-152">Consider the following general guidelines:</span></span>

- <span data-ttu-id="d6e14-153">**Знаком**</span><span class="sxs-lookup"><span data-stu-id="d6e14-153">**Who**</span></span>

  - <span data-ttu-id="d6e14-154">*Отдельный узел*: локальный фильтр или прямое соединение.</span><span class="sxs-lookup"><span data-stu-id="d6e14-154">*Individual node*:  Local filter or direct connection.</span></span>

  - <span data-ttu-id="d6e14-155">*Соседи в определенном окружении*: пирхопкаунт.</span><span class="sxs-lookup"><span data-stu-id="d6e14-155">*Neighbors within a certain vicinity*:  PeerHopCount.</span></span>

  - <span data-ttu-id="d6e14-156">*Комплексное подмножество сетки*: мессажепропагатионфилтер.</span><span class="sxs-lookup"><span data-stu-id="d6e14-156">*Complex subset of the mesh*:  MessagePropagationFilter.</span></span>

- <span data-ttu-id="d6e14-157">**Как часто**</span><span class="sxs-lookup"><span data-stu-id="d6e14-157">**How often**</span></span>

  - <span data-ttu-id="d6e14-158">*Очень часто*: прямое соединение, Пирхопкаунт, мессажепропагатионфилтер.</span><span class="sxs-lookup"><span data-stu-id="d6e14-158">*Very frequent*:  Direct connection, PeerHopCount, MessagePropagationFilter.</span></span>

  - <span data-ttu-id="d6e14-159">*Случайный*: локальный фильтр.</span><span class="sxs-lookup"><span data-stu-id="d6e14-159">*Occasional*:  Local filter.</span></span>

- <span data-ttu-id="d6e14-160">**Использование пропускной способности**</span><span class="sxs-lookup"><span data-stu-id="d6e14-160">**Bandwidth use**</span></span>

  - <span data-ttu-id="d6e14-161">*Высокий*: прямое подключение, не рекомендуется, чтобы использовать мессажепропагатионфилтер или локальный фильтр.</span><span class="sxs-lookup"><span data-stu-id="d6e14-161">*High*:  Direct connection, less advisable to use MessagePropagationFilter or local filter.</span></span>

  - <span data-ttu-id="d6e14-162">*Низкий*: любое прямое подключение, скорее всего, не требуется.</span><span class="sxs-lookup"><span data-stu-id="d6e14-162">*Low*:  Any, direct connection probably not needed.</span></span>

## <a name="see-also"></a><span data-ttu-id="d6e14-163">См. также:</span><span class="sxs-lookup"><span data-stu-id="d6e14-163">See also</span></span>

- [<span data-ttu-id="d6e14-164">Создание приложения одноранговых каналов</span><span class="sxs-lookup"><span data-stu-id="d6e14-164">Building a Peer Channel Application</span></span>](../../../../docs/framework/wcf/feature-details/building-a-peer-channel-application.md)
