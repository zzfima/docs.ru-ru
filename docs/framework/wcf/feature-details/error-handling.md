---
title: Обработка ошибок
ms.date: 03/30/2017
ms.assetid: c948841a-7db9-40ae-9b78-587d216cbcaf
ms.openlocfilehash: f6c0d676a37648678b2b726a46a6238ccc1b3331
ms.sourcegitcommit: eff6adb61852369ab690f3f047818c90580e7eb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2019
ms.locfileid: "72004886"
---
# <a name="error-handling-in-windows-communication-foundation-wcf"></a>Обработка ошибок в Windows Communication Foundation (WCF)

Есть несколько способов проектирования решений по обработке исключений, когда служба обнаруживает непредвиденное исключение или ошибку. Хотя не существует единого решения для обработки ошибок или рекомендации, существует несколько допустимых путей, которые следует учитывать. Обычно рекомендуется реализовать гибридное решение, объединяющее несколько подходов из списка ниже, в зависимости от сложности реализации WCF, типа и частоты исключений, обработанной и необработанной природы элемента исключения и связанные с ними трассировка, ведение журнала или политика.

Эти решения более подробно рассматриваются далее в этом разделе.

## <a name="the-microsoft-enterprise-library"></a>Библиотека Microsoft Enterprise

Программный блок обработки исключений библиотеки Microsoft Enterprise помогает реализовать общие принципы проектирования и создать согласованную стратегию обработки исключений, возникающих на всех уровнях архитектуры корпоративного приложения. Он предназначен для поддержки обычного кода, содержащегося в инструкциях CATCH в компонентах приложения. Вместо того чтобы повторять этот код (например, код, который записывает сведения об исключении в журнал) в двух одинаковых блоках CATCH по всему приложению, можно использовать программный блок обработки исключений, который позволяет разработчикам инкапсулировать эту логику в многократно используемых обработчиках исключений.

В состав этой библиотеки входит готовый обработчик исключений контрактов ошибок. Этот обработчик исключений предназначен для использования в границах службы WCF и создает новый контракт сбоя из исключения.

Программные блоки предназначены для встраивания широко используемых методов и обеспечивают общий подход к обработке исключений в пределах всего приложения. С другой стороны, могут быть весьма полезными самостоятельно разрабатываемые пользовательские обработчики ошибок и контракты ошибок. Например, пользовательские обработчики ошибок обеспечивают отличную возможность автоматического продвижения всех исключений в Фаултексцептионс, а также добавление возможностей ведения журнала в приложение.

Дополнительные сведения см. в [статье корпоративная библиотека Microsoft](https://docs.microsoft.com/previous-versions/msp-n-p/ff632023(v=pandp.10)).

## <a name="dealing-with-expected-exceptions"></a>Работа с ожидаемыми исключениями

Правильный курс действий заключается в перехвате ожидаемых исключений в каждой операции или соответствующей точке расширения, принятии решения о том, можно ли их восстановить из, и возвращать правильную пользовательскую ошибку в FaultException\<T >.
  
## <a name="dealing-with-unexpected-exceptions-using-an-ierrorhandler"></a>Работа с непредвиденными исключениями с помощью IErrorHandler

Чтобы справиться с непредвиденными исключениями, рекомендуемым действием является «привязать» IErrorHandler. Обработчики ошибок перехватывают исключения только на уровне среды выполнения WCF (уровень Service Model), а не на уровне канала. Единственным способом подключения IErrorHandler на уровне канала является создание пользовательского канала, что в большинстве случаев делать не рекомендуется.

"Непредвиденное исключение" обычно не является исключением Неустранимая и исключением обработки. Вместо этого произошло непредвиденное исключение пользователя. Исключение Неустранимая (например, исключение нехватки памяти), которое обычно обрабатывается [обработчиком исключений модели службы](xref:System.ServiceModel.Dispatcher.ExceptionHandler) , обычно не может быть корректно обработано, и единственной причиной для обработки такого исключения может быть дополнительное ведение журнала или возвращение клиенту стандартного исключения. Исключение при обработке возникает при обработке сообщения, например на уровне сериализации, кодировщика или модуля форматирования. Как правило, его нельзя обработать с помощью IErrorHandler, поскольку на момент возникновения таких исключений вмешательство обработчика обычно происходит либо слишком рано, либо слишком поздно. Аналогичным образом с помощью IErrorHandler нельзя обрабатывать исключения транспорта.

С помощью IErrorHandler можно явно управлять поведением приложения, когда возникает исключение. Можно сделать следующее:  

1. Решите, следует ли отправить клиенту ошибку.

2. Замена исключения на ошибку.

3. Замена сбоя другой ошибкой.

4. Выполните ведение журнала или трассировку.

5. Выполнение других настраиваемых действий.

Можно установить пользовательский обработчик ошибок путем добавления его в свойство ErrorHandlers диспетчеров каналов для данной службы.  Может применяться несколько обработчиков ошибок, и они будут вызываться в порядке добавления в данную коллекцию.

IErrorHandler.ProvideFault управляет отправкой клиенту сообщений об ошибках. Этот метод вызывается независимо от типа исключения, возникшего в результате операции в данной службе. Если ни одна операция не выполняется, WCF предполагает поведение по умолчанию и продолжит работу, как если бы на месте не было пользовательских обработчиков ошибок.

Одна область, в которой можно использовать этот подход, - если необходимо создать центральное расположение для преобразования исключений в ошибки, прежде чем они будут отправлены клиенту (при условии, что экземпляр не удаляется и канал не переходит в состояние «Ошибка»).

Метод IErrorHandler. HandleError обычно используется для реализации поведения, связанного с ошибками, таких как ведение журнала ошибок, системные уведомления, завершение работы приложения и т. д. IErrorHandler. HandleError может вызываться в нескольких местах внутри службы, и в зависимости от того, где возникает ошибка, метод HandleError может вызываться или не быть вызван тем же потоком, что и операция. в этом отношении нет никаких гарантий.

## <a name="dealing-with-exceptions-outside-wcf"></a>Работа с исключениями вне WCF

Часто исключения конфигурации, исключения строки подключения к базам данных и другие подобные исключения могут возникать в контексте приложения WCF, но сами они не являются исключениями, вызываемыми моделью службы или самой веб-службой. Эти исключения являются "обычными" исключениями, которые являются внешними по отношению к веб-службе, и должны обрабатываться так же, как другие внешние исключения в среде.

## <a name="tracing-exceptions"></a>Трассировка исключений

Трассировка — единственное место «Catch-All», где один может видеть все исключения. Дополнительные сведения о трассировке исключений и занесении их в журналы см. в разделе «Трассировка и ведение журнала».

## <a name="uri-template-errors-when-using-webgetattribute-and-webinvokeattribute"></a>Ошибки шаблона URI при использовании WebGetAttribute и WebInvokeAttribute

Атрибуты WebGet и WebInvoke позволяют указывать шаблон URI, сопоставляющий компоненты адреса запроса с параметрами операции. Например, шаблон URI «weather/{state}/{city}» сопоставляет адрес запроса с литеральными лексемами, параметром «state» и параметром «city». Затем эти параметры могут быть связаны по имени с некоторым из формальных параметров операции.

Параметры шаблона отображаются в виде строк в пределах URI, тогда как формальные параметры типизированного контракта могут иметь нестроковые типы. Таким образом, преобразование должно происходить до вызова операции. Доступна [Таблица форматов преобразования](wcf-web-http-programming-model-overview.md) .

Однако если преобразование выполнить не удалось, то невозможно сообщить операции, что возникло какое-то нарушение. Вместо этого преобразование типа проявляется в виде сбоев при подготовке к отправке.

Наличие ошибок подготовки к отправке при преобразовании типов можно проверить так же, как многие другие типы ошибок отправки - путем установки обработчика ошибки. Для обработки исключения уровня службы вызывается точка расширения IErrorHandler. Там можно выбрать, будет ли ответ отправлен обратно в вызывающий код, или будут выполнены какие-либо пользовательские задачи или действия с отчетами.

## <a name="see-also"></a>См. также:

- [Базовое программирование для WCF](../basic-wcf-programming.md)
