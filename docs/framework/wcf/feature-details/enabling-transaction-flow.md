---
title: Включение потока транзакций
ms.date: 03/30/2017
helpviewer_keywords:
- transactions [WCF], enabling flow
ms.assetid: a03f5041-5049-43f4-897c-e0292d4718f7
ms.openlocfilehash: 8aff6afb09c97d7d01f5e7b7f1b92ae24bb99fb7
ms.sourcegitcommit: fbb8a593a511ce667992502a3ce6d8f65c594edf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/16/2019
ms.locfileid: "74141763"
---
# <a name="enabling-transaction-flow"></a>Включение потока транзакций
Windows Communication Foundation (WCF) предоставляет гибкие возможности для управления потоком транзакций. Параметры потока транзакций службы могут быть выражены посредством комбинации атрибутов и конфигурации.  
  
## <a name="transaction-flow-settings"></a>Параметры потока транзакций  
 Параметры потока транзакций создаются для конечной точки службы в результате пересечения следующих трех значений:  
  
- атрибута <xref:System.ServiceModel.TransactionFlowAttribute>, определенного для каждого метода в контракте службы;  
  
- свойства привязки `TransactionFlow` в конкретной привязке.  
  
- свойства привязки `TransactionFlowProtocol` в конкретной привязке. Свойство привязки `TransactionFlowProtocol` позволяет выбрать один из двух различных протоколов транзакций для передачи транзакции. Эти протоколы кратко описываются в следующих разделах.  
  
### <a name="ws-atomictransaction-protocol"></a>Протокол WS-AtomicTransaction  
 В сценариях, требующих взаимодействия со сторонним стеком протоколов, удобно использовать протокол WS-AtomicTransaction (WS-AT).  
  
### <a name="oletransactions-protocol"></a>Протокол OleTransactions  
 В сценариях, не требующих взаимодействия со сторонним стеком протоколов, когда специалисту, выполняющему развертывание приложения, известно, что служба протокола WS-AT отключена в данном местоположении или в топологии существующей сети предпочтительно не использовать протокол WS-AT, удобно использовать протокол OleTransactions.  
  
 В следующей таблице показаны типы потоков транзакций, которые можно создать, используя представленные различные комбинации.  
  
|TransactionFlow<br /><br /> привязка|Свойство привязки TransactionFlow|Протокол привязки TransactionFlowProtocol|Тип потока транзакций|  
|---------------------------------|--------------------------------------|----------------------------------------------|------------------------------|  
|Обязательный|true|WS-AT|Транзакция должна передаваться в обеспечивающем возможность взаимодействия формате WS-AT.|  
|Обязательный|true|OleTransactions|Транзакция должна передаваться в формате WCF OleTransactions.|  
|Обязательный|Ложь|Неприменимо|Неприменима, так как это недопустимая конфигурация.|  
|Allowed|true|WS-AT|Транзакция может передаваться в обеспечивающем возможность взаимодействия формате WS-AT.|  
|Allowed|true|OleTransactions|Транзакция может передаваться в формате WCF OleTransactions.|  
|Allowed|Ложь|Любое значение|Транзакция не передается.|  
|NotAllowed|Любое значение|Любое значение|Транзакция не передается.|  
  
 В следующей таблице приведены сводные результаты обработки сообщений.  
  
|Входящее сообщение|Параметры TransactionFlow|Заголовок транзакции|Результат обработки сообщения|  
|----------------------|-----------------------------|------------------------|-------------------------------|  
|Транзакция соответствует ожидаемому формату протокола|Allowed или Mandatory|`MustUnderstand` равняется `true`.|Как это работает|  
|Транзакция не соответствует ожидаемому формату протокола|Обязательный|`MustUnderstand` равняется `false`.|Отклонена, так как требуется транзакция|  
|Транзакция не соответствует ожидаемому формату протокола|Allowed|`MustUnderstand` равняется `false`.|Отклонена, так как заголовок не распознан|  
|Транзакция, использующая любой формат протокола|NotAllowed|`MustUnderstand` равняется `false`.|Отклонена, так как заголовок не распознан|  
|Транзакция отсутствует|Обязательный|Н/Д|Отклонена, так как требуется транзакция|  
|Транзакция отсутствует|Allowed|Н/Д|Как это работает|  
|Транзакция отсутствует|NotAllowed|Н/Д|Как это работает|  
  
 Хотя у каждого метода в контракте могут быть разные требования к потоку транзакций, параметр протокола передачи транзакций действует на уровне привязки. Это означает, что во всех методах, использующих совместно одну и ту же конечную точку (и, таким образом, одну и ту же привязку), применяется одна и та же политика, в соответствии с которой разрешена или необходима передача транзакций, так же как и тот же протокол транзакций, если применимо.  
  
## <a name="enabling-transaction-flow-at-the-method-level"></a>Включение потока транзакций на уровне метода  
 Требования потока транзакций не всегда одинаковы для всех методов в контракте службы. Таким образом, WCF также предоставляет механизм на основе атрибутов, позволяющий выражать параметры потока транзакций для каждого метода. Это обеспечивается посредством атрибута <xref:System.ServiceModel.TransactionFlowAttribute>, задающего уровень, на котором операция службы принимает заголовок транзакции. Для включения потока транзакций необходимо пометить методы контракта службы этим атрибутом. Этот атрибут принимает одно из значений перечисления <xref:System.ServiceModel.TransactionFlowOption>, в котором значением по умолчанию является <xref:System.ServiceModel.TransactionFlowOption.NotAllowed>. Если задано какое-либо значение, отличное от <xref:System.ServiceModel.TransactionFlowOption.NotAllowed>, требуется, чтобы метод был не односторонним. Разработчик может использовать этот атрибут для задания требований или ограничений потока транзакций на уровне метода во время разработки.  
  
## <a name="enabling-transaction-flow-at-the-endpoint-level"></a>Включение потока транзакций на уровне конечной точки  
 В дополнение к настройке потока транзакций уровня метода, предоставляемого атрибутом <xref:System.ServiceModel.TransactionFlowAttribute>, WCF предоставляет параметр на уровне конечной точки для потока транзакций, что позволяет администраторам управлять потоком транзакций на более высоком уровне.  
  
 Это обеспечивается элементом <xref:System.ServiceModel.Channels.TransactionFlowBindingElement>, который позволяет включить или отключить входящий поток транзакций в параметрах привязки конечной точки, а также задать необходимый формат протокола транзакций для входящих транзакций.  
  
 Если поток транзакций привязки выключен, но для выполнения одной из операций в контракте службы требуется входящая транзакция, при запуске службы вызывается исключение проверки.  
  
 Большая часть фиксированных привязок WCF содержит атрибуты `transactionFlow` и `transactionProtocol`, позволяющие настроить определенную привязку для приема входящих транзакций. Дополнительные сведения о настройке элементов конфигурации см. в разделе [\<binding >](../../configure-apps/file-schema/wcf/bindings.md).  
  
 Администратор или разработчик могут использовать поток транзакций уровня конечной точки для настройки на этапе разработки требований или ограничений для потока транзакций с помощью файла конфигурации.  
  
## <a name="security"></a>Безопасность  
 Для обеспечения безопасности и целостности системы необходимо обеспечить безопасный обмен сообщениями при передаче транзакций между приложениями. Не следует передавать или раскрывать сведения о транзакции никакому приложению, не имеющему разрешения на участие в данной транзакции.  
  
 При создании клиентов WCF для неизвестных или ненадежных веб-служб с помощью обмена метаданными вызовы операций для этих веб-служб должны подавлять текущую транзакцию по возможности. В следующем примере показано, как это сделать.  
  
```csharp
//client code which has an ambient transaction  
using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Suppress))  
{  
    // No transaction will flow to this operation  
    untrustedProxy.Operation1(...);  
    scope.Complete();  
}  
//remainder of client code  
```  
  
 Кроме того, службы должны быть настроены таким образом, что они принимают входящие транзакции только от прошедших проверку подлинности и авторизованных клиентов. Входящие транзакции должны приниматься только от клиентов высокого уровня доверия.  
  
## <a name="policy-assertions"></a>Утверждения политики  
 WCF использует утверждения политики для управления потоком транзакций. Утверждения политики описаны в документе о политике службы, агрегируемом с помощью добавления контрактов, конфигурации и атрибутов. Клиент может получить документ о политике службы с помощью запроса-ответа HTTP GET или WS-MetadataExchange. Клиенты затем могут обработать документ о политике, определив, для каких операций в контракте службы может поддерживаться или требуется поток транзакций.  
  
 Утверждения политики потока транзакций влияют на поток транзакций, указывая заголовки протокола SOAP, которые должны посылаться клиентом службе для представления транзакции. Все заголовки транзакций должны быть помечены `MustUnderstand` равняется `true`. Любое сообщение с заголовком, помеченным иначе, отклоняется с ошибкой SOAP.  
  
 В одной операции может присутствовать только одно утверждение политики транзакций. Документы политики с более чем одним утверждением транзакций в операции считаются недопустимыми и отклоняются WCF. Кроме того, в каждом типе порта может присутствовать только один протокол транзакций. Документы политики с операциями, ссылающимися на несколько протоколов транзакций внутри одного типа портов, считаются недопустимыми и отклоняются [средством служебной программы метаданных ServiceModel (Svcutil. exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md). Документы политики, имеющие утверждения о транзакции в выходных сообщениях или односторонних входных сообщениях, также считаются недействительными.
