---
title: Рекомендации по размещению в службах IIS
ms.date: 03/30/2017
ms.assetid: 0834768e-9665-46bf-86eb-d4b09ab91af5
ms.openlocfilehash: 119f14df9d46883a33272903558d83128501b293
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
---
# <a name="internet-information-services-hosting-best-practices"></a><span data-ttu-id="f7048-102">Рекомендации по размещению в службах IIS</span><span class="sxs-lookup"><span data-stu-id="f7048-102">Internet Information Services Hosting Best Practices</span></span>
<span data-ttu-id="f7048-103">В этом разделе даются некоторые рекомендации для размещения служб Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="f7048-103">This topic outlines some best practices for hosting Windows Communication Foundation (WCF) services.</span></span>  
  
## <a name="implementing-wcf-services-as-dlls"></a><span data-ttu-id="f7048-104">Реализация служб WCF в виде библиотек DLL</span><span class="sxs-lookup"><span data-stu-id="f7048-104">Implementing WCF Services as DLLs</span></span>  
 <span data-ttu-id="f7048-105">Реализация WCF службы в виде библиотеки DLL, которая развертывается в каталог \bin веб-приложения позволяет использовать службу вне модели веб-приложения, например, в тестовой среде, не может иметь Internet Information Services (IIS) развернуты.</span><span class="sxs-lookup"><span data-stu-id="f7048-105">Implementing a WCF service as a DLL that is deployed to the \bin directory of a Web application allows you reuse the service outside of the Web application model, for example, in a test environment that may not have Internet Information Services (IIS) deployed.</span></span>  
  
## <a name="service-hosts-in-iis-hosted-applications"></a><span data-ttu-id="f7048-106">Ведущие приложения служб в приложениях, размещенных в IIS</span><span class="sxs-lookup"><span data-stu-id="f7048-106">Service Hosts in IIS-Hosted Applications</span></span>  
 <span data-ttu-id="f7048-107">Не используйте императивные резидентные интерфейсы API для создания новых основных приложений служб, которые ожидают передачи данных различного сетевого транспорта, изначально не поддерживаемого средой размещения IIS (например, [!INCLUDE[iis601](../../../../includes/iis601-md.md)] для размещения служб TCP, поскольку связь по протоколу TCP изначально не поддерживается в [!INCLUDE[iis601](../../../../includes/iis601-md.md)]).</span><span class="sxs-lookup"><span data-stu-id="f7048-107">Do not use the imperative self-host APIs to create new service hosts that listen on network transports not natively supported by the IIS hosting environment (For example, [!INCLUDE[iis601](../../../../includes/iis601-md.md)] to host TCP services, because TCP communication is not natively supported on [!INCLUDE[iis601](../../../../includes/iis601-md.md)]).</span></span> <span data-ttu-id="f7048-108">Такой подход не рекомендуется.</span><span class="sxs-lookup"><span data-stu-id="f7048-108">This approach is not recommended.</span></span> <span data-ttu-id="f7048-109">Основные приложения служб, созданные принудительно, в среде размещения IIS неизвестны.</span><span class="sxs-lookup"><span data-stu-id="f7048-109">Service hosts created imperatively are not known within the IIS hosting environment.</span></span> <span data-ttu-id="f7048-110">Ключевым пунктом является то, что обработка, выполненная принудительно созданными службами, не принимается во внимание системой IIS, когда она определяет, простаивает ли пул ведущих приложений.</span><span class="sxs-lookup"><span data-stu-id="f7048-110">The critical point is that processing done by imperatively created services is not accounted for by IIS when it determines whether the hosting application pool is idle.</span></span> <span data-ttu-id="f7048-111">В результате приложения, где есть такие принудительно созданные основные приложения служб, имеют среду размещения IIS, которая агрессивно удаляет ведущие процессы IIS.</span><span class="sxs-lookup"><span data-stu-id="f7048-111">The result is that applications that have such imperatively created service hosts have an IIS hosting environment that aggressively disposes of IIS host processes.</span></span>  
  
## <a name="uris-and-iis-hosted-endpoints"></a><span data-ttu-id="f7048-112">Универсальные коды ресурсов (URI) и размещенные в IIS конечные точки</span><span class="sxs-lookup"><span data-stu-id="f7048-112">URIs and IIS-Hosted Endpoints</span></span>  
 <span data-ttu-id="f7048-113">Конечные точки для службы, размещенной в IIS, должны быть настроены с использованием относительных универсальных кодов ресурсов (URI), а не абсолютных адресов.</span><span class="sxs-lookup"><span data-stu-id="f7048-113">Endpoints for an IIS-hosted service should be configured using relative Uniform Resource Identifiers (URIs), not absolute addresses.</span></span> <span data-ttu-id="f7048-114">При этом гарантируется попадание адреса конечной точки в ряд адресов URI, принадлежащих ведущему приложению, и обеспечивается надлежащая активация на основе сообщений.</span><span class="sxs-lookup"><span data-stu-id="f7048-114">This guarantees that the endpoint address falls within the set of URI addresses that belong to the hosting application and ensures that message-based activation happens as expected.</span></span>  
  
## <a name="state-management-and-process-recycling"></a><span data-ttu-id="f7048-115">Управление состоянием и перезапуск процессов</span><span class="sxs-lookup"><span data-stu-id="f7048-115">State Management and Process Recycling</span></span>  
 <span data-ttu-id="f7048-116">Среда размещения IIS оптимизирована для служб, не поддерживающих локальное состояние в памяти.</span><span class="sxs-lookup"><span data-stu-id="f7048-116">The IIS hosting environment is optimized for services that do not maintain local state in memory.</span></span> <span data-ttu-id="f7048-117">При появлении множества внешних и внутренних событий система IIS перезапускает ведущий процесс, в результате чего любое непостоянное состояние, сохраненное только в памяти, теряется.</span><span class="sxs-lookup"><span data-stu-id="f7048-117">IIS recycles the host process in response to a variety of external and internal events, causing any volatile state stored exclusively in memory to be lost.</span></span> <span data-ttu-id="f7048-118">Службы, размещенные в IIS, должны сохранять свое состояние во внешней по отношению к процессу среде (например, в базе данных) или в расположенном в памяти кэше, который в случае перезапуска приложения может быть легко восстановлен.</span><span class="sxs-lookup"><span data-stu-id="f7048-118">Services hosted in IIS should store their state external to the process (for example, in a database) or in an in-memory cache that can easily be re-created if an application recycle event occurs.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="f7048-119">Протоколы, которые используют WCF для сообщений уровня надежности и безопасности использование неустойчивого состояния в памяти.</span><span class="sxs-lookup"><span data-stu-id="f7048-119">The protocols WCF uses for message-layer reliability and security make use of the volatile in-memory state.</span></span> <span data-ttu-id="f7048-120">Надежные сеансы WCF и сеансы безопасности может привести к непредвиденному завершению из-за перезапусков приложений.</span><span class="sxs-lookup"><span data-stu-id="f7048-120">WCF reliable sessions and security sessions may terminate unexpectedly due to application recycles.</span></span> <span data-ttu-id="f7048-121">Приложения, размещенные в IIS, которые используют эти протоколы, должны либо зависеть нечто, отличное от предоставляемый WCF сеансовый ключ для корреляции состояния прикладного уровня (например, прикладного уровня или пользовательского заголовка корреляции) или отключить Перезапуск процессов IIS для размещенного приложения.</span><span class="sxs-lookup"><span data-stu-id="f7048-121">IIS-hosted applications that make use of these protocols should either depend on something other than the WCF-provided session key for correlating application-layer state (for example, an application-layer construct or custom correlation header) or disable IIS process recycling for the hosted application.</span></span>  
  
## <a name="optimizing-performance-in-middle-tier-scenarios"></a><span data-ttu-id="f7048-122">Оптимизация производительности в сценариях среднего уровня</span><span class="sxs-lookup"><span data-stu-id="f7048-122">Optimizing Performance in Middle-Tier Scenarios</span></span>  
 <span data-ttu-id="f7048-123">Для обеспечения оптимальной производительности в *сценариях среднего уровня*— служба, которая вызывает другие службы в ответ на входящие сообщения — один раз экземпляр клиента службы WCF для удаленной службы и используйте его многократно несколько входящих запросы.</span><span class="sxs-lookup"><span data-stu-id="f7048-123">For optimal performance in a *middle-tier scenario*—a service that calls out to other services in response to incoming messages—instantiate the WCF service client to the remote service once and reuse it across multiple incoming requests.</span></span> <span data-ttu-id="f7048-124">Создание экземпляров клиентов службы WCF является ресурсоемкой операцией сравнению вызывать в уже существующем экземпляре клиента службы и сценариях среднего уровня представляют повышение производительности благодаря кэшированию удаленных клиентов между запросами.</span><span class="sxs-lookup"><span data-stu-id="f7048-124">Instantiating WCF service clients is an expensive operation relative to making a service call on a pre-existing client instance, and middle-tier scenarios produce distinct performance gains by caching remote clients across requests.</span></span> <span data-ttu-id="f7048-125">Клиенты службы WCF являются потокобезопасными, поэтому не требуется синхронизировать доступ к клиенту в нескольких потоках.</span><span class="sxs-lookup"><span data-stu-id="f7048-125">WCF service clients are thread-safe, so it is not necessary to synchronize access to a client across multiple threads.</span></span>  
  
 <span data-ttu-id="f7048-126">Увеличение производительности в сценариях среднего уровня обеспечивается также благодаря использованию асинхронных интерфейсов API, создаваемых параметром `svcutil /a`.</span><span class="sxs-lookup"><span data-stu-id="f7048-126">Middle-tier scenarios also produce performance gains by using the asynchronous APIs generated by the `svcutil /a` option.</span></span> <span data-ttu-id="f7048-127">`/a` Предписывает [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) для создания `BeginXXX/EndXXX` методы для каждой операции службы, которая позволяет потенциально длительных вызовы к службам удаленных выполнены на фоновые потоки.</span><span class="sxs-lookup"><span data-stu-id="f7048-127">The `/a` option causes the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) to generate `BeginXXX/EndXXX` methods for each service operation, which allows potentially long-running calls to remote services to be made on background threads.</span></span>  
  
## <a name="wcf-in-multi-homed-or-multi-named-scenarios"></a><span data-ttu-id="f7048-128">WCF в многосетевых сценариях и сценариях со многими именами</span><span class="sxs-lookup"><span data-stu-id="f7048-128">WCF in Multi-Homed or Multi-named scenarios</span></span>  
 <span data-ttu-id="f7048-129">Можно развернуть служб WCF внутри веб-фермы IIS, где ряд компьютеров совместно используют общее имя внешнего (такие как http://www.contoso.com) , но в разных имен узлов (например, http://www.contoso.com может направлять трафик на два разных с именем http://machine1.internal.contoso.com и http://machine2.internal.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="f7048-129">You can deploy WCF services inside of an IIS Web farm, where a set of computers share a common external name (such as http://www.contoso.com) but are individually addressed by different hostnames (for example, http://www.contoso.com might direct traffic to two different machines named http://machine1.internal.contoso.com and http://machine2.internal.contoso.com).</span></span> <span data-ttu-id="f7048-130">Этот сценарий развертывания полностью поддерживается системой WCF, но требуется специальная конфигурация веб-сайта IIS размещение служб WCF для отображения надлежащего (внешнего) имени узла в метаданных службы (языке WSDL).</span><span class="sxs-lookup"><span data-stu-id="f7048-130">This deployment scenario is fully supported by WCF, but requires special configuration of the IIS Web site hosting WCF services to display the correct (external) hostname in the service's metadata (Web Services Description Language).</span></span>  
  
 <span data-ttu-id="f7048-131">Чтобы обеспечить появление правильного имени узла в метаданных службы WCF приводит к возникновению ошибки, настройте идентификацию по умолчанию для веб-узла IIS, на котором размещены службы WCF для использования явно заданного имени узла.</span><span class="sxs-lookup"><span data-stu-id="f7048-131">To ensure that the correct hostname appears in the service metadata WCF generates, configure the default identity for the IIS Web site that hosts WCF services to use an explicit hostname.</span></span> <span data-ttu-id="f7048-132">Например, компьютеры, расположенные в ферме www.contoso.com следует использовать привязку узла IIS *: 80: www.contoso.com для HTTP и \*: 443:www.contoso.com для HTTPS.</span><span class="sxs-lookup"><span data-stu-id="f7048-132">For example, computers that reside inside of the www.contoso.com farm should use an IIS site binding of *:80:www.contoso.com for HTTP and \*:443:www.contoso.com for HTTPS.</span></span>  
  
 <span data-ttu-id="f7048-133">Привязки веб-узла IIS можно настроить с помощью оснастки консоли управления (MMC) IIS.</span><span class="sxs-lookup"><span data-stu-id="f7048-133">You can configure IIS Web site bindings by using the IIS Microsoft Management Console (MMC) snap-in.</span></span>  
  
## <a name="application-pools-running-in-different-user-contexts-overwrite-assemblies-from-other-accounts-in-the-temporary-folder"></a><span data-ttu-id="f7048-134">Пулы приложений, работающие в разных контекстах пользователей, которые перезаписывают сборки из других учетных записей во временной папке</span><span class="sxs-lookup"><span data-stu-id="f7048-134">Application Pools Running in Different User Contexts Overwrite Assemblies from Other Accounts in the Temporary Folder</span></span>  
 <span data-ttu-id="f7048-135">Чтобы пулы приложений, работающие в разных контекстах пользователей, не могли перезаписывать сборки из других учетных записей в папке временных файлов [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)], используйте для разных приложений разные идентификаторы и временные папки.</span><span class="sxs-lookup"><span data-stu-id="f7048-135">To ensure that application pools running in different user contexts cannot overwrite assemblies from other accounts in the temporary [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] files folder, use different identities and temporary folders for different applications.</span></span> <span data-ttu-id="f7048-136">Например, если имеется два виртуальных приложения /Application1 и / Application2, можно создать два пула приложений (A и B) с двумя разными идентификаторами.</span><span class="sxs-lookup"><span data-stu-id="f7048-136">For example, if you have two virtual applications /Application1 and / Application2, you can create two Application pools, A and B, with two different identities.</span></span> <span data-ttu-id="f7048-137">Пул приложений A может работать под одним идентификатором пользователя (user1), а пул приложений B - под другим идентификатором пользователя (user2). Настройте приложение /Application1 на использование пула A, а приложение /Application2 - на использование пула B.</span><span class="sxs-lookup"><span data-stu-id="f7048-137">Application pool A can run under one user identity (user1) while application pool B can run under another user identity (user2), and configure /Application1 to use A and /Application2 to use B.</span></span>  
  
 <span data-ttu-id="f7048-138">В файле Web.config можно настроить с помощью временной папки \< system.web/compilation/@tempFolder>.</span><span class="sxs-lookup"><span data-stu-id="f7048-138">In Web.config, you can configure the temporary folder using \<system.web/compilation/@tempFolder>.</span></span> <span data-ttu-id="f7048-139">Для приложения/application1 это может быть «c:\tempForUser1» и для приложения application2 может быть «c:\tempForUser2».</span><span class="sxs-lookup"><span data-stu-id="f7048-139">For /Application1, it can be "c:\tempForUser1" and for application2 it can be "c:\tempForUser2".</span></span> <span data-ttu-id="f7048-140">Предоставьте соответствующее разрешение на запись в эти папки для двух идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="f7048-140">Grant corresponding write permission to these folders for the two identities.</span></span>  
  
 <span data-ttu-id="f7048-141">В этом случае пользователь user2 не может изменить папку создания кода для приложения /application2 (в папке c:\tempForUser1).</span><span class="sxs-lookup"><span data-stu-id="f7048-141">Then user2 cannot change the code-generation folder for /application2 (under c:\tempForUser1).</span></span>  
  
## <a name="enabling-asynchronous-processing"></a><span data-ttu-id="f7048-142">Включение асинхронной обработки</span><span class="sxs-lookup"><span data-stu-id="f7048-142">Enabling asynchronous processing</span></span>  
 <span data-ttu-id="f7048-143">По умолчанию сообщения, отправляемые службой WCF, размещенной в службах IIS 6.0 и более ранних версий, обрабатываются в синхронном режиме.</span><span class="sxs-lookup"><span data-stu-id="f7048-143">By default messages sent to a WCF service hosted under IIS 6.0 and earlier are processed in a synchronous manner.</span></span> <span data-ttu-id="f7048-144">ASP.NET вызывает WCF в своем собственном потоке (рабочий поток ASP.NET) и WCF использует другой поток для обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="f7048-144">ASP.NET calls into WCF on its own thread (the ASP.NET worker thread) and WCF uses another thread to process the request.</span></span> <span data-ttu-id="f7048-145">WCF удерживает рабочий поток ASP.NET до завершения обработки.</span><span class="sxs-lookup"><span data-stu-id="f7048-145">WCF holds onto the ASP.NET worker thread until it completes its processing.</span></span> <span data-ttu-id="f7048-146">В результате обработка запросов выполняется синхронно.</span><span class="sxs-lookup"><span data-stu-id="f7048-146">This leads to synchronous processing of requests.</span></span> <span data-ttu-id="f7048-147">Асинхронная обработка запросов расширяет возможности масштабирования, так как это уменьшает количество потоков, необходимых для обработки запроса, — WCF не удерживает поток ASP.NET при обработке запроса.</span><span class="sxs-lookup"><span data-stu-id="f7048-147">Processing requests asynchronously enables greater scalability because it reduces the number of threads required to process a request –WCF does not hold on to the ASP.NET thread while processing the request.</span></span> <span data-ttu-id="f7048-148">Асинхронный режим не рекомендуется для компьютеров под управлением IIS 6.0, поскольку отсутствует возможность регулирования входящих запросов, которые открываются серверу *отказ в обслуживании* (DDOS).</span><span class="sxs-lookup"><span data-stu-id="f7048-148">Use of asynchronous behavior is not recommended for machines running IIS 6.0 because there is no way to throttle incoming requests that open up the server to *Denial Of Service* (DOS) attacks.</span></span> <span data-ttu-id="f7048-149">Начиная с версии IIS 7.0, реализовано регулирование параллельных запросов: `[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ASP.NET\2.0.50727.0]"MaxConcurrentRequestsPerCpu`.</span><span class="sxs-lookup"><span data-stu-id="f7048-149">Starting with IIS 7.0, a concurrent request throttle has been introduced: `[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ASP.NET\2.0.50727.0]"MaxConcurrentRequestsPerCpu`.</span></span> <span data-ttu-id="f7048-150">Новая система регулирования гарантирует безопасность использования асинхронной обработки.</span><span class="sxs-lookup"><span data-stu-id="f7048-150">With this new throttle it is safe to use the asynchronous processing.</span></span>  <span data-ttu-id="f7048-151">По умолчанию в IIS 7.0 регистрируются асинхронные обработчик и модуль.</span><span class="sxs-lookup"><span data-stu-id="f7048-151">By default in IIS 7.0, the asynchronous handler and module are registered.</span></span> <span data-ttu-id="f7048-152">Если эта функция выключена, то можно вручную включить асинхронную обработку запросов в файле Web.config приложения.</span><span class="sxs-lookup"><span data-stu-id="f7048-152">If this has been turned off, you can manually enable asynchronous processing of requests in your application's Web.config file.</span></span> <span data-ttu-id="f7048-153">Используемые параметры зависят от параметра `aspNetCompatibilityEnabled`.</span><span class="sxs-lookup"><span data-stu-id="f7048-153">The settings you use depend on your `aspNetCompatibilityEnabled` setting.</span></span> <span data-ttu-id="f7048-154">Если параметр `aspNetCompatibilityEnabled` установлен в значение `false`, настройте модуль `System.ServiceModel.Activation.ServiceHttpModule`, как показано в следующем фрагменте конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f7048-154">If you have `aspNetCompatibilityEnabled` set to `false`, configure the `System.ServiceModel.Activation.ServiceHttpModule` as shown in the following configuration snippet.</span></span>  
  
```xml  
<system.serviceModel>  
    <serviceHostingEnvironment aspNetCompatibilityEnabled="false" />      
  </system.serviceModel>  
  <system.webServer>  
    <modules>  
      <remove name="ServiceModel"/>  
      <add name="ServiceModel"   
           preCondition="integratedMode,runtimeVersionv2.0"   
           type="System.ServiceModel.Activation.ServiceHttpModule, System.ServiceModel,Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"/>  
    </modules>  
    </system.webServer>  
```  
  
 <span data-ttu-id="f7048-155">Если параметр `aspNetCompatibilityEnabled` установлен в значение `true`, настройте модуль `System.ServiceModel.Activation.ServiceHttpHandlerFactory`, как показано в следующем фрагменте конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f7048-155">If you have `aspNetCompatibilityEnabled` set to `true`, configure the `System.ServiceModel.Activation.ServiceHttpHandlerFactory` as shown in the following config snippet.</span></span>  
  
```xml  
<system.serviceModel>  
    <serviceHostingEnvironment aspNetCompatibilityEnabled="true" />      
  </system.serviceModel>  
  <system.webServer>  
    <handlers>  
          <clear/>  
          <add name="TestAsyncHttpHandler"   
               path="*.svc"   
               verb="*"   
               type="System.ServiceModel.Activation.ServiceHttpHandlerFactory, System.ServiceModel, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"           
               />  
    </handlers>      
  </system.webServer>  
```  
  
## <a name="see-also"></a><span data-ttu-id="f7048-156">См. также</span><span class="sxs-lookup"><span data-stu-id="f7048-156">See Also</span></span>  
 [<span data-ttu-id="f7048-157">Образцы размещения службы</span><span class="sxs-lookup"><span data-stu-id="f7048-157">Service Hosting Samples</span></span>](http://msdn.microsoft.com/library/f703a3f6-0fba-418a-a92f-7ce75ccfa47e)  
 [<span data-ttu-id="f7048-158">Функции размещения Windows Server App Fabric</span><span class="sxs-lookup"><span data-stu-id="f7048-158">Windows Server App Fabric Hosting Features</span></span>](http://go.microsoft.com/fwlink/?LinkId=201276)
