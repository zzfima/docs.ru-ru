---
title: 'Как: создать пользовательский аутентификатор маркера безопасности'
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, authentication
ms.assetid: 10e245f7-d31e-42e7-82a2-d5780325d372
ms.openlocfilehash: 7bbe59958f59f76046c0a112463cfa64d09c14d3
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79185591"
---
# <a name="how-to-create-a-custom-security-token-authenticator"></a><span data-ttu-id="b0355-102">Как: создать пользовательский аутентификатор маркера безопасности</span><span class="sxs-lookup"><span data-stu-id="b0355-102">How to: create a custom security token authenticator</span></span>
<span data-ttu-id="b0355-103">В этом разделе показано, как создать пользовательскую структуру проверки подлинности маркеров безопасности и интегрировать ее с пользовательским диспетчером маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="b0355-103">This topic shows how to create a custom security token authenticator and how to integrate it with a custom security token manager.</span></span> <span data-ttu-id="b0355-104">Структура проверки подлинности маркеров безопасности проверяет содержимое маркера безопасности, которым снабжается входящее сообщение.</span><span class="sxs-lookup"><span data-stu-id="b0355-104">A security token authenticator validates the content of a security token provided with an incoming message.</span></span> <span data-ttu-id="b0355-105">В случае успешной проверки структура проверки подлинности возвращает коллекцию экземпляров <xref:System.IdentityModel.Policy.IAuthorizationPolicy>, которая при вычислении возвращает набор утверждений.</span><span class="sxs-lookup"><span data-stu-id="b0355-105">If the validation succeeds, the authenticator returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances that, when evaluated, returns a set of claims.</span></span>  
  
 <span data-ttu-id="b0355-106">Для использования пользовательского маркера безопасности аутентификатора в Windows Communication Foundation (WCF) необходимо сначала создать пользовательские учетные данные и реализации маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="b0355-106">To use a custom security token authenticator in Windows Communication Foundation (WCF), you must first create custom credentials and security token manager implementations.</span></span> <span data-ttu-id="b0355-107">Для получения дополнительной информации о создании пользовательских учетных данных и менеджере маркеров безопасности [см.](walkthrough-creating-custom-client-and-service-credentials.md)</span><span class="sxs-lookup"><span data-stu-id="b0355-107">For more information about creating custom credentials and a security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>
  
## <a name="procedures"></a><span data-ttu-id="b0355-108">Процедуры</span><span class="sxs-lookup"><span data-stu-id="b0355-108">Procedures</span></span>  
  
#### <a name="to-create-a-custom-security-token-authenticator"></a><span data-ttu-id="b0355-109">Создание пользовательской структуры проверки подлинности маркера безопасности</span><span class="sxs-lookup"><span data-stu-id="b0355-109">To create a custom security token authenticator</span></span>  
  
1. <span data-ttu-id="b0355-110">Определите новый класс, производный от класса <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>.</span><span class="sxs-lookup"><span data-stu-id="b0355-110">Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span>  
  
2. <span data-ttu-id="b0355-111">Переопределите метод <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> .</span><span class="sxs-lookup"><span data-stu-id="b0355-111">Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> method.</span></span> <span data-ttu-id="b0355-112">Метод возвращает значение `true` или `false` в зависимости от того, может ли пользовательская структура проверки подлинности проверить входящий маркер.</span><span class="sxs-lookup"><span data-stu-id="b0355-112">The method returns `true` or `false` depending on whether the custom authenticator can validate the incoming token type or not.</span></span>  
  
3. <span data-ttu-id="b0355-113">Переопределите метод <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> .</span><span class="sxs-lookup"><span data-stu-id="b0355-113">Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="b0355-114">Этот метод должен соответствующим образом проверить содержимое маркера.</span><span class="sxs-lookup"><span data-stu-id="b0355-114">This method needs to validate the token contents appropriately.</span></span> <span data-ttu-id="b0355-115">Если маркер проходит этап проверки, метод возвращает коллекцию экземпляров <xref:System.IdentityModel.Policy.IAuthorizationPolicy>.</span><span class="sxs-lookup"><span data-stu-id="b0355-115">If the token passes the validation step, it returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances.</span></span> <span data-ttu-id="b0355-116">В приведенном ниже примере используется пользовательская реализация политики авторизации, которая будет создана в следующей процедуре.</span><span class="sxs-lookup"><span data-stu-id="b0355-116">The following example uses a custom authorization policy implementation that will be created in the next procedure.</span></span>  
  
     [!code-csharp[C_CustomTokenAuthenticator#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#1)]
     [!code-vb[C_CustomTokenAuthenticator#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#1)]  
  
 <span data-ttu-id="b0355-117">Приведенный выше образец кода возвращает коллекцию политик авторизации в методе <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="b0355-117">The previous code returns a collection of authorization policies in the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="b0355-118">WCF не обеспечивает публичное внедрение этого интерфейса.</span><span class="sxs-lookup"><span data-stu-id="b0355-118">WCF does not provide a public implementation of this interface.</span></span> <span data-ttu-id="b0355-119">В следующей процедуре показано, как сделать это для пользовательских требований.</span><span class="sxs-lookup"><span data-stu-id="b0355-119">The following procedure shows how to do so for your own requirements.</span></span>  
  
#### <a name="to-create-a-custom-authorization-policy"></a><span data-ttu-id="b0355-120">Создание пользовательской политики авторизации</span><span class="sxs-lookup"><span data-stu-id="b0355-120">To create a custom authorization policy</span></span>  
  
1. <span data-ttu-id="b0355-121">Определите новый класс, реализующий интерфейс <xref:System.IdentityModel.Policy.IAuthorizationPolicy>.</span><span class="sxs-lookup"><span data-stu-id="b0355-121">Define a new class implementing the <xref:System.IdentityModel.Policy.IAuthorizationPolicy> interface.</span></span>  
  
2. <span data-ttu-id="b0355-122">Реализуйте свойство <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A>, доступное только для чтения.</span><span class="sxs-lookup"><span data-stu-id="b0355-122">Implement the <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> read-only property.</span></span> <span data-ttu-id="b0355-123">Один из способов реализации этого свойства предполагает создание глобального уникального идентификатора (GUID) в конструкторе класса и его возврат при каждом запросе данного свойства.</span><span class="sxs-lookup"><span data-stu-id="b0355-123">One way to implement this property is to generate a globally unique identifier (GUID) in the class constructor and return it every time the value for this property is requested.</span></span>  
  
3. <span data-ttu-id="b0355-124">Реализуйте свойство <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A>, доступное только для чтения.</span><span class="sxs-lookup"><span data-stu-id="b0355-124">Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> read-only property.</span></span> <span data-ttu-id="b0355-125">Это свойство должно возвращать издатель наборов утверждений, которые извлекаются из маркера.</span><span class="sxs-lookup"><span data-stu-id="b0355-125">This property needs to return an issuer of the claim sets that are obtained from the token.</span></span> <span data-ttu-id="b0355-126">Этот издатель должен соответствовать издателю маркера или объекту, который отвечает за проверку содержимого маркера.</span><span class="sxs-lookup"><span data-stu-id="b0355-126">This issuer should correspond to the issuer of the token or an authority that is responsible for validating the token contents.</span></span> <span data-ttu-id="b0355-127">В следующем примере используется утверждение издателя, которое передается данному классу из пользовательской структуры проверки подлинности маркеров безопасности, созданной в приведенной выше процедуре.</span><span class="sxs-lookup"><span data-stu-id="b0355-127">The following example uses the issuer claim that passed to this class from the custom security token authenticator created in the previous procedure.</span></span> <span data-ttu-id="b0355-128">Пользовательская структура проверки подлинности маркеров безопасности использует предоставляемый системой набор утверждений (возвращаемый свойством <xref:System.IdentityModel.Claims.ClaimSet.System%2A>) для представления издателя маркера имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="b0355-128">The custom security token authenticator uses the system-provided claim set (returned by the <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property) to represent the issuer of the username token.</span></span>  
  
4. <span data-ttu-id="b0355-129">Выполните метод <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A>.</span><span class="sxs-lookup"><span data-stu-id="b0355-129">Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method.</span></span> <span data-ttu-id="b0355-130">Этот метод записывает в экземпляр класса <xref:System.IdentityModel.Policy.EvaluationContext> (передаваемый в качестве аргумента) утверждения, основанные на содержимом входящего маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="b0355-130">This method populates an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class (passed in as an argument) with claims that are based on the incoming security token content.</span></span> <span data-ttu-id="b0355-131">Метод возвращает значение `true` после завершения вычисления.</span><span class="sxs-lookup"><span data-stu-id="b0355-131">The method returns `true` when it is done with the evaluation.</span></span> <span data-ttu-id="b0355-132">Если реализация зависит от наличия других политик авторизации, которые предоставляют дополнительные сведения для контекста вычисления, этот метод может возвращать значение `false`, если необходимые сведения пока отсутствуют в контексте вычисления.</span><span class="sxs-lookup"><span data-stu-id="b0355-132">In cases when the implementation relies on the presence of other authorization policies that provide additional information to the evaluation context, this method can return `false` if the required information is not present yet in the evaluation context.</span></span> <span data-ttu-id="b0355-133">В этом случае WCF снова вызовет метод после оценки всех других политик авторизации, генерируемых для входящего сообщения, если хотя бы одна из этих политик авторизации изменила контекст оценки.</span><span class="sxs-lookup"><span data-stu-id="b0355-133">In that case, WCF will call the method again after evaluating all other authorization policies generated for the incoming message if at least one of those authorization policies modified the evaluation context.</span></span>  
  
     [!code-csharp[c_CustomTokenAuthenticator#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#3)]
     [!code-vb[c_CustomTokenAuthenticator#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#3)]  

 <span data-ttu-id="b0355-134">[Пошаговая прогулка: Создание пользовательских учетных данных клиентов и служб](walkthrough-creating-custom-client-and-service-credentials.md) ы описывает, как создавать пользовательские учетные данные и пользовательский менеджер маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="b0355-134">[Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md) describes how to create custom credentials and a custom security token manager.</span></span> <span data-ttu-id="b0355-135">Для использования созданной здесь пользовательской структуры проверки подлинности маркеров безопасности реализация диспетчера маркеров безопасности изменяется таким образом, чтобы возвращать из метода <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> пользовательскую структуру проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b0355-135">To use the custom security token authenticator created here, an implementation of the security token manager is modified to return the custom authenticator from the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method.</span></span> <span data-ttu-id="b0355-136">Метод возвращает структуру проверки подлинности, когда ему передается соответствующее требование маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="b0355-136">The method returns an authenticator when an appropriate security token requirement is passed in.</span></span>  
  
#### <a name="to-integrate-a-custom-security-token-authenticator-with-a-custom-security-token-manager"></a><span data-ttu-id="b0355-137">Интеграция пользовательской структуры проверки подлинности маркеров безопасности с пользовательским диспетчером маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="b0355-137">To integrate a custom security token authenticator with a custom security token manager</span></span>  
  
1. <span data-ttu-id="b0355-138">Переопределите метод <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> в реализации пользовательского диспетчера маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="b0355-138">Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method in your custom security token manager implementation.</span></span>  
  
2. <span data-ttu-id="b0355-139">Добавьте в метод соответствующие инструкции, чтобы он мог возвращать пользовательскую структуру проверки подлинности маркеров безопасности на основании параметра <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>.</span><span class="sxs-lookup"><span data-stu-id="b0355-139">Add logic to the method to enable it to return your custom security token authenticator based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter.</span></span> <span data-ttu-id="b0355-140">Следующий пример возвращает пользовательскую структуру проверки подлинности маркеров безопасности, если типом маркера требований является имя пользователя (представляется свойством <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A>), а направлением сообщения, для которого запрашивается структура проверки подлинности маркеров безопасности, являются входящие сообщения (представляется полем <xref:System.ServiceModel.Description.MessageDirection.Input>).</span><span class="sxs-lookup"><span data-stu-id="b0355-140">The following example returns a custom security token authenticator if the token requirements token type is a user name (represented by the <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> property) and the message direction for which the security token authenticator is being requested is input (represented by the <xref:System.ServiceModel.Description.MessageDirection.Input> field).</span></span>  
  
     [!code-csharp[c_CustomTokenAuthenticator#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#2)]
     [!code-vb[c_CustomTokenAuthenticator#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#2)]  

## <a name="see-also"></a><span data-ttu-id="b0355-141">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="b0355-141">See also</span></span>

- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.IdentityModel.Tokens.UserNameSecurityToken>
- [<span data-ttu-id="b0355-142">Пошаговое руководство. Создание пользовательских учетных данных для клиента и службы</span><span class="sxs-lookup"><span data-stu-id="b0355-142">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="b0355-143">Практическое руководство. Создание пользовательского поставщика маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="b0355-143">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)
