---
title: Переопределение идентификатора службы для проверки подлинности
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d
ms.openlocfilehash: d1c0cc487d8deea7045ee9653d1eae9b73ec864f
ms.sourcegitcommit: 7e2128d4a4c45b4274bea3b8e5760d4694569ca1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75938016"
---
# <a name="overriding-the-identity-of-a-service-for-authentication"></a><span data-ttu-id="c0097-102">Переопределение идентификатора службы для проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="c0097-102">Overriding the Identity of a Service for Authentication</span></span>
<span data-ttu-id="c0097-103">Как правило, нет необходимости задавать удостоверение в службе, поскольку выбор типа учетных данных клиента определяет тип удостоверения, предоставляемого в метаданных службы.</span><span class="sxs-lookup"><span data-stu-id="c0097-103">Typically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata.</span></span> <span data-ttu-id="c0097-104">Например, следующий код конфигурации использует элемент [\<wsHttpBinding >](../../configure-apps/file-schema/wcf/wshttpbinding.md) и задает для атрибута `clientCredentialType` значение Windows.</span><span class="sxs-lookup"><span data-stu-id="c0097-104">For example, the following configuration code uses the [\<wsHttpBinding>](../../configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows.</span></span>  

 <span data-ttu-id="c0097-105">В следующем фрагменте WSDL (Web Services Description Language) показано удостоверение для ранее определенной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="c0097-105">The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined.</span></span> <span data-ttu-id="c0097-106">В этом примере служба выполняется как самостоятельная служба под определенной учетной записью пользователя (username@contoso.com), поэтому удостоверение имени участника-пользователя (UPN) содержит имя учетной записи.</span><span class="sxs-lookup"><span data-stu-id="c0097-106">In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name.</span></span> <span data-ttu-id="c0097-107">UPN также известно как имя для входа в систему в домене Windows.</span><span class="sxs-lookup"><span data-stu-id="c0097-107">The UPN is also known as the user logon name in a Windows domain.</span></span>  

 <span data-ttu-id="c0097-108">Пример приложения, демонстрирующий настройку удостоверения, см. в разделе [Пример удостоверения службы](../samples/service-identity-sample.md).</span><span class="sxs-lookup"><span data-stu-id="c0097-108">For a sample application that demonstrates identity setting, see [Service Identity Sample](../samples/service-identity-sample.md).</span></span> <span data-ttu-id="c0097-109">Дополнительные сведения об удостоверении службы см. в статье [удостоверение службы и проверка подлинности](../feature-details/service-identity-and-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="c0097-109">For more information about service identity, see [Service Identity and Authentication](../feature-details/service-identity-and-authentication.md).</span></span>  
  
## <a name="kerberos-authentication-and-identity"></a><span data-ttu-id="c0097-110">Проверка подлинности Kerberos и удостоверение</span><span class="sxs-lookup"><span data-stu-id="c0097-110">Kerberos Authentication and Identity</span></span>  
 <span data-ttu-id="c0097-111">По умолчанию, когда служба настроена для использования учетных данных Windows, в WSDL-файле создается элемент [\<identity >](../../configure-apps/file-schema/wcf/identity.md) , который содержит элемент [\<userPrincipalName >](../../configure-apps/file-schema/wcf/userprincipalname.md) или [\<](../../configure-apps/file-schema/wcf/serviceprincipalname.md) .</span><span class="sxs-lookup"><span data-stu-id="c0097-111">By default, when a service is configured to use a Windows credential, an [\<identity>](../../configure-apps/file-schema/wcf/identity.md) element that contains a [\<userPrincipalName>](../../configure-apps/file-schema/wcf/userprincipalname.md) or [\<servicePrincipalName>](../../configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL.</span></span> <span data-ttu-id="c0097-112">Если служба выполняется под учетной записью `LocalSystem`, `LocalService`или `NetworkService`, имя участника-службы (SPN) по умолчанию создается в виде `host/`\<*имя узла*>, так как эти учетные записи имеют доступ к данным имени участника-службы компьютера.</span><span class="sxs-lookup"><span data-stu-id="c0097-112">If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\<*hostname*> because those accounts have access to the computer's SPN data.</span></span> <span data-ttu-id="c0097-113">Если служба выполняется под другой учетной записью, Windows Communication Foundation (WCF) создает имя участника-пользователя в виде \<*имя_пользователя*>@<*имя_домена*`>`.</span><span class="sxs-lookup"><span data-stu-id="c0097-113">If the service is running under a different account, Windows Communication Foundation (WCF) generates a UPN in the form of \<*username*>@<*domainName*`>`.</span></span> <span data-ttu-id="c0097-114">Это происходит потому, что проверка подлинности Kerberos требует предоставления клиенту имени участника-пользователя или имени участника-службы для проверки подлинности службы.</span><span class="sxs-lookup"><span data-stu-id="c0097-114">This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.</span></span>  
  
 <span data-ttu-id="c0097-115">Также для регистрации дополнительного имени участника-службы с учетной записью службы в домене можно использовать средство Setspn.exe.</span><span class="sxs-lookup"><span data-stu-id="c0097-115">You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain.</span></span> <span data-ttu-id="c0097-116">В этом случае имя участника-службы можно использовать в качестве удостоверения службы.</span><span class="sxs-lookup"><span data-stu-id="c0097-116">You can then use the SPN as the identity of the service.</span></span> <span data-ttu-id="c0097-117">Чтобы скачать средство, ознакомьтесь с [пакетом Windows 2000 Resource Kit Tool: SetSPN. exe](https://go.microsoft.com/fwlink/?LinkId=91752).</span><span class="sxs-lookup"><span data-stu-id="c0097-117">To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](https://go.microsoft.com/fwlink/?LinkId=91752).</span></span> <span data-ttu-id="c0097-118">Дополнительные сведения об этом средстве см. в разделе [Обзор SetSPN](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc773257(v=ws.10)).</span><span class="sxs-lookup"><span data-stu-id="c0097-118">For more information about the tool, see [Setspn Overview](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc773257(v=ws.10)).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c0097-119">Чтобы использовать тип учетных данных Windows без согласования, учетная запись пользователя службы должна иметь доступ к имени участника службы (SPN), зарегистрированному с доменом Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c0097-119">To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain.</span></span> <span data-ttu-id="c0097-120">Это можно сделать следующими способами:</span><span class="sxs-lookup"><span data-stu-id="c0097-120">You can do this in the following ways:</span></span>  
  
- <span data-ttu-id="c0097-121">Используйте учетную запись NetworkService или LocalSystem для запуска службы.</span><span class="sxs-lookup"><span data-stu-id="c0097-121">Use the NetworkService or LocalSystem account to run your service.</span></span> <span data-ttu-id="c0097-122">Поскольку эти учетные записи имеют доступ к имени участника-службы (SPN), установленному при присоединении компьютера к домену Active Directory, WCF автоматически создает соответствующий элемент SPN в конечной точке службы в метаданных службы (WSDL).</span><span class="sxs-lookup"><span data-stu-id="c0097-122">Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, WCF automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).</span></span>  
  
- <span data-ttu-id="c0097-123">Запустите службу из любой учетной записи домена Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c0097-123">Use an arbitrary Active Directory domain account to run your service.</span></span> <span data-ttu-id="c0097-124">В данном случае с помощью служебного средства Setspn.exe необходимо установить имя участника-службы для этой учетной записи домена.</span><span class="sxs-lookup"><span data-stu-id="c0097-124">In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool.</span></span> <span data-ttu-id="c0097-125">После создания имени субъекта-службы для учетной записи службы настройте WCF, чтобы опубликовать это SPN для клиентов службы с помощью метаданных (WSDL).</span><span class="sxs-lookup"><span data-stu-id="c0097-125">Once you create the SPN for the service's account, configure WCF to publish that SPN to the service's clients through its metadata (WSDL).</span></span> <span data-ttu-id="c0097-126">Для этого нужно настроить удостоверение конечной точки для предоставляемой конечной точки в файле конфигурации приложения или в коде.</span><span class="sxs-lookup"><span data-stu-id="c0097-126">This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.</span></span>  
  
 <span data-ttu-id="c0097-127">Дополнительные сведения об именах участников-служб, протоколе Kerberos и Active Directory см. в статье [Техническая поддержка Kerberos для Windows](https://docs.microsoft.com/previous-versions/msp-n-p/ff649429(v=pandp.10)).</span><span class="sxs-lookup"><span data-stu-id="c0097-127">For more information about SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](https://docs.microsoft.com/previous-versions/msp-n-p/ff649429(v=pandp.10)).</span></span>  
  
### <a name="when-spn-or-upn-equals-the-empty-string"></a><span data-ttu-id="c0097-128">Если имя участника-службы или имя участника-пользователя равно пустой строке</span><span class="sxs-lookup"><span data-stu-id="c0097-128">When SPN or UPN Equals the Empty String</span></span>  
 <span data-ttu-id="c0097-129">Если задать имя участника-службы или имя участника-пользователя равным пустой строке, возможны разные варианты развития событий в зависимости от используемых уровня безопасности и режима проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c0097-129">If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:</span></span>  
  
- <span data-ttu-id="c0097-130">Если используется безопасность на уровне транспорта, выбирается проверка подлинности по протоколу NT LanMan (NTLM).</span><span class="sxs-lookup"><span data-stu-id="c0097-130">If you are using transport level security, NT LanMan (NTLM) authentication is chosen.</span></span>  
  
- <span data-ttu-id="c0097-131">Если используется безопасность на уровне сообщения, при проверке подлинности в зависимости от используемого режима проверки подлинности может произойти сбой.</span><span class="sxs-lookup"><span data-stu-id="c0097-131">If you are using message level security, authentication may fail, depending on the authentication mode:</span></span>  
  
- <span data-ttu-id="c0097-132">Если используется режим `spnego`, а атрибуту `AllowNtlm` задано значение `false`, произойдет сбой при проверке подлинности.</span><span class="sxs-lookup"><span data-stu-id="c0097-132">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail.</span></span>  
  
- <span data-ttu-id="c0097-133">Если используется режим `spnego`, а атрибуту `AllowNtlm` задано значение `true`, произойдет сбой проверки подлинности, если пусто имя участника-пользователя, и проверку подлинности удастся завершить успешно, если пусто имя участника-службы.</span><span class="sxs-lookup"><span data-stu-id="c0097-133">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty.</span></span>  
  
- <span data-ttu-id="c0097-134">При использовании протокола Kerberos напрямую (этот процесс также известен как "одноступенчатая" проверка) происходит сбой проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c0097-134">If you are using Kerberos direct (also known as "one-shot"), authentication fails.</span></span>  
  
### <a name="using-the-identity-element-in-configuration"></a><span data-ttu-id="c0097-135">Использование элемента > удостоверений \<в конфигурации</span><span class="sxs-lookup"><span data-stu-id="c0097-135">Using the \<identity> Element in Configuration</span></span>  
 <span data-ttu-id="c0097-136">Если изменить тип учетных данных клиента в привязке, ранее показанной сертификату Certificate`,` созданный WSDL будет содержать сериализованный сертификат X.509 в кодировке Base64, соответствующий значению удостоверения, как показано в следующем примере кода.</span><span class="sxs-lookup"><span data-stu-id="c0097-136">If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code.</span></span> <span data-ttu-id="c0097-137">Используется по умолчанию для всех типов учетных данных клиентов, за исключением Windows.</span><span class="sxs-lookup"><span data-stu-id="c0097-137">This is the default for all client credential types other than Windows.</span></span>  

 <span data-ttu-id="c0097-138">Можно изменить значение удостоверения службы по умолчанию или изменить тип удостоверения с помощью элемента <`identity`> в конфигурации или путем задания удостоверения в коде.</span><span class="sxs-lookup"><span data-stu-id="c0097-138">You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code.</span></span> <span data-ttu-id="c0097-139">В следующем коде конфигурации задается идентификатор DNS со значением `contoso.com`.</span><span class="sxs-lookup"><span data-stu-id="c0097-139">The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`.</span></span>  

### <a name="setting-identity-programmatically"></a><span data-ttu-id="c0097-140">Задание удостоверения программным способом</span><span class="sxs-lookup"><span data-stu-id="c0097-140">Setting Identity Programmatically</span></span>  
 <span data-ttu-id="c0097-141">Службе не нужно явно указывать удостоверение, так как WCF автоматически определяет ее.</span><span class="sxs-lookup"><span data-stu-id="c0097-141">Your service does not have to explicitly specify an identity, because WCF automatically determines it.</span></span> <span data-ttu-id="c0097-142">Однако WCF позволяет указать удостоверение в конечной точке, если это необходимо.</span><span class="sxs-lookup"><span data-stu-id="c0097-142">However, WCF allows you to specify an identity on an endpoint, if required.</span></span> <span data-ttu-id="c0097-143">В приведенном ниже примере кода добавляется новая конечная точка службы с определенным идентификатором DNS.</span><span class="sxs-lookup"><span data-stu-id="c0097-143">The following code adds a new service endpoint with a specific DNS identity.</span></span>  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="see-also"></a><span data-ttu-id="c0097-144">См. также:</span><span class="sxs-lookup"><span data-stu-id="c0097-144">See also</span></span>

- [<span data-ttu-id="c0097-145">Практическое руководство. Создание пользовательского средства проверки идентификации клиентов</span><span class="sxs-lookup"><span data-stu-id="c0097-145">How to: Create a Custom Client Identity Verifier</span></span>](how-to-create-a-custom-client-identity-verifier.md)
- [<span data-ttu-id="c0097-146">Идентификация и проверка подлинности службы</span><span class="sxs-lookup"><span data-stu-id="c0097-146">Service Identity and Authentication</span></span>](../feature-details/service-identity-and-authentication.md)
