---
title: Использование действий для реализации поведения на стороне сервера
ms.date: 03/30/2017
ms.assetid: 11a372db-7168-498b-80d2-9419ff557ba5
ms.openlocfilehash: 7068845054e04a002296e7c157655eef6a98db78
ms.sourcegitcommit: 559259da2738a7b33a46c0130e51d336091c2097
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2019
ms.locfileid: "72774140"
---
# <a name="using-actions-to-implement-server-side-behavior"></a>Использование действий для реализации поведения на стороне сервера

Действия OData предоставляют способ реализации поведения, срабатывающего при получении ресурса из службы OData. Рассмотрим для примера цифровой фильм в качестве ресурса. С цифровым фильмом можно совершить множество различных действий: извлекать, оценивать, комментировать или возвращать. Приведенные варианты являются примерами действий, которые могут выполняться службой данных WCF, управляющей цифровыми фильмами. Действия описываются в ответе OData, содержащим ресурс, для которого может быть вызвано это действие. Если пользователь запрашивает ответ, который представляет цифровой фильм, то ответ, возвращаемый службой данных WCF, содержит сведения о действиях, которые могут быть применены к этому ресурсу. Доступность действия зависит от состояния службы данных или ресурса. Например, цифровой фильм, извлеченный одним пользователем, не может быть извлечен другим пользователем. Для вызова действий клиентам достаточно указать URL-адрес. Например, `http://MyServer/MovieService.svc/Movies(6)` определит конкретный цифровой фильм, и `http://MyServer/MovieService.svc/Movies(6)/Checkout` вызовет действие в конкретном фильме. Действия позволяют применять модель службы, не обращаясь к модели данных. Продолжим рассмотрение примера с фильмом. Например, вы можете разрешить пользователям оценивать фильм, но не предоставлять доступ к данным оценок как к ресурсу. Вы можете реализовать действие оценки, чтобы разрешить пользователям оценивать фильм, при этом у них не будет прямого доступа к данным оценок как к ресурсу.

## <a name="implementing-an-action"></a>Реализация действия
 Чтобы реализовать действие службы, необходимо реализовать интерфейсы <xref:System.IServiceProvider>, [идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103))и [идатасервицеинвокабле](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859893(v=vs.103)) . <xref:System.IServiceProvider> позволяет WCF Data Services получить реализацию [идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103)). [Идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103)) позволяет WCF Data Services создавать, находить, описывать и вызывать действия службы. [Идатасервицеинвокабле](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859893(v=vs.103)) позволяет вызывать код, реализующий поведение действий службы, и получать результаты, если таковые имеются. Помните, что службы данных WCF являются службами с предварительным вызовом, то есть новый экземпляр службы создается при каждом вызове службы.  Удостоверьтесь в том, что при создании службы выполняется только необходимая работа.

### <a name="iserviceprovider"></a>IServiceProvider
 Интерфейс <xref:System.IServiceProvider> содержит метод <xref:System.IServiceProvider.GetService%2A>. Службы данных WCF вызывают этот метод для получения числа поставщиков служб, включая поставщиков служб метаданных и поставщиков действий служб данных. При запросе поставщика действий службы данных возвратите реализацию [идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103)) .

### <a name="idataserviceactionprovider"></a>IDataServiceActionProvider
 [Идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103)) содержит методы, позволяющие получать сведения о доступных действиях. При реализации [идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103)) Вы дополняете метаданные службы, которая определяется реализацией [идатасервицеактионпровидер](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859915(v=vs.103)) вашей службы с действиями и обрабатывает эти действия как подходят.

#### <a name="advertiseserviceaction"></a>AdvertiseServiceAction
 [Метод адвертисесервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859971(v=vs.103)) вызывается для определения действий, доступных для указанного ресурса. Этот метод вызывается только для действий, которые не всегда доступны. Он используется для проверки того, следует ли включать действие в ответ OData, исходя из состояния запрашиваемого ресурса или службы. Способ выполнения этой проверки полностью зависит от вас. Если вычислять доступность затратно, а текущий ресурс находится в веб-канале, можно просто пропустить проверку и объявить о доступности действия. Если текущий ресурс в данный момент возвращается в рамках веб-канала, параметру `inFeed` задается значение `true`.

#### <a name="createinvokable"></a>CreateInvokable
 [Креатеинвокабле](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859940(v=vs.103)) вызывается для создания [идатасервицеинвокабле](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859893(v=vs.103)) , содержащего делегат, который инкапсулирует код, реализующий поведение действия. При этом создается экземпляр [идатасервицеинвокабле](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859893(v=vs.103)) , но не вызывается действие. У действий службы данных WCF имеются побочные эффекты, они должны выполняться в сочетании с поставщиком обновлений для сохранения этих изменений на диске. Метод [идатасервицеинвокабле. Invoke](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh859924(v=vs.103)) вызывается из метода SaveChanges () поставщика обновлений.

#### <a name="getserviceactions"></a>GetServiceActions
 Этот метод возвращает коллекцию экземпляров [сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)) , которые представляют все действия, предоставляемые службой данных WCF. [Сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)) — это представление метаданных действия и включает такие сведения, как имя действия, его параметры и тип возвращаемого значения.

#### <a name="getserviceactionsbybindingparametertype"></a>GetServiceActionsByBindingParameterType
 Этот метод возвращает коллекцию всех экземпляров [сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)) , которые могут быть привязаны к указанному типу параметра привязки. Иными словами, все [сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)), которые могут действовать с указанным типом ресурса (также называемым типом параметра привязки). Используется, когда служба возвращает ресурс, чтобы включить сведения о действиях, которые могут быть вызваны для этого ресурса. Этот метод должен возвращать только действия, которые могут быть привязаны к указанному типу параметра привязки (а не производным типам). Этот метод вызывается один раз для каждого запроса и каждого типа, а результат его работы кэшируется службами данных WCF.

#### <a name="tryresolveserviceaction"></a>TryResolveServiceAction
 Этот метод выполняет поиск указанного [сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)) и возвращает `true`, если [сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)) найден. Если объект найден, [сервицеактион](https://docs.microsoft.com/previous-versions/dotnet/wcf-data-services/hh544089(v=vs.103)) возвращается в параметре `out` `serviceAction`.

### <a name="idataserviceinvokable"></a>IDataServiceInvokable
 Этот интерфейс обеспечивает способ выполнения действия службы данных WCF. При реализации интерфейса IDataServiceInvokable необходимо учесть три вещи.

1. Отслеживание и, потенциально, маршалинг параметров.

2. Передача параметров коду, который фактически реализует действие при вызове метода Invoke().

3. Сохранение результатов работы метода Invoke() с тем, чтобы их можно было получить с помощью метода GetResult().

 Параметры могут передаваться в виде токенов. Это так, потому что можно написать поставщика службы данных, работающего с токенами, которые представляют ресурсы. При реализации такой схемы может потребоваться преобразование (маршалинг) этих токенов в сами ресурсы до их отправки собственно действию. После маршалирования параметра он должен находиться в состоянии, доступном для редактирования, чтобы любые изменения ресурса, происходящие при вызове действия, были сохранены и записаны на диск.

 Этому интерфейсу требуется два метода: Invoke и GetResult. Метод Invoke вызывает делегата, который реализует поведение действия, а метод GetResult возвращает результат выполнения действия.

## <a name="invoking-a-wcf-data-service-action"></a>Вызов действия службы данных WCF
 Действия вызываются с помощью запроса HTTP POST. В URL-адресе указывается ресурс, за которым следует имя действия. Параметры передаются в тексте запроса. Например, при наличии службы MovieService, которая выполняла действие Rate. Для вызова действия Rate в отношении определенного фильма можно использовать следующий URL-адрес:

 `http://MovieServer/MovieService.svc/Movies(1)/Rate`

 Movies(1) обозначает фильм, который требуется оценить, а Rate обозначает действие Rate. Само значение оценки будет приведено в тексте HTTP-запроса, как показано в следующем примере:

```http
POST http://MovieServer/MoviesService.svc/Movies(1)/Rate HTTP/1.1
Content-Type: application/json
Content-Length: 20
Host: localhost:15238
{
   "rating": 4
}
```

> [!WARNING]
> Приведенный выше образец кода будет работать только со службами данных WCF 5.2 и более поздней версии, которые поддерживают облегченный формат JSON. При использовании более ранней версии служб данных WCF необходимо указать подробный тип содержимого json следующим образом: `application/json;odata=verbose`.

 Также можно вызывать действия с помощью клиента служб данных WCF, как показано в следующем фрагменте кода:

```csharp
MoviesModel context = new MoviesModel (new Uri("http://MyServer/MoviesService.svc/"));
//...
context.Execute(new Uri("http://MyServer/MoviesService.svc/Movies(1)/Rate"), "POST", new BodyOperationParameter("rating",4) );
```

 В приведенном выше фрагменте кода класс `MoviesModel` был сформирован с помощью Visual Studio для добавления ссылки на службу данных WCF.

## <a name="see-also"></a>См. также

- [Службы данных WCF 4.5](index.md)
- [Определение служб данных WCF](defining-wcf-data-services.md)
- [Разработка и развертывание служб WCF Data Services](developing-and-deploying-wcf-data-services.md)
- [Специализированные поставщики служб данных](custom-data-service-providers-wcf-data-services.md)
