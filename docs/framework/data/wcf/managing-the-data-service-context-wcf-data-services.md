---
title: Управление контекстом службы данных (службы WCF Data Services)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 621887f2814127c7c6800fecc9ade1e161db46e0
ms.sourcegitcommit: f348c84443380a1959294cdf12babcb804cfa987
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2019
ms.locfileid: "73975197"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Управление контекстом службы данных (службы WCF Data Services)
Класс <xref:System.Data.Services.Client.DataServiceContext> инкапсулирует операции, поддерживающие работу с конкретной службой данных. Несмотря на то, что службы OData не имеют состояния, контекст не имеет. Таким образом, можно использовать класс <xref:System.Data.Services.Client.DataServiceContext> для поддержания состояния на клиенте между взаимодействием со службой данных для поддержки таких функций, как управление изменениями. Этот класс также управляет идентификаторами и отслеживает изменения.  
  
## <a name="merge-options-and-identity-resolution"></a>Параметры слияния и разрешение идентификаторов  
 При исполнении <xref:System.Data.Services.Client.DataServiceQuery%601> сущности в канале ответа материализуются в объекты. Дополнительные сведения см. в разделе [материализация объектов](object-materialization-wcf-data-services.md). Способ материализации сущностей в ответном сообщении в объекты выбирается в зависимости от разрешения идентификаторов и параметра слияния, при котором был произведен запрос. Когда несколько запросов или требований загрузки выполняются в области одного контекста <xref:System.Data.Services.Client.DataServiceContext>, клиент [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] отслеживает только один экземпляр объекта, имеющий определенное значение ключа. Этот ключ, который используется для разрешения идентификаторов, однозначно определяет сущность.  
  
 По умолчанию клиент материализует значение в канале ответа в объект только для сущностей, еще не отслеживаемых в контексте <xref:System.Data.Services.Client.DataServiceContext>. Это означает, что изменения в объектах, уже находящихся в кэше, не перезаписываются. Это поведение управляется указанием значения параметра <xref:System.Data.Services.Client.MergeOption> для запросов и операций загрузки. Этот параметр указывается установкой свойства <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> в <xref:System.Data.Services.Client.DataServiceContext>. Значение параметра слияния по умолчанию равно <xref:System.Data.Services.Client.MergeOption.AppendOnly>. В этом случае материализуются только объекты для еще неотслеживаемых сущностей, то есть существующие объекты не перезаписываются. Еще один способ предотвратить перезапись изменений объектов в клиенте при получении обновлений из службы данных состоит в указании параметра <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. При указании параметра <xref:System.Data.Services.Client.MergeOption.OverwriteChanges> значения объектов в клиенте заменяются новейшими значениями из записей в канале ответа, даже если в эти объекты уже были внесены изменения. При использовании параметра слияния <xref:System.Data.Services.Client.MergeOption.NoTracking><xref:System.Data.Services.Client.DataServiceContext> не может отправлять изменения, внесенные в объекты клиента, в службу данных. При выборе этого параметра, изменения всегда перезаписываются значениями из службы данных.  
  
## <a name="managing-concurrency"></a>Управление параллелизмом  
 OData поддерживает оптимистичный параллелизм, позволяющий службе данных обнаруживать конфликты обновления. Поставщик службы данных можно настроить таким образом, что служба данных будет проверять наличие изменений в сущностях с помощью маркера параллелизма. Этот маркер включает одно или несколько свойств типа сущности, проверяемых службой данных для определения, был ли ресурс изменен. Маркеры параллелизма, которые включены в заголовок eTag запросов и ответов от службы данных, управляются клиентом [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]. Дополнительные сведения см. [в разделе Обновление службы данных](updating-the-data-service-wcf-data-services.md).  
  
 Объект <xref:System.Data.Services.Client.DataServiceContext> отслеживает изменения, внесенные в объекты, указанные вручную с помощью методов <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A> и <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A> или с помощью объекта <xref:System.Data.Services.Client.DataServiceCollection%601>. При вызове метода <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> клиент отправляет изменения назад службе данных. Метод <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> может завершиться ошибкой, если изменения данных, произведенные клиентом, вступают в конфликт с изменениями, произведенными службой данных. В этом случае необходимо запросить сущности повторно, чтобы получить обновленные данные. Чтобы переписать изменения в службе данных, выполните запрос с использованием параметра слияния <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. При повторном вызове метода <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> изменения, произведенные в клиенте, будут внесены в службе данных, если в службе данных не производилось других изменений в ресурсах.  
  
## <a name="saving-changes"></a>Сохранение изменений  
 Изменения отслеживаются в экземпляре <xref:System.Data.Services.Client.DataServiceContext>, но не отправляются на сервер немедленно. После завершения изменений для указанного действия вызовите метод <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, чтобы передать все изменения в службу данных. По завершении операции <xref:System.Data.Services.Client.DataServiceResponse> возвращается объект <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>. Объект <xref:System.Data.Services.Client.DataServiceResponse> включает последовательность объектов <xref:System.Data.Services.Client.OperationResponse>, которые в свою очередь содержат последовательность экземпляров <xref:System.Data.Services.Client.EntityDescriptor> или <xref:System.Data.Services.Client.LinkDescriptor>, представляющих сохраненные или ожидаемые изменения. Когда сущность создается или изменяется в службе данных, объект <xref:System.Data.Services.Client.EntityDescriptor> включает ссылку на обновленную сущность, включая все значения свойств, сформированные сервером, такие как сформированное значение `ProductID` в предыдущем примере. Клиентская библиотека автоматически обновляет объект .NET Framework с учетом этих новых значений.  
  
 Для успешного выполнения операций вставки и обновления свойству состояния объекта <xref:System.Data.Services.Client.EntityDescriptor> или <xref:System.Data.Services.Client.LinkDescriptor>, связанного с операцией, присваивается значение <xref:System.Data.Services.Client.EntityStates.Unchanged>, а новые значения добавляются с помощью <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. Если операция вставки, обновления или удаления завершается с ошибкой, состояние сущности остается таким же, как до вызова метода <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, а свойству <xref:System.Data.Services.Client.OperationResponse.Error%2A> объекта <xref:System.Data.Services.Client.OperationResponse> присваивается значение <xref:System.Data.Services.Client.DataServiceRequestException>, содержащее сведения об ошибке. Дополнительные сведения см. [в разделе Обновление службы данных](updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Задание метода HTTP для обновлений  
 По умолчанию клиентская библиотека платформы .NET Framework отправляет обновления созданным сущностям в качестве запросов MERGE. Запрос MERGE обновляет выбранные свойства сущности. Однако клиент всегда включает все свойства в запрос MERGE, даже те свойства, которые не изменились. Протокол OData также поддерживает отправку запросов на размещение для обновления сущностей. В запросе PUT существующая сущность заменяется новым экземпляром сущности с клиентскими значениями свойств. Чтобы использовать запрос PUT, установите флаг <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> напротив перечисления <xref:System.Data.Services.Client.SaveChangesOptions> при вызове метода <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
> Логика запроса PUT отличается от логики запроса MERGE, если клиенту неизвестны все свойства сущности. Такое может иметь место во время проекции типа сущности в новый тип на клиенте. Это также может иметь место при добавлении новых свойств в сущность в модели сервисных данных, если свойство <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> в контексте <xref:System.Data.Services.Client.DataServiceContext> имеет значение `true`, то есть система будет пропускать такие клиентские ошибки сопоставления. В таких случаях запрос PUT сбросит значения всех неизвестных клиенту свойств по умолчанию.  
  
### <a name="post-tunneling"></a>POST-туннелирование  
 По умолчанию клиентская библиотека отправляет запросы на создание, чтение, обновление и удаление в службу OData с помощью соответствующих методов HTTP POST, GET, WHERE/MERGE/PATCH и DELETE. Поддерживаются основные принципы REST (передачи репрезентативных состояний). Однако не каждая реализация веб-сервера поддерживает полный набор методов HTTP. В некоторых случаях поддерживаемые методы ограничиваются лишь GET и POST. Это может произойти, когда посредник, например межсетевой экран, блокирует запросы с некоторыми методами. Так как методы GET и POST чаще всего поддерживаются, OData предписывает способ выполнения любых неподдерживаемых методов HTTP с помощью запроса POST. Это позволяет клиенту отправить запрос POSTс фактическим *методом,* указанным в заголовке настраиваемого `X-HTTP-Method`. Чтобы включить POST-туннелирование для запросов, задайте для свойства <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> на экземпляре <xref:System.Data.Services.Client.DataServiceContext> значение `true`.  
  
## <a name="see-also"></a>См. также

- [Библиотека клиентов служб данных WCF](wcf-data-services-client-library.md)
- [Обновление службы данных](updating-the-data-service-wcf-data-services.md)
- [Асинхронные операции](asynchronous-operations-wcf-data-services.md)
- [Пакетные операции](batching-operations-wcf-data-services.md)
