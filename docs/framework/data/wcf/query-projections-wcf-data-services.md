---
title: Проекции запросов (службы данных WCF)
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- projection [WCF Data Services]
- WCF Data Services, projection
- query projection [WCF Data Services]
- WCF Data Services, querying
ms.assetid: a09f4985-9f0d-48c8-b183-83d67a3dfe5f
ms.openlocfilehash: 17475cccf461371a909660bfe3f8db29bf1fa2fe
ms.sourcegitcommit: f348c84443380a1959294cdf12babcb804cfa987
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2019
ms.locfileid: "73975175"
---
# <a name="query-projections-wcf-data-services"></a><span data-ttu-id="798c8-102">Проекции запросов (службы данных WCF)</span><span class="sxs-lookup"><span data-stu-id="798c8-102">Query Projections (WCF Data Services)</span></span>

<span data-ttu-id="798c8-103">Проекция предоставляет механизм в Open Data Protocol (OData) для уменьшения объема данных в веб-канале, возвращаемых запросом, указывая, что в ответе возвращаются только определенные свойства сущности.</span><span class="sxs-lookup"><span data-stu-id="798c8-103">Projection provides a mechanism in the Open Data Protocol (OData) to reduce the amount of data in the feed returned by a query by specifying that only certain properties of an entity are returned in the response.</span></span> <span data-ttu-id="798c8-104">Дополнительные сведения см. в разделе [OData: выберите параметр системного запроса ($SELECT)](https://go.microsoft.com/fwlink/?LinkId=186076).</span><span class="sxs-lookup"><span data-stu-id="798c8-104">For more information, see [OData: Select System Query Option ($select)](https://go.microsoft.com/fwlink/?LinkId=186076).</span></span>

<span data-ttu-id="798c8-105">В этом разделе описано, как определить проекции запроса, какие требования предъявляются к типам сущности и несущностным типам, как выполнить обновления спроецированных результатов, создать проецируемые типы, а также представляются некоторые вопросы проекции.</span><span class="sxs-lookup"><span data-stu-id="798c8-105">This topic describes how to define a query projection, what the requirements are for entity and non-entity types, making updates to projected results, creating projected types, and lists some projection considerations.</span></span>

## <a name="defining-a-query-projection"></a><span data-ttu-id="798c8-106">Определение проекции запроса</span><span class="sxs-lookup"><span data-stu-id="798c8-106">Defining a Query Projection</span></span>

<span data-ttu-id="798c8-107">Предложение проекции можно добавить в запрос либо с помощью параметра запроса `$select` в URI, либо с помощью предложения [SELECT](../../../csharp/language-reference/keywords/select-clause.md) ([выберите](../../../visual-basic/language-reference/queries/select-clause.md) в Visual Basic) в запросе LINQ.</span><span class="sxs-lookup"><span data-stu-id="798c8-107">You can add a projection clause to a query either by using the `$select` query option in a URI or by using the [select](../../../csharp/language-reference/keywords/select-clause.md) clause ([Select](../../../visual-basic/language-reference/queries/select-clause.md) in Visual Basic) in a LINQ query.</span></span> <span data-ttu-id="798c8-108">Возвращаемые данные сущности могут быть проецированы в типы сущностей или в типы, отличные от сущностей, на клиенте.</span><span class="sxs-lookup"><span data-stu-id="798c8-108">Returned entity data can be projected into either entity types or non-entity types on the client.</span></span> <span data-ttu-id="798c8-109">В примерах этого раздела показано, как использовать предложение `select` в запросе LINQ.</span><span class="sxs-lookup"><span data-stu-id="798c8-109">Examples in this topic demonstrate how to use the `select` clause in a LINQ query.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="798c8-110">При сохранении обновлений, выполненных в проецируемых типах, в службе данных может произойти потеря данных.</span><span class="sxs-lookup"><span data-stu-id="798c8-110">Data loss might occur in the data service when you save updates that were made to projected types.</span></span> <span data-ttu-id="798c8-111">Дополнительные сведения см. в разделе [рекомендации по проекции](#considerations).</span><span class="sxs-lookup"><span data-stu-id="798c8-111">For more information, see [Projection Considerations](#considerations).</span></span>

## <a name="requirements-for-entity-and-non-entity-types"></a><span data-ttu-id="798c8-112">Требования к типам сущностей и несущностным типам</span><span class="sxs-lookup"><span data-stu-id="798c8-112">Requirements for Entity and Non-Entity Types</span></span>

<span data-ttu-id="798c8-113">Типы сущностей должны содержать одно или несколько свойств идентификатора, которые составляют ключ сущности.</span><span class="sxs-lookup"><span data-stu-id="798c8-113">Entity types must have one or more identity properties that make up the entity key.</span></span> <span data-ttu-id="798c8-114">Типы сущностей определяются на клиентах одним из следующих способов.</span><span class="sxs-lookup"><span data-stu-id="798c8-114">Entity types are defined on clients in one of the following ways:</span></span>

- <span data-ttu-id="798c8-115">Применением атрибута <xref:System.Data.Services.Common.DataServiceKeyAttribute> или <xref:System.Data.Services.Common.DataServiceEntityAttribute> к типу.</span><span class="sxs-lookup"><span data-stu-id="798c8-115">By applying the <xref:System.Data.Services.Common.DataServiceKeyAttribute> or <xref:System.Data.Services.Common.DataServiceEntityAttribute> to the type.</span></span>

- <span data-ttu-id="798c8-116">Если тип имеет свойство, именуемое `ID`.</span><span class="sxs-lookup"><span data-stu-id="798c8-116">When the type has a property named `ID`.</span></span>

- <span data-ttu-id="798c8-117">Если тип имеет свойство с именем *type*`ID`, где *Type* — это имя типа.</span><span class="sxs-lookup"><span data-stu-id="798c8-117">When the type has a property named *type*`ID`, where *type* is the name of the type.</span></span>

<span data-ttu-id="798c8-118">По умолчанию, если результаты запроса проецируются на тип, определенный на клиенте, свойства, запрашиваемые в проекции, должны существовать в типе клиента.</span><span class="sxs-lookup"><span data-stu-id="798c8-118">By default, when you project query results into a type defined at the client, the properties requested in the projection must exist in the client type.</span></span> <span data-ttu-id="798c8-119">Но если задается значение `true` для свойства <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> для <xref:System.Data.Services.Client.DataServiceContext>, не требуется, чтобы свойства, заданные в проекции, были в типе клиента.</span><span class="sxs-lookup"><span data-stu-id="798c8-119">However, when you specify a value of `true` for the <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> property of the <xref:System.Data.Services.Client.DataServiceContext>, properties specified in the projection are not required to occur in the client type.</span></span>

### <a name="making-updates-to-projected-results"></a><span data-ttu-id="798c8-120">Выполнение обновлений спроецированных результатов</span><span class="sxs-lookup"><span data-stu-id="798c8-120">Making Updates to Projected Results</span></span>

<span data-ttu-id="798c8-121">При выполнении проекции результатов запроса на типы сущностей объект <xref:System.Data.Services.Client.DataServiceContext> может отслеживать объекты с обновлениями, которые должны передаваться вновь в службу данных, если вызывается метод <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.</span><span class="sxs-lookup"><span data-stu-id="798c8-121">When you project query results into entity types on the client, the <xref:System.Data.Services.Client.DataServiceContext> can track those objects with updates to be sent back to the data service when the <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> method is called.</span></span> <span data-ttu-id="798c8-122">Однако обновления, выполненные в данных, проецируемых на клиенте на несущностные типы, не могут передаваться обратно в службу данных.</span><span class="sxs-lookup"><span data-stu-id="798c8-122">However, updates that are made to data projected into non-entity types on the client cannot be sent back to the data service.</span></span> <span data-ttu-id="798c8-123">Это является следствием того, что без ключа для идентификации экземпляра сущности служба данных не может обновить правильную сущность в источнике данных.</span><span class="sxs-lookup"><span data-stu-id="798c8-123">This is because without a key to identify the entity instance, the data service cannot update the correct entity in the data source.</span></span> <span data-ttu-id="798c8-124">Несущностные типы не прикрепляются к объекту <xref:System.Data.Services.Client.DataServiceContext>.</span><span class="sxs-lookup"><span data-stu-id="798c8-124">Non-entity types are not attached to the <xref:System.Data.Services.Client.DataServiceContext>.</span></span>

<span data-ttu-id="798c8-125">Если одно или несколько свойств типа сущности, определенного в службе данных, не проявляются в типе клиента, в который спроецирована сущность, вставки новых сущностей не будут содержать эти отсутствующие свойства.</span><span class="sxs-lookup"><span data-stu-id="798c8-125">When one or more properties of an entity type defined in the data service do not occur in the client type into which the entity is projected, inserts of new entities will not contain these missing properties.</span></span> <span data-ttu-id="798c8-126">В этом случае обновления, внесенные в существующие сущности, **также** не будут содержать эти отсутствующие свойства.</span><span class="sxs-lookup"><span data-stu-id="798c8-126">In this case, updates that are made to existing entities will **also** not include these missing properties.</span></span> <span data-ttu-id="798c8-127">Если для такого свойства существует значение, обновление сбрасывает его в значение по умолчанию для свойства, как определено в источнике данных.</span><span class="sxs-lookup"><span data-stu-id="798c8-127">When a value exists for such a property, the update resets it to the default value for the property, as defined in the data source.</span></span>

### <a name="creating-projected-types"></a><span data-ttu-id="798c8-128">Создание проецируемых типов</span><span class="sxs-lookup"><span data-stu-id="798c8-128">Creating Projected Types</span></span>

<span data-ttu-id="798c8-129">В следующем примере используется анонимный запрос LINQ, который проецирует связанные с адресом свойства типа `Customers` в новый тип `CustomerAddress`, как определено на клиенте, и помечается как тип сущности.</span><span class="sxs-lookup"><span data-stu-id="798c8-129">The following example uses an anonymous LINQ query that projects the address-related properties of the `Customers` type into a new `CustomerAddress` type, which is defined on the client and is attributed as an entity type:</span></span>

[!code-csharp[Astoria Northwind Client#SelectCustomerAddressSpecific](~/samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#selectcustomeraddressspecific)]
[!code-vb[Astoria Northwind Client#SelectCustomerAddressSpecific](~/samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#selectcustomeraddressspecific)]

<span data-ttu-id="798c8-130">В этом примере шаблон инициализатора объекта используется для создания нового экземпляра типа `CustomerAddress` вместо вызова конструктора.</span><span class="sxs-lookup"><span data-stu-id="798c8-130">In this example, the object initializer pattern is used to create a new instance of the `CustomerAddress` type instead of calling a constructor.</span></span> <span data-ttu-id="798c8-131">При проецировании в типы сущностей конструкторы не поддерживаются, но они могут использоваться при проецировании в несущностные типы и в анонимные типы.</span><span class="sxs-lookup"><span data-stu-id="798c8-131">Constructors are not supported when projecting into entity types, but they can be used when projecting into non-entity and anonymous types.</span></span> <span data-ttu-id="798c8-132">Поскольку `CustomerAddress` имеет тип сущности, изменения могут быть сделаны и отправлены обратно в службу данных.</span><span class="sxs-lookup"><span data-stu-id="798c8-132">Because `CustomerAddress` is an entity type, changes can be made and sent back to the data service.</span></span>

<span data-ttu-id="798c8-133">Кроме того, данные из типа `Customer` проецируются в экземпляр типа сущности `CustomerAddress`, а не в анонимный тип.</span><span class="sxs-lookup"><span data-stu-id="798c8-133">Also, the data from the `Customer` type is projected into an instance of the `CustomerAddress` entity type instead of an anonymous type.</span></span> <span data-ttu-id="798c8-134">Проецирование в типы сущностей поддерживается, но данные доступны только для чтения, поскольку анонимные типы рассматриваются как несущностные типы.</span><span class="sxs-lookup"><span data-stu-id="798c8-134">Projection into anonymous types is supported, but the data is read-only because anonymous types are treated as non-entity types.</span></span>

<span data-ttu-id="798c8-135">Параметры <xref:System.Data.Services.Client.MergeOption> объекта <xref:System.Data.Services.Client.DataServiceContext> используются для разрешения идентификатора во время проекции запроса.</span><span class="sxs-lookup"><span data-stu-id="798c8-135">The <xref:System.Data.Services.Client.MergeOption> settings of the <xref:System.Data.Services.Client.DataServiceContext> are used for identity resolution during query projection.</span></span> <span data-ttu-id="798c8-136">Это означает, что, если экземпляр типа `Customer` уже существует в объекте <xref:System.Data.Services.Client.DataServiceContext>, экземпляр `CustomerAddress` с тем же идентификатором будет следовать правилам разрешения идентификатора, установленным параметром <xref:System.Data.Services.Client.MergeOption></span><span class="sxs-lookup"><span data-stu-id="798c8-136">This means that if an instance of the `Customer` type already exists in the <xref:System.Data.Services.Client.DataServiceContext>, an instance of `CustomerAddress` with the same identity will follow the identity resolution rules set by the <xref:System.Data.Services.Client.MergeOption></span></span>

<span data-ttu-id="798c8-137">Ниже описаны варианты поведения при проецировании результатов в типы сущностей и объектов, не являющихся сущностями.</span><span class="sxs-lookup"><span data-stu-id="798c8-137">The following describes the behaviors when projecting results into entity and non-entity types:</span></span>

<span data-ttu-id="798c8-138">**Создание нового проецируемого экземпляра с помощью инициализаторов**</span><span class="sxs-lookup"><span data-stu-id="798c8-138">**Creating a new projected instance by using initializers**</span></span>

- <span data-ttu-id="798c8-139">Пример</span><span class="sxs-lookup"><span data-stu-id="798c8-139">Example:</span></span>

   [!code-csharp[Astoria Northwind Client#ProjectWithInitializer](~/samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#projectwithinitializer)]
   [!code-vb[Astoria Northwind Client#ProjectWithInitializer](~/samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#projectwithinitializer)]

- <span data-ttu-id="798c8-140">Тип сущности: поддерживается</span><span class="sxs-lookup"><span data-stu-id="798c8-140">Entity type: Supported</span></span>

- <span data-ttu-id="798c8-141">Тип, не относящийся к сущности: поддерживается</span><span class="sxs-lookup"><span data-stu-id="798c8-141">Non-entity type: Supported</span></span>

<span data-ttu-id="798c8-142">**Создание нового проецируемого экземпляра с помощью конструкторов**</span><span class="sxs-lookup"><span data-stu-id="798c8-142">**Creating a new projected instance by using constructors**</span></span>

- <span data-ttu-id="798c8-143">Пример</span><span class="sxs-lookup"><span data-stu-id="798c8-143">Example:</span></span>

   [!code-csharp[Astoria Northwind Client#ProjectWithConstructor](~/samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#projectwithconstructor)]
   [!code-vb[Astoria Northwind Client#ProjectWithConstructor](~/samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#projectwithconstructor)]

- <span data-ttu-id="798c8-144">Тип сущности: создается <xref:System.NotSupportedException>.</span><span class="sxs-lookup"><span data-stu-id="798c8-144">Entity type: A <xref:System.NotSupportedException> is raised.</span></span>

- <span data-ttu-id="798c8-145">Тип, не относящийся к сущности: поддерживается</span><span class="sxs-lookup"><span data-stu-id="798c8-145">Non-entity type: Supported</span></span>

<span data-ttu-id="798c8-146">**Преобразование значения свойства с помощью проекции**</span><span class="sxs-lookup"><span data-stu-id="798c8-146">**Using projection to transform a property value**</span></span>

- <span data-ttu-id="798c8-147">Пример</span><span class="sxs-lookup"><span data-stu-id="798c8-147">Example:</span></span>

   [!code-csharp[Astoria Northwind Client#ProjectWithTransform](~/samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#projectwithtransform)]
   [!code-vb[Astoria Northwind Client#ProjectWithTransform](~/samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#projectwithtransform)]

- <span data-ttu-id="798c8-148">Тип сущности. это преобразование не поддерживается для типов сущностей, поскольку оно может привести к путанице и возможному перезаписи данных в источнике данных, принадлежащем другой сущности.</span><span class="sxs-lookup"><span data-stu-id="798c8-148">Entity type: This transformation is not supported for entity types because it can lead to confusion and potentially overwriting the data in the data source that belongs to another entity.</span></span> <span data-ttu-id="798c8-149">Вызывается исключение <xref:System.NotSupportedException>.</span><span class="sxs-lookup"><span data-stu-id="798c8-149">A <xref:System.NotSupportedException> is raised.</span></span>

- <span data-ttu-id="798c8-150">Тип, не относящийся к сущности: поддерживается</span><span class="sxs-lookup"><span data-stu-id="798c8-150">Non-entity type: Supported</span></span>

<a name="considerations"></a>

## <a name="projection-considerations"></a><span data-ttu-id="798c8-151">Вопросы проекции</span><span class="sxs-lookup"><span data-stu-id="798c8-151">Projection Considerations</span></span>

<span data-ttu-id="798c8-152">При определении проекции запроса следует учитывать следующие дополнительные соображения.</span><span class="sxs-lookup"><span data-stu-id="798c8-152">The following additional considerations apply when defining a query projection.</span></span>

- <span data-ttu-id="798c8-153">При определении пользовательских потоков для формата Atom следует убедиться, что все свойства сущностей, имеющие пользовательские сопоставления, включены в проекцию.</span><span class="sxs-lookup"><span data-stu-id="798c8-153">When you define custom feeds for the Atom format, you must make sure that all entity properties that have custom mappings defined are included in the projection.</span></span> <span data-ttu-id="798c8-154">Если сопоставленное свойство сущности не включено в проекцию, может произойти потеря данных.</span><span class="sxs-lookup"><span data-stu-id="798c8-154">When a mapped entity property is not included in the projection, data loss might occur.</span></span> <span data-ttu-id="798c8-155">Дополнительные сведения см. в разделе [Настройка веб-канала](feed-customization-wcf-data-services.md).</span><span class="sxs-lookup"><span data-stu-id="798c8-155">For more information, see [Feed Customization](feed-customization-wcf-data-services.md).</span></span>

- <span data-ttu-id="798c8-156">Если вставки выполняются в проецированный тип, который не содержит все свойства сущности в модели данных службы данных, свойства, не включенные в проекцию на клиенте, устанавливаются в их значения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="798c8-156">When inserts are made to a projected type that does not contain all of the properties of the entity in the data model of the data service, the properties not included in the projection at the client are set to their default values.</span></span>

- <span data-ttu-id="798c8-157">Если обновления выполняются в проецированном типе, который не содержит все свойства сущности в модели данных службы данных, существующие значения, не включенные в проекцию на клиенте, будут переписаны инициализированными значениями по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="798c8-157">When updates are made to a projected type that does not contain all of the properties of the entity in the data model of the data service, existing values not included in the projection on the client will be overwritten with uninitialized default values.</span></span>

- <span data-ttu-id="798c8-158">Если проекция включает сложное свойство, должен быть возвращен весь сложный объект.</span><span class="sxs-lookup"><span data-stu-id="798c8-158">When a projection includes a complex property, the entire complex object must be returned.</span></span>

- <span data-ttu-id="798c8-159">Если проекция включает свойство навигации, связанные объекты загружаются неявно, без вызова метода <xref:System.Data.Services.Client.DataServiceQuery%601.Expand%2A>.</span><span class="sxs-lookup"><span data-stu-id="798c8-159">When a projection includes a navigation property, the related objects are loaded implicitly without having to call the <xref:System.Data.Services.Client.DataServiceQuery%601.Expand%2A> method.</span></span> <span data-ttu-id="798c8-160">Метод <xref:System.Data.Services.Client.DataServiceQuery%601.Expand%2A> не поддерживается для использования в проецированном запросе.</span><span class="sxs-lookup"><span data-stu-id="798c8-160">The <xref:System.Data.Services.Client.DataServiceQuery%601.Expand%2A> method is not supported for use in a projected query.</span></span>

- <span data-ttu-id="798c8-161">Запросы проецирования запроса на клиенте преобразуются для использования параметра запроса `$select` в URI запроса.</span><span class="sxs-lookup"><span data-stu-id="798c8-161">Query projections queries on the client are translated to use the `$select` query option in the request URI.</span></span> <span data-ttu-id="798c8-162">Если запрос с проекцией выполняется для предыдущей версии служб [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)], которая не поддерживает параметр запроса `$select`, возвращается ошибка.</span><span class="sxs-lookup"><span data-stu-id="798c8-162">When a query with projection is executed against a previous version of [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] that does not support the `$select` query option, an error is returned.</span></span> <span data-ttu-id="798c8-163">Это может также произойти, если версия <xref:System.Data.Services.DataServiceBehavior.MaxProtocolVersion%2A> объекта <xref:System.Data.Services.DataServiceBehavior> для службы данных установлена в значение <xref:System.Data.Services.Common.DataServiceProtocolVersion.V1>.</span><span class="sxs-lookup"><span data-stu-id="798c8-163">This can also happen when the <xref:System.Data.Services.DataServiceBehavior.MaxProtocolVersion%2A> of the <xref:System.Data.Services.DataServiceBehavior> for the data service is set to a value of <xref:System.Data.Services.Common.DataServiceProtocolVersion.V1>.</span></span> <span data-ttu-id="798c8-164">Дополнительные сведения см. в разделе [Управление версиями службы данных](data-service-versioning-wcf-data-services.md).</span><span class="sxs-lookup"><span data-stu-id="798c8-164">For more information, see [Data Service Versioning](data-service-versioning-wcf-data-services.md).</span></span>

<span data-ttu-id="798c8-165">Дополнительные сведения см. [в разделе Практические руководства. Project Results Query](how-to-project-query-results-wcf-data-services.md).</span><span class="sxs-lookup"><span data-stu-id="798c8-165">For more information, see [How to: Project Query Results](how-to-project-query-results-wcf-data-services.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="798c8-166">См. также</span><span class="sxs-lookup"><span data-stu-id="798c8-166">See also</span></span>

- [<span data-ttu-id="798c8-167">Выполнение запросов к службе данных</span><span class="sxs-lookup"><span data-stu-id="798c8-167">Querying the Data Service</span></span>](querying-the-data-service-wcf-data-services.md)
