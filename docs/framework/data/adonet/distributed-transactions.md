---
title: Распределенные транзакции
ms.date: 03/30/2017
ms.assetid: 718b257c-bcb2-408e-b004-a7b0adb1c176
ms.openlocfilehash: f5ed99928534dc31832ac0baf1bb1bfa7e83ded2
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2019
ms.locfileid: "69956758"
---
# <a name="distributed-transactions"></a>Распределенные транзакции
Транзакция - это набор связанных задач, который, помимо всего прочего, завершается успешно (фиксация) или с ошибкой (отмена) как единое целое. *Распределенная транзакция* — это транзакция, влияющая на несколько ресурсов. Для фиксации распределенной транзакции все участники должны гарантировать, что любое изменение данных будет постоянным. Изменения должны сохраняться даже в случае фатального сбоя системы или других непредвиденных событий. Если хоть один из участников не сможет предоставить такую гарантию, вся транзакция завершится с ошибкой и будет выполнен откат любых изменений данных внутри области транзакции.  
  
> [!NOTE]
> Если `DataReader` запускается во время активной транзакции, то при попытке зафиксировать или выполнить откат транзакции возникнет исключение.  
  
## <a name="working-with-systemtransactions"></a>Работа с System.Transactions  
 На платформе.NET Framework распределенные транзакции управляются с помощью API-интерфейса пространства имен <xref:System.Transactions>. При участии нескольких постоянных диспетчеров ресурсов API-интерфейс <xref:System.Transactions> делегирует обработку распределенной транзакции средству наблюдения за транзакциями, такому как координатор распределенных транзакций (Майкрософт) (MSDTC). Дополнительные сведения см. в статье [основы транзакций](../../../../docs/framework/data/transactions/transaction-fundamentals.md).  
  
 В ADO.NET 2.0 появилась поддержка прикрепления распределенных транзакций с помощью метода `EnlistTransaction`, который прикрепляет подключение к экземпляру <xref:System.Transactions.Transaction>. В предыдущих версиях ADO.NET явное прикрепление к распределенной транзакции выполнялось с помощью метода соединения `EnlistDistributedTransaction` для прикрепления соединения к экземпляру <xref:System.EnterpriseServices.ITransaction>, который поддерживался в целях обратной совместимости. Дополнительные сведения о транзакциях корпоративных служб см. в статье [взаимодействие с корпоративными службами и транзакциями COM+](../../../../docs/framework/data/transactions/interoperability-with-enterprise-services-and-com-transactions.md).  
  
 При использовании транзакции <xref:System.Transactions> с поставщиком .NET Framework для SQL Server для базы данных SQL Server автоматически будет использована упрощенная <xref:System.Transactions.Transaction>. Затем по мере необходимости транзакция может стать полной распределенной транзакцией. Дополнительные сведения см. [в разделе Интеграция System. Transactions с SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md).  
  
> [!NOTE]
> Максимальное количество распределенных транзакций, которое база данных Oracle может обрабатывать одновременно, по умолчанию равно 10. При соединении с базой данных Oracle после десятой транзакции возникает исключение. Oracle не поддерживает инструкции языка `DDL` внутри распределенной транзакции.  
  
## <a name="automatically-enlisting-in-a-distributed-transaction"></a>Автоматическое прикрепление к распределенной транзакции  
 Автоматическое прикрепление является способом интеграции соединений ADO.NET по умолчанию (и предпочитаемым) с `System.Transactions`. В случае определения активной транзакции (что, с точки зрения `System.Transaction`, означает, что `Transaction.Current` отлична от значения типа NULL) объект соединения автоматически будет прикреплен к существующей распределенной транзакции. Автоматическое прикрепление транзакции происходит при открытии соединения. Оно не произойдет после открытия, даже если команда выполняется внутри области транзакций. Для отключения автоматического прикрепления в существующих транзакциях следует указать `Enlist=false` в качестве параметра строки соединения для <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType> или `OLE DB Services=-7` в качестве параметра строки соединения для <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType>. Дополнительные сведения о параметрах строки соединения Oracle и ODBC см. в <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> и <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>.  
  
## <a name="manually-enlisting-in-a-distributed-transaction"></a>Ручное прикрепление к распределенной транзакции  
 Если автоматическое прикрепление отключено или необходимо прикрепить транзакцию, запущенную после открытия соединения, то можно осуществить прикрепление к существующей распределенной транзакции с помощью метода `EnlistTransaction` объекта <xref:System.Data.Common.DbConnection> для рабочего поставщика. Прикрепление к существующей распределенной транзакции гарантирует, что в случае фиксации или отката транзакции изменения, выполненные кодом в источнике данных, будут также зафиксированы или откатаны назад.  
  
 Прикрепление к распределенным транзакциям обычно применяется при объединении бизнес-объектов в пул. Если бизнес-объект заносится в пул с открытым соединением, автоматическое прикрепление происходит только при открытии этого соединения. При выполнении нескольких транзакций с помощью занесенного в пул бизнес-объекта открытое для этого объекта соединение не будет автоматически прикрепляться к новым транзакциям. В этом случае можно отключить для соединения автоматическое прикрепление транзакций и прикреплять его к транзакциям с помощью `EnlistTransaction`.  
  
 `EnlistTransaction`принимает один аргумент типа <xref:System.Transactions.Transaction> , который является ссылкой на существующую транзакцию. После вызова метода соединения `EnlistTransaction` все изменения в источнике данных, выполненные с помощью соединения, включаются в транзакцию. Передача значения NULL исключает соединение из прикрепления к текущей распределенной транзакции. Обратите внимание, что соединение должно быть открыто до вызова `EnlistTransaction`.  
  
> [!NOTE]
> После явного прикрепления соединения к транзакции нельзя отменить его прикрепление или прикрепить к другой транзакции до завершения первой транзакции.  
  
> [!CAUTION]
>  Если соединение уже запустило транзакцию с помощью метода соединений `EnlistTransaction`, то <xref:System.Data.Common.DbConnection.BeginTransaction%2A> вызовет исключение. Однако, если транзакция является локальной и запущенной из источника данных (например, явно выполнив инструкцию BEGIN TRANSACTION с помощью <xref:System.Data.SqlClient.SqlCommand>), `EnlistTransaction` выполнит откат локальной транзакции и прикрепит к существующей распределенной транзакции. Уведомления об откате локальной транзакции не высылается, и управление любыми незапущенными локальными транзакциями осуществляется с помощью <xref:System.Data.Common.DbConnection.BeginTransaction%2A>. При использовании поставщика данных .NET Framework для SQL Server (`SqlClient`) с SQL Server попытка прикрепления вызовет исключение. Все остальные случаи исключений не вызовут.  
  
## <a name="promotable-transactions-in-sql-server"></a>Повышаемые транзакции в SQL Server  
 SQL Server поддерживает повышаемые транзакции, в которых локальная упрощенная транзакция может быть автоматически повышена до распределенной, если потребуется. Повышаемая транзакция не вызывает дополнительную нагрузку распределенной транзакции, если таковая не требуется. Дополнительные сведения и пример кода см. в разделе [Интеграция System. Transactions с SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md).  
  
## <a name="configuring-distributed-transactions"></a>Настройка распределенных транзакций  
 Для использования распределенных транзакций возможна необходимость включения в сети MS DTC. Если включен межсетевой экран Windows, необходимо разрешить службе MS DTC использовать сеть или открыть порт MS DTC.  
  
## <a name="see-also"></a>См. также

- [Транзакции и параллельность](../../../../docs/framework/data/adonet/transactions-and-concurrency.md)
- [Интеграция System.Transactions с SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md)
- [Центр разработчиков наборов данных и управляемых поставщиков ADO.NET](https://go.microsoft.com/fwlink/?LinkId=217917)
