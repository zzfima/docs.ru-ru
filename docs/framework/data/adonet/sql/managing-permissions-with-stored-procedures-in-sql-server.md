---
title: Управление разрешениями с использованием хранимых процедур в SQL Server
ms.date: 03/30/2017
ms.assetid: 08fa34e8-2ffa-470d-ba62-e511a5f8558e
ms.openlocfilehash: e6161195682964ac9063cbee65d26ade601ef66c
ms.sourcegitcommit: efff8f331fd9467f093f8ab8d23a203d6ecb5b60
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/01/2018
ms.locfileid: "43425202"
---
# <a name="managing-permissions-with-stored-procedures-in-sql-server"></a><span data-ttu-id="bcd6f-102">Управление разрешениями с использованием хранимых процедур в SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-102">Managing Permissions with Stored Procedures in SQL Server</span></span>
<span data-ttu-id="bcd6f-103">Одним из методов создания нескольких линий защиты для базы данных является реализация доступа ко всем данным с помощью хранимых процедур или определяемых пользователем функций.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-103">One method of creating multiple lines of defense around your database is to implement all data access using stored procedures or user-defined functions.</span></span> <span data-ttu-id="bcd6f-104">Отменяются или запрещаются разрешения на все базовые объекты (например, таблицы), на хранимые процедуры предоставляются разрешения EXECUTE.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-104">You revoke or deny all permissions to underlying objects, such as tables, and grant EXECUTE permissions on stored procedures.</span></span> <span data-ttu-id="bcd6f-105">Тем самым создается эффективный периметр безопасности вокруг данных и объектов базы данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-105">This effectively creates a security perimeter around your data and database objects.</span></span>  
  
## <a name="stored-procedure-benefits"></a><span data-ttu-id="bcd6f-106">Преимущества хранимых процедур</span><span class="sxs-lookup"><span data-stu-id="bcd6f-106">Stored Procedure Benefits</span></span>  
 <span data-ttu-id="bcd6f-107">Хранимые процедуры обладают следующими преимуществами.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-107">Stored procedures have the following benefits:</span></span>  
  
-   <span data-ttu-id="bcd6f-108">Логику данных и бизнес-правила можно инкапсулировать, чтобы пользователи получали доступ к данным и объектам только тем путем, который предусмотрен разработчиками и администраторами баз данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-108">Data logic and business rules can be encapsulated so that users can access data and objects only in ways that developers and database administrators intend.</span></span>  
  
-   <span data-ttu-id="bcd6f-109">Чтобы исключить возможность атак путем внедрения кода SQL, можно использовать параметризованные хранимые процедуры, проверяющие ввод пользователя.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-109">Parameterized stored procedures that validate all user input can be used to thwart SQL injection attacks.</span></span> <span data-ttu-id="bcd6f-110">При использовании динамического SQL обязательно параметризуйте команды и ни в коем случае не включайте значения параметров непосредственно в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-110">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into a query string.</span></span>  
  
-   <span data-ttu-id="bcd6f-111">Можно запретить нерегламентированные запросы и изменение данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-111">Ad hoc queries and data modifications can be disallowed.</span></span> <span data-ttu-id="bcd6f-112">Таким образом пользователи не смогут злонамеренно или случайно уничтожить данные или выполнить запросы, снижающие производительность сервера в сети.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-112">This prevents users from maliciously or inadvertently destroying data or executing queries that impair performance on the server or the network.</span></span>  
  
-   <span data-ttu-id="bcd6f-113">В коде процедур можно обрабатывать ошибки, не передавая их в клиентские приложения.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-113">Errors can be handled in procedure code without being passed directly to client applications.</span></span> <span data-ttu-id="bcd6f-114">Таким образом предотвращается возвращение сообщений об ошибках, которые могут использоваться в атаках зондированием.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-114">This prevents error messages from being returned that could aid in a probing attack.</span></span> <span data-ttu-id="bcd6f-115">Регистрируйте ошибки и обрабатывайте их на сервере.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-115">Log errors and handle them on the server.</span></span>  
  
-   <span data-ttu-id="bcd6f-116">К написанным однажды хранимым процедурам могут обращаться многие приложения.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-116">Stored procedures can be written once, and accessed by many applications.</span></span>  
  
-   <span data-ttu-id="bcd6f-117">Клиентским приложениям не требуются сведения о базовых структурах данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-117">Client applications do not need to know anything about the underlying data structures.</span></span> <span data-ttu-id="bcd6f-118">Код хранимых процедур можно изменять, не внося изменения в клиентские приложения, если это не влияет на списки параметров и возвращаемые типы данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-118">Stored procedure code can be changed without requiring changes in client applications as long as the changes do not affect parameter lists or returned data types.</span></span>  
  
-   <span data-ttu-id="bcd6f-119">Хранимые процедуры снижают нагрузку на сетевой трафик, объединяя несколько операций в одном вызове процедуры.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-119">Stored procedures can reduce network traffic by combining multiple operations into one procedure call.</span></span>  
  
## <a name="stored-procedure-execution"></a><span data-ttu-id="bcd6f-120">Выполнение хранимых процедур</span><span class="sxs-lookup"><span data-stu-id="bcd6f-120">Stored Procedure Execution</span></span>  
 <span data-ttu-id="bcd6f-121">Хранимые процедуры предоставляют доступ к данным с помощью цепочек владения таким образом, чтобы пользователям не требовались явные разрешения для работы с объектами базы данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-121">Stored procedures take advantage of ownership chaining to provide access to data so that users do not need to have explicit permission to access database objects.</span></span> <span data-ttu-id="bcd6f-122">Цепочка владения возникает, когда объекты, последовательно получающие доступ друг к другу, принадлежат одному пользователю.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-122">An ownership chain exists when objects that access each other sequentially are owned by the same user.</span></span> <span data-ttu-id="bcd6f-123">Например, хранимая процедура может вызывать другие хранимые процедуры или обращаться к нескольким таблицам.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-123">For example, a stored procedure can call other stored procedures, or a stored procedure can access multiple tables.</span></span> <span data-ttu-id="bcd6f-124">Если все объекты в цепочке владения принадлежат одному владельцу, то SQL Server проверяет только разрешение EXECUTE вызывающего, но не разрешения вызывающего на другие объекты.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-124">If all objects in the chain of execution have the same owner, then SQL Server only checks the EXECUTE permission for the caller, not the caller's permissions on other objects.</span></span> <span data-ttu-id="bcd6f-125">Поэтому нужно предоставить только разрешения EXECUTE на хранимые процедуры и отменить или запретить все разрешения на базовые таблицы.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-125">Therefore you need to grant only EXECUTE permissions on stored procedures; you can revoke or deny all permissions on the underlying tables.</span></span>  
  
## <a name="best-practices"></a><span data-ttu-id="bcd6f-126">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="bcd6f-126">Best Practices</span></span>  
 <span data-ttu-id="bcd6f-127">Простого написания хранимой процедуры недостаточно для надежной защиты приложения.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-127">Simply writing stored procedures isn't enough to adequately secure your application.</span></span> <span data-ttu-id="bcd6f-128">Необходимо учитывать следующие потенциальные уязвимости защиты.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-128">You should also consider the following potential security holes.</span></span>  
  
-   <span data-ttu-id="bcd6f-129">Предоставьте разрешения EXECUTE на хранимые процедуры нужным ролям базы данных для доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-129">Grant EXECUTE permissions on the stored procedures for database roles you want to be able to access the data.</span></span>  
  
-   <span data-ttu-id="bcd6f-130">Отмените или запретите все разрешения на базовые таблицы для всех ролей и пользователей базы данных, в том числе роль `public`.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-130">Revoke or deny all permissions to the underlying tables for all roles and users in the database, including the `public` role.</span></span> <span data-ttu-id="bcd6f-131">Все пользователи наследуют разрешения из роли public.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-131">All users inherit permissions from public.</span></span> <span data-ttu-id="bcd6f-132">Поэтому запрет разрешений для роли `public` означает, что доступ будут иметь только владельцы объектов и члены роли `sysadmin`, все остальные пользователи не смогут наследовать разрешения, будучи членами других ролей.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-132">Therefore denying permissions to `public` means that only owners and `sysadmin` members have access; all other users will be unable to inherit permissions from membership in other roles.</span></span>  
  
-   <span data-ttu-id="bcd6f-133">Не добавляйте пользователей или роли к ролям `sysadmin` и `db_owner`.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-133">Do not add users or roles to the `sysadmin` or `db_owner` roles.</span></span> <span data-ttu-id="bcd6f-134">Системные администраторы и владельцы базы данных имеют доступ ко всем объектам базы данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-134">System administrators and database owners can access all database objects.</span></span>  
  
-   <span data-ttu-id="bcd6f-135">Отключите учетную запись `guest`.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-135">Disable the `guest` account.</span></span> <span data-ttu-id="bcd6f-136">Это будет препятствовать соединению анонимных пользователей с базой данных.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-136">This will prevent anonymous users from connecting to the database.</span></span> <span data-ttu-id="bcd6f-137">В новых базах данных учетная запись guest отключена по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-137">The guest account is disabled by default in new databases.</span></span>  
  
-   <span data-ttu-id="bcd6f-138">Реализуйте обработку ошибок и ошибочных записей журнала.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-138">Implement error handling and log errors.</span></span>  
  
-   <span data-ttu-id="bcd6f-139">Создайте параметризованные хранимые процедуры, которые будут проверять ввод пользователей.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-139">Create parameterized stored procedures that validate all user input.</span></span> <span data-ttu-id="bcd6f-140">Считайте все входные данные пользователей не соответствующими требованиям безопасности.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-140">Treat all user input as untrusted.</span></span>  
  
-   <span data-ttu-id="bcd6f-141">Избегайте использования динамического SQL за исключением абсолютно необходимых случаев.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-141">Avoid dynamic SQL unless absolutely necessary.</span></span> <span data-ttu-id="bcd6f-142">Используйте функцию Transact-SQL QUOTENAME() для разделения строковых значений и избегайте любого вхождения разделителей в строке ввода.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-142">Use the Transact-SQL QUOTENAME() function to delimit a string value and escape any occurrence of the delimiter in the input string.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="bcd6f-143">Внешние ресурсы</span><span class="sxs-lookup"><span data-stu-id="bcd6f-143">External Resources</span></span>  
 <span data-ttu-id="bcd6f-144">Дополнительные сведения см. в следующих ресурсах.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-144">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="bcd6f-145">Ресурс</span><span class="sxs-lookup"><span data-stu-id="bcd6f-145">Resource</span></span>|<span data-ttu-id="bcd6f-146">Описание:</span><span class="sxs-lookup"><span data-stu-id="bcd6f-146">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="bcd6f-147">[Хранимые процедуры](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) и [Внедрение кода SQL](https://go.microsoft.com/fwlink/?LinkId=98234) в электронной документации на SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-147">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](https://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online</span></span>|<span data-ttu-id="bcd6f-148">Разделы описывают, как создавать хранимые процедуры и как работает внедрение кода SQL.</span><span class="sxs-lookup"><span data-stu-id="bcd6f-148">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="bcd6f-149">См. также</span><span class="sxs-lookup"><span data-stu-id="bcd6f-149">See Also</span></span>  
 [<span data-ttu-id="bcd6f-150">Защита приложений ADO.NET</span><span class="sxs-lookup"><span data-stu-id="bcd6f-150">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)  
 [<span data-ttu-id="bcd6f-151">Общие сведения о безопасности SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-151">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="bcd6f-152">Сценарии безопасности приложений в SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-152">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="bcd6f-153">Написание безопасного динамического кода SQL в SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-153">Writing Secure Dynamic SQL in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)  
 [<span data-ttu-id="bcd6f-154">Подписывание хранимых процедур в SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-154">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="bcd6f-155">Настройка разрешений с олицетворением в SQL Server</span><span class="sxs-lookup"><span data-stu-id="bcd6f-155">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)  
 [<span data-ttu-id="bcd6f-156">Изменение данных с помощью хранимых процедур</span><span class="sxs-lookup"><span data-stu-id="bcd6f-156">Modifying Data with Stored Procedures</span></span>](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)  
 [<span data-ttu-id="bcd6f-157">Центр разработчиков наборов данных и управляемых поставщиков ADO.NET</span><span class="sxs-lookup"><span data-stu-id="bcd6f-157">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
