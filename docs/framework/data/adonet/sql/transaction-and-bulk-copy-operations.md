---
title: Транзакции и операции массового копирования
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: b05ff42fc79a8fc39b7ebe4969875dbadf0dab7b
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54527735"
---
# <a name="transaction-and-bulk-copy-operations"></a>Транзакции и операции массового копирования
Операции массового копирования могут выполняться как изолированные операции или как часть многошаговой транзакции. Этот последний режим обеспечивает выполнение нескольких операций массового копирования в одной транзакции, а также выполнение операций базы данных (таких как вставки, обновления и удаления) при сохранении возможности фиксирования или отката всей транзакции.  
  
 По умолчанию операция массового копирования выполняется как изолированная операция. Операция массового копирования производится без использования транзакции, без возможности отката. Если необходимо выполнить откат всей или части операции массового копирования при возникновении ошибки, можно использовать <xref:System.Data.SqlClient.SqlBulkCopy>-управляемую транзакцию, выполнить операцию массового копирования в существующей транзакции или прикрепиться **System.Transactions** <xref:System.Transactions.Transaction>.  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a>Выполнение операции массового копирования без использования транзакции  
 Следующее приложение командной строки демонстрирует, что случается, если в ходе выполнения операции массового копирования возникает ошибка.  
  
 В примере исходная таблица и целевая таблица включают `Identity` столбец с именем **ProductID**. Вначале код подготавливает целевую таблицу, удалив все строки, а потом вставляя одну строку, для которой **ProductID** известно, что существует в исходной таблице. По умолчанию новое значение для столбца `Identity` формируется в целевой таблице для каждой добавляемой строки. В этом примере при установлении соединения устанавливается параметр, вызывающий вместо этого принудительное использование процессом массовой загрузки значений `Identity` из таблицы источника.  
  
 Операция массового копирования выполняется со свойством <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A>, равным 10. Если при выполнении операции встретилась недопустимая строка, то вызывается исключение. В этом первом примере операция массового копирования не использует транзакцию. Все пакеты, скопированные до момента ошибки, фиксируются. Пакет, содержащий повторяющийся ключ, подвергается откату, а операция массового копирования прерывается до обработки любых других пакетов.  
  
> [!NOTE]
>  Этот пример не будет работать, пока вы не создадите рабочие таблицы, как описано в разделе [Установка примера массового копирования](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). Этот код предоставляется для демонстрации синтаксиса использования **SqlBulkCopy** только. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, это проще и быстрее использовать [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` инструкцию, чтобы скопировать данные.  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a>Выполнение специальной операции массового копирования в транзакции  
 По умолчанию операция массового копирования является своей собственной транзакцией. Если нужно выполнить специальную операцию массового копирования, создайте новый экземпляр <xref:System.Data.SqlClient.SqlBulkCopy> со строкой соединения или используйте существующий объект <xref:System.Data.SqlClient.SqlConnection> без активной транзакции. В каждом сценарии операция массового копирования создает, а затем фиксирует транзакцию или выполняет ее откат.  
  
 Можно явно задать параметр <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> в конструкторе класса <xref:System.Data.SqlClient.SqlBulkCopy>, чтобы явно задать для операции массового копирования выполнить свою собственную транзакцию, в результате чего каждый пакет операции массового копирования будет выполняться в отдельной транзакции.  
  
> [!NOTE]
>  Так как разные пакеты выполняются в разных транзакциях, если во время операции массового копирования возникнет ошибка, для всех строк в текущем пакете будет выполнен откат, но строки из предыдущих пакетов останутся в базе данных.  
  
 Следующее приложение командной строки сходно с предыдущим примером, с одним исключением: в этом примере операция массового копирования управляет своей собственной транзакцией. Все пакеты, скопированные до момента ошибки, фиксируются. Пакет, содержащий повторяющийся ключ, подвергается откату, а операция массового копирования прерывается до обработки любых других пакетов.  
  
> [!IMPORTANT]
>  Этот пример не будет работать, пока вы не создадите рабочие таблицы, как описано в разделе [Установка примера массового копирования](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). Этот код предоставляется для демонстрации синтаксиса использования **SqlBulkCopy** только. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, это проще и быстрее использовать [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` инструкцию, чтобы скопировать данные.  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a>Использование существующих транзакций  
 Можно задать существующий объект <xref:System.Data.SqlClient.SqlTransaction> как параметр в конструкторе <xref:System.Data.SqlClient.SqlBulkCopy>. В этой ситуации операция массового копирования выполняется в существующей транзакции, и в состоянии транзакции не делается никаких изменений (т. е. она не фиксируется и не прерывается). Это позволяет приложению включить операцию массового копирования в транзакцию с другими операциями базы данных. Но если объект <xref:System.Data.SqlClient.SqlTransaction> не задан, ссылка Null не передана и соединение имеет активную транзакцию, возникает исключение.  
  
 Если нужно выполнить откат всей операции массового копирования из-за возникновения ошибки или если массовое копирование должно выполняться как часть большего процесса, для которого может быть выполнен откат, можно предоставить объект <xref:System.Data.SqlClient.SqlTransaction> для конструктора <xref:System.Data.SqlClient.SqlBulkCopy>.  
  
 Следующее приложение командной строки аналогично первому примеру (без транзакции), за одним исключением: здесь операция массового копирования включена в большую, внешнюю транзакцию. Если возникает ошибка нарушения первичного ключа, производится откат всей транзакции и в целевую таблицу строки не добавляются.  
  
> [!IMPORTANT]
>  Этот пример не будет работать, пока вы не создадите рабочие таблицы, как описано в разделе [Установка примера массового копирования](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md). Этот код предоставляется для демонстрации синтаксиса использования **SqlBulkCopy** только. Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, это проще и быстрее использовать [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` инструкцию, чтобы скопировать данные.  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a>См. также
- [Операции массового копирования в SQL Server](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [Центр разработчиков наборов данных и управляемых поставщиков ADO.NET](https://go.microsoft.com/fwlink/?LinkId=217917)
