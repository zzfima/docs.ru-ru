---
title: Транзакции и операции массового копирования
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: b05ff42fc79a8fc39b7ebe4969875dbadf0dab7b
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2019
ms.locfileid: "54527735"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="545a6-102">Транзакции и операции массового копирования</span><span class="sxs-lookup"><span data-stu-id="545a6-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="545a6-103">Операции массового копирования могут выполняться как изолированные операции или как часть многошаговой транзакции.</span><span class="sxs-lookup"><span data-stu-id="545a6-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="545a6-104">Этот последний режим обеспечивает выполнение нескольких операций массового копирования в одной транзакции, а также выполнение операций базы данных (таких как вставки, обновления и удаления) при сохранении возможности фиксирования или отката всей транзакции.</span><span class="sxs-lookup"><span data-stu-id="545a6-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="545a6-105">По умолчанию операция массового копирования выполняется как изолированная операция.</span><span class="sxs-lookup"><span data-stu-id="545a6-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="545a6-106">Операция массового копирования производится без использования транзакции, без возможности отката.</span><span class="sxs-lookup"><span data-stu-id="545a6-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="545a6-107">Если необходимо выполнить откат всей или части операции массового копирования при возникновении ошибки, можно использовать <xref:System.Data.SqlClient.SqlBulkCopy>-управляемую транзакцию, выполнить операцию массового копирования в существующей транзакции или прикрепиться **System.Transactions** <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="545a6-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="545a6-108">Выполнение операции массового копирования без использования транзакции</span><span class="sxs-lookup"><span data-stu-id="545a6-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="545a6-109">Следующее приложение командной строки демонстрирует, что случается, если в ходе выполнения операции массового копирования возникает ошибка.</span><span class="sxs-lookup"><span data-stu-id="545a6-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="545a6-110">В примере исходная таблица и целевая таблица включают `Identity` столбец с именем **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="545a6-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="545a6-111">Вначале код подготавливает целевую таблицу, удалив все строки, а потом вставляя одну строку, для которой **ProductID** известно, что существует в исходной таблице.</span><span class="sxs-lookup"><span data-stu-id="545a6-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="545a6-112">По умолчанию новое значение для столбца `Identity` формируется в целевой таблице для каждой добавляемой строки.</span><span class="sxs-lookup"><span data-stu-id="545a6-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="545a6-113">В этом примере при установлении соединения устанавливается параметр, вызывающий вместо этого принудительное использование процессом массовой загрузки значений `Identity` из таблицы источника.</span><span class="sxs-lookup"><span data-stu-id="545a6-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="545a6-114">Операция массового копирования выполняется со свойством <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A>, равным 10.</span><span class="sxs-lookup"><span data-stu-id="545a6-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="545a6-115">Если при выполнении операции встретилась недопустимая строка, то вызывается исключение.</span><span class="sxs-lookup"><span data-stu-id="545a6-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="545a6-116">В этом первом примере операция массового копирования не использует транзакцию.</span><span class="sxs-lookup"><span data-stu-id="545a6-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="545a6-117">Все пакеты, скопированные до момента ошибки, фиксируются. Пакет, содержащий повторяющийся ключ, подвергается откату, а операция массового копирования прерывается до обработки любых других пакетов.</span><span class="sxs-lookup"><span data-stu-id="545a6-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="545a6-118">Этот пример не будет работать, пока вы не создадите рабочие таблицы, как описано в разделе [Установка примера массового копирования](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="545a6-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="545a6-119">Этот код предоставляется для демонстрации синтаксиса использования **SqlBulkCopy** только.</span><span class="sxs-lookup"><span data-stu-id="545a6-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="545a6-120">Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, это проще и быстрее использовать [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` инструкцию, чтобы скопировать данные.</span><span class="sxs-lookup"><span data-stu-id="545a6-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="545a6-121">Выполнение специальной операции массового копирования в транзакции</span><span class="sxs-lookup"><span data-stu-id="545a6-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="545a6-122">По умолчанию операция массового копирования является своей собственной транзакцией.</span><span class="sxs-lookup"><span data-stu-id="545a6-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="545a6-123">Если нужно выполнить специальную операцию массового копирования, создайте новый экземпляр <xref:System.Data.SqlClient.SqlBulkCopy> со строкой соединения или используйте существующий объект <xref:System.Data.SqlClient.SqlConnection> без активной транзакции.</span><span class="sxs-lookup"><span data-stu-id="545a6-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="545a6-124">В каждом сценарии операция массового копирования создает, а затем фиксирует транзакцию или выполняет ее откат.</span><span class="sxs-lookup"><span data-stu-id="545a6-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="545a6-125">Можно явно задать параметр <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> в конструкторе класса <xref:System.Data.SqlClient.SqlBulkCopy>, чтобы явно задать для операции массового копирования выполнить свою собственную транзакцию, в результате чего каждый пакет операции массового копирования будет выполняться в отдельной транзакции.</span><span class="sxs-lookup"><span data-stu-id="545a6-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="545a6-126">Так как разные пакеты выполняются в разных транзакциях, если во время операции массового копирования возникнет ошибка, для всех строк в текущем пакете будет выполнен откат, но строки из предыдущих пакетов останутся в базе данных.</span><span class="sxs-lookup"><span data-stu-id="545a6-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="545a6-127">Следующее приложение командной строки сходно с предыдущим примером, с одним исключением: в этом примере операция массового копирования управляет своей собственной транзакцией.</span><span class="sxs-lookup"><span data-stu-id="545a6-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="545a6-128">Все пакеты, скопированные до момента ошибки, фиксируются. Пакет, содержащий повторяющийся ключ, подвергается откату, а операция массового копирования прерывается до обработки любых других пакетов.</span><span class="sxs-lookup"><span data-stu-id="545a6-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="545a6-129">Этот пример не будет работать, пока вы не создадите рабочие таблицы, как описано в разделе [Установка примера массового копирования](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="545a6-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="545a6-130">Этот код предоставляется для демонстрации синтаксиса использования **SqlBulkCopy** только.</span><span class="sxs-lookup"><span data-stu-id="545a6-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="545a6-131">Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, это проще и быстрее использовать [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` инструкцию, чтобы скопировать данные.</span><span class="sxs-lookup"><span data-stu-id="545a6-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="545a6-132">Использование существующих транзакций</span><span class="sxs-lookup"><span data-stu-id="545a6-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="545a6-133">Можно задать существующий объект <xref:System.Data.SqlClient.SqlTransaction> как параметр в конструкторе <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="545a6-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="545a6-134">В этой ситуации операция массового копирования выполняется в существующей транзакции, и в состоянии транзакции не делается никаких изменений (т. е. она не фиксируется и не прерывается).</span><span class="sxs-lookup"><span data-stu-id="545a6-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="545a6-135">Это позволяет приложению включить операцию массового копирования в транзакцию с другими операциями базы данных.</span><span class="sxs-lookup"><span data-stu-id="545a6-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="545a6-136">Но если объект <xref:System.Data.SqlClient.SqlTransaction> не задан, ссылка Null не передана и соединение имеет активную транзакцию, возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="545a6-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="545a6-137">Если нужно выполнить откат всей операции массового копирования из-за возникновения ошибки или если массовое копирование должно выполняться как часть большего процесса, для которого может быть выполнен откат, можно предоставить объект <xref:System.Data.SqlClient.SqlTransaction> для конструктора <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="545a6-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="545a6-138">Следующее приложение командной строки аналогично первому примеру (без транзакции), за одним исключением: здесь операция массового копирования включена в большую, внешнюю транзакцию.</span><span class="sxs-lookup"><span data-stu-id="545a6-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="545a6-139">Если возникает ошибка нарушения первичного ключа, производится откат всей транзакции и в целевую таблицу строки не добавляются.</span><span class="sxs-lookup"><span data-stu-id="545a6-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="545a6-140">Этот пример не будет работать, пока вы не создадите рабочие таблицы, как описано в разделе [Установка примера массового копирования](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="545a6-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="545a6-141">Этот код предоставляется для демонстрации синтаксиса использования **SqlBulkCopy** только.</span><span class="sxs-lookup"><span data-stu-id="545a6-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="545a6-142">Если исходная и целевая таблицы расположены в одном экземпляре SQL Server, это проще и быстрее использовать [!INCLUDE[tsql](../../../../../includes/tsql-md.md)] `INSERT … SELECT` инструкцию, чтобы скопировать данные.</span><span class="sxs-lookup"><span data-stu-id="545a6-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a [!INCLUDE[tsql](../../../../../includes/tsql-md.md)]`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="545a6-143">См. также</span><span class="sxs-lookup"><span data-stu-id="545a6-143">See also</span></span>
- [<span data-ttu-id="545a6-144">Операции массового копирования в SQL Server</span><span class="sxs-lookup"><span data-stu-id="545a6-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="545a6-145">Центр разработчиков наборов данных и управляемых поставщиков ADO.NET</span><span class="sxs-lookup"><span data-stu-id="545a6-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
