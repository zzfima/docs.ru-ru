---
title: Присоединенные и отсоединенные дочерние задачи
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- tasks, child tasks
ms.assetid: c95788bf-90a6-4e96-b7bc-58e36a228cc5
ms.openlocfilehash: 8f15ee4f136e3e2df1a4e1c7683467f2a4bc9bc0
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73123187"
---
# <a name="attached-and-detached-child-tasks"></a>Присоединенные и отсоединенные дочерние задачи
*Дочерняя задача* (или *вложенная задача*) — это экземпляр <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, создаваемый в пользовательском делегате другой задачи, которая называется *родительской задачей*. Дочерняя задача может быть отсоединенной или присоединенной. *Отсоединенная дочерняя задача* — это задача, которая выполняется независимо от своего родительского объекта. *Присоединенная дочерняя задача* — это вложенная задача, созданная с параметром <xref:System.Threading.Tasks.TaskCreationOptions.AttachedToParent?displayProperty=nameWithType>, родительский объект которой не запрещает ее присоединение явно или по умолчанию. Задача может создавать любое количество присоединенных и отсоединенных дочерних задач, ограничиваемое только системными ресурсами.  
  
 В следующей таблице перечислены основные различия между двумя видами дочерних задач.  
  
|Категория|Отсоединенные дочерние задачи|Присоединенные дочерние задачи|  
|--------------|--------------------------|--------------------------|  
|Родительский объект ожидает завершение дочерних задач.|Нет|Yes|  
|Родительский объект распространяет исключения, созданные дочерними задачами.|Нет|Yes|  
|Состояние родительского объекта зависит от состояния дочернего объекта.|Нет|Yes|  
  
 В большинстве случаев рекомендуется использовать отсоединенные дочерние задачи, поскольку их связи с другими задачами менее сложные. Именно поэтому задачи, создаваемые в родительских задачах, по умолчанию отсоединены, и чтобы создать присоединенную дочернюю задачу, необходимо явно указать параметр <xref:System.Threading.Tasks.TaskCreationOptions.AttachedToParent?displayProperty=nameWithType>.  
  
## <a name="detached-child-tasks"></a>Отсоединенные дочерние задачи  
 Несмотря на то что дочерняя задача создается родительской задачей, по умолчанию она не зависит от родительской задачи. В следующем примере родительская задача создает одну простую дочернюю задачу. Если вы несколько раз выполните этот пример кода, то заметите, что выходные данные примера отличаются от показанных здесь и что выходные данные могут изменяться после каждого выполнения кода. Это происходит потому, что родительская задача и дочерние задачи выполняются независимо друг от друга; дочерняя задача является отсоединенной. В этом примере ожидается только выполнение родительской задачи, а дочерняя задача может не выполниться или выполниться прежде, чем завершится консольное приложение.  
  
 [!code-csharp[TPL_ChildTasks#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_childtasks/cs/nested1.cs#1)]
 [!code-vb[TPL_ChildTasks#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_childtasks/vb/nested1.vb#1)]  
  
 Если дочерняя задача представлена объектом <xref:System.Threading.Tasks.Task%601>, а не объектом <xref:System.Threading.Tasks.Task>, вы можете обеспечить, чтобы родительская задача ожидала завершение дочерней задачи, обратившись к свойству <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> дочернего объекта, даже если это отсоединенная дочерняя задача. Свойство <xref:System.Threading.Tasks.Task%601.Result%2A> выполняет блокировку до завершения его задачи, как показано в следующем примере.  
  
 [!code-csharp[TPL_ChildTasks#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_childtasks/cs/childtasks.cs#4)]
 [!code-vb[TPL_ChildTasks#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_childtasks/vb/tpl_childtasks.vb#4)]  
  
## <a name="attached-child-tasks"></a>Присоединенные дочерние задачи  
 В отличие от отсоединенных дочерних задач, вложенные дочерние задачи полностью синхронизируются с родительским объектом. Вы можете изменить отсоединенную дочернюю задачу из предыдущего примера на присоединенную дочернюю задачу с помощью параметра <xref:System.Threading.Tasks.TaskCreationOptions.AttachedToParent?displayProperty=nameWithType> в инструкции создания задачи, как показано в следующем примере. В этом коде присоединенная дочерняя задача завершается перед родительской задачей. В результате выходные данные из этого примера остаются неизменными после каждого выполнения кода.  
  
 [!code-csharp[TPL_ChildTasks#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_childtasks/cs/child1.cs#2)]
 [!code-vb[TPL_ChildTasks#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_childtasks/vb/child1.vb#2)]  
  
 Присоединенные дочерние задачи можно использовать для создания полностью синхронизированных графиков асинхронных операций.  
  
 Однако дочернюю задачу можно присоединить к ее родительской задаче только в том случае, если эта родительская задача не запрещает присоединенные дочерние задачи. Родительские задачи могут явно запрещать присоединение к ним дочерних задач путем указания параметра <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType> в конструкторе класса родительской задачи или с помощью метода <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType> Родительские задачи неявно запрещают присоединение к ним дочерних задач, если они создаются путем вызова метода <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType>. Это показано в следующем примере. Он аналогичен предыдущему примеру, за исключением того, что родительская задача создается путем вызова метода <xref:System.Threading.Tasks.Task.Run%28System.Action%29?displayProperty=nameWithType> вместо метода <xref:System.Threading.Tasks.TaskFactory.StartNew%28System.Action%29?displayProperty=nameWithType>. Поскольку дочерняя задача не может быть присоединена к родительской задаче, выходные данные этого примера будут непредсказуемыми. Поскольку параметры создания задачи по умолчанию для перегрузок <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> включают параметр <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>, этот пример является функциональным эквивалентом первого примера в разделе «Отсоединенные дочерние задачи».  
  
 [!code-csharp[TPL_ChildTasks#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_childtasks/cs/child1a.cs#3)]
 [!code-vb[TPL_ChildTasks#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_childtasks/vb/child1a.vb#3)]  
  
## <a name="exceptions-in-child-tasks"></a>Исключения в дочерних задачах  
 Если отсоединенная дочерняя задача вызывает исключение, это исключение должно наблюдаться или обрабатываться непосредственно в родительской задаче, как и в случае любой не вложенной задачи. Если присоединенная дочерняя задача создает исключение, оно автоматически распространяется в родительскую задачу и обратно в поток, который ожидает или пытается получить доступ к свойству <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> задачи. Таким образом, используя присоединенные дочерние задачи, можно обрабатывать все исключения всего лишь в одной точке в вызове метода <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> в вызывающем потоке. Дополнительные сведения см. в разделе [Обработка исключений](../../../docs/standard/parallel-programming/exception-handling-task-parallel-library.md).  
  
## <a name="cancellation-and-child-tasks"></a>Отмена и дочерние задачи  
 Отмена задачи выполняется совместно. А именно, чтобы можно было отменить задачу, каждая присоединенная или отсоединенная дочерняя задача должна отслеживать состояние токена отмены. Если нужно отменить родительскую задачу и все ее дочерние задачи с помощью одного запроса отмены, передайте один и тот же токен в качестве аргумента во все задачи и предоставьте в каждую задачу логику для ответа на запрос в каждой задаче. Дополнительные сведения см. в разделах [Отмена задач](../../../docs/standard/parallel-programming/task-cancellation.md) и [Практическое руководство. Отмена задачи и ее дочерних элементов](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).  
  
### <a name="when-the-parent-cancels"></a>Когда родительская задача отменяется  
 Если родительская задача отменяет сама себя до запуска ее дочерней задачи, то дочерняя задача никогда не запускается. Если родительская задача отменяет сама себя после запуска ее дочерней задачи, то дочерняя задача выполняется до завершения, если в ней отсутствует собственная логика отмены. Дополнительные сведения см. в разделе [Отмена задач](../../../docs/standard/parallel-programming/task-cancellation.md).  
  
### <a name="when-a-detached-child-task-cancels"></a>Когда отменяется отсоединенная дочерняя задача  
 Если отсоединенная дочерняя задача отменяет сама себя, используя тот же токен, переданный в родительскую задачу, и родительская задача не ожидает дочернюю задачу, то исключение не распространяется, поскольку оно трактуется как неопасная совместная отмена. Это происходит так же, как и в случае любой задачи верхнего уровня.  
  
### <a name="when-an-attached-child-task-cancels"></a>Когда отменяется присоединенная дочерняя задача  
 Если присоединенная дочерняя задача отменяет саму себя, используя тот же токен, который был передан в ее родительскую задачу, <xref:System.Threading.Tasks.TaskCanceledException> распространяется в присоединенный поток в объекте <xref:System.AggregateException>. Вы должны ожидать родительскую задачу, чтобы можно было обработать все неопасные исключения в дополнение ко всем исключениям с ошибкой, которые распространяются вверх по графу присоединенных дочерних задач.  
  
 Дополнительные сведения см. в разделе [Обработка исключений](../../../docs/standard/parallel-programming/exception-handling-task-parallel-library.md).  
  
## <a name="preventing-a-child-task-from-attaching-to-its-parent"></a>Запрет присоединения дочерней задачи к ее родителю  
 Необработанное исключение, вызванное дочерней задачей, распространяется в родительскую задачу. Вы можете использовать это поведение, чтобы наблюдать за всеми исключениями дочерних задач в одной корневой задаче, вместо того чтобы перемещаться по дереву задач. Однако распространение исключений может привести к проблемам, если родительская задача не ожидает присоединение из другого кода. Например, рассмотрим приложение, которое вызывает сторонний компонент библиотеки из объекта <xref:System.Threading.Tasks.Task>. Если сторонний компонент библиотеки также создает объект <xref:System.Threading.Tasks.Task> и задает <xref:System.Threading.Tasks.TaskCreationOptions.AttachedToParent?displayProperty=nameWithType>, чтобы присоединить его к родительской задаче, то все необработанные исключения, возникающие в дочерней задаче, распространяются в родительскую задачу. Это может привести к непредвиденному поведению в основном приложении.  
  
 Чтобы запретить присоединение к родительской задаче дочерних задач, укажите параметр <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType> при создании родительской задачи <xref:System.Threading.Tasks.Task> или объекта <xref:System.Threading.Tasks.Task%601>. Если задача пытается присоединиться к родительской, а родительская задача задана с параметром <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>, то дочерней задаче не удастся присоединиться к родительской задаче, и она будет выполняться в точности так, как если бы параметр <xref:System.Threading.Tasks.TaskCreationOptions.AttachedToParent?displayProperty=nameWithType> не был указан.  
  
 Можно также запрещать присоединение дочерней задачи к ее родителю, когда дочерняя задача не завершается своевременно. Поскольку родительская задача не завершается, пока не будут завершены все ее дочерние задачи, дочерняя задача с длительным временем выполнения может привести к снижению производительности всего приложения. Пример, в котором показано, как повысить производительность приложения, предотвращая присоединение задачи к ее родительской задаче, см. в разделе [Практическое руководство. Запрет присоединения дочерней задачи к ее родительской задаче](../../../docs/standard/parallel-programming/how-to-prevent-a-child-task-from-attaching-to-its-parent.md).  
  
## <a name="see-also"></a>См. также

- [Параллельное программирование](../../../docs/standard/parallel-programming/index.md)
- [Параллелизм данных](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)
