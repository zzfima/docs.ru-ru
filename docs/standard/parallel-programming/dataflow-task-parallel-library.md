---
title: Поток данных (библиотека параллельных задач)
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Task Parallel Library, dataflows
- TPL dataflow library
ms.assetid: 643575d0-d26d-4c35-8de7-a9c403e97dd6
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 5581f825a23104ff005f3557de26420ee45b5c27
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
ms.locfileid: "33592487"
---
# <a name="dataflow-task-parallel-library"></a><span data-ttu-id="511a8-102">Поток данных (библиотека параллельных задач)</span><span class="sxs-lookup"><span data-stu-id="511a8-102">Dataflow (Task Parallel Library)</span></span>
<a name="top"></a> <span data-ttu-id="511a8-103">Библиотека параллельных задач (TPL) предоставляет компоненты потока данных, что позволяет повысить надежность приложений с включенным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="511a8-103">The Task Parallel Library (TPL) provides dataflow components to help increase the robustness of concurrency-enabled applications.</span></span> <span data-ttu-id="511a8-104">Эти компоненты потока данных вместе называются *Библиотекой потоков данных TPL*.</span><span class="sxs-lookup"><span data-stu-id="511a8-104">These dataflow components are collectively referred to as the *TPL Dataflow Library*.</span></span> <span data-ttu-id="511a8-105">Эта модель потоков данных поддерживает программирование на основе субъектов путем обеспечения внутрипроцессной передачи сообщений для недетализированного потока данных и задач по конвейеризации.</span><span class="sxs-lookup"><span data-stu-id="511a8-105">This dataflow model promotes actor-based programming by providing in-process message passing for coarse-grained dataflow and pipelining tasks.</span></span> <span data-ttu-id="511a8-106">Компоненты потоков данных строятся на типах и инфраструктуре планирования TPL и интегрированы с языковой поддержкой асинхронного программирования на C#, Visual Basic и F#.</span><span class="sxs-lookup"><span data-stu-id="511a8-106">The dataflow components build on the types and scheduling infrastructure of the TPL and integrate with the C#, Visual Basic, and F# language support for asynchronous programming.</span></span> <span data-ttu-id="511a8-107">Эти компоненты потоков данных полезны при наличии нескольких операций, которые должны асинхронно взаимодействовать друг с другом, или при необходимости обрабатывать данные по мере того, как они становятся доступными.</span><span class="sxs-lookup"><span data-stu-id="511a8-107">These dataflow components are useful when you have multiple operations that must communicate with one another asynchronously or when you want to process data as it becomes available.</span></span> <span data-ttu-id="511a8-108">Например, рассмотрим приложение, которое обрабатывает данные, поступающие с веб-камеры.</span><span class="sxs-lookup"><span data-stu-id="511a8-108">For example, consider an application that processes image data from a web camera.</span></span> <span data-ttu-id="511a8-109">С помощью модели потока данных приложение может обрабатывать кадры, как только они становятся доступными.</span><span class="sxs-lookup"><span data-stu-id="511a8-109">By using the dataflow model, the application can process image frames as they become available.</span></span> <span data-ttu-id="511a8-110">Если приложение повышает качество изображений на кадрах, например, выполняя коррекцию освещенности или удаление "красных глаз", можно создать *конвейер* компонентов потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-110">If the application enhances image frames, for example, by performing light correction or red-eye reduction, you can create a *pipeline* of dataflow components.</span></span> <span data-ttu-id="511a8-111">Каждый этап конвейера может использовать функциональность с более грубым параллелизмом, например функцию, предоставляемую библиотекой TPL, для преобразования изображения.</span><span class="sxs-lookup"><span data-stu-id="511a8-111">Each stage of the pipeline might use more coarse-grained parallelism functionality, such as the functionality that is provided by the TPL, to transform the image.</span></span>  
  
 <span data-ttu-id="511a8-112">В этом документе содержатся общие сведения о библиотеке потоков данных TPL.</span><span class="sxs-lookup"><span data-stu-id="511a8-112">This document provides an overview of the TPL Dataflow Library.</span></span> <span data-ttu-id="511a8-113">Здесь описывается модель программирования, предопределенные типы блоков потоков данных и способы настройки блоков потоков данных для соответствия требованиям вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="511a8-113">It describes the programming model, the predefined dataflow block types, and how to configure dataflow blocks to meet the specific requirements of your applications.</span></span>  

[!INCLUDE [tpl-install-instructions](../../../includes/tpl-install-instructions.md)]
  
 <span data-ttu-id="511a8-114">Этот документ содержит следующие разделы.</span><span class="sxs-lookup"><span data-stu-id="511a8-114">This document contains the following sections:</span></span>  
  
-   [<span data-ttu-id="511a8-115">Модель программирования</span><span class="sxs-lookup"><span data-stu-id="511a8-115">Programming Model</span></span>](#model)  
  
-   [<span data-ttu-id="511a8-116">Предопределенные типы блоков потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-116">Predefined Dataflow Block Types</span></span>](#predefined_types)  
  
-   [<span data-ttu-id="511a8-117">Настройка поведения блоков потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-117">Configuring Dataflow Block Behavior</span></span>](#behavior)  
  
-   [<span data-ttu-id="511a8-118">Пользовательские блоки потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-118">Custom Dataflow Blocks</span></span>](#custom)  
  
<a name="model"></a>   
## <a name="programming-model"></a><span data-ttu-id="511a8-119">Модель программирования</span><span class="sxs-lookup"><span data-stu-id="511a8-119">Programming Model</span></span>  
 <span data-ttu-id="511a8-120">Библиотека потоков данных TPL обеспечивает основу для передачи сообщений и параллелизации приложений, создающих большую нагрузку на ЦПУ и ввод-вывод, которые имеют высокую пропускную способность и низкую задержку.</span><span class="sxs-lookup"><span data-stu-id="511a8-120">The TPL Dataflow Library provides a foundation for message passing and parallelizing CPU-intensive and I/O-intensive applications that have high throughput and low latency.</span></span> <span data-ttu-id="511a8-121">Она также предоставляет явный контроль над тем, как данные буферизуются и перемещаются по системе.</span><span class="sxs-lookup"><span data-stu-id="511a8-121">It also gives you explicit control over how data is buffered and moves around the system.</span></span> <span data-ttu-id="511a8-122">Чтобы лучше понять модель программирования потоков данных, рассмотрим приложение, асинхронно загружающее изображения с диска и создающее из них композитное изображение.</span><span class="sxs-lookup"><span data-stu-id="511a8-122">To better understand the dataflow programming model, consider an application that asynchronously loads images from disk and creates a composite of those images.</span></span> <span data-ttu-id="511a8-123">Традиционные модели программирования обычно требуют использования обратных вызовов и объектов синхронизации, например блокировок, для координации задач и доступа к общим данным.</span><span class="sxs-lookup"><span data-stu-id="511a8-123">Traditional programming models typically require that you use callbacks and synchronization objects, such as locks, to coordinate tasks and access to shared data.</span></span> <span data-ttu-id="511a8-124">С помощью модели программирования потоков данных можно создавать объекты потоков данных, которые обрабатывают изображения по мере считывания их с диска.</span><span class="sxs-lookup"><span data-stu-id="511a8-124">By using the dataflow programming model, you can create dataflow objects that process images as they are read from disk.</span></span> <span data-ttu-id="511a8-125">В модели потоков данных объявляется, как обрабатываются данные, когда они становятся доступными, а также объявляются любые зависимости между данными.</span><span class="sxs-lookup"><span data-stu-id="511a8-125">Under the dataflow model, you declare how data is handled when it becomes available, and also any dependencies between data.</span></span> <span data-ttu-id="511a8-126">Поскольку среда выполнения управляет зависимостями между данными, часто можно избежать необходимости синхронизировать доступ к общим данным.</span><span class="sxs-lookup"><span data-stu-id="511a8-126">Because the runtime manages dependencies between data, you can often avoid the requirement to synchronize access to shared data.</span></span> <span data-ttu-id="511a8-127">Кроме того, поскольку планирование в среде выполнения основано на асинхронном прибытии данных, поток данных может увеличить пропускную способность и ускорить время ответа, эффективно управляя лежащими в основе потоками.</span><span class="sxs-lookup"><span data-stu-id="511a8-127">In addition, because the runtime schedules work based on the asynchronous arrival of data, dataflow can improve responsiveness and throughput by efficiently managing the underlying threads.</span></span> <span data-ttu-id="511a8-128">Пример, в котором используется модель программирования потоков данных для реализации обработки изображений в приложении Windows Forms, см. в разделе [Пошаговое руководство. Использование потока данных в приложении Windows Forms](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-128">For an example that uses the dataflow programming model to implement image processing in a Windows Forms application, see [Walkthrough: Using Dataflow in a Windows Forms Application](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span></span>  
  
### <a name="sources-and-targets"></a><span data-ttu-id="511a8-129">Источники и целевые блоки</span><span class="sxs-lookup"><span data-stu-id="511a8-129">Sources and Targets</span></span>  
 <span data-ttu-id="511a8-130">Библиотека потоков данных TPL состоит из *блоков потоков данных*, которые представляют собой структуры данных, буферизующие и обрабатывающие данные.</span><span class="sxs-lookup"><span data-stu-id="511a8-130">The TPL Dataflow Library consists of *dataflow blocks*, which are data structures that buffer and process data.</span></span> <span data-ttu-id="511a8-131">В TPL определено три типа блоков потоков данных: *блоки источника*, *целевые блоки* и *блоки передачи*.</span><span class="sxs-lookup"><span data-stu-id="511a8-131">The TPL defines three kinds of dataflow blocks: *source blocks*, *target blocks*, and *propagator blocks*.</span></span> <span data-ttu-id="511a8-132">Блок источника выступает в качестве источника данных, из которого можно считать данные.</span><span class="sxs-lookup"><span data-stu-id="511a8-132">A source block acts as a source of data and can be read from.</span></span> <span data-ttu-id="511a8-133">Целевой блок выступает в качестве получателя данных, в который можно писать.</span><span class="sxs-lookup"><span data-stu-id="511a8-133">A target block acts as a receiver of data and can be written to.</span></span> <span data-ttu-id="511a8-134">Блок передачи действует и как блок источника, и как целевой блок: из него можно читать и в него можно писать.</span><span class="sxs-lookup"><span data-stu-id="511a8-134">A propagator block acts as both a source block and a target block, and can be read from and written to.</span></span> <span data-ttu-id="511a8-135">TPL определяет интерфейс <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601?displayProperty=nameWithType> для представления источников, <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601?displayProperty=nameWithType> для представления целевых объектов и <xref:System.Threading.Tasks.Dataflow.IPropagatorBlock%602?displayProperty=nameWithType> для представления передающих.</span><span class="sxs-lookup"><span data-stu-id="511a8-135">The TPL defines the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601?displayProperty=nameWithType> interface to represent sources, <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601?displayProperty=nameWithType> to represent targets, and <xref:System.Threading.Tasks.Dataflow.IPropagatorBlock%602?displayProperty=nameWithType> to represent propagators.</span></span> <span data-ttu-id="511a8-136"><xref:System.Threading.Tasks.Dataflow.IPropagatorBlock%602> наследуется и от <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601>, и от <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-136"><xref:System.Threading.Tasks.Dataflow.IPropagatorBlock%602> inherits from both <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601>, and <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span></span>  
  
 <span data-ttu-id="511a8-137">Библиотека потоков данных TPL предоставляет несколько предопределенных типов блоков потоков данных, которые реализуют интерфейсы <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601>, <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> и <xref:System.Threading.Tasks.Dataflow.IPropagatorBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-137">The TPL Dataflow Library provides several predefined dataflow block types that implement the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601>, <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>, and <xref:System.Threading.Tasks.Dataflow.IPropagatorBlock%602> interfaces.</span></span> <span data-ttu-id="511a8-138">Эти типы блоков потоков данных описаны в настоящем документе в разделе [Предопределенные типы блоков потоков данных](#predefined_types).</span><span class="sxs-lookup"><span data-stu-id="511a8-138">These dataflow block types are described in this document in the section [Predefined Dataflow Block Types](#predefined_types).</span></span>  
  
### <a name="connecting-blocks"></a><span data-ttu-id="511a8-139">Соединение блоков</span><span class="sxs-lookup"><span data-stu-id="511a8-139">Connecting Blocks</span></span>  
 <span data-ttu-id="511a8-140">Можно также соединять блоки потоков данных для создания *конвейеров*, которые являются линейными последовательностями блоков потоков данных, или *сетей*, являющихся графами блоков потоков данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-140">You can connect dataflow blocks to form *pipelines*, which are linear sequences of dataflow blocks, or *networks*, which are graphs of dataflow blocks.</span></span> <span data-ttu-id="511a8-141">Конвейер является одним из видов сетей.</span><span class="sxs-lookup"><span data-stu-id="511a8-141">A pipeline is one form of network.</span></span> <span data-ttu-id="511a8-142">Конвейеры или сети асинхронно распространяют исходные данные целевым объектам, когда данные становятся доступны.</span><span class="sxs-lookup"><span data-stu-id="511a8-142">In a pipeline or network, sources asynchronously propagate data to targets as that data becomes available.</span></span> <span data-ttu-id="511a8-143">Метод <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A?displayProperty=nameWithType> связывает блок потока данных источника и целевой блок.</span><span class="sxs-lookup"><span data-stu-id="511a8-143">The <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A?displayProperty=nameWithType> method links a source dataflow block to a target block.</span></span> <span data-ttu-id="511a8-144">Источник может быть связан с несколькими целевыми объектами или не связан ни с одним; целевые объекты могут иметь связь с несколькими источниками или не иметь связей.</span><span class="sxs-lookup"><span data-stu-id="511a8-144">A source can be linked to zero or more targets; targets can be linked from zero or more sources.</span></span> <span data-ttu-id="511a8-145">Можно добавлять или удалять блоки потока данных из конвейера или сети одновременно.</span><span class="sxs-lookup"><span data-stu-id="511a8-145">You can add or remove dataflow blocks to or from a pipeline or network concurrently.</span></span> <span data-ttu-id="511a8-146">Предопределенные типы блоков потоков данных отвечают за все аспекты потокобезопасности установки и удаления связей.</span><span class="sxs-lookup"><span data-stu-id="511a8-146">The predefined dataflow block types handle all thread-safety aspects of linking and unlinking.</span></span>  
  
 <span data-ttu-id="511a8-147">Пример, в котором блоки потоков данных соединяются в базовый конвейер, см. в разделе [Пошаговое руководство. Создание конвейера потока данных](../../../docs/standard/parallel-programming/walkthrough-creating-a-dataflow-pipeline.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-147">For an example that connects dataflow blocks to form a basic pipeline, see [Walkthrough: Creating a Dataflow Pipeline](../../../docs/standard/parallel-programming/walkthrough-creating-a-dataflow-pipeline.md).</span></span> <span data-ttu-id="511a8-148">Пример, в котором блоки потоков данных формируют более сложную сеть, см. в разделе [Пошаговое руководство. Использование потока данных в приложении Windows Forms](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-148">For an example that connects dataflow blocks to form a more complex network, see [Walkthrough: Using Dataflow in a Windows Forms Application](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span></span> <span data-ttu-id="511a8-149">Пример, в котором происходит удаление связи между источником и целевым объектом после того, как источник отправляет целевому объекту сообщение, см. в разделе [Практическое руководство. Удаление связей с блоками потоков данных](../../../docs/standard/parallel-programming/how-to-unlink-dataflow-blocks.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-149">For an example that unlinks a target from a source after the source offers the target a message, see [How to: Unlink Dataflow Blocks](../../../docs/standard/parallel-programming/how-to-unlink-dataflow-blocks.md).</span></span>  
  
#### <a name="filtering"></a><span data-ttu-id="511a8-150">Фильтрация</span><span class="sxs-lookup"><span data-stu-id="511a8-150">Filtering</span></span>  
 <span data-ttu-id="511a8-151">При вызове метода <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A?displayProperty=nameWithType> для связывания источника с целевым объектом, можно указать делегат, который определяет, принимает или отклоняет целевой блок сообщение в зависимости от содержания этого сообщения.</span><span class="sxs-lookup"><span data-stu-id="511a8-151">When you call the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A?displayProperty=nameWithType> method to link a source to a target, you can supply a delegate that determines whether the target block accepts or rejects a message based on the value of that message.</span></span> <span data-ttu-id="511a8-152">Механизм фильтрации позволяет гарантировать, что блок потока данных будет получать только определенные значения.</span><span class="sxs-lookup"><span data-stu-id="511a8-152">This filtering mechanism is a useful way to guarantee that a dataflow block receives only certain values.</span></span> <span data-ttu-id="511a8-153">Для большинства стандартных типов блока потока данных, если блок источника подключен к нескольким целевым блокам, когда один из целевых блоков отвергает сообщение, это сообщение отправляется следующему целевому объекту.</span><span class="sxs-lookup"><span data-stu-id="511a8-153">For most of the predefined dataflow block types, if a source block is connected to multiple target blocks, when a target block rejects a message, the source offers that message to the next target.</span></span> <span data-ttu-id="511a8-154">Порядок, в котором источник отправляет сообщения целевым объектам, определяется источником и может различаться в зависимости от типа источника.</span><span class="sxs-lookup"><span data-stu-id="511a8-154">The order in which a source offers messages to targets is defined by the source and can vary according to the type of the source.</span></span> <span data-ttu-id="511a8-155">Большинство типов блоков источников перестают отправлять сообщение после того, как один из целевых объектов его принимает.</span><span class="sxs-lookup"><span data-stu-id="511a8-155">Most source block types stop offering a message after one target accepts that message.</span></span> <span data-ttu-id="511a8-156">Единственным исключением из этого правила является класс <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601>, который предлагает каждое сообщение всем целевым объектам, даже если некоторые из целевых объектов отклоняют это сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-156">One exception to this rule is the <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> class, which offers each message to all targets, even if some targets reject the message.</span></span> <span data-ttu-id="511a8-157">Пример, в котором с помощью фильтрации обрабатываются только определенные сообщения, см. в разделе [Пошаговое руководство. Использование потока данных в приложении Windows Forms](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-157">For an example that uses filtering to process only certain messages, see [Walkthrough: Using Dataflow in a Windows Forms Application](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="511a8-158">Поскольку все стандартные типы блоков потоков данных источника гарантируют, что сообщения передаются в том порядке, в каком они поступают, каждое сообщение должно быть считано из блока источника, чтобы блок источника мог обработать следующее сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-158">Because each predefined source dataflow block type guarantees that messages are propagated out in the order in which they are received, every message must be read from the source block before the source block can process the next message.</span></span> <span data-ttu-id="511a8-159">Поэтому при использовании фильтрации для подключения нескольких целевых объектов к источнику, убедитесь, что хотя бы один целевой блок получит все сообщения.</span><span class="sxs-lookup"><span data-stu-id="511a8-159">Therefore, when you use filtering to connect multiple targets to a source, make sure that at least one target block receives each message.</span></span> <span data-ttu-id="511a8-160">В противном случае в приложении может возникнуть взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="511a8-160">Otherwise, your application might deadlock.</span></span>  
  
### <a name="message-passing"></a><span data-ttu-id="511a8-161">Передача сообщений</span><span class="sxs-lookup"><span data-stu-id="511a8-161">Message Passing</span></span>  
 <span data-ttu-id="511a8-162">Модель программирования на основе потоков данных связана с понятием *передача сообщений*, так как в этой модели независимые компоненты программы взаимодействуют друг с другом посредством отправки сообщений.</span><span class="sxs-lookup"><span data-stu-id="511a8-162">The dataflow programming model is related to the concept of *message passing*, where independent components of a program communicate with one another by sending messages.</span></span> <span data-ttu-id="511a8-163">Один из способов передавать сообщения между компонентами приложения — вызвать методы <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A> и <xref:System.Threading.Tasks.Dataflow.DataflowBlock.SendAsync%2A?displayProperty=nameWithType> для отправки сообщений целевым блокам потоков данных (<xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A> работает синхронно, а <xref:System.Threading.Tasks.Dataflow.DataflowBlock.SendAsync%2A> — асинхронно) и методы <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Receive%2A>, <xref:System.Threading.Tasks.Dataflow.DataflowBlock.ReceiveAsync%2A> и <xref:System.Threading.Tasks.Dataflow.DataflowBlock.TryReceive%2A> для получения сообщений от блоков источника.</span><span class="sxs-lookup"><span data-stu-id="511a8-163">One way to propagate messages among application components is to call the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A> and <xref:System.Threading.Tasks.Dataflow.DataflowBlock.SendAsync%2A?displayProperty=nameWithType> methods to send messages to target dataflow blocks post (<xref:System.Threading.Tasks.Dataflow.DataflowBlock.Post%2A> acts synchronously; <xref:System.Threading.Tasks.Dataflow.DataflowBlock.SendAsync%2A> acts asynchronously) and the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Receive%2A>, <xref:System.Threading.Tasks.Dataflow.DataflowBlock.ReceiveAsync%2A>, and <xref:System.Threading.Tasks.Dataflow.DataflowBlock.TryReceive%2A> methods to receive messages from source blocks.</span></span> <span data-ttu-id="511a8-164">Можно объединять эти методы с конвейерами потоков данных или сетями, отправляя входные данные в ведущий узел (целевой блок) и принимая выходные данные из терминального узла конвейера или терминальных узлов сети (один или несколько блоков источника).</span><span class="sxs-lookup"><span data-stu-id="511a8-164">You can combine these methods with dataflow pipelines or networks by sending input data to the head node (a target block), and receiving output data from the terminal node of the pipeline or the terminal nodes of the network (one or more source blocks).</span></span> <span data-ttu-id="511a8-165">Можно также использовать метод <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Choose%2A> для чтения данных из первого из имеющихся источников, где доступны данные, и выполнения действий с этими данными.</span><span class="sxs-lookup"><span data-stu-id="511a8-165">You can also use the <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Choose%2A> method to read from the first of the provided sources that has data available and perform action on that data.</span></span>  
  
 <span data-ttu-id="511a8-166">Блоки источника предлагают данные целевым блокам, вызывая метод <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="511a8-166">Source blocks offer data to target blocks by calling the <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="511a8-167">Целевой блок отвечает на предложенное сообщение одним из трех способов: он может принять сообщение, отклонить сообщение или отложить сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-167">The target block responds to an offered message in one of three ways: it can accept the message, decline the message, or postpone the message.</span></span> <span data-ttu-id="511a8-168">Если целевой объект принимает сообщение, метод <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> возвращает <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.Accepted>.</span><span class="sxs-lookup"><span data-stu-id="511a8-168">When the target accepts the message, the <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> method returns <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.Accepted>.</span></span> <span data-ttu-id="511a8-169">Если целевой объект отклоняет сообщение, метод <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> возвращает <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.Declined>.</span><span class="sxs-lookup"><span data-stu-id="511a8-169">When the target declines the message, the <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> method returns <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.Declined>.</span></span> <span data-ttu-id="511a8-170">Если целевой объект сообщает, что больше не будет получать сообщений от этого источника, <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> возвращает <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.DecliningPermanently>.</span><span class="sxs-lookup"><span data-stu-id="511a8-170">When the target requires that it no longer receives any messages from the source, <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> returns <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.DecliningPermanently>.</span></span> <span data-ttu-id="511a8-171">Стандартные типы блоков источника не предлагают связанным целевым объектам сообщения после получения такого значения, и они автоматически удаляют связи с этим целевым объектом.</span><span class="sxs-lookup"><span data-stu-id="511a8-171">The predefined source block types do not offer messages to linked targets after such a return value is received, and they automatically unlink from such targets.</span></span>  
  
 <span data-ttu-id="511a8-172">Когда целевой блок откладывает сообщение для последующего использования, метод <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> возвращает <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.Postponed>.</span><span class="sxs-lookup"><span data-stu-id="511a8-172">When a target block postpones the message for later use, the <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601.OfferMessage%2A> method returns <xref:System.Threading.Tasks.Dataflow.DataflowMessageStatus.Postponed>.</span></span> <span data-ttu-id="511a8-173">Целевой блок, откладывающий сообщение, может позднее вызвать метод <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ReserveMessage%2A?displayProperty=nameWithType>, чтобы попытаться зарезервировать предложенное сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-173">A target block that postpones a message can later call the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ReserveMessage%2A?displayProperty=nameWithType> method to try to reserve the offered message.</span></span> <span data-ttu-id="511a8-174">На этом этапе сообщение либо по-прежнему доступно и может быть использовано целевым блоком, либо было принято другим целевым объектом.</span><span class="sxs-lookup"><span data-stu-id="511a8-174">At this point, the message is either still available and can be used by the target block, or the message has been taken by another target.</span></span> <span data-ttu-id="511a8-175">Если целевой блок пытается получить сообщение позже, он вызывает метод <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ConsumeMessage%2A?displayProperty=nameWithType>, а когда сообщение больше не нужно — метод <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ReleaseReservation%2A>.</span><span class="sxs-lookup"><span data-stu-id="511a8-175">When the target block later requires the message or no longer needs the message, it calls the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ConsumeMessage%2A?displayProperty=nameWithType> or <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ReleaseReservation%2A> method, respectively.</span></span> <span data-ttu-id="511a8-176">Резервирование сообщений обычно используется типами блоков потоков данных, которые работают в нежадном режиме.</span><span class="sxs-lookup"><span data-stu-id="511a8-176">Message reservation is typically used by the dataflow block types that operate in non-greedy mode.</span></span> <span data-ttu-id="511a8-177">Нежадный режим описан далее в этом документе.</span><span class="sxs-lookup"><span data-stu-id="511a8-177">Non-greedy mode is explained later in this document.</span></span> <span data-ttu-id="511a8-178">Вместо резервирования отложенного сообщения целевой блок может также использовать метод <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ConsumeMessage%2A?displayProperty=nameWithType>, чтобы попытаться напрямую использовать отложенное сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-178">Instead of reserving a postponed message, a target block can also use the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.ConsumeMessage%2A?displayProperty=nameWithType> method to attempt to directly consume the postponed message.</span></span>  
  
### <a name="dataflow-block-completion"></a><span data-ttu-id="511a8-179">Завершение блока потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-179">Dataflow Block Completion</span></span>  
 <span data-ttu-id="511a8-180">Блоки потоков данных также поддерживают понятие *завершения*.</span><span class="sxs-lookup"><span data-stu-id="511a8-180">Dataflow blocks also support the concept of *completion*.</span></span> <span data-ttu-id="511a8-181">Блок потока данных, находящийся в состоянии завершения, не будет далее выполнять никакой работы.</span><span class="sxs-lookup"><span data-stu-id="511a8-181">A dataflow block that is in the completed state does not perform any further work.</span></span> <span data-ttu-id="511a8-182">С каждым блоком потока данных связан объект <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, который называется *задачей завершения* и представляет состояние завершенности блока.</span><span class="sxs-lookup"><span data-stu-id="511a8-182">Each dataflow block has an associated <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> object, known as a *completion task*, that represents the completion status of the block.</span></span> <span data-ttu-id="511a8-183">Поскольку можно дождаться завершения для объекта <xref:System.Threading.Tasks.Task>, с помощью задачи завершения, можно дождаться завершения одного или нескольких терминальных узлов сети потоков данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-183">Because you can wait for a <xref:System.Threading.Tasks.Task> object to finish, by using completion tasks, you can wait for one or more terminal nodes of a dataflow network to finish.</span></span> <span data-ttu-id="511a8-184">Интерфейс <xref:System.Threading.Tasks.Dataflow.IDataflowBlock> определяет метод <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A>, который уведомляет блок потока данных о запросе завершения, и свойство <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Completion%2A>, возвращающее задачу завершения для блока потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-184">The <xref:System.Threading.Tasks.Dataflow.IDataflowBlock> interface defines the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A> method, which informs the dataflow block of a request for it to complete, and the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Completion%2A> property, which returns the completion task for the dataflow block.</span></span> <span data-ttu-id="511a8-185">Интерфейсы <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> и <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> наследуются от <xref:System.Threading.Tasks.Dataflow.IDataflowBlock>.</span><span class="sxs-lookup"><span data-stu-id="511a8-185">Both <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> and <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> inherit the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock> interface.</span></span>  
  
 <span data-ttu-id="511a8-186">Существует два способа определить, завершился ли блок потока данных без ошибки, с одной или несколькими ошибками или был отменен.</span><span class="sxs-lookup"><span data-stu-id="511a8-186">There are two ways to determine whether a dataflow block completed without error, encountered one or more errors, or was canceled.</span></span> <span data-ttu-id="511a8-187">Первый способ — вызвать метод <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> для задачи завершения в блоке `try`-`catch` (`Try`-`Catch` в Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="511a8-187">The first way is to call the <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> method on the completion task in a `try`-`catch` block (`Try`-`Catch` in Visual Basic).</span></span> <span data-ttu-id="511a8-188">В следующем примере создается объект <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, создающий исключение <xref:System.ArgumentOutOfRangeException>, если его входное значение меньше нуля.</span><span class="sxs-lookup"><span data-stu-id="511a8-188">The following example creates an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object that throws <xref:System.ArgumentOutOfRangeException> if its input value is less than zero.</span></span> <span data-ttu-id="511a8-189"><xref:System.AggregateException> возникает, когда в данном примере вызывается <xref:System.Threading.Tasks.Task.Wait%2A> для задачи завершения.</span><span class="sxs-lookup"><span data-stu-id="511a8-189"><xref:System.AggregateException> is thrown when this example calls <xref:System.Threading.Tasks.Task.Wait%2A> on the completion task.</span></span> <span data-ttu-id="511a8-190">Доступ к объекту <xref:System.ArgumentOutOfRangeException> обеспечивается с помощью свойства <xref:System.AggregateException.InnerExceptions%2A> объекта <xref:System.AggregateException>.</span><span class="sxs-lookup"><span data-stu-id="511a8-190">The <xref:System.ArgumentOutOfRangeException> is accessed through the <xref:System.AggregateException.InnerExceptions%2A> property of the <xref:System.AggregateException> object.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#10](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#10)]
 [!code-vb[TPLDataflow_Overview#10](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#10)]  
  
 <span data-ttu-id="511a8-191">В этом примере показан случай, в котором необработанное исключение передается в делегат блока выполнения потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-191">This example demonstrates the case in which an exception goes unhandled in the delegate of an execution dataflow block.</span></span> <span data-ttu-id="511a8-192">Рекомендуется обрабатывать исключения в телах таких блоков.</span><span class="sxs-lookup"><span data-stu-id="511a8-192">We recommend that you handle exceptions in the bodies of such blocks.</span></span> <span data-ttu-id="511a8-193">Однако, если возможности сделать это нет, блок ведет себя, как если бы он был отменен, и не обрабатывает входящие сообщения.</span><span class="sxs-lookup"><span data-stu-id="511a8-193">However, if you are unable to do so, the block behaves as though it was canceled and does not process incoming messages.</span></span>  
  
 <span data-ttu-id="511a8-194">Если блок потока данных отменяется явно, объект <xref:System.AggregateException> содержит <xref:System.OperationCanceledException> в свойстве <xref:System.AggregateException.InnerExceptions%2A>.</span><span class="sxs-lookup"><span data-stu-id="511a8-194">When a dataflow block is canceled explicitly, the <xref:System.AggregateException> object contains <xref:System.OperationCanceledException> in the <xref:System.AggregateException.InnerExceptions%2A> property.</span></span> <span data-ttu-id="511a8-195">Дополнительные сведения об отмене потока данных см. далее в этом документе в разделе "Активирование отмены".</span><span class="sxs-lookup"><span data-stu-id="511a8-195">For more information about dataflow cancellation, see Enabling Cancellation later in this document.</span></span>  
  
 <span data-ttu-id="511a8-196">Второй способ определить состояние завершения блока потока данных — использовать продолжение задачи завершения или использовать асинхронные функции языка C# и Visual Basic, чтобы асинхронно ожидать завершения задачи.</span><span class="sxs-lookup"><span data-stu-id="511a8-196">The second way to determine the completion status of a dataflow block is to use a continuation off of the completion task, or to use the asynchronous language features of C# and Visual Basic to asynchronously wait for the completion task.</span></span> <span data-ttu-id="511a8-197">Делегат, который предоставляется методу <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType>, принимает объект <xref:System.Threading.Tasks.Task>, представляющий предшествующую задачу.</span><span class="sxs-lookup"><span data-stu-id="511a8-197">The delegate that you provide to the <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method takes a <xref:System.Threading.Tasks.Task> object that represents the antecedent task.</span></span> <span data-ttu-id="511a8-198">В случае со свойством <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Completion%2A> делегат для продолжения принимает саму задачу завершения.</span><span class="sxs-lookup"><span data-stu-id="511a8-198">In the case of the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Completion%2A> property, the delegate for the continuation takes the completion task itself.</span></span> <span data-ttu-id="511a8-199">Следующий пример похож на предыдущий, но в нем используется метод <xref:System.Threading.Tasks.Task.ContinueWith%2A> для создания задачи завершения, выводящей общее состояние операции потока данных на печать.</span><span class="sxs-lookup"><span data-stu-id="511a8-199">The following example resembles the previous one, except that it also uses the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method to create a completion task that prints the status of the overall dataflow operation.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#11](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#11)]
 [!code-vb[TPLDataflow_Overview#11](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#11)]  
  
 <span data-ttu-id="511a8-200">Можно также использовать такие свойства, как <xref:System.Threading.Tasks.Task.IsCanceled%2A>, в теле задачи продолжения, чтобы определить дополнительные сведения о состоянии выполнения блока потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-200">You can also use properties such as <xref:System.Threading.Tasks.Task.IsCanceled%2A> in the body of the continuation task to determine additional information about the completion status of a dataflow block.</span></span> <span data-ttu-id="511a8-201">Подробнее о задачах продолжения и их связи с отменой и обработкой ошибок читайте в разделах [Создание цепочки задач с помощью задач продолжения](../../../docs/standard/parallel-programming/chaining-tasks-by-using-continuation-tasks.md), [Отмена задач](../../../docs/standard/parallel-programming/task-cancellation.md), [Обработка исключений](../../../docs/standard/parallel-programming/exception-handling-task-parallel-library.md) и [Практическое руководство. Обработка исключений, создаваемых задачами](https://msdn.microsoft.com/library/d6c47ec8-9de9-4880-beb3-ff19ae51565d).</span><span class="sxs-lookup"><span data-stu-id="511a8-201">For more information about continuation tasks and how they relate to cancellation and error handling, see [Chaining Tasks by Using Continuation Tasks](../../../docs/standard/parallel-programming/chaining-tasks-by-using-continuation-tasks.md), [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md), [Exception Handling](../../../docs/standard/parallel-programming/exception-handling-task-parallel-library.md), and [NIB: How to: Handle Exceptions Thrown by Tasks](https://msdn.microsoft.com/library/d6c47ec8-9de9-4880-beb3-ff19ae51565d).</span></span>  
  
 <span data-ttu-id="511a8-202">[[в начало](#top)]</span><span class="sxs-lookup"><span data-stu-id="511a8-202">[[go to top](#top)]</span></span>  
  
<a name="predefined_types"></a>   
## <a name="predefined-dataflow-block-types"></a><span data-ttu-id="511a8-203">Предопределенные типы блоков потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-203">Predefined Dataflow Block Types</span></span>  
 <span data-ttu-id="511a8-204">Библиотека потоков данных TPL предоставляет несколько предопределенных типов блоков потоков данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-204">The TPL Dataflow Library provides several predefined dataflow block types.</span></span> <span data-ttu-id="511a8-205">Эти типы делятся на три категории: *блоки буферизации*, *блоки выполнения* и *блоки группировки*.</span><span class="sxs-lookup"><span data-stu-id="511a8-205">These types are divided into three categories: *buffering blocks*, *execution blocks*, and *grouping blocks*.</span></span> <span data-ttu-id="511a8-206">В следующих подразделах описаны типы блоков, составляющие эти категории.</span><span class="sxs-lookup"><span data-stu-id="511a8-206">The following sections describe the block types that make up these categories.</span></span>  
  
### <a name="buffering-blocks"></a><span data-ttu-id="511a8-207">Блоки буферизации</span><span class="sxs-lookup"><span data-stu-id="511a8-207">Buffering Blocks</span></span>  
 <span data-ttu-id="511a8-208">Блоки буферизации хранят данные для их использования объектами-потребителями данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-208">Buffering blocks hold data for use by data consumers.</span></span> <span data-ttu-id="511a8-209">Библиотека потоков данных TPL предоставляет три типа блоков буферизации: <xref:System.Threading.Tasks.Dataflow.BufferBlock%601?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601?displayProperty=nameWithType> и <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="511a8-209">The TPL Dataflow Library provides three buffering block types: <xref:System.Threading.Tasks.Dataflow.BufferBlock%601?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601?displayProperty=nameWithType>.</span></span>  
  
#### <a name="bufferblockt"></a><span data-ttu-id="511a8-210">BufferBlock(T)</span><span class="sxs-lookup"><span data-stu-id="511a8-210">BufferBlock(T)</span></span>  
 <span data-ttu-id="511a8-211">Класс <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> представляет структуру общего назначения для асинхронного обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="511a8-211">The <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> class represents a general-purpose asynchronous messaging structure.</span></span> <span data-ttu-id="511a8-212">В этом классе хранится очередь сообщений типа «первым вошел — первым вышел» (FIFO), в которую могут записывать данные несколько источников и из которой могут читать данные несколько целевых объектов.</span><span class="sxs-lookup"><span data-stu-id="511a8-212">This class stores a first in, first out (FIFO) queue of messages that can be written to by multiple sources or read from by multiple targets.</span></span> <span data-ttu-id="511a8-213">Если целевой объект получает сообщение от объекта <xref:System.Threading.Tasks.Dataflow.BufferBlock%601>, это сообщение удаляется из очереди сообщений.</span><span class="sxs-lookup"><span data-stu-id="511a8-213">When a target receives a message from a <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> object, that message is removed from the message queue.</span></span> <span data-ttu-id="511a8-214">Поэтому, хотя объект <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> может иметь несколько целевых объектов, каждое сообщение может быть получено только одним из них.</span><span class="sxs-lookup"><span data-stu-id="511a8-214">Therefore, although a <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> object can have multiple targets, only one target will receive each message.</span></span> <span data-ttu-id="511a8-215">Класс <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> удобен, если нужно передать несколько сообщений другому компоненту и этот компонент должен принять каждое сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-215">The <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> class is useful when you want to pass multiple messages to another component, and that component must receive each message.</span></span>  
  
 <span data-ttu-id="511a8-216">Следующий пример отправляет несколько значений <xref:System.Int32> объекту <xref:System.Threading.Tasks.Dataflow.BufferBlock%601>, а затем эти значения считываются из этого объекта.</span><span class="sxs-lookup"><span data-stu-id="511a8-216">The following basic example posts several <xref:System.Int32> values to a <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> object and then reads those values back from that object.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#1)]
 [!code-vb[TPLDataflow_Overview#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#1)]  
  
 <span data-ttu-id="511a8-217">Полный пример, в котором показано, как записывать сообщения в объект <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> и считывать сообщения из него, вы найдете в статье [Практическое руководство. Запись и чтение сообщений в блоке потока данных](../../../docs/standard/parallel-programming/how-to-write-messages-to-and-read-messages-from-a-dataflow-block.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-217">For a complete example that demonstrates how to write messages to and read messages from a <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> object, see [How to: Write Messages to and Read Messages from a Dataflow Block](../../../docs/standard/parallel-programming/how-to-write-messages-to-and-read-messages-from-a-dataflow-block.md).</span></span>  
  
#### <a name="broadcastblockt"></a><span data-ttu-id="511a8-218">BroadcastBlock(T)</span><span class="sxs-lookup"><span data-stu-id="511a8-218">BroadcastBlock(T)</span></span>  
 <span data-ttu-id="511a8-219">Класс <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> удобен, если необходимо передать несколько сообщений другому компоненту, но этому компоненту нужно только самое последнее значение.</span><span class="sxs-lookup"><span data-stu-id="511a8-219">The <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> class is useful when you must pass multiple messages to another component, but that component needs only the most recent value.</span></span> <span data-ttu-id="511a8-220">Этот класс также может оказаться полезным при необходимости широковещательной передачи сообщения нескольким компонентам.</span><span class="sxs-lookup"><span data-stu-id="511a8-220">This class is also useful when you want to broadcast a message to multiple components.</span></span>  
  
 <span data-ttu-id="511a8-221">В следующем примере значение <xref:System.Double> отправляется объекту <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601>, а затем это значение считывается обратно из объекта несколько раз.</span><span class="sxs-lookup"><span data-stu-id="511a8-221">The following basic example posts a <xref:System.Double> value to a <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> object and then reads that value back from that object several times.</span></span> <span data-ttu-id="511a8-222">Поскольку значения не удаляются из объектов <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> после их прочтения, одно и то же значение доступно каждый раз.</span><span class="sxs-lookup"><span data-stu-id="511a8-222">Because values are not removed from <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> objects after they are read, the same value is available every time.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#2)]
 [!code-vb[TPLDataflow_Overview#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#2)]  
  
 <span data-ttu-id="511a8-223">Полный пример, в котором показано, как использовать <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> для передачи сообщения нескольким целевым блокам, см. в статье [Практическое руководство. Указание планировщика задач в блоке потока данных](../../../docs/standard/parallel-programming/how-to-specify-a-task-scheduler-in-a-dataflow-block.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-223">For a complete example that demonstrates how to use <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> to broadcast a message to multiple target blocks, see [How to: Specify a Task Scheduler in a Dataflow Block](../../../docs/standard/parallel-programming/how-to-specify-a-task-scheduler-in-a-dataflow-block.md).</span></span>  
  
#### <a name="writeonceblockt"></a><span data-ttu-id="511a8-224">WriteOnceBlock(T)</span><span class="sxs-lookup"><span data-stu-id="511a8-224">WriteOnceBlock(T)</span></span>  
 <span data-ttu-id="511a8-225">Класс <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> похож на класс <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601>, но объект <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> допускает только однократную запись.</span><span class="sxs-lookup"><span data-stu-id="511a8-225">The <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> class resembles the <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> class, except that a <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> object can be written to one time only.</span></span> <span data-ttu-id="511a8-226">Можно рассматривать <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> как аналог ключевого слова [readonly](~/docs/csharp/language-reference/keywords/readonly.md) в C# ([ReadOnly](~/docs/visual-basic/language-reference/modifiers/readonly.md) в Visual Basic), но объект <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> становится неизменяемым после того, как он получает значение, а не в момент создания.</span><span class="sxs-lookup"><span data-stu-id="511a8-226">You can think of <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> as being similar to the C# [readonly](~/docs/csharp/language-reference/keywords/readonly.md) ([ReadOnly](~/docs/visual-basic/language-reference/modifiers/readonly.md) in Visual Basic) keyword, except that a <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> object becomes immutable after it receives a value instead of at construction.</span></span> <span data-ttu-id="511a8-227">Как и в случае с классом <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601>, когда целевой объект получает сообщение от объекта <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601>, это сообщение не удаляется.</span><span class="sxs-lookup"><span data-stu-id="511a8-227">Like the <xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601> class, when a target receives a message from a <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> object, that message is not removed from that object.</span></span> <span data-ttu-id="511a8-228">Поэтому копию сообщения могут получить несколько целевых объектов.</span><span class="sxs-lookup"><span data-stu-id="511a8-228">Therefore, multiple targets receive a copy of the message.</span></span> <span data-ttu-id="511a8-229">Класс <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> полезен, если требуется передать только первое из нескольких сообщений.</span><span class="sxs-lookup"><span data-stu-id="511a8-229">The <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> class is useful when you want to propagate only the first of multiple messages.</span></span>  
  
 <span data-ttu-id="511a8-230">В следующем примере несколько значений <xref:System.String> отправляется объекту <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601>, а затем это значение считывается обратно из этого объекта.</span><span class="sxs-lookup"><span data-stu-id="511a8-230">The following basic example posts multiple <xref:System.String> values to a <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> object and then reads the value back from that object.</span></span> <span data-ttu-id="511a8-231">Поскольку в объект <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> можно сделать запись только один раз, после того, как объект <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> получает сообщение, он отклоняет последующие сообщения.</span><span class="sxs-lookup"><span data-stu-id="511a8-231">Because a <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> object can be written to one time only, after a <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> object receives a message, it discards subsequent messages.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#3)]
 [!code-vb[TPLDataflow_Overview#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#3)]  
  
 <span data-ttu-id="511a8-232">Полный пример того, как применять <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601>, чтобы получить значение первой завершенной операции, см. в статье [Практическое руководство. Удаление связей с блоками потоков данных](../../../docs/standard/parallel-programming/how-to-unlink-dataflow-blocks.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-232">For a complete example that demonstrates how to use <xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601> to receive the value of the first operation that finishes, see [How to: Unlink Dataflow Blocks](../../../docs/standard/parallel-programming/how-to-unlink-dataflow-blocks.md).</span></span>  
  
### <a name="execution-blocks"></a><span data-ttu-id="511a8-233">Блоки выполнения</span><span class="sxs-lookup"><span data-stu-id="511a8-233">Execution Blocks</span></span>  
 <span data-ttu-id="511a8-234">Блоки выполнения вызывают предоставленный пользователем делегат для каждого элемента полученных данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-234">Execution blocks call a user-provided delegate for each piece of received data.</span></span> <span data-ttu-id="511a8-235">Библиотека потоков данных TPL предоставляет три типа блоков выполнения: <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602?displayProperty=nameWithType> и <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="511a8-235">The TPL Dataflow Library provides three execution block types: <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602?displayProperty=nameWithType>.</span></span>  
  
#### <a name="actionblockt"></a><span data-ttu-id="511a8-236">ActionBlock(T)</span><span class="sxs-lookup"><span data-stu-id="511a8-236">ActionBlock(T)</span></span>  
 <span data-ttu-id="511a8-237">Класс <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> — целевой блок, который вызывает делегат при получении данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-237">The <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> class is a target block that calls a delegate when it receives data.</span></span> <span data-ttu-id="511a8-238">Можно рассматривать объект <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> как делегат, который выполняется асинхронно, когда данные становятся доступными.</span><span class="sxs-lookup"><span data-stu-id="511a8-238">Think of a <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object as a delegate that runs asynchronously when data becomes available.</span></span> <span data-ttu-id="511a8-239">Делегат, который предоставляется объекту <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, может быть типа <xref:System.Action> или типа `System.Func\<TInput, Task>`.</span><span class="sxs-lookup"><span data-stu-id="511a8-239">The delegate that you provide to an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object can be of type <xref:System.Action> or type `System.Func\<TInput, Task>`.</span></span> <span data-ttu-id="511a8-240">При использовании объекта <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> с <xref:System.Action> обработка каждого входного элемента считается завершенной, когда возвращается делегат.</span><span class="sxs-lookup"><span data-stu-id="511a8-240">When you use an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object with <xref:System.Action>, processing of each input element is considered completed when the delegate returns.</span></span> <span data-ttu-id="511a8-241">При использовании объекта <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> с `System.Func\<TInput, Task>` обработка каждого входного элемента считается завершенной, только если возвращенный объект <xref:System.Threading.Tasks.Task> завершен.</span><span class="sxs-lookup"><span data-stu-id="511a8-241">When you use an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object with `System.Func\<TInput, Task>`, processing of each input element is considered completed only when the returned <xref:System.Threading.Tasks.Task> object is completed.</span></span> <span data-ttu-id="511a8-242">С помощью двух этих механизмов можно использовать <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> как для синхронной, так и для асинхронной обработки каждого входного элемента.</span><span class="sxs-lookup"><span data-stu-id="511a8-242">By using these two mechanisms, you can use <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> for both synchronous and asynchronous processing of each input element.</span></span>  
  
 <span data-ttu-id="511a8-243">В следующем примере несколько значений <xref:System.Int32> отправляется объекту <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-243">The following basic example posts multiple <xref:System.Int32> values to an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object.</span></span> <span data-ttu-id="511a8-244">Объект <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> выводит эти значения на консоль.</span><span class="sxs-lookup"><span data-stu-id="511a8-244">The <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object prints those values to the console.</span></span> <span data-ttu-id="511a8-245">Затем в этом примере производится установка блока в завершенное состояние, и происходит ожидание завершения всех задач потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-245">This example then sets the block to the completed state and waits for all dataflow tasks to finish.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#4)]
 [!code-vb[TPLDataflow_Overview#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#4)]  
  
 <span data-ttu-id="511a8-246">Полные примеры того, как использовать делегат с классом <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, см. в статье [Практическое руководство. Выполнение действий при получении данных блоком потоков данных](../../../docs/standard/parallel-programming/how-to-perform-action-when-a-dataflow-block-receives-data.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-246">For complete examples that demonstrate how to use delegates with the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> class, see [How to: Perform Action When a Dataflow Block Receives Data](../../../docs/standard/parallel-programming/how-to-perform-action-when-a-dataflow-block-receives-data.md).</span></span>  
  
#### <a name="transformblocktinput-toutput"></a><span data-ttu-id="511a8-247">TransformBlock(TInput, TOutput)</span><span class="sxs-lookup"><span data-stu-id="511a8-247">TransformBlock(TInput, TOutput)</span></span>  
 <span data-ttu-id="511a8-248">Класс <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> похож на класс <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> за исключением того, что он работает и как источник, и как целевой объект.</span><span class="sxs-lookup"><span data-stu-id="511a8-248">The <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> class resembles the <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> class, except that it acts as both a source and as a target.</span></span> <span data-ttu-id="511a8-249">Делегат, который передается объекту <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, возвращает значение типа `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="511a8-249">The delegate that you pass to a <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> object returns a value of type `TOutput`.</span></span> <span data-ttu-id="511a8-250">Делегат, который предоставляется объекту <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, может относиться к типу `System.Func<TInput, TOutput>` или типу `System.Func<TInput, Task>`.</span><span class="sxs-lookup"><span data-stu-id="511a8-250">The delegate that you provide to a <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> object can be of type `System.Func<TInput, TOutput>` or type `System.Func<TInput, Task>`.</span></span> <span data-ttu-id="511a8-251">При использовании объекта <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> с `System.Func\<TInput, TOutput>` обработка каждого входного элемента считается завершенной, когда делегат возвращается.</span><span class="sxs-lookup"><span data-stu-id="511a8-251">When you use a <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> object with `System.Func\<TInput, TOutput>`, processing of each input element is considered completed when the delegate returns.</span></span> <span data-ttu-id="511a8-252">При использовании объекта <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> с `System.Func<TInput, Task<TOutput>>` обработка каждого входного элемента считается завершенной, только если возвращаемый объект <xref:System.Threading.Tasks.Task> завершен.</span><span class="sxs-lookup"><span data-stu-id="511a8-252">When you use a <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> object used with `System.Func<TInput, Task<TOutput>>`, processing of each input element is considered completed only when the returned <xref:System.Threading.Tasks.Task> object is completed.</span></span> <span data-ttu-id="511a8-253">Как и в случае с <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, с помощью двух этих механизмов можно использовать <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> как для синхронной, так и для асинхронной обработки каждого входного элемента.</span><span class="sxs-lookup"><span data-stu-id="511a8-253">As with <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, by using these two mechanisms, you can use <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> for both synchronous and asynchronous processing of each input element.</span></span>  
  
 <span data-ttu-id="511a8-254">В следующем примере создается объект <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, который вычисляет квадратный корень введенного значения.</span><span class="sxs-lookup"><span data-stu-id="511a8-254">The following basic example creates a <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> object that computes the square root of its input.</span></span> <span data-ttu-id="511a8-255">Объект <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> принимает значения <xref:System.Int32> на входе и создает значения <xref:System.Double> на выходе.</span><span class="sxs-lookup"><span data-stu-id="511a8-255">The <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> object takes <xref:System.Int32> values as input and produces <xref:System.Double> values as output.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#5](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#5)]
 [!code-vb[TPLDataflow_Overview#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#5)]  
  
 <span data-ttu-id="511a8-256">Полный пример использования <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> в сети блоков потоков данных, в котором выполняется обработка изображений в приложении Windows Forms, см. в статье [Пошаговое руководство. Использование потока данных в приложении Windows Forms](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-256">For complete examples that uses <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> in a network of dataflow blocks that performs image processing in a Windows Forms application, see [Walkthrough: Using Dataflow in a Windows Forms Application](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md).</span></span>  
  
#### <a name="transformmanyblocktinput-toutput"></a><span data-ttu-id="511a8-257">TransformManyBlock(TInput, TOutput)</span><span class="sxs-lookup"><span data-stu-id="511a8-257">TransformManyBlock(TInput, TOutput)</span></span>  
 <span data-ttu-id="511a8-258">Класс <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> похож на класс <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> за исключением того, что для каждого входного значения <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> создает ноль или более выходных значений вместо только одного значения.</span><span class="sxs-lookup"><span data-stu-id="511a8-258">The <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> class resembles the <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> class, except that <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> produces zero or more output values for each input value, instead of only one output value for each input value.</span></span> <span data-ttu-id="511a8-259">Делегат, который предоставляется объекту <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>, может быть типа `System.Func<TInput, IEnumerable<TOutput>>` или `type System.Func<TInput, Task<IEnumerable<TOutput>>>`.</span><span class="sxs-lookup"><span data-stu-id="511a8-259">The delegate that you provide to a <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> object can be of type `System.Func<TInput, IEnumerable<TOutput>>` or `type System.Func<TInput, Task<IEnumerable<TOutput>>>`.</span></span> <span data-ttu-id="511a8-260">При использовании объекта <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> с `System.Func<TInput, IEnumerable<TOutput>>` обработка каждого входного элемента считается завершенной, когда делегат возвращается.</span><span class="sxs-lookup"><span data-stu-id="511a8-260">When you use a <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> object with `System.Func<TInput, IEnumerable<TOutput>>`, processing of each input element is considered completed when the delegate returns.</span></span> <span data-ttu-id="511a8-261">При использовании объекта <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> с `System.Func<TInput, Task<IEnumerable<TOutput>>>` обработка каждого входного элемента считается завершенной, только если возвращаемый объект `System.Threading.Tasks.Task<IEnumerable<TOutput>>` завершен.</span><span class="sxs-lookup"><span data-stu-id="511a8-261">When you use a <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> object with `System.Func<TInput, Task<IEnumerable<TOutput>>>`, processing of each input element is considered complete only when the returned `System.Threading.Tasks.Task<IEnumerable<TOutput>>` object is completed.</span></span>  
  
 <span data-ttu-id="511a8-262">В следующем примере создается объект <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>, который разделяет строки на отдельные цепочки символов.</span><span class="sxs-lookup"><span data-stu-id="511a8-262">The following basic example creates a <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> object that splits strings into their individual character sequences.</span></span> <span data-ttu-id="511a8-263">Объект <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> принимает значения <xref:System.String> на входе и создает значения <xref:System.Char> на выходе.</span><span class="sxs-lookup"><span data-stu-id="511a8-263">The <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> object takes <xref:System.String> values as input and produces <xref:System.Char> values as output.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#6](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#6)]
 [!code-vb[TPLDataflow_Overview#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#6)]  
  
 <span data-ttu-id="511a8-264">Полный пример, в котором <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> используется, чтобы создавать несколько независимых выходных значений для каждого входного элемента в конвейере потока данных, см. в статье [Пошаговое руководство. Создание конвейера потока данных](../../../docs/standard/parallel-programming/walkthrough-creating-a-dataflow-pipeline.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-264">For complete examples that use <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> to produce multiple independent outputs for each input in a dataflow pipeline, see [Walkthrough: Creating a Dataflow Pipeline](../../../docs/standard/parallel-programming/walkthrough-creating-a-dataflow-pipeline.md).</span></span>  
  
#### <a name="degree-of-parallelism"></a><span data-ttu-id="511a8-265">Степень параллелизма</span><span class="sxs-lookup"><span data-stu-id="511a8-265">Degree of Parallelism</span></span>  
 <span data-ttu-id="511a8-266">Каждый из объектов <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> и <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> буферизует входные сообщения до тех пор, пока блок не будет готов их обработать.</span><span class="sxs-lookup"><span data-stu-id="511a8-266">Every <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, and <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> object buffers input messages until the block is ready to process them.</span></span> <span data-ttu-id="511a8-267">По умолчанию эти классы обрабатывают сообщения в том порядке, в котором они поступают, по одному.</span><span class="sxs-lookup"><span data-stu-id="511a8-267">By default, these classes process messages in the order in which they are received, one message at a time.</span></span> <span data-ttu-id="511a8-268">Можно также указать степень параллелизма для включения объектов <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> и <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> для одновременной обработки нескольких сообщений.</span><span class="sxs-lookup"><span data-stu-id="511a8-268">You can also specify the degree of parallelism to enable <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> and <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> objects to process multiple messages concurrently.</span></span> <span data-ttu-id="511a8-269">Дополнительные сведения о параллельном выполнении см. в разделе "Определение степени параллелизма" далее в этом документе.</span><span class="sxs-lookup"><span data-stu-id="511a8-269">For more information about concurrent execution, see the section Specifying the Degree of Parallelism later in this document.</span></span> <span data-ttu-id="511a8-270">Пример, в котором задается степень параллелизма для включения обработки блоком потока данных более одного сообщения одновременно, см. в разделе [Практическое руководство. Указание степени параллелизма в блоке потока данных](../../../docs/standard/parallel-programming/how-to-specify-the-degree-of-parallelism-in-a-dataflow-block.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-270">For an example that sets the degree of parallelism to enable an execution dataflow block to process more than one message at a time, see [How to: Specify the Degree of Parallelism in a Dataflow Block](../../../docs/standard/parallel-programming/how-to-specify-the-degree-of-parallelism-in-a-dataflow-block.md).</span></span>  
  
#### <a name="summary-of-delegate-types"></a><span data-ttu-id="511a8-271">Сводка по типам делегатов</span><span class="sxs-lookup"><span data-stu-id="511a8-271">Summary of Delegate Types</span></span>  
 <span data-ttu-id="511a8-272">В следующей таблице перечислены типы делегатов, которые можно передать объектам <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> и <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-272">The following table summarizes the delegate types that you can provide to <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, and <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602> objects.</span></span> <span data-ttu-id="511a8-273">В этой таблице также указано, работает ли делегат данного типа синхронно или асинхронно.</span><span class="sxs-lookup"><span data-stu-id="511a8-273">This table also specifies whether the delegate type operates synchronously or asynchronously.</span></span>  
  
|<span data-ttu-id="511a8-274">Тип</span><span class="sxs-lookup"><span data-stu-id="511a8-274">Type</span></span>|<span data-ttu-id="511a8-275">Синхронный тип делегата</span><span class="sxs-lookup"><span data-stu-id="511a8-275">Synchronous Delegate Type</span></span>|<span data-ttu-id="511a8-276">Асинхронный тип делегата</span><span class="sxs-lookup"><span data-stu-id="511a8-276">Asynchronous Delegate Type</span></span>|  
|----------|-------------------------------|--------------------------------|  
|<xref:System.Threading.Tasks.Dataflow.ActionBlock%601>|`System.Action`|`System.Func<TInput, Task>`|  
|<xref:System.Threading.Tasks.Dataflow.TransformBlock%602>|`System.Func<TInput, TOutput>`|`System.Func<TInput, Task<TOutput>>`|  
|<xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>|`System.Func<TInput, IEnumerable<TOutput>>`|`System.Func<TInput, Task<IEnumerable<TOutput>>>`|  
  
 <span data-ttu-id="511a8-277">Можно также использовать лямбда-выражения при работе с типами блоков выполнения.</span><span class="sxs-lookup"><span data-stu-id="511a8-277">You can also use lambda expressions when you work with execution block types.</span></span> <span data-ttu-id="511a8-278">Пример, демонстрирующий способ использования лямбда-выражения с блоком выполнения, см. в разделе [Практическое руководство. Выполнение действий при получении данных блоком потоков данных](../../../docs/standard/parallel-programming/how-to-perform-action-when-a-dataflow-block-receives-data.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-278">For an example that shows how to use a lambda expression with an execution block, see [How to: Perform Action When a Dataflow Block Receives Data](../../../docs/standard/parallel-programming/how-to-perform-action-when-a-dataflow-block-receives-data.md).</span></span>  
  
### <a name="grouping-blocks"></a><span data-ttu-id="511a8-279">Группирующие блоки</span><span class="sxs-lookup"><span data-stu-id="511a8-279">Grouping Blocks</span></span>  
 <span data-ttu-id="511a8-280">Группирующие блоки объединяют данные из одного или более источников с различными ограничениями.</span><span class="sxs-lookup"><span data-stu-id="511a8-280">Grouping blocks combine data from one or more sources and under various constraints.</span></span> <span data-ttu-id="511a8-281">Библиотека потоков данных TPL предоставляет три типа блоков объединения: <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> и <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-281">The TPL Dataflow Library provides three join block types: <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>, and <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602>.</span></span>  
  
#### <a name="batchblockt"></a><span data-ttu-id="511a8-282">BatchBlock(T)</span><span class="sxs-lookup"><span data-stu-id="511a8-282">BatchBlock(T)</span></span>  
 <span data-ttu-id="511a8-283">Класс <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> объединяет наборы входных данных, называемые пакетами, в массивы выходных данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-283">The <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class combines sets of input data, which are known as batches, into arrays of output data.</span></span> <span data-ttu-id="511a8-284">Укажите размер каждого пакета при создании объекта <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-284">You specify the size of each batch when you create a <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object.</span></span> <span data-ttu-id="511a8-285">Когда объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> получает указанное число входных элементов, он асинхронно передает массив, содержащий эти элементы.</span><span class="sxs-lookup"><span data-stu-id="511a8-285">When the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object receives the specified count of input elements, it asynchronously propagates out an array that contains those elements.</span></span> <span data-ttu-id="511a8-286">Если объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> переведен в состояние завершения, но не содержит достаточно элементов для формирования пакета, он формирует и передает конечный массив, который содержит оставшиеся входные элементы.</span><span class="sxs-lookup"><span data-stu-id="511a8-286">If a <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object is set to the completed state but does not contain enough elements to form a batch, it propagates out a final array that contains the remaining input elements.</span></span>  
  
 <span data-ttu-id="511a8-287">Класс <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> работает либо в *жадном*, либо в *нежадном* режиме.</span><span class="sxs-lookup"><span data-stu-id="511a8-287">The <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class operates in either *greedy* or *non-greedy* mode.</span></span> <span data-ttu-id="511a8-288">В жадном режиме, используемом по умолчанию, объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> принимает каждое предлагаемое ему сообщение и передает массив, как только получит указанное количество элементов.</span><span class="sxs-lookup"><span data-stu-id="511a8-288">In greedy mode, which is the default, a <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object accepts every message that it is offered and propagates out an array after it receives the specified count of elements.</span></span> <span data-ttu-id="511a8-289">В нежадном режиме объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> откладывает все входящие сообщения до тех пор, пока достаточное количество источников не предложит сообщения блоку для формирования пакета.</span><span class="sxs-lookup"><span data-stu-id="511a8-289">In non-greedy mode, a <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object postpones all incoming messages until enough sources have offered messages to the block to form a batch.</span></span> <span data-ttu-id="511a8-290">Жадный режим обычно работает быстрее, чем нежадный режим, поскольку он требует меньше дополнительной нагрузки для обработки.</span><span class="sxs-lookup"><span data-stu-id="511a8-290">Greedy mode typically performs better than non-greedy mode because it requires less processing overhead.</span></span> <span data-ttu-id="511a8-291">Однако можно использовать нежадный режим, если необходимо координировать получение от нескольких источников атомарным образом.</span><span class="sxs-lookup"><span data-stu-id="511a8-291">However, you can use non-greedy mode when you must coordinate consumption from multiple sources in an atomic fashion.</span></span> <span data-ttu-id="511a8-292">Определите нежадный режим, установив свойству <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions.Greedy%2A> значение `False` в параметре `dataflowBlockOptions` в конструкторе <xref:System.Threading.Tasks.Dataflow.BatchBlock%601.%23ctor%2A>.</span><span class="sxs-lookup"><span data-stu-id="511a8-292">Specify non-greedy mode by setting <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions.Greedy%2A> to `False` in the `dataflowBlockOptions` parameter in the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601.%23ctor%2A> constructor.</span></span>  
  
 <span data-ttu-id="511a8-293">Следующий пример отправляет несколько значений <xref:System.Int32> объекту <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, содержащему десять элементов в пакете.</span><span class="sxs-lookup"><span data-stu-id="511a8-293">The following basic example posts several <xref:System.Int32> values to a <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object that holds ten elements in a batch.</span></span> <span data-ttu-id="511a8-294">Для обеспечения передачи всех значений из <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> в этом примере вызывается метод <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A>.</span><span class="sxs-lookup"><span data-stu-id="511a8-294">To guarantee that all values propagate out of the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, this example calls the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A> method.</span></span> <span data-ttu-id="511a8-295">Метод <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A> переводит объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> в состояние завершения, и поэтому объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> передает все оставшиеся элементы в качестве последнего пакета.</span><span class="sxs-lookup"><span data-stu-id="511a8-295">The <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Complete%2A> method sets the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object to the completed state, and therefore, the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object propagates out any remaining elements as a final batch.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#7](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#7)]
 [!code-vb[TPLDataflow_Overview#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#7)]  
  
 <span data-ttu-id="511a8-296">Полный пример использования <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, чтобы повысить эффективность операций вставки в базу данных, см. в статье [Пошаговое руководство. Повышение эффективности с помощью BatchBlock и BatchedJoinBlock](../../../docs/standard/parallel-programming/walkthrough-using-batchblock-and-batchedjoinblock-to-improve-efficiency.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-296">For a complete example that uses <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> to improve the efficiency of database insert operations, see [Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency](../../../docs/standard/parallel-programming/walkthrough-using-batchblock-and-batchedjoinblock-to-improve-efficiency.md).</span></span>  
  
#### <a name="joinblockt1-t2-"></a><span data-ttu-id="511a8-297">JoinBlock(T1, T2, ...)</span><span class="sxs-lookup"><span data-stu-id="511a8-297">JoinBlock(T1, T2, ...)</span></span>  
 <span data-ttu-id="511a8-298">Классы <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> и <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> собирают входные элементы и распространяют объекты <xref:System.Tuple%602?displayProperty=nameWithType> или <xref:System.Tuple%603?displayProperty=nameWithType>, содержащие эти элементы.</span><span class="sxs-lookup"><span data-stu-id="511a8-298">The <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> and <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> classes collect input elements and propagate out <xref:System.Tuple%602?displayProperty=nameWithType> or <xref:System.Tuple%603?displayProperty=nameWithType> objects that contain those elements.</span></span> <span data-ttu-id="511a8-299">Классы <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> и <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> не наследуются от <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-299">The <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> and <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> classes do not inherit from <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span></span> <span data-ttu-id="511a8-300">Вместо этого они предоставляют свойства <xref:System.Threading.Tasks.Dataflow.JoinBlock%602.Target1%2A>, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602.Target2%2A> и <xref:System.Threading.Tasks.Dataflow.JoinBlock%603.Target3%2A>, которые реализуют <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-300">Instead, they provide properties, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602.Target1%2A>, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602.Target2%2A>, and <xref:System.Threading.Tasks.Dataflow.JoinBlock%603.Target3%2A>, that implement <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span></span>  
  
 <span data-ttu-id="511a8-301">Как <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> и <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> работают либо в жадном, либо в нежадном режиме.</span><span class="sxs-lookup"><span data-stu-id="511a8-301">Like <xref:System.Threading.Tasks.Dataflow.BatchBlock%601>, <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> and <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> operate in either greedy or non-greedy mode.</span></span> <span data-ttu-id="511a8-302">В жадном режиме, используемом по умолчанию, объект <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> или <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> принимает каждое предлагаемое ему сообщение и распространяет кортеж после того, как каждый из его целевых объектов получает по меньшей мере одно сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-302">In greedy mode, which is the default, a <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> or <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> object accepts every message that it is offered and propagates out a tuple after each of its targets receives at least one message.</span></span> <span data-ttu-id="511a8-303">В нежадном режиме объект <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> или <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> откладывает все входящие сообщения, пока всем целевым объектам не будут предложены данные, необходимые для создания кортежа.</span><span class="sxs-lookup"><span data-stu-id="511a8-303">In non-greedy mode, a <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> or <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> object postpones all incoming messages until all targets have been offered the data that is required to create a tuple.</span></span> <span data-ttu-id="511a8-304">В этот момент блок использует протокол двухфазной фиксации для атомарного извлечения всех необходимых элементов из источника.</span><span class="sxs-lookup"><span data-stu-id="511a8-304">At this point, the block engages in a two-phase commit protocol to atomically retrieve all required items from the sources.</span></span> <span data-ttu-id="511a8-305">Эта задержка дает возможность другой сущности в это же время получать эти данные, что позволяет системе в целом продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="511a8-305">This postponement makes it possible for another entity to consume the data in the meantime, to allow the overall system to make forward progress.</span></span>  
  
 <span data-ttu-id="511a8-306">В следующем примере описан случай, в котором объект <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> требует нескольких элементов данных для вычисления значения.</span><span class="sxs-lookup"><span data-stu-id="511a8-306">The following basic example demonstrates a case in which a <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> object requires multiple data to compute a value.</span></span> <span data-ttu-id="511a8-307">В этом примере создается объект <xref:System.Threading.Tasks.Dataflow.JoinBlock%603>, который требует два значения <xref:System.Int32> и <xref:System.Char> для выполнения арифметической операции.</span><span class="sxs-lookup"><span data-stu-id="511a8-307">This example creates a <xref:System.Threading.Tasks.Dataflow.JoinBlock%603> object that requires two <xref:System.Int32> values and a <xref:System.Char> value to perform an arithmetic operation.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#8](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#8)]
 [!code-vb[TPLDataflow_Overview#8](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#8)]  
  
 <span data-ttu-id="511a8-308">Полный пример применения объектов <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> в нежадном режиме для совместного использования ресурсов см. в статье [Практическое руководство. Использование JoinBlock для чтения данных из нескольких источников](../../../docs/standard/parallel-programming/how-to-use-joinblock-to-read-data-from-multiple-sources.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-308">For a complete example that uses <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> objects in non-greedy mode to cooperatively share a resource, see [How to: Use JoinBlock to Read Data From Multiple Sources](../../../docs/standard/parallel-programming/how-to-use-joinblock-to-read-data-from-multiple-sources.md).</span></span>  
  
#### <a name="batchedjoinblockt1-t2-"></a><span data-ttu-id="511a8-309">BatchedJoinBlock(T1, T2, ...)</span><span class="sxs-lookup"><span data-stu-id="511a8-309">BatchedJoinBlock(T1, T2, ...)</span></span>  
 <span data-ttu-id="511a8-310">Классы <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> и <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%603> собирают пакеты входных элементов и распространяют объекты `System.Tuple(IList(T1), IList(T2))` или `System.Tuple(IList(T1), IList(T2), IList(T3))`, содержащие эти элементы.</span><span class="sxs-lookup"><span data-stu-id="511a8-310">The <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> and <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%603> classes collect batches of input elements and propagate out `System.Tuple(IList(T1), IList(T2))` or `System.Tuple(IList(T1), IList(T2), IList(T3))` objects that contain those elements.</span></span> <span data-ttu-id="511a8-311">Класс <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> можно рассматривать как сочетание <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> и <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-311">Think of <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> as a combination of <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> and <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>.</span></span> <span data-ttu-id="511a8-312">Укажите размер каждого пакета во время создания объекта <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-312">Specify the size of each batch when you create a <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> object.</span></span> <span data-ttu-id="511a8-313"><xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> также предоставляет свойства, <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target1%2A> и <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target2%2A>, которые реализуют <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-313"><xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> also provides properties, <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target1%2A> and <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target2%2A>, that implement <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601>.</span></span> <span data-ttu-id="511a8-314">Если указанное число входных элементов получено от всех целевых объектов, объект <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> асинхронно распространяет объект `System.Tuple(IList(T1), IList(T2))`, содержащий эти элементы.</span><span class="sxs-lookup"><span data-stu-id="511a8-314">When the specified count of input elements are received from across all targets, the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> object asynchronously propagates out a `System.Tuple(IList(T1), IList(T2))` object that contains those elements.</span></span>  
  
 <span data-ttu-id="511a8-315">В следующем примере создается объект <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602>, содержащий результаты, значения <xref:System.Int32> и ошибки, представленные объектами <xref:System.Exception>.</span><span class="sxs-lookup"><span data-stu-id="511a8-315">The following basic example creates a <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> object that holds results, <xref:System.Int32> values, and errors that are <xref:System.Exception> objects.</span></span> <span data-ttu-id="511a8-316">В этом примере выполняется несколько операций, результаты записываются в свойство <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target1%2A>, а ошибки — в свойство <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target2%2A> объекта <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-316">This example performs multiple operations and writes results to the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target1%2A> property, and errors to the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602.Target2%2A> property, of the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> object.</span></span> <span data-ttu-id="511a8-317">Поскольку число успешных и неудачных операций не известно заранее, объекты <xref:System.Collections.Generic.IList%601> позволяют каждому целевому объекту получать ноль и более значений.</span><span class="sxs-lookup"><span data-stu-id="511a8-317">Because the count of successful and failed operations is unknown in advance, the <xref:System.Collections.Generic.IList%601> objects enable each target to receive zero or more values.</span></span>  
  
 [!code-csharp[TPLDataflow_Overview#9](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_overview/cs/program.cs#9)]
 [!code-vb[TPLDataflow_Overview#9](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_overview/vb/program.vb#9)]  
  
 <span data-ttu-id="511a8-318">Полный пример использования <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> для захвата как результатов, так и всех исключений, которые могут возникнуть при выполнении считывания данных из базы, см. в статье [Пошаговое руководство. Повышение эффективности с помощью BatchBlock и BatchedJoinBlock](../../../docs/standard/parallel-programming/walkthrough-using-batchblock-and-batchedjoinblock-to-improve-efficiency.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-318">For a complete example that uses <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> to capture both the results and any exceptions that occur while the program reads from a database, see [Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency](../../../docs/standard/parallel-programming/walkthrough-using-batchblock-and-batchedjoinblock-to-improve-efficiency.md).</span></span>  
  
 <span data-ttu-id="511a8-319">[[в начало](#top)]</span><span class="sxs-lookup"><span data-stu-id="511a8-319">[[go to top](#top)]</span></span>  
  
<a name="behavior"></a>   
## <a name="configuring-dataflow--block-behavior"></a><span data-ttu-id="511a8-320">Настройка поведения блоков потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-320">Configuring Dataflow  Block Behavior</span></span>  
 <span data-ttu-id="511a8-321">Можно включить дополнительные параметры, предоставив объект <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions?displayProperty=nameWithType> конструктору типов блоков потоков данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-321">You can enable additional options by providing a <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions?displayProperty=nameWithType> object to the constructor of dataflow block types.</span></span> <span data-ttu-id="511a8-322">Эти параметры управляют таким поведением, как у планировщика, который управляет основной задачей и степенью параллелизма.</span><span class="sxs-lookup"><span data-stu-id="511a8-322">These options control behavior such the scheduler that manages the underlying task and the degree of parallelism.</span></span> <span data-ttu-id="511a8-323"><xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions> также содержит производные типы, которые задают поведение, характерное для некоторых типов блоков потоков данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-323">The <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions> also has derived types that specify behavior that is specific to certain dataflow block types.</span></span> <span data-ttu-id="511a8-324">В следующей таблице перечислено, какие типы параметров связаны с каждым из типов блоков потоков данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-324">The following table summarizes which options type is associated with each dataflow block type.</span></span>  
  
|<span data-ttu-id="511a8-325">Тип блока потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-325">Dataflow Block Type</span></span>|<span data-ttu-id="511a8-326">Тип <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions></span><span class="sxs-lookup"><span data-stu-id="511a8-326"><xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions> type</span></span>|  
|-------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|  
|<xref:System.Threading.Tasks.Dataflow.BufferBlock%601>|<xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.BroadcastBlock%601>|<xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.WriteOnceBlock%601>|<xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.ActionBlock%601>|<xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.TransformBlock%602>|<xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>|<xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.BatchBlock%601>|<xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.JoinBlock%602>|<xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions>|  
|<xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602>|<xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions>|  
  
 <span data-ttu-id="511a8-327">В следующих разделах приведены дополнительные сведения о важных типах параметров блоков потоков данных, доступных с помощью классов <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions?displayProperty=nameWithType> и <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="511a8-327">The following sections provide additional information about the important kinds of dataflow block options that are available through the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions?displayProperty=nameWithType> classes.</span></span>  
  
### <a name="specifying-the-task-scheduler"></a><span data-ttu-id="511a8-328">Определение планировщика заданий</span><span class="sxs-lookup"><span data-stu-id="511a8-328">Specifying the Task Scheduler</span></span>  
 <span data-ttu-id="511a8-329">Все стандартные блоки потоков данных используют механизм планирования задач TPL для выполнения таких действий, как передача данных целевому объекту, получение данных из источника и выполнение определенных пользователем делегатов, когда данные становятся доступны.</span><span class="sxs-lookup"><span data-stu-id="511a8-329">Every predefined dataflow block uses the TPL task scheduling mechanism to perform activities such as propagating data to a target, receiving data from a source, and running user-defined delegates when data becomes available.</span></span> <span data-ttu-id="511a8-330"><xref:System.Threading.Tasks.TaskScheduler> — абстрактный класс, представляющий планировщик заданий, ставящий задачи в очередь потоков.</span><span class="sxs-lookup"><span data-stu-id="511a8-330"><xref:System.Threading.Tasks.TaskScheduler> is an abstract class that represents a task scheduler that queues tasks onto threads.</span></span> <span data-ttu-id="511a8-331">Планировщик заданий по умолчанию, <xref:System.Threading.Tasks.TaskScheduler.Default%2A>, использует класс <xref:System.Threading.ThreadPool> для постановки в очередь и выполнения работы.</span><span class="sxs-lookup"><span data-stu-id="511a8-331">The default task scheduler, <xref:System.Threading.Tasks.TaskScheduler.Default%2A>, uses the <xref:System.Threading.ThreadPool> class to queue and execute work.</span></span> <span data-ttu-id="511a8-332">Можно переопределить планировщик заданий по умолчанию, установив свойство <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A> при создании объекта блока потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-332">You can override the default task scheduler by setting the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.TaskScheduler%2A> property when you construct a dataflow block object.</span></span>  
  
 <span data-ttu-id="511a8-333">Если один и тот же планировщик заданий управляет несколькими блоками потока данных, он может применять к ним определенные политики.</span><span class="sxs-lookup"><span data-stu-id="511a8-333">When the same task scheduler manages multiple dataflow blocks, it can enforce policies across them.</span></span> <span data-ttu-id="511a8-334">Например, если каждый из нескольких блоков потока данных настроен для отдельного планировщика заданий одного объекта <xref:System.Threading.Tasks.ConcurrentExclusiveSchedulerPair>, вся работа, выполняемая в этих блоках, сериализуется.</span><span class="sxs-lookup"><span data-stu-id="511a8-334">For example, if multiple dataflow blocks are each configured to target the exclusive scheduler of the same <xref:System.Threading.Tasks.ConcurrentExclusiveSchedulerPair> object, all work that runs across these blocks is serialized.</span></span> <span data-ttu-id="511a8-335">Аналогично, если эти блоки настроены для параллельного планировщика заданий одного объекта <xref:System.Threading.Tasks.ConcurrentExclusiveSchedulerPair> и этот планировщик настроен так, чтобы иметь максимальный уровень параллелизма, вся работа из этих блоков ограничивается заданным числом одновременных операций.</span><span class="sxs-lookup"><span data-stu-id="511a8-335">Similarly, if these blocks are configured to target the concurrent scheduler of the same <xref:System.Threading.Tasks.ConcurrentExclusiveSchedulerPair> object, and that scheduler is configured to have a maximum concurrency level, all work from these blocks is limited to that number of concurrent operations.</span></span> <span data-ttu-id="511a8-336">Пример, в котором класс <xref:System.Threading.Tasks.ConcurrentExclusiveSchedulerPair> допускает параллельное выполнение операций чтения, а операции записи приостанавливают выполнение любых других операций, см. в статье [Практическое руководство. Указание планировщика задач в блоке потока данных](../../../docs/standard/parallel-programming/how-to-specify-a-task-scheduler-in-a-dataflow-block.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-336">For an example that uses the <xref:System.Threading.Tasks.ConcurrentExclusiveSchedulerPair> class to enable read operations to occur in parallel, but write operations to occur exclusively of all other operations, see [How to: Specify a Task Scheduler in a Dataflow Block](../../../docs/standard/parallel-programming/how-to-specify-a-task-scheduler-in-a-dataflow-block.md).</span></span> <span data-ttu-id="511a8-337">Дополнительные сведения о планировщиках задач в TPL см. в разделе <xref:System.Threading.Tasks.TaskScheduler>.</span><span class="sxs-lookup"><span data-stu-id="511a8-337">For more information about task schedulers in the TPL, see the <xref:System.Threading.Tasks.TaskScheduler> class topic.</span></span>  
  
### <a name="specifying-the-degree-of-parallelism"></a><span data-ttu-id="511a8-338">Определение степени параллелизма</span><span class="sxs-lookup"><span data-stu-id="511a8-338">Specifying the Degree of Parallelism</span></span>  
 <span data-ttu-id="511a8-339">По умолчанию библиотека потоков данных TPL предоставляет три типа блоков выполнения: <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> и <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>, которые обрабатывают одно сообщение за раз.</span><span class="sxs-lookup"><span data-stu-id="511a8-339">By default, the three execution block types that the TPL Dataflow Library provides, <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, and <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>, process one message at a time.</span></span> <span data-ttu-id="511a8-340">Эти типы блоков потоков данных также обрабатывают сообщения в порядке их поступления.</span><span class="sxs-lookup"><span data-stu-id="511a8-340">These dataflow block types also process messages in the order in which they are received.</span></span> <span data-ttu-id="511a8-341">Чтобы обеспечить возможность обработки одновременно нескольких сообщений этими блоками потоков данных, задайте свойство <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A?displayProperty=nameWithType> при создании объекта блока потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-341">To enable these dataflow blocks to process messages concurrently, set the <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A?displayProperty=nameWithType> property when you construct the dataflow block object.</span></span>  
  
 <span data-ttu-id="511a8-342">Значение по умолчанию у <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> — 1, оно гарантирует, что блок потока данных единовременно обрабатывает одно сообщение.</span><span class="sxs-lookup"><span data-stu-id="511a8-342">The default value of <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> is 1, which guarantees that the dataflow block processes one message at a time.</span></span> <span data-ttu-id="511a8-343">Присвоение этому свойству значения более 1 активирует обработку блоком потока данных нескольких сообщений одновременно.</span><span class="sxs-lookup"><span data-stu-id="511a8-343">Setting this property to a value that is larger than 1 enables the dataflow block to process multiple messages concurrently.</span></span> <span data-ttu-id="511a8-344">Присвоение этому свойству значения <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.Unbounded?displayProperty=nameWithType> позволяет основному планировщику задач управлять максимальной степенью параллелизма.</span><span class="sxs-lookup"><span data-stu-id="511a8-344">Setting this property to <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.Unbounded?displayProperty=nameWithType> enables the underlying task scheduler to manage the maximum degree of concurrency.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="511a8-345">При максимальной степени параллелизма, составляющей больше 1, несколько сообщений обрабатываются одновременно, и поэтому сообщения не могут обрабатываться в порядке их получения.</span><span class="sxs-lookup"><span data-stu-id="511a8-345">When you specify a maximum degree of parallelism that is larger than 1, multiple messages are processed simultaneously, and therefore, messages might not be processed in the order in which they are received.</span></span> <span data-ttu-id="511a8-346">Тем не менее порядок, в котором сообщения выводятся из блока, будет верным.</span><span class="sxs-lookup"><span data-stu-id="511a8-346">The order in which the messages are output from the block will, however, be correctly ordered.</span></span>  
  
 <span data-ttu-id="511a8-347">Поскольку свойство <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> представляет максимальную степень параллелизма, блок потока данных может выполняться с меньшей степенью параллелизма, чем задано.</span><span class="sxs-lookup"><span data-stu-id="511a8-347">Because the <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> property represents the maximum degree of parallelism, the dataflow block might execute with a lesser degree of parallelism than you specify.</span></span> <span data-ttu-id="511a8-348">Блок потока данных может использовать меньшую степень параллелизма для удовлетворения функциональных требований или при нехватке доступных системных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="511a8-348">The dataflow block might use a lesser degree of parallelism to meet its functional requirements or because there is a lack of available system resources.</span></span> <span data-ttu-id="511a8-349">Блок потока данных никогда не выбирает степень параллелизма больше заданной.</span><span class="sxs-lookup"><span data-stu-id="511a8-349">A dataflow block never chooses more parallelism than you specify.</span></span>  
  
 <span data-ttu-id="511a8-350">Значение свойства <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> уникально для каждого объекта блока потока данных.</span><span class="sxs-lookup"><span data-stu-id="511a8-350">The value of the <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> property is exclusive to each dataflow block object.</span></span> <span data-ttu-id="511a8-351">Например, если для четырех объектов блока потока данных задана 1 как максимальная степень параллелизма, все четыре объекта блока потока данных потенциально могут выполняться параллельно.</span><span class="sxs-lookup"><span data-stu-id="511a8-351">For example, if four dataflow block objects each specify 1 for the maximum degree of parallelism, all four dataflow block objects can potentially run in parallel.</span></span>  
  
 <span data-ttu-id="511a8-352">Пример, в котором задается максимальная степень параллелизма для предоставления возможности параллельного выполнения продолжительных операций, см. в разделе [Практическое руководство. Указание степени параллелизма в блоке потока данных](../../../docs/standard/parallel-programming/how-to-specify-the-degree-of-parallelism-in-a-dataflow-block.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-352">For an example that sets the maximum degree of parallelism to enable lengthy operations to occur in parallel, see [How to: Specify the Degree of Parallelism in a Dataflow Block](../../../docs/standard/parallel-programming/how-to-specify-the-degree-of-parallelism-in-a-dataflow-block.md).</span></span>  
  
### <a name="specifying-the-number-of-messages-per-task"></a><span data-ttu-id="511a8-353">Определение количества сообщений на задачу</span><span class="sxs-lookup"><span data-stu-id="511a8-353">Specifying the Number of Messages per Task</span></span>  
 <span data-ttu-id="511a8-354">Предопределенные типы блоков потока данных используют задачи для обработки нескольких входных элементов.</span><span class="sxs-lookup"><span data-stu-id="511a8-354">The predefined dataflow block types use tasks to process multiple input elements.</span></span> <span data-ttu-id="511a8-355">Это позволяет минимизировать число объектов задачи, необходимых для обработки данных, из-за чего приложения выполняются более эффективно.</span><span class="sxs-lookup"><span data-stu-id="511a8-355">This helps minimize the number of task objects that are required to process data, which enables applications to run more efficiently.</span></span> <span data-ttu-id="511a8-356">Однако если задачи из одного набора блоков потока данных обрабатывают данные, задачи из других блоков потока данных быть вынуждены ожидать в течение времени, необходимого для обработки данных, добавляя сообщения в очередь.</span><span class="sxs-lookup"><span data-stu-id="511a8-356">However, when the tasks from one set of dataflow blocks are processing data, the tasks from other dataflow blocks might need to wait for processing time by queuing messages.</span></span> <span data-ttu-id="511a8-357">Чтобы обеспечить улучшенное распределение ресурсов между задачами потока данных, задайте значение для свойства <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A>.</span><span class="sxs-lookup"><span data-stu-id="511a8-357">To enable better fairness among dataflow tasks, set the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> property.</span></span> <span data-ttu-id="511a8-358">Если свойству <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> задано значение <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.Unbounded?displayProperty=nameWithType>, которое используется по умолчанию, задача, используемая блоком потока данных, обрабатывает столько сообщений, сколько их доступно.</span><span class="sxs-lookup"><span data-stu-id="511a8-358">When <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> is set to <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.Unbounded?displayProperty=nameWithType>, which is the default, the task used by a dataflow block processes as many messages as are available.</span></span> <span data-ttu-id="511a8-359">Если свойству <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> задано значение, отличное от <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.Unbounded>, блок потока данных обрабатывает не больше этого количества сообщений на объект <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="511a8-359">When <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> is set to a value other than <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.Unbounded>, the dataflow block processes at most this number of messages per <xref:System.Threading.Tasks.Task> object.</span></span> <span data-ttu-id="511a8-360">Хотя настройка свойства <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> может улучшить распределение ресурсов между задачами, это может привести к созданию в системе количества задач, превышающего необходимое количество, что может снизить производительность.</span><span class="sxs-lookup"><span data-stu-id="511a8-360">Although setting the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.MaxMessagesPerTask%2A> property can increase fairness among tasks, it can cause the system to create more tasks than are necessary, which can decrease performance.</span></span>  
  
### <a name="enabling-cancellation"></a><span data-ttu-id="511a8-361">Включение отмены</span><span class="sxs-lookup"><span data-stu-id="511a8-361">Enabling Cancellation</span></span>  
 <span data-ttu-id="511a8-362">TPL предоставляет механизм, который позволяет задачам координировать отмены согласованным образом.</span><span class="sxs-lookup"><span data-stu-id="511a8-362">The TPL provides a mechanism that enables tasks to coordinate cancellation in a cooperative manner.</span></span> <span data-ttu-id="511a8-363">Чтобы позволить блокам потока данных участвовать в этом механизме отмены, задайте значение для свойства <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A>.</span><span class="sxs-lookup"><span data-stu-id="511a8-363">To enable dataflow blocks to participate in this cancellation mechanism, set the <xref:System.Threading.Tasks.Dataflow.DataflowBlockOptions.CancellationToken%2A> property.</span></span> <span data-ttu-id="511a8-364">Если объект <xref:System.Threading.CancellationToken> переводится в состояние отмены, все блоки потока данных, которые отслеживают выполнение этого токена, завершат выполнение текущего элемента, но не начнут обрабатывать последующие.</span><span class="sxs-lookup"><span data-stu-id="511a8-364">When this <xref:System.Threading.CancellationToken> object is set to the canceled state, all dataflow blocks that monitor this token finish execution of their current item but do not start processing subsequent items.</span></span> <span data-ttu-id="511a8-365">Эти блоки потока данных также очищают все буферизованные сообщения, прекращают подключения ко всем блокам источников и целевых объектов, и переходят в состояние отмены.</span><span class="sxs-lookup"><span data-stu-id="511a8-365">These dataflow blocks also clear any buffered messages, release connections to any source and target blocks, and transition to the canceled state.</span></span> <span data-ttu-id="511a8-366">Путем перехода в состояние отмены у свойства <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Completion%2A> свойству <xref:System.Threading.Tasks.Task.Status%2A> присваивается значение <xref:System.Threading.Tasks.TaskStatus.Canceled>, если во время обработки не возникает исключения.</span><span class="sxs-lookup"><span data-stu-id="511a8-366">By transitioning to the canceled state, the <xref:System.Threading.Tasks.Dataflow.IDataflowBlock.Completion%2A> property has the <xref:System.Threading.Tasks.Task.Status%2A> property set to <xref:System.Threading.Tasks.TaskStatus.Canceled>, unless an exception occurred during processing.</span></span> <span data-ttu-id="511a8-367">В таком случае свойству <xref:System.Threading.Tasks.Task.Status%2A> присваивается значение <xref:System.Threading.Tasks.TaskStatus.Faulted>.</span><span class="sxs-lookup"><span data-stu-id="511a8-367">In that case, <xref:System.Threading.Tasks.Task.Status%2A> is set to <xref:System.Threading.Tasks.TaskStatus.Faulted>.</span></span>  
  
 <span data-ttu-id="511a8-368">Пример использования отмены в приложении Windows Forms см. в разделе [Практическое руководство. Отмена блока потока данных](../../../docs/standard/parallel-programming/how-to-cancel-a-dataflow-block.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-368">For an example that demonstrates how to use cancellation in a Windows Forms application, see [How to: Cancel a Dataflow Block](../../../docs/standard/parallel-programming/how-to-cancel-a-dataflow-block.md).</span></span> <span data-ttu-id="511a8-369">Подробнее об отмене в TPL читайте в разделе [Отмена задач](../../../docs/standard/parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-369">For more information about cancellation in the TPL, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="specifying-greedy-versus-non-greedy-behavior"></a><span data-ttu-id="511a8-370">Определение жадного и нежадного поведения</span><span class="sxs-lookup"><span data-stu-id="511a8-370">Specifying Greedy Versus Non-Greedy Behavior</span></span>  
 <span data-ttu-id="511a8-371">Несколько группирующих типов блоков потоков данных могут работать либо в *жадном*, либо в *нежадном* режиме.</span><span class="sxs-lookup"><span data-stu-id="511a8-371">Several grouping dataflow block types can operate in either *greedy* or *non-greedy* mode.</span></span> <span data-ttu-id="511a8-372">По умолчанию стандартные типы блоков потоков данных работают в жадном режиме.</span><span class="sxs-lookup"><span data-stu-id="511a8-372">By default, the predefined dataflow block types operate in greedy mode.</span></span>  
  
 <span data-ttu-id="511a8-373">Для типов блоков соединения, таких как <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>, жадный режим означает, что блок сразу принимает данные, даже если соответствующие данные, с которыми нужно выполнить объединение, еще недоступны.</span><span class="sxs-lookup"><span data-stu-id="511a8-373">For join block types such as <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>, greedy mode means that the block immediately accepts data even if the corresponding data with which to join is not yet available.</span></span> <span data-ttu-id="511a8-374">Нежадный режим означает, что блок откладывает все входящие сообщения до тех пор, пока сообщение не будет доступно на каждом из его целевых объектов для завершения объединения.</span><span class="sxs-lookup"><span data-stu-id="511a8-374">Non-greedy mode means that the block postpones all incoming messages until one is available on each of its targets to complete the join.</span></span> <span data-ttu-id="511a8-375">Если любое из отложенных сообщений больше недоступно, блоки соединения освобождают все отложенные сообщения и перезапускают процесс.</span><span class="sxs-lookup"><span data-stu-id="511a8-375">If any of the postponed messages are no longer available, the join block releases all postponed messages and restarts the process.</span></span> <span data-ttu-id="511a8-376">Для класса <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> жадный и нежадный режим работают одинаково за исключением того, что в нежадном режиме объект <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> откладывает все входящие сообщения до тех пор, пока достаточное их количество не будет доступно из различных источников для заполнения пакета.</span><span class="sxs-lookup"><span data-stu-id="511a8-376">For the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class, greedy and non-greedy behavior is similar, except that under non-greedy mode, a <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> object postpones all incoming messages until enough are available from distinct sources to complete a batch.</span></span>  
  
 <span data-ttu-id="511a8-377">Для определения нежадного режима для блока потока данных задайте свойству <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions.Greedy%2A> значение `False`.</span><span class="sxs-lookup"><span data-stu-id="511a8-377">To specify non-greedy mode for a dataflow block, set <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions.Greedy%2A> to `False`.</span></span> <span data-ttu-id="511a8-378">Пример использования нежадного режима для включения нескольких блоков соединения для более эффективного совместного использования источника данных см. в разделе [Практическое руководство. Использование JoinBlock для чтения данных из нескольких источников](../../../docs/standard/parallel-programming/how-to-use-joinblock-to-read-data-from-multiple-sources.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-378">For an example that demonstrates how to use non-greedy mode to enable multiple join blocks to share a data source more efficiently, see [How to: Use JoinBlock to Read Data From Multiple Sources](../../../docs/standard/parallel-programming/how-to-use-joinblock-to-read-data-from-multiple-sources.md).</span></span>  
  
 <span data-ttu-id="511a8-379">[[в начало](#top)]</span><span class="sxs-lookup"><span data-stu-id="511a8-379">[[go to top](#top)]</span></span>  
  
<a name="custom"></a>   
## <a name="custom-dataflow-blocks"></a><span data-ttu-id="511a8-380">Пользовательские блоки потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-380">Custom Dataflow Blocks</span></span>  
 <span data-ttu-id="511a8-381">Хотя библиотека потоков данных TPL предоставляет множество стандартных типов блоков, можно создавать дополнительные типы блоков, которые выполняют устанавливаемые пользователем функции.</span><span class="sxs-lookup"><span data-stu-id="511a8-381">Although the TPL Dataflow Library provides many predefined block types, you can create additional block types that perform custom behavior.</span></span> <span data-ttu-id="511a8-382">Реализуйте интерфейсы <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> или <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> непосредственно или используйте метод <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Encapsulate%2A> для сборки сложных блоков, которые инкапсулируют поведение существующих типов блоков.</span><span class="sxs-lookup"><span data-stu-id="511a8-382">Implement the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601> or <xref:System.Threading.Tasks.Dataflow.ITargetBlock%601> interfaces directly or use the  <xref:System.Threading.Tasks.Dataflow.DataflowBlock.Encapsulate%2A> method to build a complex block that encapsulates the behavior of existing block types.</span></span> <span data-ttu-id="511a8-383">Примеры, в которых демонстрируются способы реализации пользовательской функциональности блоков потока данных, см. в разделе [Пошаговое руководство. Создание пользовательского типа блока потока данных](../../../docs/standard/parallel-programming/walkthrough-creating-a-custom-dataflow-block-type.md).</span><span class="sxs-lookup"><span data-stu-id="511a8-383">For examples that show how to implement custom dataflow block functionality, see [Walkthrough: Creating a Custom Dataflow Block Type](../../../docs/standard/parallel-programming/walkthrough-creating-a-custom-dataflow-block-type.md).</span></span>  
  
 <span data-ttu-id="511a8-384">[[в начало](#top)]</span><span class="sxs-lookup"><span data-stu-id="511a8-384">[[go to top](#top)]</span></span>  
  
## <a name="related-topics"></a><span data-ttu-id="511a8-385">См. также</span><span class="sxs-lookup"><span data-stu-id="511a8-385">Related Topics</span></span>  
  
|<span data-ttu-id="511a8-386">Заголовок</span><span class="sxs-lookup"><span data-stu-id="511a8-386">Title</span></span>|<span data-ttu-id="511a8-387">Описание:</span><span class="sxs-lookup"><span data-stu-id="511a8-387">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="511a8-388">Практическое руководство. Запись и чтение сообщений в блоке потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-388">How to: Write Messages to and Read Messages from a Dataflow Block</span></span>](../../../docs/standard/parallel-programming/how-to-write-messages-to-and-read-messages-from-a-dataflow-block.md)|<span data-ttu-id="511a8-389">Здесь показано, как писать и считывать сообщения из объекта <xref:System.Threading.Tasks.Dataflow.BufferBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="511a8-389">Demonstrates how to write messages to and read messages from a <xref:System.Threading.Tasks.Dataflow.BufferBlock%601> object.</span></span>|  
|[<span data-ttu-id="511a8-390">Практическое руководство. Реализация шаблона потока данных "производитель-получатель"</span><span class="sxs-lookup"><span data-stu-id="511a8-390">How to: Implement a Producer-Consumer Dataflow Pattern</span></span>](../../../docs/standard/parallel-programming/how-to-implement-a-producer-consumer-dataflow-pattern.md)|<span data-ttu-id="511a8-391">Здесь приводится описания способов использования модели потока данных для реализации шаблона производитель-потребитель, где производитель отправляет сообщения в блок потока данных, а потребитель считывает сообщения из этого блока.</span><span class="sxs-lookup"><span data-stu-id="511a8-391">Describes how to use the dataflow model to implement a producer-consumer pattern, where the producer sends messages to a dataflow block, and the consumer reads messages from that block.</span></span>|  
|[<span data-ttu-id="511a8-392">Практическое руководство. Выполнение действий при получении данных блоком потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-392">How to: Perform Action When a Dataflow Block Receives Data</span></span>](../../../docs/standard/parallel-programming/how-to-perform-action-when-a-dataflow-block-receives-data.md)|<span data-ttu-id="511a8-393">Здесь приводится описание способов предоставления делегатов типам блоков выполнения потока данных, <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602> и <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="511a8-393">Describes how to provide delegates to the execution dataflow block types, <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>, <xref:System.Threading.Tasks.Dataflow.TransformBlock%602>, and <xref:System.Threading.Tasks.Dataflow.TransformManyBlock%602>.</span></span>|  
|[<span data-ttu-id="511a8-394">Пошаговое руководство. Создание конвейера потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-394">Walkthrough: Creating a Dataflow Pipeline</span></span>](../../../docs/standard/parallel-programming/walkthrough-creating-a-dataflow-pipeline.md)|<span data-ttu-id="511a8-395">Здесь приводится способ создания конвейера потока данных, который загружает текст из Интернета и выполняет над ним операции.</span><span class="sxs-lookup"><span data-stu-id="511a8-395">Describes how to create a dataflow pipeline that downloads text from the web and performs operations on that text.</span></span>|  
|[<span data-ttu-id="511a8-396">Практическое руководство. Удаление связей с блоками потоков данных</span><span class="sxs-lookup"><span data-stu-id="511a8-396">How to: Unlink Dataflow Blocks</span></span>](../../../docs/standard/parallel-programming/how-to-unlink-dataflow-blocks.md)|<span data-ttu-id="511a8-397">Здесь показано, как с помощью метода <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A> удалить связь между целевым блоком и его источником после того, как источник отправил сообщение целевому объекту.</span><span class="sxs-lookup"><span data-stu-id="511a8-397">Demonstrates how to use the <xref:System.Threading.Tasks.Dataflow.ISourceBlock%601.LinkTo%2A> method to unlink a target block from its source after the source offers a message to the target.</span></span>|  
|[<span data-ttu-id="511a8-398">Пошаговое руководство. Использование потока данных в приложении Windows Forms</span><span class="sxs-lookup"><span data-stu-id="511a8-398">Walkthrough: Using Dataflow in a Windows Forms Application</span></span>](../../../docs/standard/parallel-programming/walkthrough-using-dataflow-in-a-windows-forms-application.md)|<span data-ttu-id="511a8-399">Здесь демонстрируется, как создавать сеть блоков потока данных, которые выполняют обработку изображений в приложении Windows Forms.</span><span class="sxs-lookup"><span data-stu-id="511a8-399">Demonstrates how to create a network of dataflow blocks that perform image processing in a Windows Forms application.</span></span>|  
|[<span data-ttu-id="511a8-400">Практическое руководство. Отмена блока потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-400">How to: Cancel a Dataflow Block</span></span>](../../../docs/standard/parallel-programming/how-to-cancel-a-dataflow-block.md)|<span data-ttu-id="511a8-401">Здесь демонстрируется способ использования отмены в приложении Windows Forms.</span><span class="sxs-lookup"><span data-stu-id="511a8-401">Demonstrates how to use cancellation in a Windows Forms application.</span></span>|  
|[<span data-ttu-id="511a8-402">Практическое руководство. Использование JoinBlock для чтения данных из нескольких источников</span><span class="sxs-lookup"><span data-stu-id="511a8-402">How to: Use JoinBlock to Read Data From Multiple Sources</span></span>](../../../docs/standard/parallel-programming/how-to-use-joinblock-to-read-data-from-multiple-sources.md)|<span data-ttu-id="511a8-403">Здесь описывается способ использования класса <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> для выполнения операции, когда данные доступны из нескольких источников, и использования нежадного режима, чтобы позволить нескольким блокам объединения использовать общий источник данных более эффективно.</span><span class="sxs-lookup"><span data-stu-id="511a8-403">Explains how to use the <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> class to perform an operation when data is available from multiple sources, and how to use non-greedy mode to enable multiple join blocks to share a data source more efficiently.</span></span>|  
|[<span data-ttu-id="511a8-404">Практическое руководство. Указание степени параллелизма в блоке потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-404">How to: Specify the Degree of Parallelism in a Dataflow Block</span></span>](../../../docs/standard/parallel-programming/how-to-specify-the-degree-of-parallelism-in-a-dataflow-block.md)|<span data-ttu-id="511a8-405">Здесь описывается, как задать свойство <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A>, чтобы позволить блоку выполнения потока данных обрабатывать более одного сообщения единовременно.</span><span class="sxs-lookup"><span data-stu-id="511a8-405">Describes how to set the <xref:System.Threading.Tasks.Dataflow.ExecutionDataflowBlockOptions.MaxDegreeOfParallelism%2A> property to enable an execution dataflow block to process more than one message at a time.</span></span>|  
|[<span data-ttu-id="511a8-406">Практическое руководство. Указание планировщика задач в блоке потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-406">How to: Specify a Task Scheduler in a Dataflow Block</span></span>](../../../docs/standard/parallel-programming/how-to-specify-a-task-scheduler-in-a-dataflow-block.md)|<span data-ttu-id="511a8-407">Здесь демонстрируется, как связать определенный планировщик задач при использовании потока данных в приложении.</span><span class="sxs-lookup"><span data-stu-id="511a8-407">Demonstrates how to associate a specific task scheduler when you use dataflow in your application.</span></span>|  
|[<span data-ttu-id="511a8-408">Пошаговое руководство. Повышение эффективности с помощью BatchBlock и BatchedJoinBlock</span><span class="sxs-lookup"><span data-stu-id="511a8-408">Walkthrough: Using BatchBlock and BatchedJoinBlock to Improve Efficiency</span></span>](../../../docs/standard/parallel-programming/walkthrough-using-batchblock-and-batchedjoinblock-to-improve-efficiency.md)|<span data-ttu-id="511a8-409">Здесь описывается, как использовать класс <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> для увеличения эффективности операций вставки в базу данных, а также как использовать класс <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> для получения как результата, так и всех исключений, возникающих при чтении данных из базы.</span><span class="sxs-lookup"><span data-stu-id="511a8-409">Describes how to use the <xref:System.Threading.Tasks.Dataflow.BatchBlock%601> class to improve the efficiency of database insert operations, and how to use the <xref:System.Threading.Tasks.Dataflow.BatchedJoinBlock%602> class to capture both the results and any exceptions that occur while the program reads from a database.</span></span>|  
|[<span data-ttu-id="511a8-410">Пошаговое руководство. Создание пользовательского типа блока потока данных</span><span class="sxs-lookup"><span data-stu-id="511a8-410">Walkthrough: Creating a Custom Dataflow Block Type</span></span>](../../../docs/standard/parallel-programming/walkthrough-creating-a-custom-dataflow-block-type.md)|<span data-ttu-id="511a8-411">Здесь приводятся два способа создания типа блока потока данных, который реализует пользовательские функции.</span><span class="sxs-lookup"><span data-stu-id="511a8-411">Demonstrates two ways to create a dataflow block type that implements custom behavior.</span></span>|  
|[<span data-ttu-id="511a8-412">Библиотека параллельных задач (TPL)</span><span class="sxs-lookup"><span data-stu-id="511a8-412">Task Parallel Library (TPL)</span></span>](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)|<span data-ttu-id="511a8-413">Здесь приводится описание TPL — библиотеки, упрощающей параллельное и одновременное программирование в приложениях [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)].</span><span class="sxs-lookup"><span data-stu-id="511a8-413">Introduces the TPL, a library that simplifies parallel and concurrent programming in [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] applications.</span></span>|
