---
title: Вызываемая оболочка времени выполнения
ms.date: 03/30/2017
helpviewer_keywords:
- COM interop, COM wrappers
- RCW
- COM wrappers
- runtime callable wrappers
- interoperation with unmanaged code, COM wrappers
ms.assetid: 7e542583-1e31-4e10-b523-8cf2f29cb4a4
ms.openlocfilehash: 0b448379fba965060fdf3bf067e65374f40d1fc2
ms.sourcegitcommit: 00aa62e2f469c2272a457b04e66b4cc3c97a800b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2020
ms.locfileid: "78156014"
---
# <a name="runtime-callable-wrapper"></a>Вызываемая оболочка времени выполнения
Среда CLR предоставляет доступ к COM-объектам через посредник, называемый вызываемой оболочкой времени выполнения. Хотя вызываемая оболочка времени выполнения выглядит для клиентов .NET обычным объектом, ее основная функция состоит в маршалинге вызовов между клиентом .NET и COM-объектом.  
  
 Среда выполнения создает по одной вызываемой оболочке времени выполнения для каждого COM-объекта независимо от числа существующих ссылок на этот объект. Среда выполнения поддерживает одну вызываемую оболочку времени выполнения на процесс для каждого объекта.  Если вы создаете вызываемую оболочку времени выполнения в одном домене приложения или подразделении, а затем передаете ссылку в другой домен приложения или подразделение, будет использоваться посредник для первого объекта.  Как показано на схеме ниже, любое количество управляемых клиентов может содержать ссылку на COM-объекты, предоставляющие интерфейсы INew и INewer.  

На следующем рисунке показана процедура доступа к COM-объектам с помощью вызываемой оболочки времени выполнения:

 ![Процедура доступа к COM-объектам с помощью вызываемой оболочки времени выполнения.](./media/runtime-callable-wrapper/runtime-callable-wrapper.gif)  

 Используя метаданные, полученные из библиотеки типов, среда выполнения создает и вызываемый COM-объект, и оболочку для него. Каждая вызываемая оболочка времени выполнения содержит кэш указателей интерфейса для COM-объекта, для которого она используется, и освобождает ссылку на COM-объект, когда она больше не нужна. Среда выполнения выполняет сборку мусора для вызываемой оболочки времени выполнения.  
  
 Среди прочих операций вызываемая оболочка времени выполнения осуществляет маршалинг данных между управляемым и неуправляемым кодом от имени упакованного в оболочку объекта. В частности, вызываемая оболочка времени выполнения выполняет маршалинг аргументов и возвращаемых значений метода, если данные, которыми обмениваются клиент и сервер, представлены в них по-разному.  
  
 Стандартная оболочка обеспечивает выполнение встроенных правил маршалинга. Например, когда клиент .NET передает в неуправляемый объект тип String как часть аргумента, оболочка преобразует эту строку в тип BSTR. Если COM-объект возвращает управляемому вызывающему объекту данные типа BSTR, вызывающий объект получит данные типа String. И клиент, и сервер отправляют и получают данные в понятном им представлении. Преобразование других типов не требуется. Например, стандартная оболочка всегда передает 4-байтовое целое число между управляемым и неуправляемым кодом, не преобразуя тип.  
  
## <a name="marshaling-selected-interfaces"></a>Маршалинг выбранных интерфейсов  
 Основная цель [вызываемой оболочки времени выполнения](runtime-callable-wrapper.md) — скрыть различия между управляемыми и неуправляемыми моделями программирования. Чтобы обеспечить беспроблемный переход, вызываемая оболочка времени выполнения использует выбранные COM-интерфейсы, не предоставляя доступа к ним клиенту .NET, как показано на схеме ниже.

 На следующем рисунке показаны COM-интерфейсы и вызываемая оболочка времени выполнения:
  
 ![Снимок экрана, показывающий вызываемую оболочку времени выполнения с интерфейсами.](./media/runtime-callable-wrapper/runtime-callable-wrapper-interfaces.gif)  
  
 Вызываемая оболочка времени выполнения, если она создается как объект с ранним связыванием, является особым типом. Она реализует интерфейсы, реализуемые COM-объектом, и предоставляет доступ к методам, свойствам и событиям из интерфейсов объекта. На рисунке вызываемая оболочка времени выполнения предоставляет доступ к интерфейсу INew, для чего использует интерфейсы **IUnknown** и **IDispatch**. Кроме того, вызываемая оболочка времени выполнения предоставляет клиенту .NET доступ ко всем членам интерфейса INew.  
  
 Вызываемая оболочка времени выполнения использует перечисленные в следующей таблице интерфейсы, предоставляемые инкапсулированным в эту оболочку объектом.  
  
|Интерфейс|Description|  
|---------------|-----------------|  
|**IDispatch**|Для позднего связывания с COM-объектами с помощью отражения.|  
|**IErrorInfo**|Предоставляет текстовое описание ошибки, ее источник, файл справки, контекст справки и идентификатор GUID интерфейса, определившего ошибку (для классов .NET всегда **GUID_NULL**).|  
|**IProvideClassInfo**|Если инкапсулируемый COM-объект реализует интерфейс **IProvideClassInfo**, вызываемая оболочка времени выполнения извлекает из этого интерфейса сведения о типе для лучшей его идентификации.|  
|**IUnknown**|Для идентификации объектов, приведения типов и управления жизненным циклом объекта:<br /><br /> — Идентификация объектов<br />     Среда выполнения различает COM-объекты, сравнивая значение интерфейса **IUnknown** для каждого из них.<br />— Приведение типов<br />     Вызываемая оболочка времени выполнения распознает динамическое обнаружение типов, выполняемое методом **QueryInterface**.<br />— Управление жизненным циклом объекта<br />     С помощью метода **QueryInterface** вызываемая оболочка времени выполнения получает и сохраняет ссылку на неуправляемый объект, пока среда выполнения не выполнит для оболочки сбор мусора, освободив неуправляемый объект.|  
  
 Вызываемая оболочка времени выполнения может использовать перечисленные в следующей таблице интерфейсы, предоставляемые инкапсулированным в эту оболочку объектом.  
  
|Интерфейс|Description|  
|---------------|-----------------|  
|**IConnectionPoint** и **IConnectionPointContainer**|Вызываемая оболочка времени выполнения преобразует объекты, предоставляющие событиям на основе делегата доступ к стилю события точки подключения.|  
|**IDispatchEx** (только в .NET Framework) |Если класс реализует интерфейс **IDispatchEx**, вызываемая оболочка времени выполнения реализует интерфейс **IExpando**. Интерфейс **IDispatchEx** является расширением интерфейса **IDispatch**, который, в отличие от интерфейса **IDispatch**, позволяет перечислять, добавлять, удалять и вызывать члены с учетом регистра.|  
|**IEnumVARIANT**|Активирует COM-типы, позволяющие работать с перечислениями как с коллекциями.|  
  
## <a name="see-also"></a>См. также раздел

- [Oболочки COM](com-wrappers.md)
- [Вызываемая оболочка COM](com-callable-wrapper.md)
- [Общие сведения о преобразовании библиотеки типов в сборку](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/k83zzh38(v=vs.100))
- [Импорт библиотеки типов в виде сборки](../../framework/interop/importing-a-type-library-as-an-assembly.md)
