---
title: Маршалинг типов — .NET
description: Из этой статьи вы узнаете, как платформа .NET маршалирует ваши типы данных в собственное представление.
ms.date: 01/18/2019
ms.openlocfilehash: 91b8f3d6cb53fd7a0adea7ea9669e7459e81445f
ms.sourcegitcommit: 5f236cd78cf09593c8945a7d753e0850e96a0b80
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2020
ms.locfileid: "75706270"
---
# <a name="type-marshaling"></a>Маршалинг типов

**Маршалинг** — это процесс преобразования типов при переходе от управляемого кода к машинному.

Необходимость в маршалинге вызвана различием типов в управляемом и неуправляемом коде. Например, в управляемом коде имеется `String`, в то время как в неуправляемых строках может использоваться Юникод ("Wide"), не в Юникоде, с завершающим нулем, ASCII и т. д. По умолчанию подсистема P/Invoke пытается выполнить нужное действие в зависимости от поведения по умолчанию, описанного в этой статье. Однако в ситуациях, когда требуется дополнительный контроль, можно применить атрибут [MarshalAs](xref:System.Runtime.InteropServices.MarshalAsAttribute), чтобы указать ожидаемый тип на стороне неуправляемого кода. Например, если строку нужно передать в виде строки ANSI с конечным символом NULL, это можно сделать следующим образом:

```csharp
[DllImport("somenativelibrary.dll")]
static extern int MethodA([MarshalAs(UnmanagedType.LPStr)] string parameter);
```

## <a name="default-rules-for-marshaling-common-types"></a>Правила маршалинга общих типов

Обычно среда выполнения пытается маршалировать типы "правильно", чтобы от пользователя не потребовалось никаких действий. В приведенных ниже таблицах показано, как при использовании в параметре или поле каждый тип данных маршалируется по умолчанию. Чтобы проверить правильность данных в приведенных ниже таблицах для всех платформ, используются символьные и целочисленные (фиксированной ширины) типы данных C99/C++11. Используйте любой собственный тип, который имеет такое же выравнивание и требования к размеру, как эти типы данных.

В первой таблице представлены сопоставления различных типов, для которых маршалинг выполняется одинаково — как для P/Invoke, так и для поля.

| Тип .NET | Собственный тип  |
|-----------|-------------------------|
| `byte`    | `uint8_t`               |
| `sbyte`   | `int8_t`                |
| `short`   | `int16_t`               |
| `ushort`  | `uint16_t`              |
| `int`     | `int32_t`               |
| `uint`    | `uint32_t`              |
| `long`    | `int64_t`               |
| `ulong`   | `uint64_t`              |
| `char`    | Тип `char` или `char16_t` в зависимости от кодировки `CharSet` P/Invoke или структуры. См. дополнительные сведения в [документации по кодировке](charset.md). |
| `string`  | Тип `char*` или `char16_t*` в зависимости от кодировки `CharSet` P/Invoke или структуры. См. дополнительные сведения в [документации по кодировке](charset.md). |
| `System.IntPtr` | `intptr_t`        |
| `System.UIntPtr` | `uintptr_t`      |
| Типы указателей .NET (за исключением `void*`)  | `void*` |
| Тип, производный от `System.Runtime.InteropServices.SafeHandle` | `void*` |
| Тип, производный от `System.Runtime.InteropServices.CriticalHandle` | `void*`          |
| `bool`    | Тип Win32 `BOOL`       |
| `decimal` | Структура COM `DECIMAL` |
| Делегат .NET | Собственный указатель функции |
| `System.DateTime` | Тип Win32 `DATE` |
| `System.Guid` | Тип Win32 `GUID` |

Если вы маршалируете тип как параметр или структуру, несколько категорий маршалинга будут иметь разные значения по умолчанию.

| Тип .NET | Собственный тип (параметр) | Собственный тип (поле) |
|-----------|-------------------------|---------------------|
| Массив .NET | Указатель на начало массива в собственном представлении элементов массива. | Нельзя использовать без атрибута `[MarshalAs]`|
| Класс, где для `LayoutKind` задано значение `Sequential` или `Explicit` | Указатель на собственное представление класса | Собственное представление класса |

В приведенной ниже таблице содержатся правила маршалинга, применяемые по умолчанию только для Windows. На других платформах (не Windows) эти типы нельзя маршалировать.

| Тип .NET | Собственный тип (параметр) | Собственный тип (поле) |
|-----------|-------------------------|---------------------|
| `object`  | `VARIANT`               | `IUnknown*`         |
| `System.Array` | Интерфейс COM | Нельзя использовать без атрибута `[MarshalAs]` |
| `System.ArgIterator` | `va_list` | Запрещено |
| `System.Collections.IEnumerator` | `IEnumVARIANT*` | Запрещено |
| `System.Collections.IEnumerable` | `IDispatch*` | Запрещено |
| `System.DateTimeOffset` | `int64_t` — число тактов начиная с полуночи 1 января 1601 года. || `int64_t` — число тактов начиная с полуночи 1 января 1601 года. |

Некоторые типы можно маршалировать только как параметры и нельзя — как поля. Эти типы перечислены в следующей таблице.

| Тип .NET | Собственный тип (только параметр) |
|-----------|------------------------------|
| `System.Text.StringBuilder` | Тип `char*` или `char16_t*` в зависимости от кодировки `CharSet` P/Invoke.  См. дополнительные сведения в [документации по кодировке](charset.md). |
| `System.ArgIterator` | `va_list` (только в Windows x86/x64/arm64) |
| `System.Runtime.InteropServices.ArrayWithOffset` | `void*` |
| `System.Runtime.InteropServices.HandleRef` | `void*` |

Если эти значения по умолчанию вам не подходят, вы можете настроить маршалинг параметров. В статье о [маршалинге параметров](customize-parameter-marshaling.md) описана настройка маршалинга различных типов параметров.

## <a name="default-marshaling-in-com-scenarios"></a>Маршалинг в сценариях COM по умолчанию

При вызове методов в объектах COM в .NET среда выполнения .NET изменяет правила маршалинга по умолчанию в соответствии с общей семантикой COM. В следующей таблице перечислены правила, которые среда выполнения .NET использует в сценариях COM:

| Тип .NET | Собственный тип (вызовы метода COM) |
|-----------|--------------------------------|
| `bool`    | `VARIANT_BOOL`                 |
| `StringBuilder` | `LPWSTR`                 |
| `string`  | `BSTR`                         |
| Тип делегатов | `_Delegate*` в .NET Framework. Не разрешены в .NET Core. |
| `System.Drawing.Color` | `OLECOLOR`        |
| Массив .NET | `SAFEARRAY`                   |
| `string[]` | `SAFEARRAY``BSTR`        |

## <a name="marshaling-classes-and-structs"></a>Маршалинг классов и структур

Другим аспектом маршалинга типов является способ передачи структуры в неуправляемый метод. Например, некоторые неуправляемые методы требуют указания структуры в качестве параметра. В таких случаях необходимо создать соответствующую структуру или соответствующий класс в управляемом коде и использовать в качестве параметра. Но определить класс недостаточно. Нужно также указать маршалеру, как сопоставлять поля класса с неуправляемой структурой. Здесь пригодится атрибут `StructLayout`.

```csharp
[DllImport("kernel32.dll")]
static extern void GetSystemTime(SystemTime systemTime);

[StructLayout(LayoutKind.Sequential)]
class SystemTime {
    public ushort Year;
    public ushort Month;
    public ushort DayOfWeek;
    public ushort Day;
    public ushort Hour;
    public ushort Minute;
    public ushort Second;
    public ushort Milsecond;
}

public static void Main(string[] args) {
    SystemTime st = new SystemTime();
    GetSystemTime(st);
    Console.WriteLine(st.Year);
}
```

В приведенном выше примере представлен код вызова функции `GetSystemTime()`. Интерес представляет строка 4. Атрибут указывает, что поля класса должны последовательно сопоставляться со структурой на другой (неуправляемой) стороне. Это означает, что имена полей не важны, важен только их порядок, так как он должен соответствовать неуправляемой структуре, которая показана в приведенном ниже примере:

```c
typedef struct _SYSTEMTIME {
  WORD wYear;
  WORD wMonth;
  WORD wDayOfWeek;
  WORD wDay;
  WORD wHour;
  WORD wMinute;
  WORD wSecond;
  WORD wMilliseconds;
} SYSTEMTIME, *PSYSTEMTIME;
```

Иногда маршалинг по умолчанию не решает задачу для вашей структуры. Дополнительные сведения см. в статье о [настройке маршалинга структур](./customize-struct-marshaling.md).
