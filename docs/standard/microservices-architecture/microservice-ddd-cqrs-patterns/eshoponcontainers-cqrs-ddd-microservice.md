---
title: Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers
description: Архитектура микрослужб .NET для контейнерных приложений .NET | Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.openlocfilehash: 6be8b52f42e3e37ff03e561af45c46f4dd283d9e
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
---
# <a name="applying-cqrs-and-cqs-approaches-in-a-ddd-microservice-in-eshoponcontainers"></a><span data-ttu-id="26c24-103">Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers</span><span class="sxs-lookup"><span data-stu-id="26c24-103">Applying CQRS and CQS approaches in a DDD microservice in eShopOnContainers</span></span>

<span data-ttu-id="26c24-104">Проект микрослужбы заказов эталонного приложения eShopOnContainers построен на принципах CQRS.</span><span class="sxs-lookup"><span data-stu-id="26c24-104">The design of the ordering microservice at the eShopOnContainers reference application is based on CQRS principles.</span></span> <span data-ttu-id="26c24-105">Однако в нем применяется простейший подход, который просто разделяет запросы и команды и использует одну и ту же базу данных для обоих действий.</span><span class="sxs-lookup"><span data-stu-id="26c24-105">However, it uses the simplest approach, which is just separating the queries from the commands and using the same database for both actions.</span></span>

<span data-ttu-id="26c24-106">Суть этих шаблонов и важный момент заключается в том, что запросы идемпотентны: независимо от того, сколько раз запрашивается система, состояние этой системы не изменится. Можно даже использовать модель данных "чтения", отличную от модели предметной области "записи" транзакционной логики, несмотря на то, что микрослужба заказов использует ту же базу данных.</span><span class="sxs-lookup"><span data-stu-id="26c24-106">The essence of those patterns, and the important point here, is that queries are idempotent: no matter how many times you query a system, the state of that system will not change You could even use a different “reads” data model than the transactional logic “writes” domain model, although the ordering microservices is using the same database.</span></span> <span data-ttu-id="26c24-107">Поэтому это упрощенный подход CQRS.</span><span class="sxs-lookup"><span data-stu-id="26c24-107">Hence this is a simplified CQRS approach.</span></span>

<span data-ttu-id="26c24-108">С другой стороны, команды, которые инициируют транзакции и обновления данных, изменяют состояние в системе.</span><span class="sxs-lookup"><span data-stu-id="26c24-108">On the other hand, commands, which trigger transactions and data updates, change state in the system.</span></span> <span data-ttu-id="26c24-109">При использовании команд необходимо соблюдать осторожность, имея дело со сложными и постоянно меняющимися бизнес-правилами.</span><span class="sxs-lookup"><span data-stu-id="26c24-109">With commands, you need to be careful when dealing with complexity and ever-changing business rules.</span></span> <span data-ttu-id="26c24-110">Это наиболее подходящее место для применения методов DDD, чтобы получить наилучшим образом смоделированную систему.</span><span class="sxs-lookup"><span data-stu-id="26c24-110">This is the where you want to apply DDD techniques to have a better modeled system.</span></span>

<span data-ttu-id="26c24-111">Шаблоны DDD, представленные в настоящем руководстве, не должны применяться универсально.</span><span class="sxs-lookup"><span data-stu-id="26c24-111">The DDD patterns presented in this guide should not be applied universally.</span></span> <span data-ttu-id="26c24-112">Они вводят в ваш проект ограничения.</span><span class="sxs-lookup"><span data-stu-id="26c24-112">They introduce constraints on your design.</span></span> <span data-ttu-id="26c24-113">Эти ограничения обеспечивают такие преимущества, как повышение качества с течением времени, особенно в командах и другом коде, который изменяет состояние системы.</span><span class="sxs-lookup"><span data-stu-id="26c24-113">Those constraints provide benefits such as higher quality over time, especially in commands and other code that modifies system state.</span></span> <span data-ttu-id="26c24-114">Однако эти ограничения увеличивают сложность с минимумом преимуществ для чтения и запросов данных.</span><span class="sxs-lookup"><span data-stu-id="26c24-114">However, those constraints add complexity with fewer benefits for reading and querying data.</span></span>

<span data-ttu-id="26c24-115">Одним из таких шаблонов является шаблон агрегата, который мы подробно рассмотрим в последующих разделах.</span><span class="sxs-lookup"><span data-stu-id="26c24-115">One such pattern is the Aggregate pattern, which we examine more in later sections.</span></span> <span data-ttu-id="26c24-116">Вкратце, в шаблоне агрегата (Aggregate) многие объекты предметной области обрабатываются как единое целое в результате их связей в предметной области.</span><span class="sxs-lookup"><span data-stu-id="26c24-116">Briefly, in the Aggregate pattern, you treat many domain objects as a single unit as a result of their relationship in the domain.</span></span> <span data-ttu-id="26c24-117">В запросах не всегда удается извлечь преимущества из этого шаблона; он может увеличить сложность логики запроса.</span><span class="sxs-lookup"><span data-stu-id="26c24-117">You might not always gain advantages from this pattern in queries; it can increase the complexity of query logic.</span></span> <span data-ttu-id="26c24-118">В запросах только на чтение вы не получите никаких преимуществ от обработки нескольких объектов как единого агрегата.</span><span class="sxs-lookup"><span data-stu-id="26c24-118">For read-only queries, you do not get the advantages of treating multiple objects as a single Aggregate.</span></span> <span data-ttu-id="26c24-119">Вы получите только сложность.</span><span class="sxs-lookup"><span data-stu-id="26c24-119">You only get the complexity.</span></span>

<span data-ttu-id="26c24-120">Как показано на рисунке 9-2, в данном руководстве предлагается использовать шаблоны DDD только в области транзакций или обновлений вашей микрослужбы (то есть в том, что инициируется командами).</span><span class="sxs-lookup"><span data-stu-id="26c24-120">As shown in Figure 9-2, this guide suggests using DDD patterns only in the transactional/updates area of your microservice (that is, as triggered by commands).</span></span> <span data-ttu-id="26c24-121">Для запросов можно использовать более простой подход, и согласно концепции CQRS их следует отделить от команд.</span><span class="sxs-lookup"><span data-stu-id="26c24-121">Queries can follow a simpler approach and should be separated from commands, following a CQRS approach.</span></span>

<span data-ttu-id="26c24-122">Для реализации "стороны запросов" вы можете выбирать между подходами, включая полнофункциональные ORM, например EF Core, проекции AutoMapper, хранимые процедуры, представления, материализованные представления и micro ORM.</span><span class="sxs-lookup"><span data-stu-id="26c24-122">For implementing the “queries side”, you can choose between many approaches, from your full-blown ORM like EF Core, AutoMapper projections, stored procedures, views, materialized views or a micro ORM.</span></span>

<span data-ttu-id="26c24-123">В данном руководстве и в приложении eShopOnContainers (в частности, в микрослужбе заказов) мы решили реализовать прямые запросы с помощью micro ORM, например [Dapper](https://github.com/StackExchange/dapper-dot-net).</span><span class="sxs-lookup"><span data-stu-id="26c24-123">In this guide and in eShopOnContainers (specifically the ordering microservice) we chose to implement straight queries using a micro ORM like [Dapper](https://github.com/StackExchange/dapper-dot-net).</span></span> <span data-ttu-id="26c24-124">Это позволяет реализовать любой запрос на основе инструкций SQL для получения наилучшей производительности благодаря облегченной инфраструктуре с минимальными накладными расходами.</span><span class="sxs-lookup"><span data-stu-id="26c24-124">This lets you implement any query based on SQL statements to get the best performance, thanks to a light framework with very little overhead.</span></span>

<span data-ttu-id="26c24-125">Обратите внимание, что при использовании этого подхода для любых обновлений модели, влияющих на то, как сущности сохраняются в базе данных SQL, также требуются отдельные обновления запросов SQL, используемых Dapper или любым другим отдельным (не EF) подходом к запросам.</span><span class="sxs-lookup"><span data-stu-id="26c24-125">Note that when you use this approach, any updates to your model that impact how entities are persisted to a SQL database also need separate updates to SQL queries used by Dapper or any other separate (non-EF) approaches to querying.</span></span>

## <a name="cqrs-and-ddd-patterns-are-not-top-level-architectures"></a><span data-ttu-id="26c24-126">Шаблоны DDD и CQRS не относятся к архитектурам верхнего уровня</span><span class="sxs-lookup"><span data-stu-id="26c24-126">CQRS and DDD patterns are not top-level architectures</span></span>

<span data-ttu-id="26c24-127">Важно понимать, что CQRS и большинство шаблонов DDD (например, слои DDD или модель предметной области с агрегатами) являются не архитектурными стилями, а лишь архитектурными шаблонами.</span><span class="sxs-lookup"><span data-stu-id="26c24-127">It important to understand that CQRS and most DDD patterns (like DDD layers or a domain model with aggregates) are not architectural styles, but only architecture patterns.</span></span> <span data-ttu-id="26c24-128">Примерами архитектурных стилей являются микрослужбы, SOA и событийно-управляемая архитектура (EDA).</span><span class="sxs-lookup"><span data-stu-id="26c24-128">Microservices, SOA, and event-driven architecture (EDA) are examples of architectural styles.</span></span> <span data-ttu-id="26c24-129">Они описывают систему, состоящую из множества компонентов, например из множества микрослужб.</span><span class="sxs-lookup"><span data-stu-id="26c24-129">They describe a system of many components, such as many microservices.</span></span> <span data-ttu-id="26c24-130">Шаблоны DDD и CQRS описывают нечто внутри одной системы или компонента; в данном случае — нечто внутри микрослужбы.</span><span class="sxs-lookup"><span data-stu-id="26c24-130">CQRS and DDD patterns describe something inside a single system or component; in this case, something inside a microservice.</span></span>

<span data-ttu-id="26c24-131">Разные ограниченные контексты (BC) будут использовать разные шаблоны.</span><span class="sxs-lookup"><span data-stu-id="26c24-131">Different Bounded Contexts (BCs) will employ different patterns.</span></span> <span data-ttu-id="26c24-132">Они имеют разные сферы ответственности, что ведет к разным решениям.</span><span class="sxs-lookup"><span data-stu-id="26c24-132">They have different responsibilities, and that leads to different solutions.</span></span> <span data-ttu-id="26c24-133">Стоит подчеркнуть, что повсеместное применение одного и того же шаблона приводит к неудаче.</span><span class="sxs-lookup"><span data-stu-id="26c24-133">It is worth emphasizing that forcing the same pattern everywhere leads to failure.</span></span> <span data-ttu-id="26c24-134">Не используйте шаблоны DDD и CQRS повсюду.</span><span class="sxs-lookup"><span data-stu-id="26c24-134">Do not use CQRS and DDD patterns everywhere.</span></span> <span data-ttu-id="26c24-135">Многие подсистемы, ограниченные контексты или микрослужбы довольно простые, и их можно реализовать более просто с помощью служб CRUD или другого метода.</span><span class="sxs-lookup"><span data-stu-id="26c24-135">Many subsystems, BCs, or microservices are simpler and can be implemented more easily using simple CRUD services or using another approach.</span></span>

<span data-ttu-id="26c24-136">Имеется только одна архитектура приложения: архитектура разрабатываемой системы или комплексного приложения (например, архитектура микрослужб).</span><span class="sxs-lookup"><span data-stu-id="26c24-136">There is only one application architecture: the architecture of the system or end-to-end application you are designing (for example, the microservices architecture).</span></span> <span data-ttu-id="26c24-137">Однако структура каждого ограниченного контекста или микрослужбы в этом приложении отражает их собственные компромиссы и внутренние проектные решения на уровне архитектурных шаблонов.</span><span class="sxs-lookup"><span data-stu-id="26c24-137">However, the design of each Bounded Context or microservice within that application reflects its own tradeoffs and internal design decisions at an architecture patterns level.</span></span> <span data-ttu-id="26c24-138">Не пытайтесь везде применять одни и те же архитектурные шаблоны, такие как CQRS или DDD.</span><span class="sxs-lookup"><span data-stu-id="26c24-138">Do not try to apply the same architectural patterns like CQRS or DDD everywhere.</span></span>

####  <a name="additional-resources"></a><span data-ttu-id="26c24-139">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="26c24-139">Additional resources</span></span>

-   <span data-ttu-id="26c24-140">**Мартин Фоулер (Martin Fowler). CQRS**
    [*https://martinfowler.com/bliki/CQRS.html*](https://martinfowler.com/bliki/CQRS.html)</span><span class="sxs-lookup"><span data-stu-id="26c24-140">**Martin Fowler. CQRS**
[*https://martinfowler.com/bliki/CQRS.html*](https://martinfowler.com/bliki/CQRS.html)</span></span>

-   <span data-ttu-id="26c24-141">**Грег Янг (Greg Young). CQS и CQRS**
    [*http://codebetter.com/gregyoung/2009/08/13/command-query-separation/*](http://codebetter.com/gregyoung/2009/08/13/command-query-separation/)</span><span class="sxs-lookup"><span data-stu-id="26c24-141">**Greg Young. CQS vs. CQRS**
[*http://codebetter.com/gregyoung/2009/08/13/command-query-separation/*](http://codebetter.com/gregyoung/2009/08/13/command-query-separation/)</span></span>

-   <span data-ttu-id="26c24-142">**Грег Янг (Greg Young). Документы CQRS**
    [*https://cqrs.files.wordpress.com/2010/11/cqrs\_documents.pdf*](https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf)</span><span class="sxs-lookup"><span data-stu-id="26c24-142">**Greg Young. CQRS Documents**
[*https://cqrs.files.wordpress.com/2010/11/cqrs\_documents.pdf*](https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf)</span></span>

-   <span data-ttu-id="26c24-143">**Грег Янг (Greg Young). CQRS, пользовательские интерфейсы на основе задач и источники событий**
    [*http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/*](http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/)</span><span class="sxs-lookup"><span data-stu-id="26c24-143">**Greg Young. CQRS, Task Based UIs and Event Sourcing**
[*http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/*](http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/)</span></span>

-   <span data-ttu-id="26c24-144">**Уди Дахан (Udi Dahan). Пояснения к CQRS**
    [*http://udidahan.com/2009/12/09/clarified-cqrs/*](http://udidahan.com/2009/12/09/clarified-cqrs/)</span><span class="sxs-lookup"><span data-stu-id="26c24-144">**Udi Dahan. Clarified CQRS**
[*http://udidahan.com/2009/12/09/clarified-cqrs/*](http://udidahan.com/2009/12/09/clarified-cqrs/)</span></span>

-   <span data-ttu-id="26c24-145">**CQRS**
    [*http://udidahan.com/2009/12/09/clarified-cqrs/*](http://udidahan.com/2009/12/09/clarified-cqrs/)</span><span class="sxs-lookup"><span data-stu-id="26c24-145">**CQRS**
[*http://udidahan.com/2009/12/09/clarified-cqrs/*](http://udidahan.com/2009/12/09/clarified-cqrs/)</span></span>

-   <span data-ttu-id="26c24-146">**Источники событий (ES)**
    [*http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/*](http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/)</span><span class="sxs-lookup"><span data-stu-id="26c24-146">**Event-Sourcing (ES)**
[*http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/*](http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/)</span></span>


>[!div class="step-by-step"]
<span data-ttu-id="26c24-147">[Назад] (apply-simplified-microservice-cqrs-ddd-patterns.md) [Далее] (cqrs-microservice-reads.md)</span><span class="sxs-lookup"><span data-stu-id="26c24-147">[Previous] (apply-simplified-microservice-cqrs-ddd-patterns.md) [Next] (cqrs-microservice-reads.md)</span></span>
