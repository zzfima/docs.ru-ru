---
title: "Пошаговое руководство. Обработка событий (Visual Basic) | Microsoft Docs"
ms.custom: ""
ms.date: "2015-07-20"
ms.prod: ".net"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-visual-basic"
ms.topic: "article"
dev_langs: 
  - "VB"
helpviewer_keywords: 
  - "обработчики событий [Visual Basic], пошаговые руководства"
  - "обработка событий [Visual Basic], пошаговые руководства"
  - "события [Visual Basic], пошаговые руководства"
  - "переменные [Visual Basic], WithEvents"
  - "пошаговые руководства [Visual Basic], обработка событий"
  - "WithEvents - ключевое слово, пошаговые руководства"
ms.assetid: f145b3fc-5ae0-4509-a2aa-1ff6934706bd
caps.latest.revision: 18
author: "stevehoag"
ms.author: "shoag"
caps.handback.revision: 18
---
# Пошаговое руководство. Обработка событий (Visual Basic)
[!INCLUDE[vs2017banner](../../../../visual-basic/includes/vs2017banner.md)]

Это последний из двух разделов, посвященных рассмотрению методов работы с событиями.  В первом разделе [Пошаговое руководство: объявление и создание событий](../../../../visual-basic/programming-guide/language-features/events/walkthrough-declaring-and-raising-events.md) демонстрировались методы объявления и вызова события.  В этом разделе форма и класс из предыдущего пошагового руководства используются для демонстрации способов обработки событий при их возникновении.  
  
 В примере класса `Widget` используются традиционные инструкции обработки исключений.  В [!INCLUDE[vbprvb](../../../../csharp/programming-guide/concepts/linq/includes/vbprvb-md.md)] имеются и другие способы работы с событиями.  В качестве примера можно изменить предыдущий пример и воспользоваться операторами `AddHandler` и `Handles`.  
  
### Чтобы обрабатывать событие PercentDone класса Widget  
  
1.  Поместите следующий код в `Form1`:  
  
     [!code-vb[VbVbcnWalkthroughDeclaringAndRaisingEvents#4](../../../../visual-basic/programming-guide/language-features/events/codesnippet/visualbasic/VbEventWalkthrough/Form1.vb#4)]  
  
     Ключевое слово `WithEvents` указывает на то, что переменная `mWidget` используется для обработки событий объекта.  Тип объекта определяется указанием имени класса, из которого объект будет создан.  
  
     Переменная `mWidget` объявлена в `Form1`, поскольку переменные `WithEvents` должны быть на уровне класса.  Это верно вне зависимости от типа класса, в который они помещены.  
  
     Переменная `mblnCancel` используется для отмены метода `LongTask`.  
  
## Написание кода обработки события  
 При объявлении переменной с помощью `WithEvents` имя переменной появляется в левом раскрывающемся списке **редактора кода** класса.  При выборе `mWidget` события класса `Widget` отображаются в правом раскрывающемся списке.  Выбор события приведет к отображению соответствующей процедуры события с префиксом `mWidget` и знаком подчеркивания.  Всем процедурам событий, связанным с переменной `WithEvents`, назначается имя переменной в качестве префикса.  
  
#### Чтобы обработать событие  
  
1.  Выберите `mWidget` из левого раскрывающегося списка в **редакторе кода**.  
  
2.  Выберите событие `PercentDone` из правого раскрывающегося списка.  **Редактор кода** откроет процедуру обработки события `mWidget_PercentDone`.  
  
    > [!NOTE]
    >  Использование **редактора кода** может быть полезным, но он не обязательно для вставки новых обработчиков событий.  В данном пошаговом руководстве наиболее простым способом является копирование обработчиков событий непосредственно в код.  
  
3.  В обработчик событий `mWidget_PercentDone` добавьте следующий код:  
  
     [!code-vb[VbVbcnWalkthroughDeclaringAndRaisingEvents#5](../../../../visual-basic/programming-guide/language-features/events/codesnippet/visualbasic/VbEventWalkthrough/Form1.vb#5)]  
  
     После вызова события `PercentDone` процедура события отображает процент выполнения в элементе управления `Label`.  Метод `DoEvents` позволяет обновить надпись, а также предоставляет пользователю возможность воспользоваться кнопкой **Отмена**.  
  
4.  В обработчик события `Button2_Click` добавьте следующий код:  
  
     [!code-vb[VbVbcnWalkthroughDeclaringAndRaisingEvents#6](../../../../visual-basic/programming-guide/language-features/events/codesnippet/visualbasic/VbEventWalkthrough/Form1.vb#6)]  
  
 Если пользователь нажимает кнопку **Отмена** во время работы `LongTask`, то событие `Button2_Click` выполняется, как только инструкция `DoEvents` позволит обработку возникшего события.  Переменной уровня класса `mblnCancel` присваивается значение `True`, а событие `mWidget_PercentDone` затем проверяет ее и устанавливает аргумент `ByRef Cancel` в значение `True`.  
  
## Подключение переменной WithEvents к объекту  
 Теперь `Form1` настроен для обработки событий объекта `Widget`.  Осталось обнаружить объект `Widget`.  
  
 Если переменная `WithEvents` объявлена во время разработки, то с ней не связан ни один объект.  Переменная `WithEvents` схожа с любой другой переменной объекта.  Необходимо создать объект и назначить ему ссылку с помощью переменной `WithEvents`.  
  
#### Чтобы создать объект и назначить ему ссылку  
  
1.  Выберите **\(События Form1\)** из левого раскрывающегося списка в **редакторе кода**.  
  
2.  Выберите событие `Load` из правого раскрывающегося списка.  **Редактор кода** откроет процедуру обработки события `Form1_Load`.  
  
3.  Добавьте следующий код к процедуре события `Form1_Load` для создания `Widget`:  
  
     [!code-vb[VbVbcnWalkthroughDeclaringAndRaisingEvents#7](../../../../visual-basic/programming-guide/language-features/events/codesnippet/visualbasic/VbEventWalkthrough/Form1.vb#7)]  
  
 При выполнении этого кода [!INCLUDE[vbprvb](../../../../csharp/programming-guide/concepts/linq/includes/vbprvb-md.md)] создает объект `Widget` и подключает его события к процедурам события, связанным с `mWidget`.  С этого момента при каждом появлении в `Widget` события `PercentDone` будет выполняться процедура события `mWidget_PercentDone`.  
  
#### Чтобы вызвать метод LongTask  
  
-   В обработчик событий `Button1_Click` добавьте следующий код:  
  
     [!code-vb[VbVbcnWalkthroughDeclaringAndRaisingEvents#8](../../../../visual-basic/programming-guide/language-features/events/codesnippet/visualbasic/VbEventWalkthrough/Form1.vb#8)]  
  
 Перед вызовом метода `LongTask` надпись, в которой выводится процент выполненной работы, должна быть инициализирована, а флаг отмены метода на уровне модуля типа `Boolean` должен иметь значение `False`.  
  
 `LongTask` вызывается для задачи с продолжительностью 12,2 секунды.  Событие `PercentDone` вызывается три раза в секунду.  Каждый раз при вызове этого события выполняется процедура события `mWidget_PercentDone`.  
  
 При завершении `LongTask`, программа проверяет `mblnCancel`, чтобы определить, завершено ли `LongTask` нормально или оно установлено заданием `mblnCancel` в значение `True`.  Значение процента выполнения обновляется только в первом случае.  
  
#### Чтобы выполнить программу  
  
1.  Нажмите клавишу F5, чтобы перевести проект в режим выполнения.  
  
2.  Нажмите кнопку **Запустить задачу** .  При каждом вызове события `PercentDone` в надписи обновляется значение процента выполненной работы.  
  
3.  Нажмите кнопку **Отмена** для отмены задачи.  Обратите внимание, что вид кнопки **Отмена** не меняется сразу после нажатия.  Событие `Click` не происходит до тех пор, пока инструкция `My.Application.DoEvents` не позволит обработку события.  
  
    > [!NOTE]
    >  Метод `My.Application.DoEvents` обрабатывает события образом, отличным от формы.  Например, в данном пошаговом руководстве необходимо нажать кнопку **Отмена** дважды.  Чтобы разрешить форме непосредственно обрабатывать события, можно использовать многопоточность.  Дополнительные сведения см. в разделе [Потоки](../Topic/Threading%20\(C%23%20and%20Visual%20Basic\).md).  
  
 Иногда может понадобиться запустить программу с помощью клавиши F11 с пошаговым выполнением кода.  Это позволяет увидеть, как начинается выполнение метода `LongTask`, а затем форма `Form1` появляется при каждом вызове события `PercentDone`.  
  
 Что же произойдет, если метод `LongTask` будет снова вызван, когда выполнение уже вернулось в код `Form1`?  В худшем случае, если метод `LongTask` вызывался каждый раз при возникновении данного события, может произойти переполнение стека.  
  
 Можно вызвать переменную `mWidget` для обработки событий для другого объекта `Widget` путем назначения ссылки на новый `Widget` переменной `mWidget`.  Действительно, данная операция может выполняться кодом в процедуре `Button1_Click` при каждом нажатии кнопки.  
  
#### Чтобы обработать события для другого объекта Widget:  
  
-   Добавьте следующую строку кода в процедуру `Button1_Click` непосредственно перед строкой, считывающей `mWidget.LongTask(12.2, 0.33)`:  
  
     [!code-vb[VbVbcnWalkthroughDeclaringAndRaisingEvents#9](../../../../visual-basic/programming-guide/language-features/events/codesnippet/visualbasic/VbEventWalkthrough/Form1.vb#9)]  
  
 Приведенный выше код создает новый объект `Widget` при каждом нажатии этой кнопки.  Как только метод `LongTask` завершается, ссылка на объект `Widget` отменяется и объект `Widget` уничтожается.  
  
 Переменная `WithEvents` может содержать только одну ссылку на объект, поэтому при назначении `mWidget` нового объекта `Widget` события предыдущего `Widget` перестают обрабатываться.  Если `mWidget` является единственной объектной переменной, содержащей ссылку на старый объект `Widget`, то объект уничтожается.  При необходимости обработки событий от нескольких объектов `Widget` можно использовать оператор `AddHandler`, чтобы по отдельности обрабатывать события каждого объекта.  
  
> [!NOTE]
>  Можно объявить столько переменных `WithEvents`, сколько требуется. При этом массивы переменных `WithEvents` не поддерживаются.  
  
## См. также  
 [Пошаговое руководство. Объявление и создание событий](../../../../visual-basic/programming-guide/language-features/events/walkthrough-declaring-and-raising-events.md)   
 [События](../../../../visual-basic/programming-guide/language-features/events/events.md)